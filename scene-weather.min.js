let e={ID:"scene-weather",NAME:"Scene Weather",LCCNAME:"sceneWeather"};const t={UNDO_STEPS:20},a={DISABLED:"disabled",WEATHER_TEMPLATE:"weatherTemplate",WEATHER_GENERATE:"weatherAuto",REGION_TEMPLATE:"regionTemplate",REGION_GENERATE:"regionAuto"},i={REG_FX_FILTERS:e.LCCNAME+"RegisterFilters",REG_FX_GENERATORS:e.LCCNAME+"RegisterGenerators",SETTINGS_UPDATED:e.LCCNAME+"SettingsUpdated",REG_TEMPLATE_REGION:e.LCCNAME+"RegisterRegionTemplate",REG_TEMPLATE_WEATHER:e.LCCNAME+"RegisterWeatherTemplate",REG_WEATHER_PERCIEVERS:e.LCCNAME+"RegisterWeatherPercievers",REG_WEATHER_SFX:e.LCCNAME+"RegisterWeatherSfx",MODULE_INITIALIZED:e.LCCNAME+"Initialized",MODULE_READY:e.LCCNAME+"Ready",WEATHER_UPDATED:e.LCCNAME+"WeatherUpdated",WEATHER_DISABLED:e.LCCNAME+"WeatherDisabled",DRAW_WEATHER_NODE:e.LCCNAME+"DrawWeatherNode",CONTROL_WEATHER_NODE:e.LCCNAME+"ControlWeatherNode",CREATE_WEATHER_NODES:e.LCCNAME+"CreateWeatherNodes",UPDATE_WEATHER_NODES:e.LCCNAME+"UpdateWeatherNodes",DELETE_WEATHER_NODES:e.LCCNAME+"DeleteWeatherNodes",PASTE_WEATHER_NODES:e.LCCNAME+"PasteWeatherNode"},r={NONE:0,POTENTIAL:1,CONFIRMED:2,COMPLETED:3},n={SOLID:0,PERMEABLE:1},o={MASK:0,EMITTER:1},s={fixed:0,procedural:1},d={outside:0,lightroof:1,roof:2,inside:3,underground:4},c=[7858152,8501516,13271551,16777147,16720537],l={WINDDIR:"winddir",TOPDOWN:"topdown",SLANTED:"slanted",WINDINFLUENCED:"windinfluence"},h={INTERNAL:"internal",EXTERNAL:"external",SIMPLE_CALENDAR:"simple-calendar"},g={isaMSLtempC:16,isaSeaLevelPa:101325,adiabaticHyDryCoeff:-.0065,g:9.80665,mAir:.0289644,R:8.3144598,Tzero:237.7},u={winter:.1667,latewinter:.3333,earlyspring:.5,spring:.6667,latespring:.8333,earlysummer:1,summer:1.1667,latesummer:1.3333,earlyfall:1.5,fall:1.6667,latefall:1.8333,earlywinter:2},m={none:0,drizzle:1,rain:2,downpour:3,hail:4,snow:5,blizzard:6},p={none:0,fog:1,stratus:2,cumulus:3,cumulunimbus:4},f={dry:20,comfortable:40,pleasant:50,sticky:65,humid:75,oppressive:Number.POSITIVE_INFINITY},y={gloomy:.1,shaded:.3,normal:.7,bright:Number.POSITIVE_INFINITY},v={nothing:.2,slight:.4,average:.7,heavy:.95,extreme:Number.POSITIVE_INFINITY},w={calm:1,light:5,lightBreeze:11,gentleBreeze:28,freshBreeze:38,strongBreeze:49,moderateGale:61,freshGale:74,strongGale:88,wholeGale:102,storm:118,hurricane:Number.POSITIVE_INFINITY},_={low:600,mid:1e3,high:4e3,veryhigh:Number.POSITIVE_INFINITY},b={freezing:-7,cold:-3,chill:3,fresh:7,moderate:18,mild:22,warm:30,hot:37,searing:Number.POSITIVE_INFINITY},T={get worldId(){return game.world.id},get systemID(){return game.system.id},get gameVersion(){return game.version},isNewerVersion:(e,t)=>isNewerVersion(e,t),get systemVersion(){return game.system.version||game.system.data.version},isGm(e=null){const t=e?T.getUser(e):game.user;return!!t&&t.isGM},userName(){const e=game.user;return e&&e.name?e.name:""},userID(){const e=game.user;return e&&e.id?e.id:""},getUser(e){const t=game.users;if(t)return t.find((t=>t.id===e))},getControlledTokens:()=>game.canvas.tokens.controlled,getControlledToken:()=>game.canvas.tokens.controlled[0],getUserByToken(e){let t,a=e.actor.ownership;for(const e of game.users)null!==e.character&&e.active&&a[e._id]>0&&(t=e);return t},getModuleVersion(){const t=game.modules.get(e.ID);return t?t.version:""},getLastTickTime:()=>canvas.app.ticker.lastTime,getWorldTime:()=>game.time.worldTime,advanceWorldTime:async(e=0)=>game.time.advance(e),isModuleEnabled(e){const t=game.modules.get(e);return t&&t.active},getSetting(t,a=null){let i=a??null;try{i=game.settings.get(e.ID,t)}catch{console.log(e.NAME+` Debug | GameConfig '${t}' not found`)}return i},async setSetting(t,a){game.settings.settings.get(`${e.ID}.${t}`)?(await game.settings.set(e.ID,t,a),Logger.debug(`GameConfig '${t}' set to '${a}'`)):Logger.debug(`GameConfig '${t}' not found`)},getItem:(e,t)=>e.items.get(t),getToken:e=>canvas.tokens.placeables.find((t=>t.id===e)),getControlledTokens:()=>game.canvas.tokens.controlled,getControlledToken:()=>game.canvas.tokens.controlled[0],getActor(e,t){let a=null;return t&&(a=canvas.tokens.placeables.find((e=>e.id===t))),a?a.actor:game.actors.get(e)},getUserByTokenId(e){let t,a=e.actor.ownership;for(const e of game.users)null!==e.character&&e.active&&a[e._id]>0&&(t=e);return t},getScene:e=>e?game.scenes.get(e):canvas.scene,getSceneFlag(t,a=null,i){let r=a??null;try{r=T.getScene(i).getFlag(e.ID,t)??a}catch{Logger.debug(`SceneFlag '${t}' not found on scene`)}return r},setSceneFlag:async(t,a,i)=>T.getScene(i).setFlag(e.ID,t,a),unsetSceneFlag:async(t,a)=>T.getScene(a).unsetFlag(e.ID,t),getUserFlag(t,a){let i=a??void 0;try{return game.user.getFlag(e.ID,t)}catch{console.log(e.NAME+` Debug | UserFlag '${t}' not found`)}return i},async setUserFlag(t,a){await game.user.setFlag(e.ID,t,a)},async unsetUserFlag(t){await game.user.unsetFlag(e.ID,t)},i18nf:(e,t={})=>game.i18n.format(e,t),i18n(e,t=null){let a=game.i18n.localize(e);return a==e?(null==t&&(a=e),a):a},getModule:(t=e.ID)=>game.modules.get(t),isModuleActive(e){const t=game.modules.get(e);return t&&t.active},isEmpty:e=>foundry.utils.isEmpty(e)};class Logger{static info(t,a=!1){a?ui.notifications.info(t):console.log("%c"+e.NAME+" | "+t,"color: cornflowerblue;")}static warn(t,a=!1,i=!1){a?ui.notifications.warn(t,{permanent:i}):console.error("%c"+e.NAME+" | "+t,"color: gold; background-color: darkgoldenrod;")}static error(t,a=!1,i=!1){a?ui.notifications.error(t,{permanent:i}):console.error("%c"+e.NAME+" | "+t,"color: orangered; background-color: darkred;")}static _dereferencer={info:{debug:()=>{},trace:()=>{}},debug:{debug:Logger._debug,trace:()=>{}},trace:{debug:Logger._debug,trace:Logger._trace}};static debug(e,t){Logger._dereferencer[T.getSetting("loglevel","info")].debug(e,t)}static trace(e,t){Logger._dereferencer[T.getSetting("loglevel","info")].trace(e,t)}static _debug(t,a){if(a){const i=S.deepClone(a);console.log("%c"+e.NAME+" | "+t,"color: darkgrey;",i)}else console.log("%c"+e.NAME+" | "+t,"color: darkgrey;")}static _trace(t,a){if(a){const i=S.deepClone(a);console.log("%c"+e.NAME+" | "+t,"color: lime; background-color: darkgreen;",i)}else console.log("%c"+e.NAME+" | "+t,"color: lime; background-color: darkgreen;")}}const S={getNestedLeaf(e,t){const a=t.split(".");let i=e;for(let e of a){if(!i.hasOwnProperty(e))return;i=i[e]}return i},createInteractionManager(e,t={},a={},i=null){const r={target:i};return a=S.mergeObject(Object.fromEntries(Object.keys(t).filter((e=>"function"==typeof t[e])).map((e=>[e,!0]))),a),new MouseInteractionManager(e,canvas.stage,a,t,r)},throttleInteractivity(e){const t=Math.ceil(1e3/(canvas.app.ticker.maxFPS||60)),a=e._drawTime||0;return Date.now()-a<t||(e._drawTime=Date.now(),!1)},getSeedFromString(e){let t=0;if(0===e.length)return t;for(let a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t=Math.trunc(t)}return Math.abs(t)},objectsEqual:(e,t)=>void 0!==e&&void 0!==t&&(null==e||null==t||"Object"!==getType(e)||"Object"!==getType(t)?e===t:Object.keys(e).length===Object.keys(t).length&&Object.entries(e).every((([e,a])=>{const i=t[e],r=getType(a);return r===getType(i)&&(a?.equals instanceof Function?a.equals(i):"Object"===r?S.objectsEqual(a,i):a===i)}))),mergeObject(e,t={},{insertKeys:a=!0,insertValues:i=!0,overwrite:r=!0,recursive:n=!0,inplace:o=!0,enforceTypes:s=!1,performDeletions:d=!1,expand:c=!0}={},l=0){if(t=t||{},!(e instanceof Object&&t instanceof Object))throw new Error("One of original or other are not Objects!");const h={insertKeys:a,insertValues:i,overwrite:r,recursive:n,inplace:o,enforceTypes:s,performDeletions:d,expand:c};if(0===l)if(c&&Object.keys(t).some((e=>/\./.test(e)))&&(t=expandObject(t)),Object.keys(e).some((e=>/\./.test(e)))){const t=c?expandObject(e):e;if(o&&c){for(const t of Object.keys(e))delete e[t];Object.assign(e,t)}else e=t}else o||(e=S.deepClone(e));for(let a of Object.keys(t)){const i=t[a];e.hasOwnProperty(a)?S._mergeUpdate(e,a,i,h,l+1):S._mergeInsert(e,a,i,h,l+1)}return e},_mergeInsert(e,t,a,{insertKeys:i,insertValues:r,performDeletions:n,expand:o}={},s){if(t.startsWith("-=")&&n)return void delete e[t.slice(2)];(s<=1&&i||s>1&&r)&&(e[t]=a?.constructor!==Object?a:S.mergeObject({},a,{insertKeys:!0,inplace:!0,performDeletions:n,expand:o}))},_mergeUpdate(e,t,a,{insertKeys:i,insertValues:r,enforceTypes:n,overwrite:o,recursive:s,performDeletions:d,expand:c}={},l){const h=e[t],g=getType(a),u=getType(h);if("Object"===g&&"Object"===u&&s)return S.mergeObject(h,a,{insertKeys:i,insertValues:r,overwrite:o,enforceTypes:n,performDeletions:d,expand:c,inplace:!0},l);if(o){if("undefined"!==u&&g!==u&&n)throw new Error("Mismatched data types encountered during object merge.");e[t]=a}},flattenObject:(e,t=0)=>flattenObject(e,t),copyToClipboard(e=""){let t=$("<input>");$("body").append(t),t.val(e).select(),document.execCommand("copy"),t.remove()},arrayNext(e=[],t=""){if(0===e.length)return t;const a=e.indexOf(t);return e[(a+1)%e.length]||e[0]},arrayPrev(e=[],t=""){if(0===e.length)return t;const a=e.indexOf(t);return e[(a+e.length-1)%e.length]||e[0]},clamp:(e,t,a)=>Math.min(Math.max(e,t),a),map(e,t,a,i,r){e=t<a?Math.max(Math.min(e,a),t):Math.max(Math.min(e,t),a);const[n,o]=[a-t,r-i];return o/n*(e-t)+i},mapColorHex(e,t,a,i,r){const{r:n,g:o,b:s}=foundry.utils.Color.from(i),{r:d,g:c,b:l}=foundry.utils.Color.from(r);return foundry.utils.Color.fromRGB([S.map(e,t,a,n,d),S.map(e,t,a,o,c),S.map(e,t,a,s,l)]).toString()},roundToDecimals:(e,t)=>Number(Math.round(e+"e"+t)+"e-"+t),omit(e,t){const{[t]:a,...i}=e;return i},isBitSet:(e,t)=>0!=(e&1<<t),deepClone:(e,t)=>deepClone(e,t)};class TimeProvider{static _instances={};static hasTimeAuthority(){return TimeProvider._getProviderInstance().hasTimeAuthority()}static getProviderIds(){return Object.keys(TimeProvider._instances)}static async advanceGameTime(e=0){return TimeProvider._getProviderInstance().advanceGameTime(e)}static getHoursInDay(){return TimeProvider._getProviderInstance().getHoursInDay()}static getDaysInYear(){return TimeProvider._getProviderInstance().getDaysInYear()}static getNumberOfMonths(){return TimeProvider._getProviderInstance().getNumberOfMonths()}static getMonthOffset(e){return TimeProvider._getProviderInstance().getMonthOffset(e)}static getSummerSolsticeDay(){return TimeProvider._getProviderInstance().getSummerSolsticeDay()}static getWinterSolsticeDay(){return TimeProvider._getProviderInstance().getWinterSolsticeDay()}static getSeasonCyclePct(){return TimeProvider._getProviderInstance().getSeasonCyclePct()}static getDaylightCyclePct(){return TimeProvider._getProviderInstance().getDaylightCyclePct()}static getDayOfYear(e=0,t=0){return TimeProvider._getProviderInstance().getDayOfYear(e,t)}static getHourOfDay(e=0,t=0){return TimeProvider._getProviderInstance().getHourOfDay(e,t)}static hourOfDayNoonPct(e=0,t=0){return TimeProvider._getProviderInstance().hourOfDayNoonPct(e,t)}static async setDaylightCyclePct(e){return TimeProvider._getProviderInstance().setDaylightCyclePct(e)}static dayOfYearSummerPct(e=0,t=0){return TimeProvider._getProviderInstance().dayOfYearSummerPct(e,t)}static async setSeasonCyclePct(e){return TimeProvider._getProviderInstance().setSeasonCyclePct(e)}static getI18nDateString(){const e=TimeProvider._getProviderInstance().getTimeStringData(),t=Handlebars.compile(T.i18n("time.formatted"))(e);return Logger.trace("TimeProvider.getI18nDateString",{"TimeProvider._getProviderId()":TimeProvider._getProviderId(),timeInfo:e,timeText:t}),t}static getCurrentTimeHash(e=0,t=0){return TimeProvider.getTimeHash(TimeProvider.getDayOfYear()+e,TimeProvider.getHourOfDay()+t)}static getTimeHash(e,t){return e*TimeProvider.getHoursInDay()+t}static getDayOfYearFromTimeHash(e){return Math.trunc(e/TimeProvider.getHoursInDay())+1}static getMonthOfYearFromTimeHash(e){let t=TimeProvider.getDayOfYearFromTimeHash(e);for(let e=0;e<TimeProvider.getNumberOfMonths();e++)if(t<TimeProvider.getMonthOffset(e))return e;return TimeProvider.getNumberOfMonths()}static getDayOfMonthFromTimeHash(e){let t=TimeProvider.getMonthOfYearFromTimeHash(e);return TimeProvider.getDayOfYearFromTimeHash(e)-TimeProvider.getMonthOffset(t-1)}static getTimeOfDayFromTimeHash(e){return e%TimeProvider.getHoursInDay()}static _getProviderId(){let e=T.getSceneFlag("timeProvider",h.INTERNAL);return e!=h.SIMPLE_CALENDAR||T.isModuleEnabled("foundryvtt-simple-calendar")||(Logger.info("Module [simple-calendar] is not installed or disabled. Reverting time provider to internal for this scene.",!0),T.setSceneFlag("timeProvider",h.INTERNAL),e=h.INTERNAL),e}static _getProviderInstance(){return TimeProvider._instances[TimeProvider._getProviderId()]}}class Noise{static F2=.5*(Math.sqrt(3)-1);static G2=(3-Math.sqrt(3))/6;static F3=1/3;static G3=1/6;static F4=(Math.sqrt(5)-1)/4;static G4=(5-Math.sqrt(5))/20;static fastFloor(e){return 0|Math.floor(e)}static getMulberry32(e){return function(){var t=e+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296}}static grad2=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);static getNoisedValue(e,t,a,i,r){return i+(r*((1*e(1*(t/=a),1*t)+.5*e(2*t,2*t)+.25*e(4*t,4*t))/1.75)*2-r)}static createNoise2D(e){const t=Noise._buildPermutationTable(e),a=new Float64Array(t).map((e=>Noise.grad2[e%12*2])),i=new Float64Array(t).map((e=>Noise.grad2[e%12*2+1]));return function(e,r){let n=0,o=0,s=0;const d=(e+r)*Noise.F2,c=Noise.fastFloor(e+d),l=Noise.fastFloor(r+d),h=(c+l)*Noise.G2,g=e-(c-h),u=r-(l-h);let m,p;g>u?(m=1,p=0):(m=0,p=1);const f=g-m+Noise.G2,y=u-p+Noise.G2,v=g-1+2*Noise.G2,w=u-1+2*Noise.G2,_=255&c,b=255&l;let T=.5-g*g-u*u;if(T>=0){const e=_+t[b];T*=T,n=T*T*(a[e]*g+i[e]*u)}let S=.5-f*f-y*y;if(S>=0){const e=_+m+t[b+p];S*=S,o=S*S*(a[e]*f+i[e]*y)}let E=.5-v*v-w*w;if(E>=0){const e=_+1+t[b+1];E*=E,s=E*E*(a[e]*v+i[e]*w)}return 70*(n+o+s)}}static _buildPermutationTable(e){const t=Noise.getMulberry32(e),a=512,i=new Uint8Array(a);for(let e=0;e<256;e++)i[e]=e;for(let e=0;e<255;e++){const a=e+~~(t()*(256-e)),r=i[e];i[e]=i[a],i[a]=r}for(let e=256;e<a;e++)i[e]=i[e-256];return i}}class RegionMeteo{_id=0;regionData=void 0;_noise=void 0;_cache={};constructor(e){if(this._id=randomID(),void 0!==e){if(this.regionData=S.deepClone(SceneWeatherState._regionTemplates[e]),void 0===this.regionData){this.regionData=S.deepClone(Object.values(SceneWeatherState._regionTemplates)[0]),T.setSceneFlag("regionTemplate",this.regionData.id);const[t,a]=e.split(".");Logger.error("Unable to set region template with id ["+t+"], registered by module ["+a+"]. Reverting to ["+T.i18n(this.regionData.name)+"]. Maybe you removed a SceneWeather plugin after configuring your scene.",!0,!0)}}else this.regionData=S.deepClone(T.getSceneFlag("regionSettings",S.deepClone(T.getSetting("defaultRegionSettings"))));const t=T.getSceneFlag("seed",""),a=S.getSeedFromString(t);this._noise=Noise.createNoise2D(a),Logger.trace("RegionMeteo:ctor(...)",{templateId:e,id:this._id,noise:this._noise,regionData:this.regionData}),this.updateConfig()}static getTemplates(){return Object.entries(SceneWeatherState._regionTemplates).map((e=>({id:e[0],name:e[1].name})))}static fromTemplate(e){return new RegionMeteo(e)}updateConfig(){return Logger.debug("RegionMeteo.updateConfig()"),this._cache={},!0}getRegionBase(e=0,t=0){const a=TimeProvider.getCurrentTimeHash(e,t);if(void 0!==this._cache[a])return this._cache[a];let i={elevation:this.regionData.elevation,vegetation:this.regionData.vegetation,waterAmount:this.regionData.waterAmount,timeHash:a};void 0===this.regionData.name?i.name="custom":i.name=this.regionData.name;const r=TimeProvider.getHourOfDay(e,t),n=TimeProvider.hourOfDayNoonPct(e,t),o=TimeProvider.dayOfYearSummerPct(e,t);let s=(this.regionData.summer.temperature.day-this.regionData.winter.temperature.day)*o+this.regionData.winter.temperature.day,d=(this.regionData.summer.temperature.night-this.regionData.winter.temperature.night)*o+this.regionData.winter.temperature.night,c=(this.regionData.summer.temperature.var-this.regionData.winter.temperature.var)*o+this.regionData.winter.temperature.var;i.baseTemp=Noise.getNoisedValue(this._noise,a+1282,64,(s-d)*n+d,c),i.baseTemp<0&&(i.waterAmount=0);let l=(this.regionData.summer.humidity.day-this.regionData.winter.humidity.day)*o+this.regionData.winter.humidity.day,h=(this.regionData.summer.humidity.night-this.regionData.winter.humidity.night)*o+this.regionData.winter.humidity.night,g=(this.regionData.summer.humidity.var-this.regionData.winter.humidity.var)*o+this.regionData.winter.humidity.var;i.baseHumidity=S.clamp(Noise.getNoisedValue(this._noise,a+732,64,(l-h)*n+h,g),0,100);let u=((this.regionData.summer.sun.hours-this.regionData.winter.sun.hours)*o+this.regionData.winter.sun.hours)/2,m=Math.abs(12-r);i.sunAmount=m>u?0:S.clamp(u/3*(1-1/(u/m)),0,1);let p=(this.regionData.summer.wind.avg-this.regionData.winter.wind.avg)*o+this.regionData.winter.wind.avg,f=(this.regionData.summer.wind.var-this.regionData.winter.wind.var)*o+this.regionData.winter.wind.var,y=1;return y=i.sunAmount<.1?.9:i.sunAmount<.2?r>12?.8:1.2:1.1,i.wind=S.clamp(Noise.getNoisedValue(this._noise,a+978,16,y*p,f),0,80),i.gusts=S.clamp(i.wind+Noise.getNoisedValue(this._noise,a+12,8,y*f,f),0,80),this._cache[a]=i,Logger.debug("RegionMeteo.getRegionBase(...)",{dayDelta:e,hourDelta:t,timeHash:a,baseValues:i}),i}}class SceneWeather$1{sceneId=void 0;weatherModel=void 0;weatherMode=a.DISABLED;constructor(e){this.sceneId=e._id,this.weatherModel=this._getWeatherModelForMode(e),Logger.debug("SceneWeather:ctor",{weatherModel:this.weatherModel,sceneId:this.sceneId})}_getWeatherModelForMode(t){switch(this.weatherMode=t.getFlag(e.ID,"weatherMode")||a.DISABLED,Logger.debug("SceneWeather._getWeatherModelForMode(...)",{scene:t,weatherMode:this.weatherMode,this:this}),this.weatherMode){case a.WEATHER_TEMPLATE:const i=t.getFlag(e.ID,"weatherTemplate");return WeatherModel.fromTemplate(i);case a.WEATHER_GENERATE:return WeatherModel.fromSceneConfig(t._id);case a.REGION_TEMPLATE:const r=t.getFlag(e.ID,"regionTemplate");return WeatherModel.fromRegion(RegionMeteo.fromTemplate(r));case a.REGION_GENERATE:return WeatherModel.fromRegion(new RegionMeteo);case a.DISABLED:default:return}}updateConfig(){if(Logger.debug("SceneWeather.updateConfig()",{sceneId:this.sceneId,this:this}),void 0===this.weatherModel)return!1;const e=T.getScene(this.sceneId);if(void 0===e)throw Logger.error("Unable to instantiate SceneWeather for non existing Scene with id "+this.sceneId),new Error("Unable to instantiate SceneWeather for non existing Scene with id "+this.sceneId);return T.getSceneFlag("weatherMode",null,this.sceneId)!=this.weatherMode?(Logger.debug("SceneWeather.updateConfig() -> newMode",{sceneId:this.sceneId,prevMode:this.weatherMode,newMode:T.getSceneFlag("weatherMode","-",this.sceneId)}),this.weatherModel=this._getWeatherModelForMode(e),!0):(Logger.debug("SceneWeather.updateConfig() -> unchangedMode",{sceneId:this.sceneId}),this.weatherModel.updateConfig())}static fromConfig({sceneId:e=null}={}){null==e&&(e=canvas.scene._id);const t=T.getScene(e);if(void 0!==t)return new SceneWeather$1(t);Logger.error("Unable to instantiate SceneWeather for non existing Scene with id "+e)}static _weatherModelToExternal(e,t,i=a.WEATHER_TEMPLATE){const[r]=Object.entries(m).find((([,t])=>t===e.precipitation.type)),[n]=Object.entries(p).find((([,t])=>t===e.clouds.type)),[o]=Object.entries(s).find((([,t])=>t===(i==a.WEATHER_GENERATE?e.wind.directionType:0))),d=i==a.WEATHER_GENERATE?1:100,c={temp:{ground:Math.round(e.temp.ground),air:Math.round(e.temp.air)},humidity:Math.round(e.humidity),wind:{speed:Math.round(e.wind.speed),gusts:Math.round(e.wind.gusts),directionType:o||"fixed",direction:Math.round(e.wind.direction)},clouds:{type:n||"cumulunimbus",coverage:Math.round(e.clouds.coverage*d),bottom:S.clamp(Math.round(e.clouds.bottom),0,2e4),thickness:i==a.WEATHER_GENERATE?Math.round(e.clouds.thickness):S.clamp(Math.round(e.clouds.top)-Math.round(e.clouds.bottom),0,2e4)},precipitation:{type:r||"none",amount:Math.round(e.precipitation.amount*d),mode:t},sun:{amount:Math.round(e.sun.amount*d)}};return Logger.trace("SceneWeather._weatherModelToExternal(...)",{model:e,template:c}),c}getWeatherModel(e=0,t=0){if(void 0!==this.weatherModel)return this.weatherModel.getWeatherData(e,t)}getWeatherSettings(){if(void 0===this.weatherModel)return;let e={generator:{seed:T.getSceneFlag("seed","",this.sceneId),mode:T.getSceneFlag("weatherMode",a.DISABLED,this.sceneId)}};switch(e.generator.mode){case a.WEATHER_TEMPLATE:const t=SceneWeatherState._weatherTemplates[T.getSceneFlag("weatherTemplate","",this.sceneId)];void 0!==t&&(e.weather=SceneWeather$1._weatherModelToExternal(t,T.getSceneFlag("rainMode",l.WINDDIR,this.sceneId),e.generator.mode),e.weather.templateId=t.id,e.weather.templateName=T.i18n(t.name));break;case a.WEATHER_GENERATE:const i=S.deepClone(T.getSceneFlag("weatherSettings",{},this.sceneId));e.weather=SceneWeather$1._weatherModelToExternal(i,T.getSceneFlag("rainMode",l.WINDDIR,this.sceneId),e.generator.mode);break;case a.REGION_TEMPLATE:e.region=S.deepClone(SceneWeatherState._regionTemplates[T.getSceneFlag("regionTemplate","",this.sceneId)]||{}),e.region.templateId=e.region.id,e.region.templateName=T.i18n(e.region.name),delete e.region.id,delete e.region.name,delete e.region.description,e.weather=SceneWeather$1._weatherModelToExternal(this.getWeatherModel(),T.getSceneFlag("rainMode",l.WINDDIR,this.sceneId),e.generator.mode);break;case a.REGION_GENERATE:e.region=S.deepClone(T.getSceneFlag("regionSettings",S.deepClone(T.getSetting("defaultRegionSettings")),this.sceneId)),e.weather=SceneWeather$1._weatherModelToExternal(this.getWeatherModel(),T.getSceneFlag("rainMode",l.WINDDIR,this.sceneId),e.generator.mode)}return Logger.trace("SceneWeather.getWeatherSettings()",{settings:e}),e}async calculateWeather({force:e=!1}={}){if(void 0===this.weatherModel)return;const t=TimeProvider.getCurrentTimeHash(),a=this.weatherModel.getWeatherData();Logger.debug("SceneWeather.calculateWeather() -> WeatherUpdated",{model:a,timeHash:t,sceneId:this.sceneId,force:e}),Hooks.callAll(i.WEATHER_UPDATED,{model:a,timeHash:t,sceneId:this.sceneId,force:e})}}class SceneWeatherState{static _lastUpdate=0;static _sceneWeather={};static _regionTemplates={};static _weatherTemplates={};static _generators=[];static _filters=[];static getSceneWeatherProvider(e,t=!1){if(!canvas||!canvas.ready)return;let a=canvas.scene._id;return void 0!==e&&(a=e),t&&(SceneWeatherState._sceneWeather[a]=void 0),void 0!==SceneWeatherState._sceneWeather[a]||(SceneWeatherState._sceneWeather[a]=SceneWeather$1.fromConfig({sceneId:a}),Logger.trace("SceneWeatherState.getSceneWeatherProvider(...) cacheMiss",{forSceneId:e,sceneId:a,ignoreCache:t,provider:SceneWeatherState._sceneWeather[a]})),SceneWeatherState._sceneWeather[a]}}class WeatherModel{useConfigSceneId=void 0;regionMeteo=void 0;weatherData=void 0;_cache={};static DEFAULT_MODEL_STRUCT={source:"_DISABLED_",name:"disabled",temp:{underground:14.5,ground:0,air:0,percieved:0},wind:{speed:0,gusts:0,direction:0},clouds:{coverage:0,bottom:0,top:0,type:0},precipitation:{amount:0,type:0},sun:{amount:0},humidity:0};constructor({regionMeteo:t,templateId:a,useWeatherConfig:i}){if(Logger.debug("WeatherModel:constrctor",{regionMeteo:t,templateId:a,useWeatherConfig:i}),this._cache={},void 0!==t)this.regionMeteo=t,this.useConfigSceneId=void 0,this.updateConfig();else if(void 0!==i)this.regionMeteo=void 0,this.useConfigSceneId=i,this.updateConfig();else{if(this.regionMeteo=void 0,this.useConfigSceneId=void 0,this.weatherData=S.deepClone(SceneWeatherState._weatherTemplates[a]),void 0===this.weatherData){this.weatherData=S.deepClone(Object.values(SceneWeatherState._weatherTemplates)[0]),canvas.scene.setFlag(e.ID,"weatherTemplate",this.weatherData.id);const[t,i]=a.split(".");Logger.error("Unable to set weather template with id ["+t+"], registered by module ["+i+"]. Reverting to ["+T.i18n(this.weatherData.name)+"]. Maybe you removed a SceneWeather plugin after configuring your scene.",!0)}this.weatherData.precipitation.mode=T.getSceneFlag("rainMode","winddir"),this.weatherData.source="_TEMPLATE_"}}static getTemplates(){return Logger.debug("getTemplates",{t:Object.entries(SceneWeatherState._weatherTemplates)}),Object.entries(SceneWeatherState._weatherTemplates).map((e=>({id:e[0],name:e[1].name})))}static fromSceneConfig(e){return new WeatherModel({useWeatherConfig:e})}static fromTemplate(e){return new WeatherModel({templateId:e})}static fromRegion(e){return new WeatherModel({regionMeteo:e})}updateConfig(){if(void 0!==this.regionMeteo)return Logger.debug("WeatherModel.updateConfig() -> invalidating cache, invoking on regionMeteo..."),this._cache={},this.regionMeteo.updateConfig();if(void 0!==this.useConfigSceneId){Logger.debug("WeatherModel.updateConfig() -> getting weatherConfig from Scene.",{configSceneId:this.useConfigSceneId});let e=this.useConfigSceneId,t=T.getSceneFlag("weatherSettings",void 0,this.useConfigSceneId);Logger.debug("WeatherModel.updateConfig() -> load from scene flags",{weatherConfig:t,sceneId:this.useConfigSceneId}),t||(t=T.getSetting("defaultWeatherSettings"),e="_GLOBAL_",Logger.debug("WeatherModel.updateConfig() -> no weather on flags, using global",{weatherConfig:t}));const a=T.getSceneFlag("seed",""),i=S.getSeedFromString(a);Logger.debug("WeatherModel:updateConfig(seed)",{seedString:a,seedValue:i}),this._noise=Noise.createNoise2D(i);const r=t.wind.speed+t.wind.gusts,n=Math.trunc(1==t.wind.directionType?WeatherModel._getNoisedWindDirection(this._noise,TimeProvider.getCurrentTimeHash(),r):t.wind.direction);let o=S.mergeObject(S.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),{source:e,name:"custom",temp:{ground:t.temp.ground,air:t.temp.air,percieved:Math.trunc(WeatherModel._apparentTemperature(t.temp.air,t.wind.speed,t.humidity,g.isaSeaLevelPa/100))},wind:{speed:t.wind.speed,gusts:r,direction:n,directionType:t.wind.directionType},clouds:{coverage:t.clouds.coverage/100,bottom:t.clouds.bottom,top:t.clouds.bottom+t.clouds.thickness,type:t.clouds.type},precipitation:{amount:t.precipitation.amount/100,type:t.precipitation.type,mode:T.getSceneFlag("rainMode","winddir",this.useConfigSceneId)||0},sun:{amount:t.sun.amount/100},humidity:t.humidity});return Logger.debug("WeatherModel.merged",{newWeatherData:o,weatherData:this.weatherData}),S.objectsEqual(this.weatherData,o)?(Logger.debug("WeatherModel.updateConfig() -> static from sceneConfig, no changes."),!1):(this.weatherData=o,Logger.debug("WeatherModel.updateConfig() -> static from sceneConfig",{sceneId:this.useConfigSceneId,weatherData:this.weatherData}),!0)}return this.weatherData.precipitation.mode==T.getSceneFlag("rainMode","winddir")?(Logger.debug("WeatherModel.updateConfig() -> static, nothing to do."),!1):(this.weatherData.precipitation.mode=T.getSceneFlag("rainMode","winddir"),!0)}getWeatherData(e=0,t=0){if(void 0!==this.regionMeteo){const a=this.regionMeteo.getRegionBase(e,t);if(void 0!==this._cache[a.timeHash])return this.weatherData=this._cache[a.timeHash],Logger.trace("WeatherModel.getWeatherData(GENERATOR_MODES.REGION_*) cacheHit",{dayOffset:e,hourOffset:t,regionBaseValues:a,weatherData:this.weatherData}),this._cache[a.timeHash];this.weatherData=S.mergeObject(S.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),{source:"_REGION_",name:a.name,temp:{ground:this._groundTemp(3,3,e,t),air:a.baseTemp,percieved:0},wind:{speed:a.wind,gusts:a.gusts+a.wind,direction:0},clouds:{coverage:0,bottom:S.clamp(Math.abs(WeatherModel._liftedCondensationLevel(a.baseTemp,a.baseHumidity)),0,2e4),top:0,type:0},precipitation:{amount:0,type:0,mode:T.getSceneFlag("rainMode","winddir")},sun:{amount:a.sunAmount},humidity:a.baseHumidity});let i=WeatherModel._calcAdiCloudBottomCoeff(this.weatherData,a),r=WeatherModel._calcGeopotential(a);return this.weatherData.clouds.top=i<0?this.weatherData.clouds.bottom+12.6*r:this.weatherData.clouds.bottom+.27*r,this.weatherData.clouds.coverage=S.clamp((this.weatherData.clouds.top-this.weatherData.clouds.bottom)/100,0,1),this.weatherData.clouds.bottom<a.elevation?this.weatherData.clouds.type=1:(i<0&&(this.weatherData.clouds.top-this.weatherData.clouds.bottom>1e3&&(this.weatherData.clouds.type=3),this.weatherData.clouds.top-this.weatherData.clouds.bottom>3e3&&(this.weatherData.clouds.type=4)),this.weatherData.clouds.type<3&&this.weatherData.clouds.coverage>.3&&(this.weatherData.clouds.type=2)),this.weatherData.precipitation.amount=S.clamp(1.2*this.weatherData.clouds.coverage-.4,0,1)*Noise.getNoisedValue(this.regionMeteo._noise,a.timeHash+321,8,.8,.2)*Noise.getNoisedValue(this.regionMeteo._noise,a.timeHash+321,32,1,.5),this.weatherData.wind.gusts=this.weatherData.wind.gusts*(2.5*this.weatherData.precipitation.amount+.5),this.weatherData.wind.speed=this.weatherData.wind.speed+2.2*this.weatherData.precipitation.amount*this.weatherData.wind.speed,this.weatherData.sun.amount=this.weatherData.sun.amount*S.clamp(1-this.weatherData.clouds.coverage,.2,1),this.weatherData.temp.air=this.weatherData.temp.air-.03*this.weatherData.wind.speed+this.weatherData.sun.amount*Math.max(2,.6*this.weatherData.temp.ground),this.weatherData.temp.percieved=WeatherModel._apparentTemperature(this.weatherData.temp.air,this.weatherData.wind.speed,this.weatherData.humidity,WeatherModel._heightToPressure(a.elevation)),this.weatherData.clouds.top=3*Math.max(0,this.weatherData.clouds.top-a.elevation),this.weatherData.clouds.bottom=3*Math.max(0,this.weatherData.clouds.bottom-a.elevation),this.weatherData.precipitation.type=WeatherModel._calcPrecipitationType(this.weatherData),this.weatherData.wind.direction=WeatherModel._getNoisedWindDirection(this.regionMeteo._noise,a.timeHash,this.weatherData.wind.gusts),this._cache[a.timeHash]=this.weatherData,Logger.trace("WeatherModel.getWeatherData(GENERATOR_MODES.REGION_*) cacheMiss",{dayOffset:e,hourOffset:t,regionBaseValues:a,weatherData:this.weatherData}),this.weatherData}return void 0!==this.useConfigSceneId?(1==this.weatherData.wind.directionType&&(this.weatherData.wind.direction=WeatherModel._getNoisedWindDirection(this._noise,TimeProvider.getCurrentTimeHash(e,t),this.weatherData.wind.gusts)),Logger.trace("WeatherModel.getWeatherData(GENERATOR_MODES.WEATHER_GENERATE)",{dayOffset:e,hourOffset:t,weatherData:this.weatherData}),this.weatherData):(Logger.trace("WeatherModel.getWeatherData(GENERATOR_MODES.WEATHER_TEMPLATE)",{dayOffset:e,hourOffset:t,weatherData:this.weatherData}),this.weatherData)}static _getNoisedWindDirection(e,t,a){let i=Noise.getNoisedValue(e,t+1277,512,180,180)+Noise.getNoisedValue(e,t+1277,8,16,16)*(.2*a);return i<0&&(i+=360),i>=360&&(i-=360),i}static _calcGeopotential(e){return e.vegetation*(1.3*e.sunAmount+.7*e.wind)+(.3*e.sunAmount+e.waterAmount*(1.3*e.wind))}static _heightToPressure(e){if(e<11e3)return g.isaSeaLevelPa*Math.pow(g.isaMSLtempC/(g.isaMSLtempC+g.adiabaticHyDryCoeff*e),g.g*g.mAir/(g.R*g.adiabaticHyDryCoeff))/100;if(e<=2e4){var t=g.isaSeaLevelPa*Math.pow(g.isaMSLtempC/(e+11e3*g.adiabaticHyDryCoeff),g.g*g.mAir/(g.R*g.adiabaticHyDryCoeff)),a=g.isaMSLtempC+11e3*g.adiabaticHyDryCoeff;return t*Math.exp(-g.g*g.mAir*(e-11e3)/(g.R*a))/100}return 0}static _apparentTemperature(e,t,a,i){return e<10?WeatherModel._windChill(e,t):WeatherModel._heatIndex(e,a,i)}static _windChill(e,t){return e>=10?e:t>=4.8&&t<=177?13.12+.6215*e+(.3965*e-11.37)*Math.pow(t,.16):t<4.8?e+.2*(.1345*e-1.59)*t:e}static _heatIndex(e,t,a){if(a<16)return e;if(e<27||g.R<.4||WeatherModel._dewPoint(e,t)<12)return e;return 1.61139411*e-8.784695+2.338549*t+-.14611605*e*t+-.012308094*e*e+-.016424828*t*t+.002211732*e*e*t+72546e-8*e*t*t+1e-6*-3.582*e*e*t*t}static _dewPoint(e,t){if(e<0||e>60)return e;if((t/=100)<.01||t>1)return e;let a=17.27*e/(g.Tzero+e)+Math.log(t),i=g.Tzero*a/(17.27-a);return i<0||i>50?e:i}static _calcAdiCloudBottomCoeff(e,t){return g.isaMSLtempC+(e.clouds.bottom-t.elevation)*g.adiabaticHyDryCoeff-(t.baseTemp+(e.clouds.bottom-t.elevation)*g.adiabaticHyDryCoeff)}static _calcPrecipitationType(e){return e.precipitation.amount<.1?0:e.clouds.type>3&&e.precipitation.amount>.7?e.temp.air<4?6:e.wind.speed>.2?4:3:e.clouds.type>=3?e.temp.air<4?e.wind.speed>.2?6:5:2:2==e.clouds.type||e.precipitation.amount>.7?e.temp.air<4?5:1:0}_groundTemp(e,t,a=0,i=0){let r=0,n=0;for(let o=0;o<=e;o++){let e=1/Math.log2(o+2);r+=this.regionMeteo.getRegionBase(a,i-o*t).baseTemp*e,n+=e}return r/n}static _liftedCondensationLevel(e,t){return 125*(e-(e-(100-t)/5))}}class WeatherPerception{static _registeredPercievers={};static _singleton;static DEFAULT_WEATHER_STRUCT={name:"unknown",temperature:{air:0,ground:0,percieved:0},humidity:{percent:0},wind:{speed:0,gusts:0,direction:0},clouds:{height:0,amount:0,type:0},sun:{amount:0},precipitation:{amount:0,type:0}};static DEFAULT_INFO_STRUCT={id:e.ID+".default",name:"default"};static registeredPerciever(e=null,t=null,a=null){Logger.debug("WeatherPerception.registeredPerciever(...)",{moduleId:e,id:t,weatherPerception:a}),e&&t&&a&&a instanceof WeatherPerception&&T.isModuleEnabled(e)?WeatherPerception._registeredPercievers[e+"."+t]=a:Logger.error("Unable to register WeatherPerciever for moduleId:"+e+" with id:"+t,!0)}static async getAsText(t=e.ID+".default",a){const i=WeatherPerception._getPercieverById(t),r=i.getTextFromModel(S.mergeObject(S.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),a));return Logger.debug("WeatherPerception.getAsText(...)",{id:t,perciever:i,text:r}),r}static async getAsUiHtml(t=e.ID+".default",a){const i=WeatherPerception._getPercieverById(t),r=i.getUiHtmlFromModel(S.mergeObject(S.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),a));return Logger.debug("WeatherPerception.getAsUiHtml(...)",{id:t,perciever:i,uiHtml:r}),r}static async getAsChatHtml(t=e.ID+".default",a){const i=WeatherPerception._getPercieverById(t),r=i.getChatHtmlFromModel(S.mergeObject(S.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),a));return Logger.debug("WeatherPerception.getAsChatHtml(...)",{id:t,perciever:i,chatHtml:r}),r}static async getAsWeatherInfo(t=e.ID+".default",a){const i=WeatherPerception._getPercieverById(t),r=i.getWeatherInfoFromModel(S.mergeObject(S.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),a));return Logger.debug("WeatherPerception.getAsWeatherInfo(...)",{id:t,perciever:i,weatherInfo:r}),r}static getInfo(t=e.ID+".default"){const a=WeatherPerception._getPercieverById(t),i=a.getPercieverInfo();return Logger.debug("WeatherPerception.getInfo(...)",{id:t,perciever:a,percieverInfo:i}),i}static getAllowedIds(e){let t=[];for(const[a,i]of Object.entries(WeatherPerception._registeredPercievers))i.isAllowed(e)&&t.push(a);return Logger.debug("WeatherPerception.getAllowedIds(...)",{userId:e,allowedIds:t}),t}static _getSingleton(){return WeatherPerception._singleton||(WeatherPerception._singleton=new WeatherPerception),WeatherPerception._singleton}static _getPercieverById(e){return WeatherPerception._registeredPercievers[e]?WeatherPerception._registeredPercievers[e]:WeatherPerception._getSingleton()}getTextFromModel(e){return""}getUiHtmlFromModel(e){return""}getChatHtmlFromModel(e){return""}getWeatherInfoFromModel(e){return S.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT)}getPercieverInfo(){return S.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT)}}class MacroGenerator{static async buildHeader(t){return await renderTemplate("modules/"+e.ID+"/templates/macroHeader.hbs",{headline:t,currentDate:(new Date).toLocaleString(),moduleName:e.NAME,moduleId:e.ID,moduleVersion:e.VERSION})}static async buildUpdateConfig(t=!1,a=null){let i={data:{},hasSceneId:!1,hasForceParam:!1,hasParams:!1};null!=a&&(i.data.forSceneId=a,i.hasSceneId=!0,i.hasParams=!0),t&&(i.data.force="true",i.hasForceParam=!0,i.hasParams=!0);return await renderTemplate("modules/"+e.ID+"/templates/macroUpdateConfig.hbs",i)}static async buildSetSceneSeed(t=""){return await renderTemplate("modules/"+e.ID+"/templates/macroSeed.hbs",{seed:t})}static async buildSetSceneTime({dayCycle:t=-1,yearCycle:a=-1}={}){if(-1==t&&-1==a)return"";let i={};t>=0&&(i.daylightCycle=Number((100*t).toFixed(3))),a>=0&&(i.seasonCycle=Number((100*a).toFixed(3)));return await renderTemplate("modules/"+e.ID+"/templates/macroTime.hbs",{data:JSON.stringify(i,null,2)})}static async buildSetSceneWeatherTemplate(t="",a=""){const i=t.includes(".")?t.split(".")[0]:null;return await renderTemplate("modules/"+e.ID+"/templates/macroWeatherTemplate.hbs",{moduleCheck:!(null==i),moduleId:i||"",templateId:t,templateName:a})}static async buildSetSceneWeatherSettings(t){delete t.templateId,delete t.templateName;return await renderTemplate("modules/"+e.ID+"/templates/macroWeather.hbs",{data:JSON.stringify(t,null,2)})}static async buildSetSceneRegionTemplate(t="",a=""){const i=t.includes(".")?t.split(".")[0]:null;return await renderTemplate("modules/"+e.ID+"/templates/macroRegionTemplate.hbs",{moduleCheck:!(null==i),moduleId:i||"",templateId:t,templateName:a})}static async buildSetSceneRegionSettings(t){delete t.templateId,delete t.templateName;return await renderTemplate("modules/"+e.ID+"/templates/macroRegion.hbs",{data:JSON.stringify(t,null,2)})}}class MacroConfigDialog extends Application{static _app=null;static refresh(e=!1){Logger.trace("MacroConfigDialog.refresh()"),MacroConfigDialog._app&&MacroConfigDialog._app.render(e,{height:"auto"})}constructor(){super(),Logger.trace("MacroConfigDialog.ctor")}static get defaultOptions(){return S.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/macroConfig.hbs",id:"scene-weather-macro-config",title:"dialogs.macroConfig.title",closeOnSubmit:!1,submitOnChange:!1,submitOnClose:!1,resizable:!1})}activateListeners(t){super.activateListeners(t),t.find("button[type='generate']").on("click",(async function(){const a=$(this),i=t.find('input[name="macro.includeTimeOfDay"]').is(":checked")||!1,r=t.find('input[name="macro.includeDayOfYear"]').is(":checked")||!1,n=t.find('input[name="macro.includeSeed"]').is(":checked")||!1,o=a.attr("data-mode")||"";Logger.trace("MacroConfigDialog.click(generateFromWeatherTemplate)",{generatorMode:o,includeTimeOfDay:i,includeDayOfYear:r,includeSeed:n});let s={img:"modules/"+e.ID+"/assets/sw-macro-icon.svg",type:"script",scope:"global"};const d=SceneWeather.getWeatherSettings();if(void 0===d)return;let c="";switch(n&&(c+=await MacroGenerator.buildSetSceneSeed(d.generator.seed)),(i||r)&&(c+=await MacroGenerator.buildSetSceneTime({dayCycle:i?TimeProvider.getDaylightCyclePct():-1,yearCycle:r?TimeProvider.getSeasonCyclePct()/2:-1})),o){case"weatherTemplate":s.name=T.i18n("dialogs.macroConfig.weatherTemplate.title")+"("+(d.weather?.templateName??" - ")+")",s.command=await MacroGenerator.buildHeader(s.name),s.command+=c,s.command+=await MacroGenerator.buildSetSceneWeatherTemplate(d.weather.templateId,d.weather.templateName);break;case"weather":s.name=T.i18n("dialogs.macroConfig.weather.title")+canvas.scene.name+")",s.command=await MacroGenerator.buildHeader(s.name),s.command+=c,s.command+=await MacroGenerator.buildSetSceneWeatherSettings(d.weather);break;case"regionTemplate":s.name=T.i18n("dialogs.macroConfig.regionTemplate.title")+"("+(d.region?.templateName??" - ")+")",s.command=await MacroGenerator.buildHeader(s.name),s.command+=c,s.command+=await MacroGenerator.buildSetSceneRegionTemplate(d.region.templateId,d.region.templateName);break;case"region":s.name=T.i18n("dialogs.macroConfig.region.title")+canvas.scene.name+")",s.command=await MacroGenerator.buildHeader(s.name),s.command+=c,s.command+=await MacroGenerator.buildSetSceneRegionSettings(d.region)}s.command+=await MacroGenerator.buildUpdateConfig(!0);(await Macro.create(s)).sheet.render(!0)}))}async _onSubmit(e,t){return e.target.querySelectorAll("input[disabled]").forEach((e=>e.disabled=!1)),super._onSubmit(e,t)}async getData(){const e=TimeProvider.getSeasonCyclePct(),[t]=Object.entries(u).find((([,t])=>e<=t)),i=SceneWeather.getWeatherSettings();if(void 0===i)return Logger.warn(T.i18n("dialogs.macroConfig.disabledWarn"),!0),{enabled:!1};const r={enabled:!0,preCheckTime:[a.REGION_TEMPLATE,a.REGION_GENERATE].includes(i.generator.mode),preCheckDate:[a.REGION_TEMPLATE,a.REGION_GENERATE].includes(i.generator.mode),scene:{name:canvas.scene.name,id:canvas.scene._id,modeName:"configTab.weatherModes."+i.generator.mode+".name",modeHint:"configTab.weatherModes."+i.generator.mode+".hint",seed:i.generator.seed},time:{summaryString:TimeProvider.getI18nDateString(),beforeSummerSolstice:!!(e<=1),pctDistanceSummerSolstice:Math.round(100*(e>1?e-1:e)),seasonString:"time."+t,seasonPct:e>1?e-1:e},weather:{detailHtml:await WeatherPerception.getAsUiHtml("scene-weather.precise",SceneWeather.getWeatherModel()),hasTemplate:!(i.generator.mode!=a.WEATHER_TEMPLATE),templateName:i.weather?.templateName??""},region:{hasRegion:[a.REGION_TEMPLATE,a.REGION_GENERATE].includes(i.generator.mode),hasTemplate:!(i.generator.mode!=a.REGION_TEMPLATE),templateName:i.region?.templateName??""}};return Logger.trace("MacroConfigDialog.getData()",{data:r}),r}_updateObject(e,t){Logger.trace("MacroConfigDialog._updateObject(...)",{formData:t})}}class Permissions{static _permissions=void 0;static DEFAULT_PERMISSION_STRUCT={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:[]};static EMPTY_PERMISSIONS={"perciever.scene-weather.vague":S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),"perciever.scene-weather.icon":S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),"perciever.scene-weather.perceptive":S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),"perciever.scene-weather.precise":S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),sceneSettings:S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),weatherUiControls:S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),timeControls:S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),meteogramUi:S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT)};static DEFAULT_PERMISSIONS={"perciever.scene-weather.vague":{player:!0,trustedPlayer:!0,assistantGameMaster:!0},"perciever.scene-weather.icon":{trustedPlayer:!0,assistantGameMaster:!0},"perciever.scene-weather.perceptive":{assistantGameMaster:!0},sceneSettings:S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),weatherUiControls:{assistantGameMaster:!0},timeControls:{assistantGameMaster:!0},meteogramUi:{assistantGameMaster:!0}};static _getDefaultPermissions(){let e=S.deepClone(Permissions.DEFAULT_PERMISSIONS);return Object.keys(WeatherPerception._registeredPercievers).forEach((t=>{e["perciever."+t]=S.mergeObject(S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),e["perciever."+t]||{})})),Logger.debug("Permissions._getDefaultPermissions()",{defaultPermissions:e}),e}static _loadPermissions(){const e=Permissions._getDefaultPermissions(),t=T.getSetting("permissions",null);if(null==t)return Logger.debug("Permissions._loadPermissions -> no stored permissions",{default:e}),Permissions._permissions=e,Permissions._permissions;{const a=S.mergeObject(e,t,{insertKeys:!1,expand:!1});return Logger.debug("Permissions._loadPermissions -> loaded from settings",{default:e,effective:a,stored:t}),Permissions._permissions=a,Permissions._permissions}}static async resetPermissions(){let e=S.deepClone(Permissions.EMPTY_PERMISSIONS);Object.keys(WeatherPerception._registeredPercievers).forEach((t=>{"perciever."+t in e||(e["perciever."+t]=S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT))})),Permissions._permissions=S.mergeObject(e,Permissions.DEFAULT_PERMISSIONS,{expand:!1}),T.setSetting("permissions",Permissions._permissions),Logger.debug("Permissions.resetPermissions()",{permissions:Permissions._permissions})}static async updatePermissions(e){Object.keys(WeatherPerception._registeredPercievers).forEach((t=>{"perciever."+t in e||(e["perciever."+t]=S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT))})),Permissions._permissions=S.mergeObject(S.deepClone(Permissions.EMPTY_PERMISSIONS),e,{expand:!1}),T.setSetting("permissions",Permissions._permissions),Logger.debug("Permissions.updatePermissions(...)",{permissions:Permissions._permissions})}static getPermissionNameI18n(e){return e?e.startsWith("perciever.")?T.i18n("permissions.percieverName")+WeatherPerception.getInfo(e.replace("perciever.","")).name:T.i18n("permissions."+e+".name"):T.i18n("permissions.unknown.name")}static getPermissionHintI18n(e){return e?e.startsWith("perciever.")?T.i18n("permissions.percieverHint")+WeatherPerception.getInfo(e.replace("perciever.","")).name:T.i18n("permissions."+e+".hint"):T.i18n("permissions.unknown.hint")+e}static getPermissionIds(){void 0===Permissions._permissions&&Permissions._loadPermissions();const e=Object.keys(Permissions._permissions);return Logger.debug("Permissions.getPermissionIds()",{permissionIds:e}),e}static getPermissionForId(e){return e?(void 0===Permissions._permissions&&Permissions._loadPermissions(),e in Permissions._permissions?(Logger.debug("Permissions.getPermissionForId(...)",{permissionId:e,permission:Permissions._permissions[e]}),S.mergeObject(Permissions.DEFAULT_PERMISSION_STRUCT,Permissions._permissions[e],{inplace:!1,expand:!1})):(Logger.debug("Permissions.getPermissionForId(unknown)",{permissionId:e}),S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT))):S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT)}static hasPermission(e="player",t=null,a=!0){if(null===e||null===t)return!1;const i=Permissions.getPermissionForId(t);switch(e){case"player":return!!i.player;case"trustedPlayer":return!!i.trustedPlayer;case"assistantGameMaster":return!!i.assistantGameMaster;default:if(T.isGm(e)&&a)return!0;const t=T.getUser(e);return!!t&&(!!(i.player&&t.hasRole(1)&&a)||(!!(i.trustedPlayer&&t.hasRole(2)&&a)||(!!(i.assistantGameMaster&&t.hasRole(3)&&a)||!!i.users.includes(e))))}}}Hooks.on("updateToken",(async(e,t,a,i)=>{T.getControlledTokens().forEach((e=>{const t=TokenAmbience.getAmbienceModelForToken(e);t&&(Logger.trace("Hook:WeatherUpdated -> updateSounds for token",{token:e,ambienceModel:t}),canvas.sceneweather.sfxHandler&&canvas.sceneweather.sfxHandler.updateSounds(t,!0))}))})),Hooks.on(i.WEATHER_UPDATED,(async e=>{T.getControlledTokens().forEach((e=>{const t=TokenAmbience.getAmbienceModelForToken(e);t&&(Logger.trace("Hook:WeatherUpdated -> updateSounds for token",{token:e,ambienceModel:t}),canvas.sceneweather.sfxHandler&&canvas.sceneweather.sfxHandler.updateSounds(t,!0))}))})),Hooks.on("controlToken",(async(e,t)=>{if(t){const t=TokenAmbience.getAmbienceModelForToken(e);if(!t)return;canvas.sceneweather.sfxHandler&&canvas.sceneweather.sfxHandler.updateSounds(t,!1)}else canvas.sceneweather.sfxHandler&&canvas.sceneweather.sfxHandler.disableAllSounds(!1)})),m.none,p.none;class TokenAmbience{static getAmbienceModelForToken(e){if(!e||!e instanceof Token)return;if(!e||!canvas||!canvas.ready)return;const t=SceneWeatherState.getSceneWeatherProvider();return t?TokenAmbience.getAmbienceModelForPosition(e.center||{x:-1,y:-1},t):void 0}static getAmbienceModelForPosition({x:e=0,y:t=0}={},a){const i=a.getWeatherModel();if(i){let a=S.mergeObject(i,{condition:d.outside,base:S.deepClone(i)}),r=a;return canvas.sceneweather.getNodesAt({x:e,y:t,onlyEnabled:!0}).forEach((e=>{r=e.filterWeatherModel(r,a)})),r}}static getAmbienceForPosition(e,t){return TokenAmbience.getAmbienceModelForPosition(e,t)}}function getSceneWeatherAPIv1(){const e={id:"unknown",name:"unknown",description:"unknown",elevation:0,vegetation:0,waterAmount:0,summer:{temperature:{day:0,night:0,var:0},humidity:{day:0,night:0,var:0},wind:{avg:0,var:0},sun:{hours:0}},winter:{temperature:{day:0,night:0,var:0},humidity:{day:0,night:0,var:0},wind:{avg:0,var:0},sun:{hours:0}}},t={id:"unknown",name:"unknown",temp:{underground:14.5,ground:0,air:0,percieved:0},wind:{speed:0,gusts:0,direction:0},clouds:{coverage:0,bottom:0,top:0,type:0},precipitation:{amount:0,type:0},sun:{amount:0},humidity:0},i={daylightCycle:-50,seasonCycle:-50};async function updateWeather({force:e=!1,sceneId:t}={}){if(Logger.debug("updateWeather(...)",{sceneId:t,force:e,canvasSceneId:canvas.scene._id}),void 0===t&&(t=canvas.scene._id),t!=canvas.scene._id)return;e&&(SceneWeatherState._lastUpdate=-1);const a=TimeProvider.getCurrentTimeHash();if(SceneWeatherState._lastUpdate==a)return;SceneWeatherState._lastUpdate=a;const i=SceneWeatherState.getSceneWeatherProvider(t);void 0!==i&&i.calculateWeather({force:e})}function _checkParam(e={},t="",a=null,i=(e=>e)){if(!e||e=={}||!t)throw new Error("-");if(!t.includes(".")){if(t in e){const r=e[t];if(null!=a){const i=getType(r);if(i!=a)throw Logger.debug("_checkParam failed: invalid type",{input:e,keyName:t,value:r,vType:i,type:a}),new Error(t+"{"+i+"} != {"+a+"}")}return i(r)}throw Logger.debug("_checkParam failed: no such key",{input:e,keyName:t}),new Error(t)}{const r=t.split(".")[0];if(!(r in e))throw Logger.debug("_checkParam failed: no such key",{input:e,treeTop:r}),new Error(r);try{return _checkParam(e[r],t.slice(r.length+1),a,i)}catch(e){throw new Error(r+"."+e.message)}}}return{clearScene:async function clearScene(){if(Logger.debug("clearScene"),Permissions.hasPermission(T.userID(),"sceneSettings")){if(canvas.ready&&canvas.scene)return await T.setSceneFlag("weatherMode",a.DISABLED),Promise.all([T.unsetSceneFlag("weatherMode"),T.unsetSceneFlag("rainMode"),T.unsetSceneFlag("regionTemplate"),T.unsetSceneFlag("seed"),T.unsetSceneFlag("timeProvider"),T.unsetSceneFlag("weatherTemplate"),T.unsetSceneFlag("weatherSettings"),T.unsetSceneFlag("regionSettings"),T.unsetSceneFlag("nodes")])}else Logger.error("clearScene | "+T.i18n("api.noPermission"))},updateWeatherConfig:async function updateWeatherConfig({forSceneId:e,force:t=!1}={}){Logger.debug("updateWeatherConfig",{forSceneId:e,force:t});const a=SceneWeatherState.getSceneWeatherProvider(e,t);void 0!==a&&(a.updateConfig()||t)&&updateWeather({sceneId:e,force:!0})},updateWeather:updateWeather,getWeatherModel:function getWeatherModel(e=0,t=0){Logger.debug("getWeatherModel(...)",{dayOffset:e,hourOffset:t});const a=SceneWeatherState.getSceneWeatherProvider();if(void 0!==a)return a.getWeatherModel(e,t)},getWeatherSettings:function getWeatherSettings(){Logger.debug("getWeatherSettings()");const e=SceneWeatherState.getSceneWeatherProvider();if(void 0!==e)return e.getWeatherSettings()},getTokenAmbience:function getTokenAmbience(e){if(!e||!e instanceof Token)return;if(!e||!canvas||!canvas.ready)return;if(!T.getControlledTokens().includes(e))return void Logger.warn("getTokenAmbience | No permission to get for non controlled tokens.");const t=SceneWeatherState.getSceneWeatherProvider();return t?TokenAmbience.getAmbienceForPosition(e.center||{x:-1,y:-1},t):void 0},setSeed:async function setSeed(e=""){Logger.debug("setSeed(...)",{seedString:e}),Permissions.hasPermission(T.userID(),"sceneSettings")?canvas.ready&&canvas.scene&&(await T.setSceneFlag("seed",e),MacroConfigDialog.refresh()):Logger.error("setSeed | "+T.i18n("api.noPermission"))},setCycleTimes:async function setCycleTimes(e){if(Logger.debug("setCycleTimes(...)",{cycleTimes:e}),!Permissions.hasPermission(T.userID(),"timeControls"))return void Logger.error("setCycleTimes | "+T.i18n("api.noPermission"));if(!TimeProvider.hasTimeAuthority())return void Logger.error("setCycleTimes | "+T.i18n("api.noTimeAuthority"));const t=S.mergeObject(S.deepClone(i),e,{insertKeys:!1});if(t.seasonCycle>=0){const e=S.clamp(t.seasonCycle,0,100);await TimeProvider.setSeasonCyclePct(e/100)}if(t.daylightCycle>=0){const e=S.clamp(t.daylightCycle,0,100);await TimeProvider.setDaylightCyclePct(e/100)}},setWeather:async function setWeather(e){if(Logger.debug("setWeather(...)",{weatherSettings:e}),Permissions.hasPermission(T.userID(),"sceneSettings"))try{const t={temp:{ground:_checkParam(e,"temp.ground","number",(e=>Math.round(S.clamp(e,-30,50)))),air:_checkParam(e,"temp.air","number",(e=>Math.round(S.clamp(e,-30,50))))},humidity:_checkParam(e,"humidity","number",(e=>Math.round(S.clamp(e,0,100)))),wind:{speed:_checkParam(e,"wind.speed","number",(e=>Math.round(S.clamp(e,0,130)))),gusts:_checkParam(e,"wind.gusts","number",(e=>Math.round(S.clamp(e,0,130)))),directionType:_checkParam(e,"wind.directionType","string",(e=>s[e]||s.fixed)),direction:_checkParam(e,"wind.direction","number",(e=>Math.round(e)%360))},clouds:{type:_checkParam(e,"clouds.type","string",(e=>p[e]||p.none)),coverage:_checkParam(e,"clouds.coverage","number",(e=>Math.round(S.clamp(e,0,100)))),bottom:_checkParam(e,"clouds.bottom","number",(e=>Math.round(S.clamp(e,0,2e4)))),thickness:_checkParam(e,"clouds.thickness","number",(e=>Math.round(S.clamp(e,0,2e4))))},precipitation:{type:_checkParam(e,"precipitation.type","string",(e=>m[e]||m.none)),amount:_checkParam(e,"precipitation.amount","number",(e=>Math.round(S.clamp(e,0,100))))},sun:{amount:_checkParam(e,"sun.amount","number",(e=>Math.round(S.clamp(e,0,100))))}};Logger.trace("setWeather(...)",{safeWeatherData:t}),await T.setSceneFlag("weatherSettings",t),Logger.info("setWeather | "+T.i18n("api.updateWeather"));T.getSceneFlag("weatherMode",a.DISABLED)!=a.WEATHER_GENERATE&&(await T.setSceneFlag("weatherMode",a.WEATHER_GENERATE),Logger.info("setWeather | "+T.i18n("api.updateWeatherMode")+a.WEATHER_GENERATE))}catch(e){Logger.error("setWeather | "+T.i18n("api.updateRegionFail")+e.message,!0)}else Logger.error("setWeather | "+T.i18n("api.noPermission"))},setWeatherTemplate:async function setWeatherTemplate(e=""){if(Logger.debug("setWeatherTemplate(...)",{templateId:e}),!Permissions.hasPermission(T.userID(),"sceneSettings"))return void Logger.error("setWeatherTemplate | "+T.i18n("api.noPermission"));if(!e.includes("."))return void Logger.error("setWeatherTemplate | "+T.i18n("api.setTemplate.idFormatInvalid"));const[t,i]=e.split(".");if(!T.isModuleActive(t))return void Logger.error("setWeatherTemplate | "+T.i18n("api.setTemplate.moduleInactive")+t);if(!Object.keys(SceneWeatherState._weatherTemplates).includes(e))return void Logger.error("setWeatherTemplate | "+T.i18n("api.setTemplate.noSuchTemplate")+e);const r=SceneWeatherState._weatherTemplates[e];T.getSceneFlag("weatherTemplate",null)!=e&&(await T.setSceneFlag("weatherTemplate",e),Logger.info("setWeatherTemplate | "+T.i18n("api.setTemplate.updateWeatherTemplate")+T.i18n(r.name)+" ("+e+")")),T.getSceneFlag("weatherMode",a.DISABLED)!=a.WEATHER_TEMPLATE&&(await T.setSceneFlag("weatherMode",a.WEATHER_TEMPLATE),Logger.info("setWeatherTemplate | "+T.i18n("api.updateWeatherMode")+a.WEATHER_TEMPLATE))},setRegion:async function setRegion(e){if(Logger.debug("setRegion(...)",{regionSettings:e}),Permissions.hasPermission(T.userID(),"sceneSettings"))try{const t={elevation:_checkParam(e,"elevation","number",(e=>Math.round(S.clamp(e,0,1e4)))),vegetation:_checkParam(e,"vegetation","number",(e=>Math.round(S.clamp(e,0,100)))),waterAmount:_checkParam(e,"waterAmount","number",(e=>Math.round(S.clamp(e,0,100)))),summer:{temperature:{day:_checkParam(e,"summer.temperature.day","number",(e=>Math.round(S.clamp(e,-30,50)))),night:_checkParam(e,"summer.temperature.night","number",(e=>Math.round(S.clamp(e,-30,50)))),var:_checkParam(e,"summer.temperature.var","number",(e=>Math.round(S.clamp(e,0,20))))},humidity:{day:_checkParam(e,"summer.humidity.day","number",(e=>Math.round(S.clamp(e,0,100)))),night:_checkParam(e,"summer.humidity.night","number",(e=>Math.round(S.clamp(e,0,100)))),var:_checkParam(e,"summer.humidity.var","number",(e=>Math.round(S.clamp(e,0,50))))},wind:{avg:_checkParam(e,"summer.wind.avg","number",(e=>Math.round(S.clamp(e,0,70)))),var:_checkParam(e,"summer.wind.var","number",(e=>Math.round(S.clamp(e,0,50))))},sun:{hours:_checkParam(e,"summer.sun.hours","number",(e=>Math.round(S.clamp(e,1,23))))}},winter:{temperature:{day:_checkParam(e,"winter.temperature.day","number",(e=>Math.round(S.clamp(e,-30,50)))),night:_checkParam(e,"winter.temperature.night","number",(e=>Math.round(S.clamp(e,-30,50)))),var:_checkParam(e,"winter.temperature.var","number",(e=>Math.round(S.clamp(e,0,20))))},humidity:{day:_checkParam(e,"winter.humidity.day","number",(e=>Math.round(S.clamp(e,0,100)))),night:_checkParam(e,"winter.humidity.night","number",(e=>Math.round(S.clamp(e,0,100)))),var:_checkParam(e,"winter.humidity.var","number",(e=>Math.round(S.clamp(e,0,50))))},wind:{avg:_checkParam(e,"winter.wind.avg","number",(e=>Math.round(S.clamp(e,0,70)))),var:_checkParam(e,"winter.wind.var","number",(e=>Math.round(S.clamp(e,0,50))))},sun:{hours:_checkParam(e,"winter.sun.hours","number",(e=>Math.round(S.clamp(e,1,23))))}}};Logger.trace("setRegion(...)",{safeRegionData:t}),await T.setSceneFlag("regionSettings",t),Logger.info("setRegion | "+T.i18n("api.updateRegion"));T.getSceneFlag("weatherMode",a.DISABLED)!=a.REGION_GENERATE&&(await T.setSceneFlag("weatherMode",a.REGION_GENERATE),Logger.info("setRegion | "+T.i18n("api.updateWeatherMode")+a.REGION_GENERATE))}catch(e){Logger.error("setRegion | "+T.i18n("api.updateRegionFail")+e.message,!0)}else Logger.error("setRegion | "+T.i18n("api.noPermission"))},setRegionTemplate:async function setRegionTemplate(e=""){if(Logger.debug("setRegionTemplate(...)",{templateId:e}),!Permissions.hasPermission(T.userID(),"sceneSettings"))return void Logger.error("setRegionTemplate | "+T.i18n("api.noPermission"));if(!e.includes("."))return void Logger.error("setRegionTemplate | "+T.i18n("api.setTemplate.idFormatInvalid"));const[t,i]=e.split(".");if(!T.isModuleActive(t))return void Logger.error("setRegionTemplate | "+T.i18n("api.setTemplate.moduleInactive")+t);if(!Object.keys(SceneWeatherState._regionTemplates).includes(e))return void Logger.error("setRegionTemplate | "+T.i18n("api.setTemplate.noSuchTemplate")+e);const r=SceneWeatherState._regionTemplates[e];T.getSceneFlag("regionTemplate",null)!=e&&(await T.setSceneFlag("regionTemplate",e),Logger.info("setRegionTemplate | "+T.i18n("api.setTemplate.updateRegionTemplate")+T.i18n(r.name)+" ("+e+")")),T.getSceneFlag("weatherMode",a.DISABLED)!=a.REGION_TEMPLATE&&(await T.setSceneFlag("weatherMode",a.REGION_TEMPLATE),Logger.info("setRegionTemplate | "+T.i18n("api.updateWeatherMode")+a.REGION_TEMPLATE))},registerPerciever:WeatherPerception.registeredPerciever,registerRegionTemplate:function registerRegionTemplate(t=null,a=null,i={}){if(t&&a&&i&&T.isModuleEnabled(t)){i.id=t+"."+a;const r=S.mergeObject(S.deepClone(e),i,{insertKeys:!1,enforceTypes:!0});SceneWeatherState._regionTemplates[r.id]=r,Logger.info("registerRegionTemplate | "+T.i18n("api.regRegionTemplate")+t+"."+a)}else Logger.error("registerRegionTemplate | "+T.i18n("api.regRegionTemplateFail")+t+"."+a,!0)},registerWeatherTemplate:function registerWeatherTemplate(e=null,a=null,i={}){if(e&&a&&i&&T.isModuleEnabled(e)){i.id=e+"."+a;const r=S.mergeObject(S.deepClone(t),i,{insertKeys:!1,enforceTypes:!0});SceneWeatherState._weatherTemplates[e+"."+a]=r,Logger.info("registerWeatherTemplate | "+T.i18n("api.regWeatherTemplate")+e+"."+a)}else Logger.error("registerWeatherTemplate | "+T.i18n("api.regWeatherTemplateFail")+e+"."+a,!0)},registerWeatherFxGenerator:function registerWeatherFxGenerator(e=null,t=null){Logger.info("registerWeatherFxGenerator | "+T.i18n("api.regFxGenerator")+e),SceneWeatherState._generators.push({name:e,getEmitter:t})},registerWeatherFxFilter:function registerWeatherFxFilter(e=null,t=null){Logger.info("registerWeatherFxFilter | "+T.i18n("api.regFxFilter")+e),SceneWeatherState._filters.push({name:e,getFilterConfig:t})},version:"1.0"}}const registerHbHelpers=function(){Handlebars.__switch_stack__=[],Handlebars.registerHelper("switch",(function(e,t){Handlebars.__switch_stack__.push({switch_match:!1,switch_value:e});var a=t.fn(this);return Handlebars.__switch_stack__.pop(),a})),Handlebars.registerHelper("case",(function(e,t){var a=Array.from(arguments),i=(t=a.pop(),a),r=Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1];return r.switch_match||-1===i.indexOf(r.switch_value)?"":(r.switch_match=!0,t.fn(this))})),Handlebars.registerHelper("default",(function(e){if(!Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1].switch_match)return e.fn(this)})),Logger.debug("HB Helpers Registered")},loadHandlebars=function(){loadTemplates({regionConfigSummer:"modules/"+e.ID+"/templates/regionConfigSummer.hbs",regionConfigWinter:"modules/"+e.ID+"/templates/regionConfigWinter.hbs"}),Logger.debug("HB partials loaded")};class RegionConfigDialog extends FormApplication{applyToScene=void 0;constructor(e){super(),this.applyToScene=e}static get defaultOptions(){return S.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/regionConfig.hbs",id:"region-settings",title:"dialogs.regionConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}activateListeners(e){super.activateListeners(e);new Tabs({navSelector:".tabs",contentSelector:".content",initial:"summer",callback:(e,t,a)=>{}}).bind(e[0]),e.find(".sceneweather-slider").each((function(t){const a=$(this),i=e.find('input[name="'+a.attr("data-min")+'"]'),r=e.find('input[name="'+a.attr("data-max")+'"]'),n=a.attr("data-range")||"0,100",o=a.attr("data-unit")||"%",s=Number(n.split(",")[0]||0),d=Number(n.split(",")[1]||s);noUiSlider.create(a[0],{start:[i.val()||0,r.val()||0],tooltips:[{to:function(e){return e+o},from:function(e){return Number(e.replace(o,""))}},{to:function(e){return e+o},from:function(e){return Number(e.replace(o,""))}}],behaviour:"drag-all",step:1,margin:0,padding:0,connect:!0,range:{min:s,max:d}}),a[0].noUiSlider.on("change",(function(e,t,a,n,o,s){Logger.debug("Slider Update",{values:e,noUiSlider:s}),i.val(e[0]),r.val(e[1])}))}))}getData(){let e={waterAmounts:Array.from({length:7},((e,t)=>({id:25*t,name:"dialogs.regionConfig.waterAmounts_"+25*t})))};if(void 0===this.applyToScene)return S.mergeObject(e,T.getSetting("defaultRegionSettings")),e;{let t=T.getSceneFlag("regionSettings",void 0,this.applyToScene);return t||(t=T.getSetting("defaultRegionSettings")),S.mergeObject(e,t),e}}_updateObject(e,t){const a=expandObject(t);void 0===this.applyToScene?T.setSetting("defaultRegionSettings",a):T.setSceneFlag("regionSettings",a,this.applyToScene)}}class WeatherConfigDialog extends FormApplication{applyToScene=void 0;constructor(e){super(),this.applyToScene=e}static get defaultOptions(){return S.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/weatherConfig.hbs",id:"weather-settings",title:"dialogs.weatherConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}activateListeners(e){super.activateListeners(e);0!=e.find('select[name="wind.directionType"]').find(":selected").val()&&e.find("#windTypeGrp").addClass("disabled"),e.find('select[name="wind.directionType"]').on("change",(function(){0!=$(this).find(":selected").val()?e.find("#windTypeGrp").addClass("disabled"):e.find("#windTypeGrp").removeClass("disabled")}));0==e.find('select[name="clouds.type"]').find(":selected").val()&&(e.find("#cloudSectionGrp").addClass("disabled"),e.find("#preciGrp").addClass("disabled")),e.find('select[name="clouds.type"]').on("change",(function(){0==$(this).find(":selected").val()?(e.find("#cloudSectionGrp").addClass("disabled"),e.find("#preciGrp").addClass("disabled")):(e.find("#cloudSectionGrp").removeClass("disabled"),e.find("#preciGrp").removeClass("disabled"))}));0==e.find('select[name="precipitation.type"]').find(":selected").val()&&e.find("#previAmtGrp").addClass("disabled"),e.find('select[name="precipitation.type"]').on("change",(function(){0==$(this).find(":selected").val()?e.find("#previAmtGrp").addClass("disabled"):e.find("#previAmtGrp").removeClass("disabled")}))}getData(){let e={windSpeeds:Object.entries(w).map((([e,t])=>"hurricane"===e?{id:120,name:"dialogs.weatherConfig.wind.speeds.hurricane"}:{id:t,name:"dialogs.weatherConfig.wind.speeds."+e})),directionTypes:[{id:0,name:"dialogs.weatherConfig.directionTypes.fixed"},{id:1,name:"dialogs.weatherConfig.directionTypes.noise"}],cloudsTypes:Object.entries(p).map((([e,t])=>({id:t,name:"dialogs.weatherConfig.clouds.types."+e}))),precipitationTypes:Object.entries(m).map((([e,t])=>({id:t,name:"dialogs.weatherConfig.precipitation.types."+e}))),windGustTypes:[{id:0,name:"dialogs.weatherConfig.windGustTypes.none"},{id:6,name:"dialogs.weatherConfig.windGustTypes.some"},{id:11,name:"dialogs.weatherConfig.windGustTypes.more"}]};if(void 0===this.applyToScene)return S.mergeObject(e,T.getSetting("defaultWeatherSettings")),e;{let t=T.getSceneFlag("weatherSettings",void 0,this.applyToScene);return t||(t=T.getSetting("defaultWeatherSettings")),S.mergeObject(e,t),Logger.debug("WeatherConfigDialog:getData(scene)",{applyToScene:this.applyToScene,data:e}),e}}_updateObject(e,t){const a=expandObject(t);void 0===this.applyToScene?T.setSetting("defaultWeatherSettings",a):T.setSceneFlag("weatherSettings",a,this.applyToScene)}}class PermissionConfigDialog extends FormApplication{constructor(){super()}static get defaultOptions(){return S.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/permissionConfig.hbs",id:"scene-weather-permissions-config",title:"dialogs.permissionConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1,width:220+110*PermissionConfigDialog._getUserIds().length,resizable:!0})}static _getUserIds(){let e=[{id:"player",name:T.i18n("USER.RolePlayer"),type:"role"},{id:"trustedPlayer",name:T.i18n("USER.RoleTrusted"),type:"role"},{id:"assistantGameMaster",name:T.i18n("USER.RoleAssistant"),type:"role"}];return game.users.forEach((t=>{e.push({id:t._id,name:t.name,type:"user",color:t.color||"#ffffff"})})),e}activateListeners(e){super.activateListeners(e),e.find("button[name='reset']").click(this._onResetDefaults.bind(this))}async _onResetDefaults(e){return e.preventDefault(),await Permissions.resetPermissions(),Logger.info(T.i18n("dialogs.permissionConfig.defaultsNotice"),!0),this.render()}async _onSubmit(e,t){return e.target.querySelectorAll("input[disabled]").forEach((e=>e.disabled=!1)),super._onSubmit(e,t)}getData(){const e=PermissionConfigDialog._getUserIds();let t={headline:e,matrix:[]};return Permissions.getPermissionIds().forEach((a=>{let i=[];e.forEach((e=>{i.push({id:e.id,name:e.name,check:Permissions.hasPermission(e.id,a,!1),checkId:a+"::"+e.id})})),t.matrix.push({permissionId:a,permissionName:Permissions.getPermissionNameI18n(a),permissionHint:Permissions.getPermissionHintI18n(a),users:i})})),t.matrix.sort(((e,t)=>e.permissionName.localeCompare(t.permissionName))),t}_updateObject(e,t){let a={};Object.keys(t).filter((e=>t[e])).forEach((e=>{const[t,i]=e.split("::");t in a||(a[t]=S.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT)),["player","trustedPlayer","assistantGameMaster"].includes(i)?a[t][i]=!0:a[t].users.push(i)})),Permissions.updatePermissions(a)}}Hooks.once("ready",(()=>{if(!T.isGm())return;const t=T.getSetting("welcomePrompt","0.0.0"),a=T.getModuleVersion();if(T.isNewerVersion(T.getModule().compatibility.verified,T.gameVersion)&&Logger.error(T.i18nf("sceneweather.foundryVersionCheck",{module:e.NAME,minVersion:T.getModule().compatibility.verified,gameVersion:T.gameVersion}),!0,!0),t!=a||"development"==a){new WelcomeDialog(!1).render(!0)}}));class WelcomeDialog extends FormApplication{_showAll=!0;constructor(e=!0){super(),this._showAll=e}static get defaultOptions(){return S.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/welcome.hbs",id:"welcome-scene-weather",title:"dialogs.welcome.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}async getData(){const e=T.getSetting("welcomePrompt","0.0.0"),t=T.getModuleVersion();let a=await this._getReleaseVersions(),i=t;return a&&(a=a.filter((a=>(isNewerVersion(a.version,i)&&(i=a.version),this._showAll||isNewerVersion(a.version,e)&&!isNewerVersion(a.version,t))))),{dontShowAgain:e==t,isDevVersion:"development"==t,isFirstTime:"0.0.0"==e,changelog:a||[],hasChangelog:!(void 0===a),url:T.getModule().url,latestVersion:i,canUpdate:!(i==t),currentVersion:t,readmeUrl:T.getModule().readme,showAll:this._showAll}}_getGitHubReleasesApi(){try{const e=new URL(T.getModule().url),[,t,a]=e.pathname.split("/");return"https://api.github.com/repos/"+t+"/"+a+"/releases"}catch(e){return"https://api.github.com/repos/BlackStripedOne/fvtt-scene-weather/releases"}}async _getReleaseVersions(){const e=this._getGitHubReleasesApi(),t=await fetch(e);if(t&&t.ok){const e=(await t.json()).map((e=>{if(!e.draft&&!e.prerelease)return{version:e.tag_name,html:this._markdownToHtml(e.body),md:e.body,url:e.html_url}})).filter((e=>void 0!==e));return 0===e.length?void 0:e}}_markdownToHtml(e){let t="";function escape(e){return new Option(e).innerHTML}function convertInlineElements(e){return escape(e).replace(/!\[([^\]]*)]\(([^(]+)\)/g,'<img alt="$1" src="$2">').replace(/\[([^\]]+)]\(([^(]+?)\)/g,'<a href="$2" target="_blank" rel="nofollow">$1</a>').replace(/(https?:\/\/[^\s]+)/g,(e=>'<a href="'+e+'">'+e.split("/").pop().replace(/\.[^/.]+$/,"")+"</a>")).replace(/`([^`]+)`/g,"<code>$1</code>").replace(/(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\1/g,"<strong>$2</strong>").replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>")}return e.replace(/^\s+|\r|\s+$/g,"").replace(/\t/g,"    ").split(/\n\n+/).forEach((function(e){let a=e;switch(e[0]){case"-":a="<ul><li>"+a.split(/\n\- /).slice(1).map(convertInlineElements).join("</li>\n<li>")+"</li></ul>";break;case"1":a="<ol><li>"+a.split(/\n[1-9]\d*\.? /).slice(1).map(convertInlineElements).join("</li>\n<li>")+"</li></ol>";break;case" ":a="<pre><code>"+escape(a.replace(/\n    /g,"\n").trim())+"</code></pre>";break;case">":a="<blockquote>"+a.split(/\n> /).slice(1).map(convertInlineElements).join("\n")+"</blockquote>";break;case"#":let t=1;for(;"#"===e[t];)t++;a="<h"+t+">"+convertInlineElements(e.slice(t).trim())+"</h"+t+">";break;default:a="<p>"+convertInlineElements(a)+"</p>"}t+=a})),t}_updateObject(e,t){const a=expandObject(t);if(a.reset)T.setSetting("welcomePrompt","0.0.0");else if(a.dontShowAgain){"development"!=T.getModuleVersion()&&T.setSetting("welcomePrompt",T.getModuleVersion())}}}function onChangeFunction(e){Hooks.callAll(i.SETTINGS_UPDATED,e)}const registerSettingsPostInit=function(){},registerSettingsPreInit=function(){game.settings.register(e.ID,"welcomePrompt",{name:"Version-Based Welcome Prompt",scope:"world",config:!1,type:String,default:"0.0.0"}),game.settings.registerMenu(e.ID,"permissionSettingsMenu",{name:"settings.permissionSettingsMenu.name",label:"settings.permissionSettingsMenu.label",hint:"settings.permissionSettingsMenu.hint",icon:"fa-regular fa-user-lock",type:PermissionConfigDialog,restricted:!0}),game.settings.register(e.ID,"permissions",{scope:"world",config:!1,type:Object,default:Permissions._getDefaultPermissions()}),game.settings.registerMenu(e.ID,"defaultRegionSettingsMenu",{name:"settings.defaultRegionSettingsMenu.name",label:"settings.defaultRegionSettingsMenu.label",hint:"settings.defaultRegionSettingsMenu.hint",icon:"fas fa-solid fa-sliders",type:RegionConfigDialog,restricted:!0}),game.settings.register(e.ID,"defaultRegionSettings",{scope:"world",config:!1,type:Object,default:{elevation:0,vegetation:0,waterAmount:0,summer:{temperature:{day:0,night:0,var:0},humidity:{day:0,night:0,var:0},wind:{avg:0,var:0},sun:{hours:0}},winter:{temperature:{day:0,night:0,var:0},humidity:{day:0,night:0,var:0},wind:{avg:0,var:0},sun:{hours:0}}}}),game.settings.registerMenu(e.ID,"defaultWeatherSettingsMenu",{name:"settings.defaultWeatherSettingsMenu.name",label:"settings.defaultWeatherSettingsMenu.label",hint:"settings.defaultWeatherSettingsMenu.hint",icon:"fas fa-solid fa-sliders",type:WeatherConfigDialog,restricted:!0}),game.settings.register(e.ID,"defaultWeatherSettings",{scope:"world",config:!1,type:Object,default:{temp:{ground:0,air:0},wind:{speed:0,gusts:0,direction:0,directionType:0},clouds:{coverage:0,bottom:0,thickness:0,type:0},precipitation:{amount:0,type:0},sun:{amount:0},humidity:0}}),game.settings.register(e.ID,"enableFx",{name:"settings.enableFx.name",hint:"settings.enableFx.hint",scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction({id:"enableFx",value:e})}}),game.settings.register(e.ID,"cloudsAlpha",{name:"settings.cloudsAlpha.name",hint:"settings.cloudsAlpha.hint",scope:"client",config:!0,type:Number,range:{min:0,max:100,step:5},default:100,onChange:e=>{onChangeFunction({id:"cloudsAlpha",value:e})}}),game.settings.register(e.ID,"precipitationAlpha",{name:"settings.precipitationAlpha.name",hint:"settings.precipitationAlpha.hint",scope:"client",config:!0,type:Number,range:{min:0,max:100,step:5},default:100,onChange:e=>{onChangeFunction({id:"precipitationAlpha",value:e})}}),game.settings.register(e.ID,"sfxVolume",{name:"settings.sfxVolume.name",hint:"settings.sfxVolume.hint",scope:"client",config:!0,type:Number,range:{min:0,max:100,step:5},default:100,onChange:e=>{onChangeFunction({id:"sfxVolume",value:e})}}),game.settings.register(e.ID,"maxParticles",{name:"settings.maxParticles.name",hint:"settings.maxParticles.hint",scope:"client",config:!0,type:Number,range:{min:200,max:32e3,step:200},default:3200,onChange:e=>{onChangeFunction({id:"maxParticles",value:e})}}),game.settings.register(e.ID,"uiVisible",{name:"settings.uiVisible.name",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"uiPosition",{name:"settings.uiPosition.name",scope:"client",config:!1,type:Object,default:{top:440,left:15}}),game.settings.register(e.ID,"meteoVisible",{name:"settings.meteoVisible.name",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"meteoPosition",{name:"settings.meteoPosition.name",hint:"settings.meteoPosition.hint",scope:"client",config:!1,type:Object,default:{top:440,left:15}}),game.settings.register(e.ID,"uiPinned",{name:"settings.uiPinned.name",hint:"settings.uiPinned.hint",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"loglevel",{name:"settings.loglevel.name",hint:"settings.loglevel.hint",scope:"client",config:!0,type:String,choices:{info:"settings.loglevel.info",debug:"settings.loglevel.debug",trace:"settings.loglevel.trace"},default:"info"}),game.settings.registerMenu(e.ID,"welcomeDialog",{name:"dialogs.welcome.name",label:"dialogs.welcome.label",hint:"dialogs.welcome.hint",icon:"fas fa-regular fa-book",type:WelcomeDialog,restricted:!0}),Logger.debug("Settings Registered")};class WeatherTab{static async addControlsTab(t,i){const r=t.document.flags[e.ID],n={weatherMode:"disabled",weatherTemplate:Object.values(SceneWeatherState._weatherTemplates)[0].id,regionTemplate:Object.values(SceneWeatherState._regionTemplates)[0].id,timeProvider:TimeProvider.getProviderIds()[0],seed:""},o={data:S.mergeObject(n,r,{overwrite:!0}),timeProviders:TimeProvider.getProviderIds().map((e=>({id:e,name:"configTab.general.timeSources."+e+".name",hint:"configTab.general.timeSources."+e+".hint"}))),rainModes:Object.values(l).map((e=>({id:e,name:"configTab.rainModes."+e+".name",hint:"configTab.rainModes."+e+".hint"}))),weatherModes:Object.values(a).map((e=>({id:e,name:"configTab.weatherModes."+e+".name",hint:"configTab.weatherModes."+e+".hint"}))),weatherTemplates:WeatherModel.getTemplates(),regionTemplates:RegionMeteo.getTemplates()},s=await renderTemplate("modules/"+e.ID+"/templates/weatherTab.hbs",o);$(".sheet-tabs",i).append($("<a>").addClass("item").attr("data-tab","weather").html('<i class="fas fa-solid fa-cloud-bolt-sun"></i> '+T.i18n("configTab.title"))),$("<div>").addClass("tab").attr("data-tab","weather").insertAfter($('div[data-tab="ambience"]',i)).append(s),WeatherTab.activateListeners(t,i,o.data.weatherMode)}static activateListeners(e,t,a){t.find('div[id="sceneWeather.mode.'+a+'"]').addClass("active"),t.find('div[id="not_sceneWeather.mode.'+a+'"]').removeClass("active"),t.find('button[data-key="flags.scene-weather.regionConfig"]').on("click",(function(){Logger.debug("Clicked Config Region for Scene",{sceneId:e.document._id});new RegionConfigDialog(e.document._id).render(!0)})),t.find('button[data-key="flags.scene-weather.weatherConfig"]').on("click",(function(){Logger.debug("Clicked Config Weather for Scene",{sceneId:e.document._id});new WeatherConfigDialog(e.document._id).render(!0)})),t.find("#randomSeed").on("click",(async function(){const e=t.find('input[name="flags.scene-weather.seed"]');let a=[];Object.values(S.flattenObject(game.i18n.translations)).forEach((e=>{e.split(/(\s+)/).forEach((e=>{e&&e.length>5&&e.length<13&&/^\w+$/.test(e)&&a.push(e)}))}));let i=[];for(var r=0;r<3;r++)i.push(a[Math.floor(Math.random()*a.length)]);e.val(i.join(" "))})),t.find('select[name="flags.scene-weather.weatherMode"]').on("change",(function(){let a=$(this).find(":selected").val();t.find("div.sceneWeather-collapsibleModeOption").each((function(){$(this).attr("id").startsWith("not_sceneWeather.mode.")?$(this).attr("id")=="not_sceneWeather.mode."+a?$(this).removeClass("active"):$(this).addClass("active"):$(this).attr("id")=="sceneWeather.mode."+a?$(this).addClass("active"):$(this).removeClass("active")})),e.setPosition({height:"auto"})}))}}Hooks.on(i.WEATHER_UPDATED,(async e=>{e.sceneId==canvas.scene._id&&void 0!==e.model&&WeatherUi.update(e.model)})),Hooks.on(e.LCCNAME+"WeatherDisabled",(async e=>{})),Hooks.on("renderWeatherUi",(()=>{WeatherUi.update()})),Hooks.on("updateWorldTime",(()=>{WeatherUi._updateTimeHeadline()}));class WeatherUi extends FormApplication{static _isOpen=!1;static _weatherModel={};static _perceptionId=void 0;constructor(){super()}static _addModelFlags(){const e=T.userID();WeatherUi._weatherModel.hasControls=Permissions.hasPermission(e,"weatherUiControls"),WeatherUi._weatherModel.hasPerceiver=WeatherPerception.getAllowedIds(T.userID()).length>=1,WeatherUi._weatherModel.hasPerceivers=WeatherPerception.getAllowedIds(T.userID()).length>1,WeatherUi._weatherModel.hasTimeAuthority=Permissions.hasPermission(e,"timeControls")&&WeatherUi._weatherModel.hasControls&&TimeProvider.hasTimeAuthority()&&[a.REGION_TEMPLATE,a.REGION_GENERATE].includes(T.getSceneFlag("weatherMode",a.DISABLED)),WeatherUi._weatherModel.hasTimeAuthority?WeatherUi._weatherModel.timeHeadline=TimeProvider.getI18nDateString():WeatherUi._weatherModel.timeHeadline=""}static get defaultOptions(){return this.initialPosition=T.getSetting("uiPosition",{top:40,left:40}),mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,width:200,height:100,submitOnChange:!0,closeOnSubmit:!1,minimizable:!1,template:"modules/"+e.ID+"/templates/weatherUi.hbs",id:"scene-weather-app",title:"dialogs.weatherUi.title",top:this.initialPosition.top,left:this.initialPosition.left})}static async pinApp(){const e=T.getModule().uiApp;e&&!e.element.hasClass("pinned")&&($("#players").before(e.element),e.element.addClass("pinned"))}static unPinApp(){const e=T.getModule().uiApp;if(e&&e.element.hasClass("pinned")){const t=e.element;return $("body").append(t),t.removeClass("pinned"),!0}}static async toggleAppVis(e){"toggle"===e?!0===T.getSetting("uiVisible",!1)?($("#scene-weather-app").stop(),$("#scene-weather-app").css({animation:"close 0.3s",opacity:"0"}),setTimeout((function(){T.getModule().uiApp.close({sceneWeather:!0})}),200)):(WeatherUi._isOpen&&T.getModule().uiApp.close({sceneWeather:!0}),T.getModule().uiApp=await(new WeatherUi).render(!0),T.setSetting("uiVisible",!0)):!0===T.getSetting("uiVisible",!1)&&(T.getModule().uiApp=await(new WeatherUi).render(!0))}static async _updateTimeHeadline(){Logger.debug("WeatherUi._updateTimeHeadline()",{model:WeatherUi._weatherModel}),WeatherUi._weatherModel.hasTimeAuthority&&(WeatherUi._weatherModel.timeHeadline=TimeProvider.getI18nDateString(),$("#weatherHeadline").html(WeatherUi._weatherModel.timeHeadline))}static async update(e=null){if(null==e&&(e=WeatherUi._weatherModel),Logger.debug("WeatherUi.update(...)",{weatherModel:e}),WeatherUi._weatherModel=e,!WeatherUi._perceptionId){WeatherUi._perceptionId=T.getUserFlag("perceptionId",void 0);const e=WeatherPerception.getAllowedIds(T.userID());e.includes(WeatherUi._perceptionId)||(WeatherUi._perceptionId=e[0]),await T.setUserFlag("perceptionId",WeatherUi._perceptionId)}if(WeatherUi._addModelFlags(),!0===T.getSetting("uiVisible",!1)){const e=await WeatherPerception.getAsUiHtml(WeatherUi._perceptionId,WeatherUi._weatherModel);$("#weatherDetail").html(e),WeatherUi._weatherModel.hasTimeAuthority&&WeatherUi._updateTimeHeadline()}}async close(e={}){return e.sceneWeather&&(WeatherUi._isOpen=!1,await T.setSetting("uiVisible",!1)),super.close(e)}getData(){return WeatherUi._addModelFlags(),WeatherUi._weatherModel}activateListeners(e){super.activateListeners(e),this._attachDragHandler(e),this._attachControls(e),this._attachPerceiverControls(e)}async _render(e=!1,t={}){await super._render(e,t),T.getSetting("uiPinned",!1)&&WeatherUi.pinApp(),WeatherUi._isOpen=!0,delete ui.windows[this.appId],T.getSceneFlag("weatherMode",a.DISABLED)!=a.DISABLED&&WeatherUi._weatherModel.hasPerceiver?$("#scene-weather-app").css("visibility","visible"):(Logger.debug("WeatherUi._render() -> hiding app, DISABLED"),$("#scene-weather-app").css("visibility","hidden"))}async _updateObject(e,t){}_attachDragHandler(e){const t=e.find("#weatherHeadline")[0],a=new Draggable(this,e,t,!1);let i=!1;a._onDragMouseMove=function _newOnDragMouseMove(e){e.preventDefault();const t=document.getElementById("players").getBoundingClientRect(),a=Date.now();if(a-this._moveTime<1e3/60)return;this._moveTime=a;const{left:r,top:n}=this.element.getBoundingClientRect();WeatherUi.unPinApp()&&Object.assign(this.position,{left:r,top:n}),this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)});let o=t.top-50,s=t.top+50;e.clientX>t.left&&e.clientX<t.left+t.width&&e.clientY>o&&e.clientY<s?($("#scene-weather-app").css("animation","jiggle 0.2s infinite"),i=!0):($("#scene-weather-app").css("animation",""),i=!1)},a._onDragMouseUp=async function _newOnDragMouseUp(e){e.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp);const t=document.getElementById("players").getBoundingClientRect().height+90;if(i)WeatherUi.pinApp(),await T.setSetting("uiPinned",!0),this.app.setPosition({left:15,top:window.innerHeight-t});else{const e=$("#scene-weather-app").position(),t={top:e.top,left:e.left};await T.setSetting("uiPosition",t),await T.setSetting("uiPinned",!1)}$("#scene-weather-app").css("animation","")}}_attachControls(e){WeatherUi._weatherModel.hasControls&&e.find("#weatherControls li").each((function(e){const t=$(this),a=t.attr("data-func")||"none",i=Number(t.attr("data-base")||"0");switch(a){case"time":WeatherUi._weatherModel.hasTimeAuthority&&t.on("click",(function(){TimeProvider.advanceGameTime(window.event.ctrlKey?5*i:i)}));break;case"chatSingle":WeatherUi._weatherModel.hasControls&&t.on("click",(async function(){const e=T.getControlledTokens();if(0==e.length)Logger.info(T.i18n("dialogs.weatherUi.chatNotice"),!0);else{const t=e.map((e=>T.getUserByToken(e)));Logger.debug("chatSingle",{tokens:e,userIds:t});const a=await WeatherPerception.getAsChatHtml(WeatherUi._perceptionId,WeatherUi._weatherModel);ChatMessage.create({user:T.userID(),whisper:t,content:a})}}));break;case"chatAll":WeatherUi._weatherModel.hasControls&&t.on("click",(async function(){const e=await WeatherPerception.getAsChatHtml(WeatherUi._perceptionId,WeatherUi._weatherModel);ChatMessage.create({user:T.userID(),content:e})}));break;case"clipboard":WeatherUi._weatherModel.hasControls&&t.on("click",(async function(){const e=await WeatherPerception.getAsText(WeatherUi._perceptionId,WeatherUi._weatherModel);S.copyToClipboard(e),Logger.info(T.i18n("dialogs.weatherUi.clipboardNotice"),!0)}))}}))}_attachPerceiverControls(e){WeatherUi._weatherModel.hasPerceivers&&e.find("#weatherContainer .percControl").each((function(e){const t=$(this);switch(t.attr("data-func")||"none"){case"prevPerc":t.on("click",(async function(){const e=WeatherPerception.getAllowedIds(T.userID());WeatherUi._perceptionId=S.arrayPrev(e,WeatherUi._perceptionId),await T.setUserFlag("perceptionId",WeatherUi._perceptionId),WeatherUi.update()}));break;case"nextPerc":t.on("click",(async function(){const e=WeatherPerception.getAllowedIds(T.userID());WeatherUi._perceptionId=S.arrayNext(e,WeatherUi._perceptionId),await T.setUserFlag("perceptionId",WeatherUi._perceptionId),WeatherUi.update()}))}}))}}Hooks.on(i.WEATHER_UPDATED,(async e=>{e.sceneId==canvas.scene._id&&void 0!==e.model&&MeteoUi.update()}));class MeteoUi extends FormApplication{static _isOpen=!1;static _context=void 0;static _fromHr=-12;static _toHr=12;constructor(){super()}async _render(e=!1,t={}){await super._render(e,t),MeteoUi._isOpen=!0,MeteoUi._context=document.getElementById("meteogramCanvas"),MeteoUi._chart=void 0,MeteoUi._drawWeatherModelData(),delete ui.windows[this.appId]}async close(e={}){return e.sceneWeather&&(MeteoUi._isOpen=!1,MeteoUi._context=void 0,T.setSetting("meteoVisible",!1)),super.close(e)}static get defaultOptions(){return this.initialPosition=T.getSetting("meteoPosition",{top:40,left:40}),S.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,width:600,height:400,submitOnChange:!1,closeOnSubmit:!1,minimizable:!1,template:"modules/"+e.ID+"/templates/meteoUi.hbs",id:"scene-weather-meteo-app",title:"SceneWeather Meteogram",top:this.initialPosition.top,left:this.initialPosition.left})}async _updateObject(e,t){Logger.debug("MeteoUi._updateObjec",{event:e,formData:t})}getData(){return{}}activateListeners(e){super.activateListeners(e);const t=e.find("#dragHandle")[0],a=new Draggable(this,e,t,!1);a._onDragMouseMove=function _newOnDragMouseMove(e){e.preventDefault();const t=Date.now();t-this._moveTime<1e3/60||(this._moveTime=t,this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)}))},a._onDragMouseUp=async function _newOnDragMouseUp(e){e.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp);let t=$("#scene-weather-meteo-app").position(),a={top:t.top,left:t.left};await T.setSetting("meteoPosition",a)}}static async toggleAppVis(e){"toggle"===e?!0===T.getSetting("meteoVisible",!1)?($("#scene-weather-meteo-app").stop(),$("#scene-weather-meteo-app").css({animation:"close 0.3s",opacity:"0"}),setTimeout((function(){T.getModule().meteoApp.close({sceneWeather:!0})}),200)):(MeteoUi._isOpen&&T.getModule().meteoApp.close({sceneWeather:!0}),T.getModule().meteoApp=await(new MeteoUi).render(!0),await T.setSetting("meteoVisible",!0)):!0===T.getSetting("meteoVisible",!1)&&(T.getModule().meteoApp=await(new MeteoUi).render(!0))}static async update(){Logger.debug("Updating MeteoUi"),!0===T.getSetting("meteoVisible",!1)&&MeteoUi._drawWeatherModelData()}static async _drawWeatherModelData(){const e=MeteoUi._fromHr,t=MeteoUi._toHr,a=MeteoUi._context;if(void 0===a)return void Logger.debug("No Context Yet");let i={labels:[],datasets:[]},r={label:"tempGround",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff0000",borderDash:[5,5],yAxisID:"y"},n={label:"tempAir",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff4400",borderDash:[5,5],yAxisID:"y"},o={label:"tempPercieved",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff0044",yAxisID:"y"},s={label:"windSpeed",data:[],borderWidth:1,pointRadius:0,borderColor:"rgba(20, 200, 0, 0.9)",yAxisID:"y"},d={label:"windGusts",data:[],borderWidth:1,pointRadius:0,borderColor:"rgba(0, 200, 0, 0.8)",borderDash:[5,5],yAxisID:"y"},c={label:"windDirection",data:[],borderWidth:1,showLine:!1,borderColor:"#b74"},l={label:"cloudsCoverage",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(128, 128, 128, 0.3)",fill:!0,stepped:!0,yAxisID:"y2"},h={label:"precipitationAmount",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(60,60,255,0.2)",fill:!0,yAxisID:"y2"},g={label:"sunAmount",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(255, 255, 0, 0.6)",fill:!0,yAxisID:"y2"},u={label:"humidity",data:[],borderWidth:1,pointRadius:0,borderColor:"#9999ff",yAxisID:"y2"};const m=SceneWeatherApi.getSceneWeatherProvider();for(let a=e;a<t;a++){const e=m.weatherModel.getWeatherData(0,a);r.data.push(e.temp.ground),n.data.push(e.temp.air),o.data.push(e.temp.percieved),s.data.push(e.wind.speed),d.data.push(e.wind.gusts),c.data.push(e.wind.direction/10),l.data.push(100*e.clouds.coverage),h.data.push(100*e.precipitation.amount),g.data.push(100*e.sun.amount),u.data.push(e.humidity),a<0?i.labels.push(a+"h"):a>0?i.labels.push("+"+a+"h"):i.labels.push("now")}i.datasets.push(r),i.datasets.push(n),i.datasets.push(o),i.datasets.push(s),i.datasets.push(d),i.datasets.push(c),i.datasets.push(l),i.datasets.push(h),i.datasets.push(g),i.datasets.push(u);let p={type:"line",data:i,options:{layout:{autoPadding:!1},interaction:{mode:"nearest",axis:"x",intersect:!1},plugins:{legend:{position:"right",labels:{usePointStyle:!0}}},responsive:!1,animation:!1,scales:{x:{position:"bottom"},y:{display:!0,position:"left",type:"linear",min:-30,max:70,title:{display:!0,text:"C"},grid:{color:function(e){return 0==e.tick.value?"rgba(0,0,0,1)":"rgba(80,80,80,0.3)"}}},y2:{position:"right",type:"linear",min:0,max:100,title:{display:!0,text:"%"}}}}};if(void 0===MeteoUi._chart)MeteoUi._chart=new Chart(a,p),Logger.debug("MeteoUI::new",{ctx:a,chart:MeteoUi._chart});else{Logger.debug("MeteoUi::update");for(let e=0;e<MeteoUi._chart.data.datasets.length;e++)MeteoUi._chart.data.datasets[e].data=i.datasets[e].data;MeteoUi._chart.data.labels=i.labels,MeteoUi._chart.update()}}}Hooks.once("init",(()=>{e.VERSION=game.modules.get("scene-weather")?.version??"development",registerSettingsPreInit(),Logger.debug("->Hook:init"),registerHbHelpers(),loadHandlebars(),window.SceneWeather=getSceneWeatherAPIv1(),Logger.info("API registered at global symbol SceneWeather"),Hooks.callAll(i.REG_FX_GENERATORS),Hooks.callAll(i.REG_FX_FILTERS),Hooks.callAll(i.REG_TEMPLATE_REGION),Hooks.callAll(i.REG_TEMPLATE_WEATHER),Hooks.callAll(i.REG_WEATHER_PERCIEVERS),Logger.debug("Initialized"),Hooks.callAll(i.MODULE_INITIALIZED)})),Hooks.on(e.LCCNAME+"Initialized",(async()=>{Logger.trace("->Hook:"+e.LCCNAME+"Initialized"),Hooks.on("updateScene",(async(t,i,r,n)=>{if(void 0!==i.flags&&void 0!==i.flags[e.ID]){if("nodes"in i.flags[e.ID]||"-=nodes"in i.flags[e.ID])return Logger.trace("updateScene-> weatherNodes updates Call updateWeatherMask"),void await canvas.sceneweatherfx.updateWeatherMask();Logger.trace("updateScene-> ",{deltaData:i,options:r}),SceneWeather.updateWeatherConfig({forSceneId:i._id,force:!0}),i.flags[e.ID].weatherMode==a.DISABLED&&(Logger.trace("updateScene-> Disabled SceneWeather...",{scene:t,sceneId:n}),Hooks.callAll(e.LCCNAME+"WeatherDisabled",{scene:t,sceneId:n})),void 0===i.flags[e.ID].weatherMode&&void 0===i.flags[e.ID].timeProvider||(ui.controls.initialize(),MacroConfigDialog.refresh(),WeatherUi.toggleAppVis("initial"))}})),Hooks.on("renderSceneConfig",(async(e,t,a)=>{Logger.trace("renderSceneConfig",{app:e,jQ:t,data:a}),WeatherTab.addControlsTab(e,t)}))})),Hooks.once("setup",(()=>{Logger.trace("->Hook:setup")})),Hooks.on("canvasReady",(async e=>{Logger.trace("->Hook:canvasReady(...)",{canvas:e}),WeatherUi.toggleAppVis("initial"),T.getSetting("uiPinned",!1)&&WeatherUi.pinApp(),MeteoUi.toggleAppVis("initial"),MacroConfigDialog.refresh(),SceneWeather.updateWeather({force:!0})})),Hooks.on("ready",(async()=>{Hooks.callAll(i.MODULE_READY),Logger.info("Ready")})),Hooks.on(i.MODULE_READY,(async()=>{Logger.trace("->Hook:"+e.LCCNAME+"Ready")})),Hooks.on("updateWorldTime",((e,t,i,r)=>{Logger.trace("->Hook:updateWorldTime",{worldTime:e,delta:t,options:i,userId:r}),[a.REGION_TEMPLATE,a.REGION_GENERATE].includes(T.getSceneFlag("weatherMode",a.DISABLED))&&SceneWeather.updateWeather()}));class Meteo{static calculateRelativeHumidityTransfer(e,t,a){const i=t/100*(6.11*Math.pow(10,7.5*e/(237.3+e)))/(6.11*Math.pow(10,7.5*a/(237.3+a)))*100;return S.clamp(Math.round(i),0,100)}}class ColorFilter extends PIXI.filters.AdjustmentFilter{constructor({options:e={},soft:t=!1}={}){super();const{color:a,...i}=S.mergeObject({tint:"#ffffff",saturation:1,gamma:1,brightness:1,contrast:1},e),{r:r,g:n,b:o}=foundry.utils.Color.from(e.tint),s={...i,red:r,green:n,blue:o},d=Object.keys(s);for(const e of d)this.optionContext[e]=s[e];this.enabled=!0}get optionContext(){return this}async destroy(){return this.enabled=!1,!0}async step(){}}class Generators{static _scaleValues(e,t){e.list=e.list.map((e=>({...e,value:e.value*t})))}static _scaleRange(e,t){e.min=e.min*t,e.max=e.max*t}static _getTransposedPosition(e,t,a,i,r,n){const o=e+a/2,s=t+i/2,d=n*Math.PI/180;return{x:o+r*Math.cos(d)-a/2,y:s+r*Math.sin(d)-i/2}}static applyGeneratorToEmitterConfig(e,t){const a=2/3,i=canvas.dimensions.sceneRect;t.maxParticles=canvas.dimensions.width/canvas.dimensions.size*(canvas.dimensions.height/canvas.dimensions.size)*e.density;const r=t.behaviors.find((({type:e})=>"moveSpeedStatic"===e))?.config;if(void 0!==r){const n=(r.min+r.max)/2,o=Math.sqrt(i.width*i.width+i.height*i.height),s=o/n,d=s/a/2,c=s/a;t.lifetime={min:d,max:c},t.frequency=(d+c)/2/t.maxParticles;const l=Generators._getTransposedPosition(i.x,i.y,i.width,i.height,o/4,(e.direction+180)%360);t.behaviors.push({type:"spawnShape",config:{type:"rect",data:{x:l.x,y:l.y,w:i.width,h:i.height}}})}else{t.frequency=(t.lifetime.min+t.lifetime.max)/2/t.maxParticles;const e=canvas.dimensions.sceneRect;t.behaviors.push({type:"spawnShape",config:{type:"rect",data:{x:e.x-e.width/4,y:e.y-e.height/4,w:1.5*e.width,h:1.5*e.height}}})}void 0!==e.alpha&&t.behaviors.filter((e=>"alpha"===e.type)).forEach((({config:t})=>Generators._scaleValues(t.alpha,e.alpha)));let n=e.scale*(canvas.dimensions.size/100);t.behaviors.filter((e=>"scale"===e.type)).forEach((({config:e})=>Generators._scaleValues(e.scale,n))),t.behaviors.filter((e=>"scaleStatic"===e.type)).forEach((({config:e})=>Generators._scaleRange(e,n))),n=e.speed*(canvas.dimensions.size/100),t.behaviors.filter((e=>["moveSpeed","movePath"].includes(e.type))).forEach((({config:e})=>Generators._scaleValues(e.speed,n))),t.behaviors.filter((e=>"moveSpeedStatic"===e.type)).forEach((({config:e})=>Generators._scaleRange(e,n))),Generators._scaleRange(t.lifetime,1/n),t.frequency/=n;const o=e.direction;void 0!==o&&(t.behaviors.filter((e=>"rotation"===e.type)).forEach((({config:e})=>{const t=e.maxStart-e.minStart;e.minStart=o-t/2,e.maxStart=o+t/2})),t.behaviors.filter((e=>"rotationStatic"===e.type)).forEach((({config:e})=>{const t=e.max-e.min;e.min=o-t/2,e.max=o+t/2})));const s=e.lifetime;Generators._scaleRange(t.lifetime,s),t.frequency*=s,null!=e.tint&&(t.behaviors=t.behaviors.filter((({type:e})=>"color"!==e&&"colorStatic"!==e)).concat({type:"colorStatic",config:{color:e.tint}}))}}Hooks.on(i.REG_FX_GENERATORS,(async()=>{SceneWeather.registerWeatherFxGenerator("cumulus",(function(t){if(T.getSetting("cloudsAlpha",100)<2)return;if(![p.cumulus,p.cumulunimbus].includes(t.clouds.type))return null;let a={alpha:T.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:S.map(t.wind.speed,10,70,.2,3),scale:S.map(t.clouds.coverage,.3,1,.8,1),lifetime:1,density:S.map(t.clouds.coverage,.2,1,.005,.02),tint:null};4==t.clouds.type&&(a.tint="#B0B0B0",a.density=.001);const i=S.deepClone({weight:.8,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.58,max:3.3}},{type:"rotationStatic",config:{min:85,max:95}},{type:"textureRandom",config:{textures:Array.fromRange(5).map((t=>"modules/"+e.ID+`/assets/cu${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(a,i),i}))}));class FlashFilter extends PIXI.filters.AdjustmentFilter{options;constructor({options:e={},soft:t=!1}={}){super(),this.options=S.mergeObject({frequency:0,duration:0,brightness:1,nextTime:T.getLastTickTime()/10},e);const a=Object.keys(this.options);for(const e of a)this.optionContext[e]=this.options[e];this.enabled=!0}get optionContext(){return this}async discard(){return this.enabled=!1,!0}async step(){if(T.getLastTickTime()/10>this.options.nextTime){this.options.nextTime=T.getLastTickTime()/10+40+this.options.frequency*Math.random();const animate=t=>{const a=[{parent:this,attribute:"brightness",to:t}];return CanvasAnimation.animate(a,{name:e.ID+`.${this.constructor.name}.${randomID()}`,context:this,duration:100+this.options.duration*Math.random(),easing:function(e){const t=2.5949095;return e<.5?Math.pow(2*e,2)*(7.189819*e-t)/2:(Math.pow(2*e-2,2)*((t+1)*(2*e-2)+t)+2)/2}})};await animate(this.options.brightness),await animate(1)}}}Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("fog",(function(t){if(T.getSetting("cloudsAlpha",100)<2)return;if(t.clouds.type!=p.fog)return null;const a={alpha:T.getSetting("cloudsAlpha",100)/100,direction:0,speed:1,scale:1,lifetime:1,density:S.map(t.clouds.coverage,.2,1,.01,1),tint:null},i=S.deepClone({weight:.9,lifetime:{min:10,max:25},behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.1,time:.1},{value:.3,time:.5},{value:.1,time:.9},{value:0,time:1}]}}},{type:"moveSpeed",config:{speed:{list:[{time:0,value:15},{time:1,value:10}]},minMult:.2}},{type:"scale",config:{scale:{list:[{value:2.5,time:0},{value:2,time:1}]},minMult:.5}},{type:"rotation",config:{accel:0,minSpeed:.15,maxSpeed:.35,minStart:0,maxStart:365}},{type:"textureRandom",config:{textures:Array.fromRange(3).map((t=>"modules/"+e.ID+`/assets/fg${t+1}.webp`))}},{type:"colorStatic",config:{color:"dddddd"}}]});return Generators.applyGeneratorToEmitterConfig(a,i),i}))})),Hooks.on(i.REG_FX_FILTERS,(async()=>{SceneWeather.registerWeatherFxFilter("freeze",(function(e){let t={};return e.temp.air<0&&(t.freeze={type:ColorFilter,tint:S.mapColorHex(e.temp.air+10,0,10,"#E1F3FE","#FFFFFF"),saturation:1-S.map(e.temp.air+10,10,0,0,.4),gamma:1,brightness:1,contrast:1}),t}))})),Hooks.on(i.REG_FX_FILTERS,(async()=>{SceneWeather.registerWeatherFxFilter("heatglare",(function(e){let t={};return e.sun.amount>.8&&e.temp.air>30&&(t.heatglare={type:ColorFilter,tint:S.mapColorHex(e.sun.amount,.8,1,"#ffffff","#FFF3D1"),saturation:1,gamma:1,brightness:S.map(e.sun.amount,.8,1,1,1.4),contrast:S.map(e.temp.air,30,50,1,1.5)}),t}))})),Hooks.on(i.REG_WEATHER_SFX,(t=>{t.registerSfx("heavyRain","modules/"+e.ID+"/assets/heavy_rain.ogg",{matchAny:{"base.precipitation.type":[m.rain,m.downpour],"precipitation.type":[m.rain,m.downpour]},gainMatrix:[[0,1],[.5,1],[.3,1],[0,1],[0,1]],baseValue:"base.precipitation.amount",actualValue:"precipitation.amount",baseGain:[{position:.7,gain:0},{position:1,gain:1}],actualGain:[{position:.7,gain:0},{position:1,gain:1}]}),t.registerSfx("heavyRainGated","modules/"+e.ID+"/assets/heavy_rain_gated.ogg",{matchAny:{"base.precipitation.type":[m.rain,m.downpour],"precipitation.type":[m.rain,m.downpour]},gainMatrix:[[0,0],[0,3],[.5,1],[.3,1],[0,0]],baseValue:"base.precipitation.amount",actualValue:"precipitation.amount",baseGain:[{position:.7,gain:0},{position:1,gain:1}],actualGain:[{position:.7,gain:0},{position:1,gain:1}]})})),Hooks.on(i.REG_WEATHER_SFX,(t=>{t.registerSfx("hurricane","modules/"+e.ID+"/assets/hurricane.ogg",{gainMatrix:[[0,1],[0,1],[0,1],[0,1],[0,0]],baseValue:"base.wind.speed",actualValue:"wind.speed",baseGain:[{position:w.strongBreeze-5,gain:0},{position:w.storm,gain:1},{position:w.storm+10,gain:0}],actualGain:[{position:w.strongBreeze-5,gain:0},{position:w.storm,gain:1},{position:w.storm+10,gain:0}]}),t.registerSfx("hurricaneGated","modules/"+e.ID+"/assets/hurricane_gated.ogg",{gainMatrix:[[0,0],[0,0],[0,0],[.2,0],[0,0]],baseValue:"base.wind.speed",actualValue:"wind.speed",baseGain:[{position:w.strongBreeze-5,gain:0},{position:w.storm,gain:1},{position:w.storm+10,gain:0}],actualGain:[{position:w.strongBreeze-5,gain:0},{position:w.storm,gain:1},{position:w.storm+10,gain:0}]})})),Hooks.on(i.REG_WEATHER_SFX,(t=>{t.registerSfx("lightRain","modules/"+e.ID+"/assets/light_rain.ogg",{matchAny:{"base.precipitation.type":[m.drizzle,m.rain],"precipitation.type":[m.drizzle,m.rain]},gainMatrix:[[0,1],[0,1],[.3,1],[0,1],[0,1]],baseValue:"base.precipitation.amount",actualValue:"precipitation.amount",baseGain:[{position:.05,gain:0},{position:.3,gain:1},{position:.4,gain:0}],actualGain:[{position:.05,gain:0},{position:.3,gain:1},{position:.4,gain:0}]})})),Hooks.on(i.REG_FX_FILTERS,(async()=>{SceneWeather.registerWeatherFxFilter("lightning",(function(e){let t={};return e.clouds.type>p.cumulus&&[m.rain,m.downpour,m.hail].includes(e.precipitation.type)&&e.precipitation.amount>.3&&(t.lightning={type:FlashFilter,frequency:2e3-S.map(e.precipitation.amount,.3,1,0,1600),duration:100,brightness:1.2},t.cloudcolor={type:ColorFilter,tint:"#D1CBD7",saturation:1,gamma:1,brightness:1,contrast:1}),t}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("nimbus",(function(t){if(T.getSetting("cloudsAlpha",100)<2)return;if(t.clouds.type!=p.cumulunimbus)return null;let a={alpha:T.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:S.map(t.wind.speed,10,70,.2,3),scale:S.map(t.clouds.coverage,.3,1,.8,1),lifetime:1,density:S.map(t.clouds.coverage,.2,1,.005,.02),tint:null};const i=S.deepClone({weight:.9,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.08,max:2.8}},{type:"rotationStatic",config:{min:90,max:90}},{type:"textureRandom",config:{textures:Array.fromRange(4).map((t=>"modules/"+e.ID+`/assets/tcu${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(a,i),i}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("rain",(function(e){if(T.getSetting("precipitationAlpha",100)<2)return;if(![m.drizzle,m.rain,m.downpour,m.hail].includes(e.precipitation.type))return null;let t=90;switch(e.precipitation.mode??"winddir"){case"winddir":default:t=(Math.round(e.wind.direction)+90)%360;break;case"topdown":t=90;break;case"slanted":t=75;break;case"windinfluence":t=90+Math.sin(e.wind.direction*Math.PI/180)*S.map(e.wind.speed,10,70,3,45)}const a={alpha:T.getSetting("precipitationAlpha",100)/100,direction:t,speed:S.map(e.precipitation.amount,.4,.95,.6,2),scale:1,lifetime:S.map(e.precipitation.amount,.4,.95,1,.5),density:S.map(e.precipitation.amount,.4,.95,.01,4),tint:null},i=S.deepClone({weight:.2,lifetime:{min:.5,max:.5},pos:{x:0,y:0},behaviors:[{type:"alpha",config:{alpha:{list:[{time:0,value:.7},{time:1,value:.1}]}}},{type:"moveSpeedStatic",config:{min:2800,max:3500}},{type:"scaleStatic",config:{min:.8,max:1}},{type:"rotationStatic",config:{min:89,max:91}},{type:"textureSingle",config:{texture:"ui/particles/rain.png"}}]});return Generators.applyGeneratorToEmitterConfig(a,i),i}))})),Hooks.on(i.REG_WEATHER_SFX,(t=>{t.registerSfx("rain","modules/"+e.ID+"/assets/rain.ogg",{matchAny:{"base.precipitation.type":[m.drizzle,m.rain,m.downpour],"precipitation.type":[m.drizzle,m.rain,m.downpour]},gainMatrix:[[0,1],[.5,1],[.3,1],[0,1],[0,1]],baseValue:"base.precipitation.amount",actualValue:"precipitation.amount",baseGain:[{position:.2,gain:0},{position:.7,gain:1},{position:.8,gain:0}],actualGain:[{position:.2,gain:0},{position:.7,gain:1},{position:.8,gain:0}]}),t.registerSfx("rainGated","modules/"+e.ID+"/assets/rain_gated.ogg",{matchAny:{"base.precipitation.type":[m.drizzle,m.rain,m.downpour]},gainMatrix:[[0,0],[0,.3],[.5,1],[.3,1],[0,0]],baseValue:"base.precipitation.amount",actualValue:"precipitation.amount",baseGain:[{position:.2,gain:0},{position:.7,gain:1},{position:.8,gain:0}],actualGain:[{position:.2,gain:0},{position:.7,gain:1},{position:.8,gain:0}]})})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("snow",(function(e){if(T.getSetting("precipitationAlpha",100)<2)return;if(![m.snow,m.blizzard].includes(e.precipitation.type))return null;let t=90;switch(e.precipitation.mode??"winddir"){case"winddir":default:t=(Math.round(e.wind.direction)+90)%360;break;case"topdown":t=90;break;case"slanted":t=75;break;case"windinfluence":t=90+Math.sin(e.wind.direction*Math.PI/180)*S.map(e.wind.speed,10,70,10,90)}const a={alpha:T.getSetting("precipitationAlpha",100)/100,direction:t,speed:S.map(e.wind.speed,10,70,.3,5),scale:1,lifetime:S.map(e.precipitation.amount,.4,.95,1,.7),density:S.map(e.precipitation.amount,.4,.95,.01,3),tint:null},i=S.deepClone({weight:.2,lifetime:{min:4,max:4},behaviors:[{type:"alpha",config:{alpha:{list:[{time:0,value:.9},{time:1,value:.5}]}}},{type:"moveSpeed",config:{speed:{list:[{time:0,value:190},{time:1,value:210}]},minMult:.6}},{type:"scale",config:{scale:{list:[{time:0,value:.2},{time:1,value:.4}]},minMult:.5}},{type:"rotation",config:{accel:0,minSpeed:0,maxSpeed:200,minStart:50,maxStart:75}},{type:"textureSingle",config:{texture:"ui/particles/snow.png"}}]});return Generators.applyGeneratorToEmitterConfig(a,i),i}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("stratus",(function(t){if(T.getSetting("cloudsAlpha",100)<2)return;if(![p.stratus,p.cumulus,p.cumulunimbus].includes(t.clouds.type))return null;let a={alpha:T.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:S.map(t.wind.speed,10,100,.2,2.5),scale:S.map(t.clouds.coverage,.3,1,1,2),lifetime:1,density:S.map(t.clouds.coverage,.2,1,.001,.01),tint:null};3==t.clouds.type&&(a.tint="#A0A0A0",a.density=.007,a.scale=1),4==t.clouds.type&&(a.tint="#808080",a.density=.01,a.scale=1.2);const i=S.deepClone({weight:.7,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.58,max:3.3}},{type:"rotationStatic",config:{min:80,max:100}},{type:"textureRandom",config:{textures:Array.fromRange(6).map((t=>"modules/"+e.ID+`/assets/st${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(a,i),i}))})),Hooks.on(i.REG_WEATHER_SFX,(t=>{t.registerSfx("thunder","modules/"+e.ID+"/assets/thunder.ogg",{matchAny:{"base.clouds.type":[p.cumulunimbus],"clouds.type":[p.cumulunimbus],"base.precipitation.type":[m.drizzle,m.rain,m.downpour,m.hail]},gainMatrix:[[0,1],[1,1],[1,1],[.3,1],[0,0]],baseValue:"base.precipitation.amount",actualValue:"precipitation.amount",baseGain:[{position:.35,gain:0},{position:.4,gain:1}],actualGain:[{position:.35,gain:0},{position:.4,gain:1}]}),t.registerSfx("distantThunder","modules/"+e.ID+"/assets/thunder_distant.ogg",{matchAny:{"base.clouds.type":[p.cumulunimbus],"clouds.type":[p.cumulunimbus],"base.precipitation.type":[m.drizzle,m.rain,m.downpour,m.hail]},gainMatrix:[[0,0],[.8,0],[.7,.2],[.5,.5],[.1,.1]],baseValue:"base.precipitation.amount",actualValue:"precipitation.amount",baseGain:[{position:.35,gain:1},{position:.4,gain:0}],actualGain:[{position:.35,gain:1},{position:.4,gain:0}]})})),Hooks.on(i.REG_WEATHER_SFX,(t=>{t.registerSfx("wind","modules/"+e.ID+"/assets/wind.ogg",{gainMatrix:[[0,1],[0,1],[0,1],[0,1],[0,0]],baseValue:"base.wind.speed",actualValue:"wind.speed",baseGain:[{position:w.calm,gain:0},{position:w.strongBreeze,gain:1},{position:w.strongBreeze+10,gain:0}],actualGain:[{position:w.calm,gain:0},{position:w.strongBreeze,gain:1},{position:w.strongBreeze+10,gain:0}]}),t.registerSfx("strongWind","modules/"+e.ID+"/assets/strong_wind.ogg",{gainMatrix:[[0,1],[0,1],[0,1],[.02,1],[0,0]],baseValue:"base.wind.speed",actualValue:"wind.speed",baseGain:[{position:w.freshBreeze,gain:0},{position:w.wholeGale,gain:1},{position:w.wholeGale+10,gain:0}],actualGain:[{position:w.freshBreeze,gain:0},{position:w.wholeGale,gain:1},{position:w.wholeGale+10,gain:0}]})}));class WeatherNodeGraphics extends PIXI.Container{_weatherNode;_area;constructor(e){super(),this._weatherNode=e,this._area=this.addChild(new PIXI.Graphics)}draw(){}refresh(){this._weatherNode.data.type===o.MASK?this._refreshMask():this._weatherNode.data.type===o.EMITTER&&this._refreshEmitter()}_refreshMask(){this._area.clear(),this._area.lineStyle(1,this._weatherNode.data.maskColor),this._area.beginFill(this._weatherNode.data.maskColor,.5),this._area.moveTo(this._weatherNode.data.borderNodes[0].x,this._weatherNode.data.borderNodes[0].y);for(let e=0;e<this._weatherNode.data.borderNodes.length;e++){const t=this._weatherNode.data.borderNodes[(e+1)%this._weatherNode.data.borderNodes.length];this._area.lineTo(t.x,t.y)}this._area.endFill()}_refreshEmitter(){}}class TrackableArray{constructor(e){const t=this;this.modified=!1;return new Proxy(e,{set(e,a,i,r){const n=e[a];return i===n||Number.isNaN(i)&&Number.isNaN(n)||("object"==typeof i&&null!==i&&(i=new TrackableArray(i)),e[a]=i,t.modified=!0),!0},deleteProperty:(e,a)=>(a in e&&(delete e[a],t.modified=!0),!0),apply(e,a,i){const r=i[0];return["push","pop","shift","unshift","splice"].includes(r)&&(t.modified=!0),Reflect.apply(e,a,i)},get(e,a,i){if("changed"===a)return()=>t.modified||e.some((e=>e instanceof TrackableArray&&e.changed()));const r=Reflect.get(e,a,i);return"object"==typeof r&&null!==r?new TrackableArray(r):r}})}}class WeatherNodeData{static defaultSchema={type:"number",initial:0,validation:e=>!0};static metadata={x:{},y:{},z:{},width:{},height:{},borderNodes:{type:"Array",initial:new TrackableArray([])},locked:{type:"boolean",initial:!1},enabled:{type:"boolean",initial:!0},feather:{type:"number",initial:0,validation:e=>Number.between(e,0,100,!0)},type:{initial:o.MASK,validation:e=>Number.between(e,0,1,!0)},mask:{initial:d.outside,validation:e=>Number.between(e,0,4,!0)}};_source={};_persisted=!1;constructor(e){this._source=e,Object.keys(this.constructor.metadata).forEach((e=>{const t=S.mergeObject(S.deepClone(this.constructor.defaultSchema),this.constructor.metadata[e]),a=t.type;Object.defineProperty(this,e,{get(){return e in this._source?this._source[e]:t.initial},set(i){if(getType(i)!=a)throw new Error("Invalid type ["+getType(i)+"] while trying to set field ["+e+"] of type ["+t.type+"].");const r=e in this._source?this._source[e]:t.initial;this._persisted=this._persisted&&r==i,this._source[e]=i},enumerable:!0,configurable:!0})}))}get persisted(){return this._persisted&&""!=this._source._id}get id(){return this._source._id||"preview"}get maskColor(){return c[this.mask]||c[0]}static defaultSource(){let e={_id:""};return Object.keys(WeatherNodeData.metadata).forEach((t=>{const a=S.mergeObject(S.deepClone(WeatherNodeData.defaultSchema),WeatherNodeData.metadata[t]);e[t]=a.initial})),e}static newDefaultBorderPointAt({x:e=0,y:t=0,permeable:a=0}={}){return{x:e,y:t,permeable:a}}static async create(e=null,t=!1){const a=t?e._id:randomID();let i=S.mergeObject(S.deepClone(WeatherNodeData.defaultSource()),{_id:a});e&&(delete e._id,i=S.mergeObject(i,e,{insertKeys:!1,enforceTypes:!0}));const r=new WeatherNodeData(i);return Logger.info("Created WeatherNode with id ["+r.id+"] in parent Scene ["+T.getScene().id+"]"),await r.update(),r}static newVolatileMaskAt({x:e=0,y:t=0}={}){const a=S.deepClone(WeatherNodeData.defaultSource());return a.borderNodes.push(WeatherNodeData.newDefaultBorderPointAt({x:e,y:t}),WeatherNodeData.newDefaultBorderPointAt({x:e,y:t})),new WeatherNodeData(a)}static loadAll(){const e=T.getSceneFlag("nodes",{});return Object.values(e).map((e=>new WeatherNodeData(e)))}static async deleteAll(){const e=Object.keys(T.getSceneFlag("nodes",{}));return Logger.info("Deleted all WeatherNodes in parent Scene ["+T.getScene().id+"]"),await T.unsetSceneFlag("nodes"),e}static load(e){const t=T.getSceneFlag("nodes",{});return e in t?new WeatherNodeData(t[e]):void 0}_isPolygonValid(e){const t=this.borderNodes.length,a=[];for(let e=0;e<t;e++){const i=this.borderNodes[e],r=this.borderNodes[(e+1)%t];a.push({p1:i,p2:r})}if(t>3)for(let e=0;e<t;e++){const i=a[e],r=Array.from({length:t-3},((a,i)=>(e+i+2)%t));for(let e=0;e<r.length;e++){const t=a[r[e]];if(this._doSegmentsIntersect(i.p1,i.p2,t.p1,t.p2))return!1}}for(let i=0;i<t;i++)for(let r=0;r<t;r++){if(i!==r&&r!==(i-1+t)%t){const t=a[r];if(this._pointToLineDistance(this.borderNodes[i].x,this.borderNodes[i].y,t.p1.x,t.p1.y,t.p2.x,t.p2.y)<e)return!1}}return!0}_doSegmentsIntersect(e,t,a,i){const r=t.x-e.x,n=t.y-e.y,o=i.x-a.x,s=i.y-a.y,d=o*n-s*r;if(0===d)return!1;const c=(r*(a.y-e.y)+n*(e.x-a.x))/d,l=(o*(e.y-a.y)+s*(a.x-e.x))/-d;return c>=0&&c<=1&&l>=0&&l<=1}_pointToLineDistance(e,t,a,i,r,n){const o=r-a,s=n-i,d=((e-a)*o+(t-i)*s)/(o*o+s*s);let c,l;d<0?(c=a,l=i):d>1?(c=r,l=n):(c=a+d*o,l=i+d*s);const h=e-c,g=t-l;return Math.sqrt(h*h+g*g)}setLastBorderNode(e,t){return this.setBorderNode(e,t,-1)}setBorderNode(e,t=-1,a){const i=this.borderNodes.at(a).x,r=this.borderNodes.at(a).y;return this.borderNodes.at(a).x=e.x-this.x,this.borderNodes.at(a).y=e.y-this.y,-1==t||(!!this._isPolygonValid(t)||(Logger.debug("invalid polygon shape"),this.borderNodes.at(a).x=i,void(this.borderNodes.at(a).y=r)))}addBorderNode(e,t){const a=this.borderNodes.at(-1);return this.borderNodes.push({x:e.x-this.x,y:e.y-this.y,permeable:0}),!!this._isPolygonValid(t)||(Logger.debug("WeatherNodeData.addBorderNode(...)  -> invalid polygon",{position:e}),this.borderNodes.at(-1).x=a.x,this.borderNodes.at(-1).y=a.y,!1)}normalize(e=!0){if(this.borderNodes.length>2){const e=this.borderNodes.map((e=>({x:e.x,y:e.y})));for(let t=0;t<e.length-2;t++){const a=e[t],i=e[(t+1)%e.length];a.x===i.x&&a.y===i.y&&this.borderNodes.splice(t,1)}}const t=this.borderNodes.reduce(((e,t)=>t.x<e?t.x:e),this.borderNodes[0].x),a=this.borderNodes.reduce(((e,t)=>t.y<e?t.y:e),this.borderNodes[0].y),i=this.borderNodes.reduce(((e,t)=>t.x>e?t.x:e),this.borderNodes[0].x),r=this.borderNodes.reduce(((e,t)=>t.y>e?t.y:e),this.borderNodes[0].y);for(let e=0;e<this.borderNodes.length;e++)this.borderNodes[e].x=this.borderNodes[e].x-t,this.borderNodes[e].y=this.borderNodes[e].y-a;return this.x+=t,this.y+=a,this.width=i-t,this.height=r-a,e&&this.update(),this}dimensionsFrom(e){this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height}async delete(){if(""==this._source._id)return;let e=T.getSceneFlag("nodes",{});this._source._id in e&&(delete e[this._source._id],Logger.info("Deleted WeatherNode with id ["+this._source._id+"] in parent Scene ["+T.getScene().id+"]"),await T.unsetSceneFlag("nodes"),await T.setSceneFlag("nodes",e)),this._source._id="",this._persisted=!0}clone(){let e=S.deepClone(this._source);return e._id="",new WeatherNodeData(e)}toObject(){return S.deepClone(this._source)}async update(){if(this.persisted)return;if(""==this._source._id)return;let e=T.getSceneFlag("nodes",{});e[this._source._id]=this._source,await T.setSceneFlag("nodes",e),this._persisted=!0}}class AbstractWeatherNode extends PIXI.Container{static weatherNodeType="WeatherNode";_nodeGraphic;_nodeData;hover=!1;controlled=!1;_original;_dragPassthrough=!1;constructor(e){super(),this.visible=!1,this.controlled=!1,this._nodeData=e,this._nodeData.normalize(),this._nodeGraphic=this.addChild(new WeatherNodeGraphics(this))}get data(){return this._nodeData}get id(){return this.constructor.weatherNodeType+this.data.id}get bounds(){Logger.trace("WeatherNode.bounds > get");const{x:e,y:t,width:a,height:i}=this.data;return new PIXI.Rectangle(e,t,a,i).normalize()}get center(){Logger.trace("WeatherNode.center > get");const{x:e,y:t,width:a,height:i}=this.data;return new PIXI.Point(e+a/2,t+i/2)}async draw(){return this.visible=!0,this.refresh(),Hooks.callAll(i.DRAW_WEATHER_NODE,this),this.id!=this.constructor.weatherNodeType+".preview"&&(this.interactive=!0,this.buttonMode=!0,this.activateListeners()),this}clone(){const e=this.data.clone(),t=new this.constructor(e);return t._original=this,t.interactive=!1,t.controlled=this.controlled,t}control(e={}){if(!1!==e.releaseOthers)for(const e of canvas.sceneweather.controlled)e!==this&&e.release();return this.controlled||"preview"==this._nodeData.id||(this.controlled=!0,canvas.sceneweather.controlledNodes.set(this.id,this),this.refresh(),Hooks.callAll(i.CONTROL_WEATHER_NODE,this,this.controlled)),!0}release(e={}){return canvas.sceneweather.controlledNodes.delete(this.id),!this.controlled||(this.controlled=!1,canvas.sceneweather.hud&&canvas.sceneweather.hud.weatherNode===this&&canvas.sceneweather.hud.clear(),this.refresh(),Hooks.callAll(i.CONTROL_WEATHER_NODE,this,this.controlled),!0)}async creationDragLeftMove(e,t){throw new Error("abstract method creationDragLeftMove needs to be implemented by inheriting class")}async creationDragLeftDrop(e,t){throw new Error("abstract method creationDragLeftDrop needs to be implemented by inheriting class")}async creationClickLeft2(e,t){throw new Error("abstract method creationClickLeft2 needs to be implemented by inheriting class")}filterWeatherModel(e,t){throw new Error("abstract method filterWeatherModel needs to be implemented by inheriting class")}showConfigApp(e){throw new Error("abstract method showConfigApp needs to be implemented by inheriting class")}activateListeners(){throw new Error("abstract method activateListeners needs to be implemented by inheriting class")}coversPoint(e,t){throw new Error("abstract method coversPoint needs to be implemented by inheriting class")}destroy(){canvas.sceneweather.hud&&canvas.sceneweather.hud.weatherNode===this&&canvas.sceneweather.hud.clear(),super.destroy()}refresh(){this._nodeGraphic.refresh();const{enabled:e,locked:t}=this.data;this.controlled&&!t&&this._refreshHud(),canvas.sceneweather._nodeFrame.refresh(),this.alpha=e?1:.5,this._setPosition()}_setPosition(){const{x:e,y:t,z:a,width:i,height:r}=this.data;this.pivot.set(i/2,r/2),this.position.set(e+this.pivot.x,t+this.pivot.y),this.zIndex=a,this.angle=0,this.visible=!0}_refreshHud(){const e=canvas.sceneweather.hud;e&&e.weatherNode==this&&e.setPosition()}async _onShift(e){throw new Error("abstract method _onShift needs to be implemented by inheriting class")}async _onShiftRelease(e){throw new Error("abstract method _onShiftRelease needs to be implemented by inheriting class")}async _onDragLeftStart(e){if(Logger.trace("WeatherNode._onDragLeftStart(...)",{event:e,this:this}),this._nodeData.locked)return this._dragPassthrough=!0,canvas._onDragLeftStart(e);const t=canvas.sceneweather.controlled,a=[];for(let e of t){if(e._nodeData.locked)continue;const t=e.clone();e._preview=t,a.push(t),t.draw().then((e=>{canvas.sceneweather.preview.addChild(e),e._onDragStart()}))}e.data.clones=a}_onDragStart(){this.alpha=.8,this._original.alpha=.4,this.visible=!0}_onDragEnd(){Logger.trace("WeatherNode._onDragEnd(...)",{this:this}),this.visible=!1,this._original&&(this._original.data.locked&&(this._original.data.locked=!1),this._original.data.update(),this._original.alpha=1)}_onDragLeftMove(e){if(!this.controlled)return;if(this._dragPassthrough)return canvas._onDragLeftMove(e);let{clones:t,destination:a,origin:i,originalEvent:r}=e.data;canvas._onDragCanvasPan(r),canvas.sceneweather.snapToGrid&&!r.ctrlKey&&(i=canvas.grid.getSnappedPosition(i.x,i.y,canvas.sceneweather.gridPrecision),a=canvas.grid.getSnappedPosition(a.x,a.y,canvas.sceneweather.gridPrecision));const n=a.x-i.x,o=a.y-i.y;for(let e of t||[]){const t=e.data.toObject();e.data.dimensionsFrom(e._original.data),e.data.x=e._original.data.x+n,e.data.y=e._original.data.y+o,e.data.normalize();const a=canvas.dimensions.rect;e.data.x>=a.x&&e.data.x+e.data.width<=a.x+a.width&&e.data.y>=a.y&&e.data.y+e.data.height<=a.y+a.height?e.refresh():e.data.dimensionsFrom(t)}}async _onDragLeftDrop(e){if(this._dragPassthrough)return this._dragPassthrough=!1,canvas._onDragLeftDrop(e);const{clones:t,destination:a,originalEvent:i}=e.data;if(!t||!canvas.dimensions.rect.contains(a.x,a.y))return!1;const r=t.map((e=>{let t={x:e.data.x,y:e.data.y};return canvas.sceneweather.snapToGrid&&!i.ctrlKey&&(t=canvas.grid.getSnappedPosition(e.data.x,e.data.y,canvas.sceneweather.gridPrecision)),e.data.x=t.x,e.data.y=t.y,e.data.normalize(),{id:e._original.id,x:e.data.x,y:e.data.y,width:e.data.width,height:e.data.height}}));return canvas.sceneweather.updateNodes(r)}_onDragLeftCancel(e){if(Logger.trace("WeatherNode._onDragLeftCancel(...)",{this:this}),this._dragPassthrough)return this._dragPassthrough=!1,canvas._onDragLeftCancel(e);canvas.sceneweather.clearPreviewContainer(),this.refresh()}_onHoverIn(e,{hoverOutOthers:t=!0}={}){if(t)for(const t of canvas.sceneweather.nodes)t!==this&&t._onHoverOut(e);this.hover=!0,Hooks.callAll("hoverWeatherNode",this,this.hover)}_onHoverOut(e){this.hover=!1,Hooks.callAll("hoverWeatherNode",this,this.hover)}_onClickLeft(e){if(Logger.trace("WeatherNode._onClickLeft("+canvas.sceneweather.createState+")"),canvas.sceneweather.createState>r.NONE)return;const t=canvas.sceneweather.hud;t&&t.clear();const a=e.data.originalEvent;if(!this.controlled)return this.control({releaseOthers:!a.shiftKey});if(a.shiftKey&&null==this._shadowBorderNode){if(!e.data.nodeAdded)return this.release();delete e.data.nodeAdded}}_onClickRight(e){const t=canvas.sceneweather.hud;if(t){const a=!this.controlled&&!e.data.originalEvent.shiftKey;this.control({releaseOthers:a}),t.weatherNode===this?t.clear():t.bind(this)}}}class DashLine{static dashTextureCache={};constructor(e,t){this.cursor=new PIXI.Point,this.scale=1,this.graphics=e,t=S.mergeObject({dash:[10,5],width:1,color:16777215,alpha:1,scale:1,useTexture:!1,alignment:.5},t),this.dash=t.dash,this.dashSize=this.dash.reduce((function(e,t){return e+t})),this.useTexture=t.useTexture,this.options=t,this._setLineStyle()}static distance(e,t,a,i){return Math.sqrt(Math.pow(a-e,2)+Math.pow(i-t,2))}static getTexture(e,t){var a=e.dash.toString();if(DashLine.dashTextureCache[a])return DashLine.dashTextureCache[a];var i=document.createElement("canvas");i.width=t,i.height=Math.ceil(e.width);var r=i.getContext("2d");if(r){r.strokeStyle="white",r.globalAlpha=e.alpha,r.lineWidth=e.width;var n=0,o=e.width/2;r.moveTo(n,o);for(var s=0;s<e.dash.length;s+=2)n+=e.dash[s],r.lineTo(n,o),e.dash.length!==s+1&&(n+=e.dash[s+1],r.moveTo(n,o));r.stroke();var d=DashLine.dashTextureCache[a]=PIXI.Texture.from(i);return d.baseTexture.scaleMode=PIXI.SCALE_MODES.NEAREST,d}Logger.warn("Did not get context from canvas")}_setLineStyle(){const e=this.options;if(this.useTexture){const t=DashLine.getTexture(e,this.dashSize);this.graphics.lineTextureStyle({width:e.width*e.scale,color:e.color,alpha:e.alpha,texture:t,alignment:e.alignment}),this.activeTexture=t}else this.graphics.lineStyle({width:e.width*e.scale,color:e.color,alpha:e.alpha,cap:e.cap,join:e.join,alignment:e.alignment});this.scale=e.scale}_adjustLineStyle(e){var t=this.graphics.line;t.matrix=new PIXI.Matrix,e&&t.matrix.rotate(e),1!==this.scale&&t.matrix.scale(this.scale,this.scale);var a=-this.lineLength;t.matrix.translate(this.cursor.x+a*Math.cos(e),this.cursor.y+a*Math.sin(e)),this.graphics.lineStyle(t)}moveTo(e,t){return this.lineLength=0,this.cursor.set(e,t),this.start=new PIXI.Point(e,t),this.graphics.moveTo(this.cursor.x,this.cursor.y),this}lineTo(e,t,a){void 0===typeof this.lineLength&&this.moveTo(0,0);const i=DashLine.distance(this.cursor.x,this.cursor.y,e,t),r=Math.atan2(t-this.cursor.y,e-this.cursor.x),n=a&&e===this.start.x&&t===this.start.y;if(this.useTexture)if(this.graphics.moveTo(this.cursor.x,this.cursor.y),this._adjustLineStyle(r),n&&this.dash.length%2==0){const a=Math.min(this.dash[this.dash.length-1],i);this.graphics.lineTo(e-Math.cos(r)*a,t-Math.sin(r)*a),this.graphics.closePath()}else this.graphics.lineTo(e,t);else{const e=Math.cos(r),t=Math.sin(r);var o=this.cursor.x,s=this.cursor.y;const a=this.lineLength%(this.dashSize*this.scale);for(var d=0,c=0,l=0,h=0;h<this.dash.length;h++){const e=this.dash[h]*this.scale;if(a<l+e){d=h,c=a-l;break}l+=e}for(var g=i;g>0;){const a=this.dash[d]*this.scale-c;var u=g>a?a:g;if(n)if(DashLine.distance(o+e*u,s+t*u,this.start.x,this.start.y)<=u){if(d%2==0){var m=DashLine.distance(o,s,this.start.x,this.start.y)-this.dash[this.dash.length-1]*this.scale;o+=e*m,s+=t*m,this.graphics.lineTo(o,s)}break}o+=e*u,s+=t*u,d%2?this.graphics.moveTo(o,s):this.graphics.lineTo(o,s),g-=u,d=++d===this.dash.length?0:d,c=0}}return this.lineLength+=i,this.cursor.set(e,t),this}closePath(){this.lineTo(this.start.x,this.start.y,!0)}drawCircle(e,t,a,i=80,r){const n=2*Math.PI/i;var o,s=0;r?(o=new PIXI.Point(e+Math.cos(s)*a,t+Math.sin(s)*a),r.apply(o,o),this.moveTo(o[0],o[1])):(o=new PIXI.Point(e+Math.cos(s)*a,t+Math.sin(s)*a),this.moveTo(o.x,o.y)),s+=n;for(var d=1;d<i+1;d++){const r=d===i?o:[e+Math.cos(s)*a,t+Math.sin(s)*a];this.lineTo(r[0],r[1]),s+=n}return this}drawEllipse(e,t,a,i,r=80,n){const o=2*Math.PI/r;for(var s,d=new PIXI.Point,c=0;c<2*Math.PI;c+=o){var l=e-a*Math.sin(c),h=t-i*Math.cos(c);n&&(d.set(l,h),n.apply(d,d),l=d.x,h=d.y),0===c?(this.moveTo(l,h),s={x:l,y:h}):this.lineTo(l,h)}return this.lineTo(s.x,s.y,!0),this}drawPolygon(e,t){var a=new PIXI.Point;if("number"==typeof e[0])if(t){a.set(e[0],e[1]),t.apply(a,a),this.moveTo(a.x,a.y);for(var i=2;i<e.length;i+=2)a.set(e[i],e[i+1]),t.apply(a,a),this.lineTo(a.x,a.y,i===e.length-2)}else{this.moveTo(e[0],e[1]);for(i=2;i<e.length;i+=2)this.lineTo(e[i],e[i+1],i===e.length-2)}else if(t){var r=e[0];a.copyFrom(r),t.apply(a,a),this.moveTo(a.x,a.y);for(i=1;i<e.length;i++){var n=e[i];a.copyFrom(n),t.apply(a,a),this.lineTo(a.x,a.y,i===e.length-1)}}else{r=e[0];this.moveTo(r.x,r.y);for(i=1;i<e.length;i++){var o=e[i];this.lineTo(o.x,o.y,i===e.length-1)}}return this}drawRect(e,t,a,i,r){if(r){var n=new PIXI.Point;n.set(e,t),r.apply(n,n),this.moveTo(n.x,n.y),n.set(e+a,t),r.apply(n,n),this.lineTo(n.x,n.y),n.set(e+a,t+i),r.apply(n,n),this.lineTo(n.x,n.y),n.set(e,t+i),r.apply(n,n),this.lineTo(n.x,n.y),n.set(e,t),r.apply(n,n),this.lineTo(n.x,n.y,!0)}else this.moveTo(e,t).lineTo(e+a,t).lineTo(e+a,t+i).lineTo(e,t+i).lineTo(e,t,!0);return this}}class BorderHandle extends PIXI.Graphics{_weatherNode;_borderNr;hover=!1;_newNodePosition={};_lw=3;mouseInteractionManager=null;constructor(e,t){super(),this._weatherNode=e,this._borderNr=t,canvas.dimensions.size>150?this._lw=7:canvas.dimensions.size>100&&(this._lw=5),this.buttonMode=!0,this.refresh()}refresh(){const e=this._weatherNode.data.borderNodes[this._borderNr],t=this._weatherNode.data.borderNodes[(this._borderNr+1)%this._weatherNode.data.borderNodes.length],a=this._weatherNode.data.maskColor;this._newNodePosition.x=(e.x+t.x)/2,this._newNodePosition.y=(e.y+t.y)/2,this._newNodePosition.permeable=e.permeable,this._newNodePosition.d=null;const i=this.hover?1.5:1,r=3*this._lw,o=5*this._lw,s=6*this._lw;switch(this.clear(),e.permeable){default:case n.SOLID:this.lineStyle(3*this._lw*i,0,1).moveTo(e.x,e.y).lineTo(t.x,t.y),this.lineStyle(this._lw*i,a,1).lineTo(e.x,e.y,10,3);break;case n.PERMEABLE:new DashLine(this,{dash:[s,r,r,r,s],width:r*i,scale:1,useTexture:false,color:0,alignment:.5}).moveTo(e.x,e.y).lineTo(t.x,t.y);new DashLine(this,{dash:[o,o,this._lw,o,o],width:this._lw*i,scale:1,useTexture:false,color:a,alignment:.5}).moveTo(e.x,e.y).lineTo(t.x,t.y)}this.hitArea=this._getWallHitPolygon(e,t,.5*canvas.dimensions.size)}getNewNodePosition(){return this._newNodePosition}getPositionOnBorder(e){e.x-=this._weatherNode.data.x,e.y-=this._weatherNode.data.y;const t=this._weatherNode.data.borderNodes[this._borderNr],a=this._weatherNode.data.borderNodes[(this._borderNr+1)%this._weatherNode.data.borderNodes.length],i=a.x-t.x,r=a.y-t.y,n=i*i+r*r,o=(i*(e.x-t.x)+r*(e.y-t.y))/n;return{x:t.x+o*i,y:t.y+o*r,permeable:t.permeable}}activateListeners(){const e=S.createInteractionManager(this,{hoverIn:this._onHoverIn,hoverOut:this._onHoverOut,clickLeft:this._onClickLeft});this.mouseInteractionManager=e.activate(),this.off("mousemove").on("mousemove",this._onMouseMove.bind(this)),this.interactive=!0}_getWallHitPolygon(e,t,a){const i=this._shortenLine(e,t,a/2);e=i.startPoint;const r=(t=i.endPoint).x-e.x,n=t.y-e.y;if(Math.sqrt(r*r+n*n)<a)return new PIXI.Polygon;const o=a/2,s=Math.atan2(n,r)+Math.PI/2,d=e.x+o*Math.cos(s),c=e.y+o*Math.sin(s),l=t.x+o*Math.cos(s),h=t.y+o*Math.sin(s),g=t.x-o*Math.cos(s),u=t.y-o*Math.sin(s),m=e.x-o*Math.cos(s),p=e.y-o*Math.sin(s);return new PIXI.Polygon(d,c,l,h,g,u,m,p)}_shortenLine(e,t,a){const i=t.x-e.x,r=t.y-e.y,n=Math.sqrt(i*i+r*r),o=Math.atan2(r,i),s=n-2*a,d=Math.cos(o)*s,c=Math.sin(o)*s,l={x:e.x+a*Math.cos(o),y:e.y+a*Math.sin(o)};return{startPoint:l,endPoint:{x:l.x+d,y:l.y+c}}}_angleBetweenLines(e,t,a){const i=t.x-e.x,r=t.y-e.y,n=a.x-e.x,o=a.y-e.y,s=(i*n+r*o)/(Math.sqrt(i*i+r*r)*Math.sqrt(n*n+o*o));return 180*Math.acos(s)/Math.PI}_onAddNode(e){this.hover=!1;const t=this._weatherNode.data.clone();t.borderNodes.splice(this._borderNr+1,0,WeatherNodeData.newDefaultBorderPointAt(this._newNodePosition)),t.normalize();const a={id:this._weatherNode.id,borderNodes:t.borderNodes};this._weatherNode._shadowBorderNode&&(this._weatherNode.removeChild(this._weatherNode._shadowBorderNode),this._weatherNode._shadowBorderNode=null),canvas.sceneweather.updateNodes([a]),e.data.nodeAdded=!0,e.data.originalEvent.preventDefault()}_onToggleBorder(){const e=this._weatherNode.data.clone();switch(e.borderNodes[this._borderNr].permeable){default:case n.SOLID:e.borderNodes[this._borderNr].permeable=n.PERMEABLE;break;case n.PERMEABLE:e.borderNodes[this._borderNr].permeable=n.SOLID}const t={id:this._weatherNode.id,borderNodes:e.borderNodes};canvas.sceneweather.updateNodes([t])}_onHoverIn(e){if(canvas.sceneweather.borderNodeControl)return;const t=e.data.getLocalPosition(canvas.sceneweather);this._newNodePosition=this.getPositionOnBorder(t);const a=t.x-this._newNodePosition.x,i=t.y-this._newNodePosition.y;this._newNodePosition.d=Math.sqrt(a*a+i*i),e.data.originalEvent.shiftKey&&this._weatherNode._onShift(e),e.data.borderHandle=e.target,this.hover=!0,this.refresh()}_onHoverOut(e){canvas.sceneweather.borderNodeControl||(this._weatherNode._onShiftRelease(e),this.hover=!1,this.refresh())}_onClickLeft(e){const{originalEvent:t}=e.data;this.hover&&(canvas.sceneweather.borderNodeControl||(t.shiftKey&&this._weatherNode._shadowBorderNode&&this._weatherNode._shadowBorderNode.hover?this._onAddNode(e):this._onToggleBorder()))}_onMouseMove(e){if(!this.hover)return;if(canvas.sceneweather.borderNodeControl)return;if(S.throttleInteractivity(this))return;const t=e.data.getLocalPosition(canvas.sceneweather);this._newNodePosition=this.getPositionOnBorder(t);const a=t.x-this._newNodePosition.x,i=t.y-this._newNodePosition.y;this._newNodePosition.d=Math.sqrt(a*a+i*i)}}class BorderNodeHandle extends PIXI.Graphics{_weatherNode;_borderNodeNr;_originNode;_maskType;_borderNodePosition={x:0,y:0,d:null};hover=!1;mouseInteractionManager=null;constructor(e=null,{borderNodeNr:t=-1,position:a={}}={}){super(),-1==t&&null==e?(this._borderNodePosition=a,this._weatherNode=null,this._borderNodeNr=-1,this.alpha=.5,this._maskType=-1):(this._weatherNode=e,this._borderNodeNr=t,this._maskType=this._weatherNode.data.mask),this._drawHandle()}get lw(){return canvas.dimensions.size>150?7:canvas.dimensions.size>100?5:3}get isShadow(){return null==this._weatherNode&&-1==this._borderNodeNr}refresh(){if(-1!=this._maskType&&this._maskType!=this._weatherNode.data.mask&&(this._maskType=this._weatherNode.data.mask,this._drawHandle()),this.isShadow){this.position.set(this._borderNodePosition.x,this._borderNodePosition.y);(this._borderNodePosition.d||9e3)<4*this.lw?(this.alpha=1,this.hover=!0,this.scale.set(1.5,1.5)):(this.alpha=.5,this.hover=!1,this.scale.set(1,1))}else{const e=this._weatherNode.data.borderNodes[this._borderNodeNr];this.position.set(e.x,e.y)}this.hitArea=new PIXI.Rectangle(-16,-16,32,32)}setPosition({x:e,y:t,d:a=null}={}){this._borderNodePosition.x=e,this._borderNodePosition.y=t,this._borderNodePosition.d=a}activateListeners(){const e=S.createInteractionManager(this,{hoverIn:this._onHoverIn,hoverOut:this._onHoverOut,clickRight:this._onClickRight,dragLeftStart:this._onDragLeftStart,dragLeftMove:this._onDragLeftMove,dragLeftDrop:this._onDragLeftDrop,dragLeftCancel:this._onDragLeftCancel});this.mouseInteractionManager=e.activate(),this.interactive=!0}_drawHandle(){const e=-1==this._maskType?16777215:this._weatherNode.data.maskColor,t=this.lw,a=this.hover?4*t:3*t;this.lineStyle(t,0,1).beginFill(e,1).drawCircle(0,0,a).endFill(),this.buttonMode=!0}_assumeControl(){canvas.sceneweather.borderNodeControl={id:this._weatherNode.id,nodeNr:this._borderNodeNr}}_yieldControl(){return!!this._canControl()&&(canvas.sceneweather.borderNodeControl=null,!0)}_isInControl(){if(canvas.sceneweather.borderNodeControl){const{id:e,nodeNr:t}=canvas.sceneweather.borderNodeControl;return e==this._weatherNode.id&&t==this._borderNodeNr}return!1}_canControl(){return!canvas.sceneweather.borderNodeControl||this._isInControl()}_onHoverIn(e){if(!this._canControl())return;e.target.scale.set(1.5,1.5),e.data.borderNodeHandle=e.target,this.hover=!0}_onHoverOut(e){if(this._isInControl())return;const{borderNodeHandle:t}=e.data;t.scale.set(1,1),this.hover=!1}_onDragLeftStart(e){this._canControl()&&(this.isShadow||(this.scale.set(1.5,1.5),this.hover=!0,this._originNode=this._weatherNode.data.toObject(),this._assumeControl()))}_onDragLeftMove(e){if(!this._isInControl())return;if(this.isShadow)return;if(S.throttleInteractivity(this))return;let{destination:t,originalEvent:a}=e.data;canvas.sceneweather.snapToGrid&&!a.ctrlKey&&(t=canvas.grid.getSnappedPosition(t.x,t.y,canvas.sceneweather.gridPrecision)),canvas._onDragCanvasPan(a),this._weatherNode.data.setBorderNode(t,.5*canvas.dimensions.size,this._borderNodeNr),this._weatherNode.data.normalize(!1),this._weatherNode.refresh()}_onDragLeftDrop(e){if(!this._isInControl())return;if(this.isShadow)return;const t=this._weatherNode.data.clone(),a={id:this._weatherNode.id,borderNodes:t.borderNodes};this._weatherNode.data.setBorderNode({x:this._originNode.borderNodes[this._borderNodeNr].x+this._originNode.x,y:this._originNode.borderNodes[this._borderNodeNr].y+this._originNode.y},.5*canvas.dimensions.size,this._borderNodeNr),canvas.sceneweather.updateNodes([a]),delete e.data._borderNodePosition,this._onHoverOut(e),this._yieldControl(),this._originNode=null}_onDragLeftCancel(e){this._originNode&&this._canControl()&&(this.isShadow||(this._weatherNode.data.setBorderNode({x:this._originNode.borderNodes[this._borderNodeNr].x+this._originNode.x,y:this._originNode.borderNodes[this._borderNodeNr].y+this._originNode.y},.5*canvas.dimensions.size,this._borderNodeNr),this._weatherNode.data.normalize(!1),this.scale.set(1,1),this.hover=!1,this._yieldControl(),this._weatherNode.refresh()))}_onClickRight(e){if(this._canControl()&&!this.isShadow){if(this._weatherNode.data.borderNodes.length>3){const t=this._weatherNode.data.clone();if(t.borderNodes.splice(this._borderNodeNr,1),t.normalize(),t._isPolygonValid(.5*canvas.dimensions.size)){this._yieldControl();const a=t.toObject();a.id=this._weatherNode.id,delete a._id,canvas.sceneweather.updateNodes([a]),delete e.data.borderNodeHandle}else Logger.info("Removing this BorderNode would result in an invalid shape. Please move this or another BorderNode first before trying to remove it again.",!0)}else Logger.info("A WeatherNodeMask needs to have at least 3 BorderNodes in the shape. You can remove the entire mask by selecting it and pressing the delete key.",!0)}}}class EmitterWeatherNode extends AbstractWeatherNode{constructor(e){super(e)}static createEmitterNodeAt(e){throw Error("Creating an Emitter Weather Node is not implemented yet.")}filterWeatherModel(e,t){return this.data.type==NODE_TYPE.EMITTER?this._filterWeatherModelEmitter(e,t):e}showConfigApp(e){}activateListeners(){}coversPoint(e,t){return!1}destroy(){super.destroy()}refresh(){super.refresh()}creationDragLeftMove(e,t){return e}async _onShift(e){}async _onShiftRelease(e){}_filterWeatherModelEmitter(e,t){}}class WeatherNodeConfig extends FormApplication{constructor(e,t={}){super(e,t),this.weatherNode=e}get title(){const e=["dialogs.weatherNodeConfig.titleMask","dialogs.weatherNodeConfig.titleEmitter"];return T.i18n(e[this.weatherNode.data.type]||e[0])}get id(){return this.weatherNode.id}get isEditable(){return this.options.editable&&!this.weatherNode.data.locked}static get defaultOptions(){return S.mergeObject(super.defaultOptions,{classes:["sheet"],template:"modules/"+e.ID+"/templates/weatherNodeConfig.hbs",viewPermission:Permissions.hasPermission(T.userID(),"sceneSettings"),id:"weather-node-config",width:480,height:"auto",tabs:[{navSelector:".tabs",contentSelector:"form",initial:"form"}]})}async close(e){await super.close(e),delete canvas.sceneweather.apps?.[this.id]}getData(e={}){const[t]=Object.entries(o).find((([,e])=>e===this.weatherNode.data.type));let a={x:this.weatherNode.data.x,y:this.weatherNode.data.y,z:this.weatherNode.data.z,enabled:this.weatherNode.data.enabled,type:t.toLowerCase()||"unknown"};if(this.weatherNode.data.type===o.MASK){const[e]=Object.entries(d).find((([,e])=>e===this.weatherNode.data.mask));a.mask=e||"outside";const t=Object.keys(d).map((e=>({id:e,name:"dialogs.weatherNodeConfig.maskType."+e})));a.masks=t,a.feather=this.weatherNode.data.feather}return{id:this.id,appId:this.appId,data:a}}activateListeners(e){super.activateListeners(e)}render(e=!1,t={}){return canvas.sceneweather.apps[this.id]=this,super.render(e,t)}async _renderOuter(){const e=await super._renderOuter();return this._injectWeatherNodeHeader(e),e}_injectWeatherNodeHeader(e){const t=e.find(".window-title"),a=this.weatherNode.data.enabled?'<i class="fa-solid fa-eye"></i> ':'<i class="fa-solid fa-eye-slash"></i> ',i=this.weatherNode.data.locked?'<i class="fa-solid fa-lock"></i> ':'<i class="fa-solid fa-lock-open"></i> ';t.prepend(a),t.prepend(i);const r="WeatherNode",n=document.createElement("a");n.classList.add("document-id-link"),n.setAttribute("alt",T.i18n("dialogs.weatherNodeConfig.copyId")),n.dataset.tooltip=r+": "+this.weatherNode.data.id,n.dataset.tooltipDirection="UP",n.innerHTML='<i class="fa-solid fa-passport"></i>',n.addEventListener("click",(e=>{e.preventDefault(),S.copyToClipboard(this.weatherNode.data.id),Logger.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:r,type:"id",id:this.weatherNode.data.id}),!0)})),n.addEventListener("contextmenu",(e=>{e.preventDefault(),S.copyToClipboard(this.weatherNode.data.id),Logger.info(game.i18n.format("DOCUMENT.IdCopiedClipboard",{label:r,type:"uuid",id:this.weatherNode.data.id}),!0)})),t.append(n)}async _updateObject(e,t){const a=canvas.dimensions.sceneRect,i=.5*canvas.dimensions.size,r=d[t.mask];let n={};const o=S.clamp(t.x,a.x,a.x+a.width-i),s=S.clamp(t.y,a.y,a.y+a.height-i);t.x!=this.weatherNode.data.x&&(n.x=o),t.y!=this.weatherNode.data.y&&(n.y=s),t.z!=this.weatherNode.data.z&&(n.z=t.z),t.enabled!=this.weatherNode.data.enabled&&(n.enabled=t.enabled),(r||r!=this.weatherNode.data.mask)&&(n.mask=r),t.feather!=this.weatherNode.data.feather&&(n.feather=S.clamp(t.feather,0,100)),Logger.trace("WeatherNodeConfig._updateObject(...)",{event:e,formData:t,changes:n,maskNumber:r}),Object.keys(n).length>0&&(n.id=this.weatherNode.id,canvas.sceneweather.updateNodes([n]))}}class MaskWeatherNode extends AbstractWeatherNode{_borderNodes;_borders;_shadowBorderNode;mouseInteractionManager=null;constructor(e){super(e),this._borders=this.addChild(this._createBorderHandles()),this._borderNodes=this.addChild(this._createBorderNodeHandles())}static createMaskNodeAt(e){Logger.trace("MaskWeatherNode.createMaskNodeAt(...)",{origin:e});const t=WeatherNodeData.newVolatileMaskAt(e);return new MaskWeatherNode(t)}filterWeatherModel(e,t){return this.data.type==o.MASK?this._filterWeatherModelMask(e,t):e}showConfigApp(e){if(canvas.sceneweather.createState>r.NONE)return e;const t=this.id in canvas.sceneweather.apps?canvas.sceneweather.apps[this.id]:new WeatherNodeConfig(this);canvas.sceneweather.apps[this.id]=t,t.rendered?(t.maximize(),t.bringToTop()):t.render(!0)}destroy(){this._borderNodes.removeChildren(),this.removeChild(this._borderNodes),this._borders.removeChildren(),this.removeChild(this._borders),this._shadowBorderNode&&(this.removeChild(this._shadowBorderNode),this._shadowBorderNode=null),super.destroy()}refresh(){const{locked:e,borderNodes:t}=this.data;this._borders.children.length==t.length&&this._borderNodes.children.length==t.length||(this._clearBorderElements(),this._assembleBorderElements()),this.buttonMode=!0,this.controlled?e?(this._borderNodes.visible=!1,this._borders.visible=!1):(this._refreshBorderNodes(),this._refreshBorders()):(this._borderNodes.visible=!1,this._borders.visible=!1,this._shadowBorderNode&&(this.removeChild(this._shadowBorderNode),this._shadowBorderNode=null)),super.refresh()}activateListeners(){const e=S.createInteractionManager(this,{hoverIn:this._onHoverIn,hoverOut:this._onHoverOut,clickLeft:this._onClickLeft,clickLeft2:this.showConfigApp,clickRight:this._onClickRight,clickRight2:this.showConfigApp,dragLeftStart:this._onDragLeftStart,dragLeftMove:this._onDragLeftMove,dragLeftDrop:this._onDragLeftDrop,dragLeftCancel:this._onDragLeftCancel,longPress:this._onLongPress});this.mouseInteractionManager=e.activate(),this._borderNodes.handle.forEach((e=>{e.activateListeners()})),this._borderNodes.interactive=!0,this._borders.handle.forEach((e=>{e.activateListeners()})),this._borders.interactive=!0}coversPoint(e,t){if(this.data.type==o.MASK){const a=this.data.x,i=this.data.y,r=new PIXI.Polygon(this.data.borderNodes.flatMap((({x:e,y:t})=>[e,t])));return r.contains(e-a,t-i)}return!1}addBorderNode(e,t){Logger.trace("WeatherNode.addBorderNode(...)",{borderNodeNr:e,newPosition:t}),this.data.borderNodes.splice(e+1,0,WeatherNodeData.newDefaultBorderPointAt(t));const a={id:this.id,borderNodes:this.data.borderNodes};this._shadowBorderNode&&(this.removeChild(this._shadowBorderNode),this._shadowBorderNode=null),canvas.sceneweather.updateNodes([a])}_filterWeatherModelMask(e,t){switch(this.data.mask){case d.lightroof:return S.mergeObject(S.deepClone(t),{precipitation:{amount:.5*t.precipitation.amount},sun:{amount:.5*t.sun.amount},condition:d.lightroof});case d.roof:return S.mergeObject(S.deepClone(t),{precipitation:{amount:0,type:m.none},sun:{amount:0},condition:d.roof});case d.inside:return S.mergeObject(S.deepClone(t),{precipitation:{amount:0,type:m.none},sun:{amount:0},wind:{speed:0,gusts:0,direction:0},temp:{air:t.temp.ground,percieved:t.temp.ground},humidity:Meteo.calculateRelativeHumidityTransfer(t.temp.air,t.humidity,t.temp.ground),condition:d.inside});case d.underground:return S.mergeObject(S.deepClone(t),{precipitation:{amount:0,type:m.none},sun:{amount:0},wind:{speed:0,gusts:0,direction:0},temp:{ground:t.temp.underground,air:t.temp.underground,percieved:t.temp.underground},humidity:Meteo.calculateRelativeHumidityTransfer(t.temp.air,t.humidity,t.temp.underground),condition:d.underground});default:return S.mergeObject(S.deepClone(t),{condition:d.outside})}}_clearBorderElements(){this._borderNodes.removeChildren().forEach((e=>{})),this._borderNodes.handle=[],this._borders.removeChildren().forEach((e=>{})),this._borders.handle=[]}_assembleBorderElements(){for(let e=0;e<this.data.borderNodes.length;e++)this._borderNodes.handle[e]=this._borderNodes.addChild(new BorderNodeHandle(this,{borderNodeNr:e}));this._borderNodes.handle.forEach((e=>{e.activateListeners()}));for(let e=0;e<this.data.borderNodes.length;e++)this._borders.handle[e]=this._borders.addChild(new BorderHandle(this,e));this._borders.handle.forEach((e=>{e.activateListeners()}))}_insidePolygon(e){return this.data.borderNodes.reduce(((t,{x:a,y:i},r,n)=>{const{x:o,y:s}=n[(r+n.length-1)%n.length];return i>e.y!=s>e.y&&e.x<(o-a)*(e.y-i)/(s-i)+a?!t:t}),!1)}_createBorderNodeHandles(){const e=new PIXI.Container;e.handle=[];for(let t=0;t<this.data.borderNodes.length;t++)e.handle[t]=e.addChild(new BorderNodeHandle(this,{borderNodeNr:t}));return e}_createBorderHandles(){const e=new PIXI.Container;e.handle=[];for(let t=0;t<this.data.borderNodes.length;t++)e.handle[t]=e.addChild(new BorderHandle(this,t));return e}_refreshBorderNodes(){this._borderNodes.handle.forEach((e=>{e.refresh()})),this._borderNodes.visible=!0}_refreshBorders(){this._borders.handle.forEach((e=>{e.refresh()})),this._borders.visible=!0}_refreshShadowBorderNodeHandle(){Logger.trace("WeatherNode._refreshShadowBorderNodeHandle() SHALL BE DEPRECATED"),this._shadowBorderNode}async creationDragLeftMove(e,t){return this.data.setLastBorderNode(t,.5*canvas.dimensions.size),this.data.normalize(),await this.data.update(),this.refresh(),e}async creationDragLeftDrop(e,t){return this.data.addBorderNode(t,.5*canvas.dimensions.size),e}async creationClickLeft2(e,t){const a=this.data.toObject();return a.borderNodes.splice(-1,1),await canvas.sceneweather.createWeatherNodes([a],{control:!0,controlOptions:{releaseOthers:!0}}),r.NONE}async _onShift(e){const t=this._borders.handle.find((e=>e.hover));if(t){const e=t.getNewNodePosition();this._shadowBorderNode?this._shadowBorderNode.setPosition(e):this._shadowBorderNode=this.addChild(new BorderNodeHandle(null,{position:{x:e.x,y:e.y}})),this._shadowBorderNode.refresh()}else this._shadowBorderNode&&(this.removeChild(this._shadowBorderNode),this._shadowBorderNode=null)}async _onShiftRelease(e){this._shadowBorderNode&&(this.removeChild(this._shadowBorderNode),this._shadowBorderNode=null)}}class NodeFrame extends PIXI.Container{border;handle;_dragHandle=!1;mouseInteractionManager=null;constructor(){super(),this.border=this.addChild(new PIXI.Graphics),this.handle=this.addChild(new ResizeHandle([1,1]))}get allControlledLocked(){return canvas.sceneweather.controlled.some((e=>e.data.locked))}refresh(){if(!canvas.sceneweather.controlled.length)return void(this.visible=!1);const e=CONFIG.Canvas.dispositionColors,t=this.allControlledLocked?e.HOSTILE:e.CONTROLLED,a=.5*canvas.dimensions.size,i=CONFIG.Canvas.objectBorderThickness,r=Math.round(i/2),n=Math.round(r/2)+a,o=this._getControlledBounds(this._dragHandle).clone().pad(n);this.border.clear().lineStyle(i,0).drawRoundedRect(o.x,o.y,o.width,o.height,n/2).lineStyle(r,t).drawRoundedRect(o.x,o.y,o.width,o.height,n/2),this.handle.refresh(o),this.allControlledLocked?this.handle.visible=!1:this.handle.visible=!0,this.visible=!0}activateListeners(){const e=S.createInteractionManager(this,{hoverIn:this._onHoverIn,hoverOut:this._onHoverOut,clickRight:this._onClickRight,dragLeftStart:this._onDragStart,dragLeftMove:this._onDragMove,dragLeftDrop:this._onDragEnd,dragLeftCancel:this._onDragCancel});this.mouseInteractionManager=e.activate(),this.handle.interactive=!0}_getControlledBounds(e=!1){const t=canvas.dimensions.rect,[a,i]=canvas.sceneweather.controlled.reduce(((t,{data:a})=>[e?Math.min(t[0],a.x+Math.min(...a.borderNodes.map((({x:e})=>e)))):Math.min(t[0],a.x),e?Math.min(t[1],a.y+Math.min(...a.borderNodes.map((({y:e})=>e)))):Math.min(t[1],a.y)]),[t.width+t.x,t.height+t.y]),[r,n]=canvas.sceneweather.controlled.reduce(((t,{data:a})=>[e?Math.max(t[0],a.x+Math.max(...a.borderNodes.map((({x:e})=>e)))):Math.max(t[0],a.x+a.width),e?Math.max(t[1],a.y+Math.max(...a.borderNodes.map((({y:e})=>e)))):Math.max(t[1],a.y+a.height)]),[t.x,t.y]);return new PIXI.Rectangle(a,i,r-a,n-i)}async _rescaleDimensions(e,t,a=!1){if(t.x<e.x||t.y<e.y)return;if(a&&(t.x<e.x+e.width/2||t.y<e.y+e.height/2))return;const i=.5*canvas.dimensions.size,r=a?{x:e.x+(e.x+e.width-t.x),y:e.y+(e.y+e.height-t.y)}:{};canvas.sceneweather.controlled.forEach((n=>{if(n._original){const o=new WeatherNodeData(n.data.toObject());for(let i=0;i<n.data.borderNodes.length;i++){const s=n._original.borderNodes[i];a?(o.borderNodes[i].x=S.map(s.x+n.data.x,e.x,e.x+e.width,r.x,t.x)-n.data.x,o.borderNodes[i].y=S.map(s.y+n.data.y,e.y,e.y+e.height,r.y,t.y)-n.data.y):(o.borderNodes[i].x=S.map(s.x+n.data.x,e.x,e.x+e.width,e.x,t.x)-n.data.x,o.borderNodes[i].y=S.map(s.y+n.data.y,e.y,e.y+e.height,e.y,t.y)-n.data.y)}if(o._isPolygonValid(i)){for(let e=0;e<n.data.borderNodes.length;e++)n.data.borderNodes[e].x=o.borderNodes[e].x,n.data.borderNodes[e].y=o.borderNodes[e].y;n.data.x=o.x,n.data.y=o.y,n.data.width=o.width,n.data.height=o.height}n.refresh()}}))}_fixedAspectRatio(e,t){const a=t.width/t.height;let i=e.x-t.x,r=i/a;if(t.y+r>e.y){const n=e.y-t.y;r=n,i=n*a}return{x:t.x+i,y:t.y+r}}_onHoverIn(e){e.target.scale.set(1.5,1.5),e.data.handle=e.target}_onHoverOut(e){e.data.handle.scale.set(1,1)}_onDragStart(e){const t=canvas.sceneweather.hud;t&&t.clear(),this.allControlledLocked||(this._dragHandle=!0,canvas.sceneweather.controlled.forEach((e=>{e._original=e.data.toObject()}))),e.data.origin=this._getControlledBounds()}async _onDragMove(e){if(S.throttleInteractivity(this))return;let{destination:t,origin:a,originalEvent:i}=e.data;i.shiftKey&&(t=this._fixedAspectRatio(t,a)),canvas.sceneweather.snapToGrid&&!i.ctrlKey&&(t=canvas.grid.getSnappedPosition(t.x,t.y,canvas.sceneweather.gridPrecision)),canvas._onDragCanvasPan(i);const r=.5*canvas.dimensions.size;this._rescaleDimensions(a,{x:t.x-r,y:t.y-r},i.altKey)}async _onDragEnd(e){Logger.trace("WeatherNode._onDragEnd(...)");let{destination:t,origin:a,originalEvent:i}=e.data;i.shiftKey&&(t=this._fixedAspectRatio(t,a)),canvas.sceneweather.snapToGrid&&!i.ctrlKey&&(t=canvas.grid.getSnappedPosition(t.x,t.y,canvas.sceneweather.gridPrecision));const r=.5*canvas.dimensions.size;this._rescaleDimensions(a,{x:t.x-r,y:t.y-r},i.altKey);const n=canvas.sceneweather.controlled.map((e=>{if(e._original){e.data.normalize();const{_id:t,...a}=e.data.toObject();return e._nodeData=new WeatherNodeData(e._original),delete e._original,{...a,id:e.id}}}));await canvas.sceneweather.updateNodes(n)}_onDragCancel(e){Logger.trace("WeatherNode._onDragCancel(...)"),this._dragHandle=!1,canvas.sceneweather.controlled.forEach((e=>{delete e._original})),this.refresh()}_onClickRight(e){Logger.trace("NodeFrame._onClickRight(...)",{event:e})}}class WeatherEffect extends ParticleEffect{static label="sceneweather.fxname";static _getFxEmittersForModel(e){let t=[];return SceneWeatherState._generators.forEach((a=>{let i=a.getEmitter(e);i&&t.push(i)})),Logger.debug("WeatherEffect._getFxEmittersForModel()",{model:e,gen:SceneWeatherState._generators,emitters:t}),t}static _equalizeMaxParticles(e,t){let a=0,i=0;for(let t=0;t<e.length;t++){const r=e[t];a+=r.maxParticles,i+=r.weight}if(a<=t)return e;let r=0;for(let t=0;t<e.length;t++){const a=e[t];r+=a.maxParticles*(a.weight/i)}r=t/r;for(let t=0;t<e.length;t++){const a=e[t];a.maxParticles*=r*(a.weight/i)}return Logger.debug("WeatherEffect._equalizeMaxParticles()",{totalParticles:a,maxParticles:t}),e}play({easeIn:e=!0}={}){e||this.emitters.forEach((e=>{e.autoUpdate=!1,e.emit=!0,e.update(e.maxLifetime),e.autoUpdate=!0})),super.play()}getParticleEmitters(e={}){if(Logger.debug("WeatherEffect.getParticleEmitters(...)",{options:e}),void 0===e.data||void 0===e.data.model)return Logger.debug("WeatherEffect.getParticleEmitters() no model data contained, no emitters."),[];const t=WeatherEffect._getFxEmittersForModel(e.data.model),a=T.getSetting("maxParticles",3200);WeatherEffect._equalizeMaxParticles(t,a);let i=[];return t.forEach((e=>{i.push(this.createEmitter(e))})),i}async softStop({gracePeriod:e}={}){const t=this.emitters.map((t=>new Promise((a=>{let i=t._activeParticlesFirst;for(;null!=i;){const t=e,a=Math.max(i.age,i.maxLife-t);i.age=a,i.agePercent=i.age*i.oneOverLife,i=i.next}t.emitterLifetime=0,t.playOnceAndDestroy((()=>{a()}))})))),a=[Promise.all(t)];void 0!==e&&a.push(new Promise((t=>setTimeout(t,1e3*e))).then(this.destroy.bind(this))),await Promise.race(a),this.stop()}}class WeatherNodeMask extends PIXI.Graphics{_weatherNodeData;constructor(e){super(),this._weatherNodeData=e}static maskColors={0:16711680,1:8388608,2:0,3:0,4:0};draw(){const{x:e,y:t,borderNodes:a,mask:i,type:r,enabled:n,feather:s}=this._weatherNodeData;if(r!=o.MASK)return;if(!n)return;const d=WeatherNodeMask.maskColors[i]||0;this.clear().beginFill(d).moveTo(e+a[0].x,t+a[0].y);for(let i=0;i<a.length;i++){const r=a[(i+1)%a.length];this.lineTo(e+r.x,t+r.y)}if(this.endFill(),s){const e=canvas.dimensions.size*(s/100);this.filters=[new PIXI.filters.BlurFilter(e,e/10)]}}}Hooks.on(i.SETTINGS_UPDATED,(async e=>{Logger.trace("-> Hooks::SettingsUpdated -> WeatherEffectsLayer.draw*Effects",{data:e}),["cloudsAlpha","precipitationAlpha","maxParticles","enableFx"].includes(e.id)&&SceneWeather.updateWeather({force:!0})})),Hooks.on(i.WEATHER_DISABLED,(async e=>{canvas.scene._id==e.scene.id?void 0!==canvas.sceneweatherfx?await Promise.all([canvas.sceneweatherfx.drawParticleEffects({soft:!1}),canvas.sceneweatherfx.drawFilterEffects({soft:!1})]):Logger.trace("No canvas.sceneweatherfx"):Logger.trace("WeatherDisabled for another scene, ignoring")})),Hooks.on(i.WEATHER_UPDATED,(async e=>{Logger.debug("-> Hooks::WeatherUpdated -> WeatherEffectsLayer.draw*Effects",{data:e}),void 0!==canvas.sceneweatherfx?await Promise.all([canvas.sceneweatherfx.drawParticleEffects({soft:!e.force,data:e}),canvas.sceneweatherfx.drawFilterEffects({soft:!e.force,data:e})]):Logger.debug("No canvas.sceneweatherfx")}));class WeatherEffectsLayer extends CanvasLayer{particleEffectsContainer;spriteMask;activeEffects=[];activeFilters={};constructor(){super(),canvas.app.ticker.add(this.handleTick,this)}async updateWeatherMask(){let e=new PIXI.Container;const t=e.addChild(new PIXI.LegacyGraphics);await t.clear().beginFill(255).drawShape(canvas.dimensions.rect).endFill().beginFill(16711680).drawShape(canvas.dimensions.sceneRect.intersection(canvas.dimensions.rect)).endFill(),t.mask=new PIXI.MaskData;const a=WeatherNodeData.loadAll().map((t=>{const a=new WeatherNodeMask(t);return e.addChild(a).draw()}));await Promise.all(a),this.spriteMask&&(this.removeChild(this.spriteMask),delete this.spriteMask);const i=await canvas.app.renderer.generateTexture(e);this.spriteMask=this.addChild(new PIXI.Sprite(i)),this.mask=this.spriteMask}static getFxFiltersForModel(e){let t={};return SceneWeatherState._filters.forEach((a=>{S.mergeObject(t,a.getFilterConfig(e))})),Logger.debug("WeatherEffectsLayer.getFxFiltersForModel()",{model:e,filter:t}),t}get elevation(){return(canvas.weather?.elevation??9999)+1}set elevation(e){const t=canvas.weather;t&&(t.elevation=e-1)}static get layerOptions(){return S.mergeObject(super.layerOptions,{name:"weather-particle-effects",zIndex:479})}async _draw(){Logger.trace("WeatherEffectsLayer._draw()",{this:this}),this.updateWeatherMask()}async _tearDown(){Logger.debug("WeatherEffectsLayer._tearDown()",{effects:this.activeEffects});const e=Object.values(this.activeFilters),t=canvas.environment;return t.filters=t.filters?.filter((function(t){return!e.find((function(e){return t===e}))}))??[],this.activeEffects.forEach((e=>{e.destroy()})),this.activeEffects=[],this.particleEffectsContainer=void 0,super._tearDown()}handleTick(){for(const e in this.activeFilters)this.activeFilters[e].step()}async drawFilterEffects(e){Logger.debug("WeatherEffectsLayer.drawFilterEffects(...)",{options:e});const t=canvas.environment;if(e=S.mergeObject({soft:!1},e),!canvas.scene)return;const a=Object.values(this.activeFilters).map((e=>e.destroy()));await Promise.all(a);const i=Object.values(this.activeFilters);if(t.filters=t.filters?.filter((function(e){return!i.find((function(t){return e===t}))}))??[],this.activeFilters={},!T.getSetting("enableFx",!0))return;if(void 0===e.data||void 0===e.data.model)return void Logger.debug("WeatherEffectsLayer.drawFilterEffects() no model data contained, no filters.");const r=WeatherEffectsLayer.getFxFiltersForModel(e.data.model);Object.entries(r).map((([a,i])=>{this.activeFilters[a]=new i.type({soft:e.soft,options:S.mergeObject(i,{"-=type":null},{performDeletions:!0})}),t.filters.push(this.activeFilters[a])}))}async drawParticleEffects(e){if(e=S.mergeObject({soft:!1},e),!canvas.scene)return;this.particleEffectsContainer||(this.particleEffectsContainer=this.addChild(new PIXI.Container));const t=Promise.all(this.activeEffects.map((async t=>{e.soft?await t.softStop({gracePeriod:10}):(t.destroy(),t.stop());const a=this.activeEffects.indexOf(t);a>-1&&this.activeEffects.splice(a,1)})));if(T.getSetting("enableFx",!0)){const t=new WeatherEffect(this.particleEffectsContainer,e);t.play({easeIn:e.soft}),this.activeEffects.push(t)}Logger.debug("waiting for emitters to clean up (softly)",{effects:this.activeEffects,soft:e.soft}),await t,Logger.debug("cleaned up emitters",{effects:this.activeEffects})}}Hooks.on("renderHeadsUpDisplay",((e,t,a)=>{Logger.trace("->Hook:renderHeadsUpDisplay",{app:e,jQ:t,options:a,hud:canvas.hud.weatherNode});const i=canvas.hud.weatherNode?.options||{id:"weathernode-hud"};0==t.find("#"+i.id).length&&t.append('<template id="'+i.id+'"></template>')}));class WeatherNodeHud extends Application{weatherNode=void 0;static get defaultOptions(){return S.mergeObject(super.defaultOptions,{id:"weathernode-hud",template:"modules/"+e.ID+"/templates/weatherNodeHud.hbs",classes:["placeable-hud"],popOut:!1})}bind(e){Logger.trace("WeatherNodeHud.bind(...)",{weatherNode:e});const t=this.constructor.RENDER_STATES;[t.CLOSING,t.RENDERING].includes(this._state)||(this.weatherNode&&this.clear(),this.weatherNode=e,this.render(!0),this.element.hide().fadeIn(200))}getData(e={}){const t=this.weatherNode.data.toObject();return S.mergeObject(t,{id:this.id,classes:this.options.classes.join(" "),appId:this.appId,lockedClass:t.locked?"active":"",lockedIcon:this._getLockedIcon(t),enabledClass:t.enabled?"active":"",enabledIcon:this._getEnabledIcon(t)})}clear(){const e=this.constructor.RENDER_STATES;this._state<=e.NONE||(this._state=e.CLOSING,this.weatherNode=null,this.element.hide(),this._element=null,this._state=e.NONE)}setPosition(e){Logger.trace("WeatherNodeHud.setPosition(...)",{options:e});const{x:t,y:a,width:i,height:r}=this.weatherNode.data,n={width:i+160+10,height:r+10,left:t-80-5,top:a-5};this.element.css(n)}activateListeners(e){Logger.trace("WeatherNodeHud.activateListeners(...)",{html:e}),e.find(".control-icon").click(this._onClickControl.bind(this))}async _render(...e){await super._render(...e),this.setPosition()}_getLockedIcon(e,t=!1){return(t?!e.locked:e.locked)?"fa-lock":"fa-lock-open"}_getEnabledIcon(e,t=!1){return(t?!e.enabled:e.enabled)?"fa-eye":"fa-eye-slash"}_onClickControl(e){Logger.trace("WeatherNodeHud._onClickControl(...)",{event:e});switch(e.currentTarget.dataset.action){case"enabled":return this._onToggleEnabled(e);case"locked":return this._onToggleLocked(e);case"sort-up":return this._onSort(e,!0);case"sort-down":return this._onSort(e,!1)}}async _onToggleEnabled(e){e.preventDefault();const t=this.weatherNode.data.enabled,a=canvas.sceneweather.controlled.map((e=>({id:e.id,enabled:!t})));return e.currentTarget.classList.toggle("active",!t),$(e.currentTarget).children("i").first().attr("class","fas fa-solid "+this._getEnabledIcon(this.weatherNode.data,!0)),canvas.sceneweather.updateNodes(a)}async _onToggleLocked(e){e.preventDefault();const t=this.weatherNode.data.locked,a=canvas.sceneweather.controlled.map((e=>({id:e.id,locked:!t})));return e.currentTarget.classList.toggle("active",!t),$(e.currentTarget).children("i").first().attr("class","fas fa-solid "+this._getLockedIcon(this.weatherNode.data,!0)),canvas.sceneweather.updateNodes(a)}async _onSort(e,t){e.preventDefault();const a=canvas.sceneweather.nodes,i=canvas.sceneweather.controlled.filter((e=>!e.data.locked));let r=0;t?(i.sort(((e,t)=>e.data.z-t.data.z)),r=a.length?Math.max(...a.map((e=>e.data.z)))+1:1):(i.sort(((e,t)=>t.data.z-e.data.z)),r=a.length?Math.min(...a.map((e=>e.data.z)))-1:-1);const n=i.map(((e,a)=>{const i=t?a:-1*a;return{id:e.id,z:r+i}}));return canvas.sceneweather.updateNodes(n)}}Hooks.on(i.MODULE_READY,(()=>{Hooks.on("renderSceneControls",((e,t)=>{if("sceneweather"==e.activeControl){const a=$('li[data-tool="weatherNode"]',t),i=game.activeTool;let r=$("<ol>").addClass("control-tools").appendTo($("<div>").attr("id","node-types").appendTo(a));for(let e of Object.keys(SceneWeatherLayer.nodeTypes))$('li[data-tool="'+e+'"]',t).appendTo(r),"weatherNode"==i&&$('li[data-tool="'+e+'"]',t).toggleClass("active",e===canvas.sceneweather.selectedTool);a.toggleClass("active",Object.keys(SceneWeatherLayer.nodeTypes).includes(e.activeTool)||"weatherNode"==e.activeTool),a.attr("data-tooltip","layer.controls."+canvas.sceneweather.selectedTool),a.children("i").first().attr("class",SceneWeatherLayer.nodeTypes[canvas.sceneweather.selectedTool].icon);const n=a.position();r.parent().css({top:n.top,left:n.left+a.width()})}else $("#node-types").remove()}))})),Hooks.once("setup",(()=>{Logger.trace("->Hook:setup"),CONFIG.Canvas.layers.sceneweatherfx={layerClass:WeatherEffectsLayer,group:"primary"},CONFIG.Canvas.layers.sceneweather={layerClass:SceneWeatherLayer,group:"primary"},Hooks.on("getSceneControlButtons",(t=>{const i=T.userID(),r=[{name:"dialogs.weatherUi.toggleName",title:"dialogs.weatherUi.toggleTitle",icon:"fas fa-solid fa-window-maximize",visible:WeatherPerception.getAllowedIds(i).length>0&&T.getSceneFlag("weatherMode",a.DISABLED)!=a.DISABLED,toggle:!0,active:WeatherUi._isOpen,onClick:()=>{WeatherUi.toggleAppVis("toggle")}},{name:"dialogs.meteoUi.toggleName",title:"dialogs.meteoUi.toggleTitle",icon:"fas fa-solid fa-chart-line",visible:Permissions.hasPermission(i,"meteogramUi")&&[a.REGION_TEMPLATE,a.REGION_GENERATE].includes(T.getSceneFlag("weatherMode",a.DISABLED)),toggle:!0,active:MeteoUi._isOpen,onClick:()=>{MeteoUi.toggleAppVis("toggle")}},{name:"dialogs.weatherConfig.toggleName",title:"dialogs.weatherConfig.toggleTitle",icon:"fas fa-solid fa-sliders",visible:Permissions.hasPermission(i,"sceneSettings")&&[a.WEATHER_GENERATE].includes(T.getSceneFlag("weatherMode",a.DISABLED)),button:!0,onClick:()=>{if(Permissions.hasPermission(i,"sceneSettings")&&[a.WEATHER_GENERATE].includes(T.getSceneFlag("weatherMode",a.DISABLED))){new WeatherConfigDialog(canvas.scene._id).render(!0)}}},{name:"dialogs.regionConfig.toggleName",title:"dialogs.regionConfig.toggleTitle",icon:"fas fa-solid fa-sliders",visible:Permissions.hasPermission(i,"sceneSettings")&&[a.REGION_GENERATE].includes(T.getSceneFlag("weatherMode",a.DISABLED)),button:!0,onClick:()=>{if(Permissions.hasPermission(i,"sceneSettings")&&[a.REGION_GENERATE].includes(T.getSceneFlag("weatherMode",a.DISABLED))){new RegionConfigDialog(canvas.scene._id).render(!0)}}},{name:"dialogs.macroConfig.toggleName",title:"dialogs.macroConfig.toggleTitle",icon:"fas fa-solid fa-scroll",visible:Permissions.hasPermission(i,"sceneSettings")&&T.getSceneFlag("weatherMode",a.DISABLED)!=a.DISABLED,button:!0,onClick:()=>{Permissions.hasPermission(i,"sceneSettings")&&T.getSceneFlag("weatherMode",a.DISABLED)!=a.DISABLED&&(MacroConfigDialog._app=new MacroConfigDialog,MacroConfigDialog._app.render(!0))}},{name:"settings.enableFx.toggleName",title:"settings.enableFx.toggleTitle",icon:"fas fa-solid fa-eye",visible:T.getSceneFlag("weatherMode",a.DISABLED)!=a.DISABLED,toggle:!0,active:T.getSetting("enableFx",!0),onClick:()=>{const t=!T.getSetting("enableFx",!0);T.setSetting("enableFx",t),Hooks.callAll(e.LCCNAME+"SettingsUpdated",{id:"enableFx",value:t})}},{name:"select",title:"layer.controls.select",icon:"fas fa-expand",visible:Permissions.hasPermission(i,"sceneSettings")},{name:"snapToGrid",title:"layer.controls.snapToGrid",icon:"fas fa-solid fa-frame",visible:Permissions.hasPermission(i,"sceneSettings"),toggle:!0,active:canvas.sceneweather?.snapToGrid,onClick:()=>{Permissions.hasPermission(i,"sceneSettings")&&(canvas.sceneweather.snapToGrid=!canvas.sceneweather.snapToGrid,ui.controls&&ui.controls.initialize())}},{name:"weatherNode",title:"layer.controls.createMask",icon:"fa-regular fa-draw-polygon",visible:Permissions.hasPermission(i,"sceneSettings")},{name:"maskWeatherNode",title:"layer.controls.maskWeatherNode",icon:"fa-regular fa-draw-polygon",visible:Permissions.hasPermission(i,"sceneSettings"),onClick:()=>{canvas.sceneweather.selectedTool="maskWeatherNode"}},{name:"emitterWeatherNode",title:"layer.controls.emitterWeatherNode",icon:"fa-regular fa-signal-stream",visible:Permissions.hasPermission(i,"sceneSettings"),onClick:()=>{canvas.sceneweather.selectedTool="emitterWeatherNode"}},{name:"clear",title:"layer.controls.purgeNodes",icon:"fa-solid fa-trash",visible:Permissions.hasPermission(i,"sceneSettings"),button:!0,onClick:()=>{Permissions.hasPermission(i,"sceneSettings")&&canvas.sceneweather.deleteAll()}}];t.splice(t.findIndex((e=>"sounds"===e.name))+1,0,{name:"sceneweather",title:"layer.title",icon:"fas fa-solid fa-cloud-bolt-sun",layer:"sceneweather",activeTool:"select",tools:r})}))}));class SceneWeatherLayer extends InteractionLayer{static nodeTypes={maskWeatherNode:{icon:"fa-regular fa-draw-polygon",builder:e=>MaskWeatherNode.createMaskNodeAt(e)},emitterWeatherNode:{icon:"fa-regular fa-signal-stream",builder:e=>EmitterWeatherNode.createEmitterNodeAt(e)}};selectedTool="maskWeatherNode";weatherNodesContainer=null;preview=null;_nodeFrame;_clipboard=[];controlledNodes=new Map;borderNodeControl=null;_history=[];_onkeydown;_onkeyup;sortDirty=!0;apps={};snapToGrid=!0;createState=r.NONE;get elevation(){return(canvas.weather?.elevation??9999)+2}set elevation(e){const t=canvas.weather;t&&(t.elevation=e-2)}get nodes(){return this.weatherNodesContainer?.children||[]}get controlled(){return[...this.controlledNodes.values()]}get hud(){return canvas.hud.weatherNode||(canvas.hud.weatherNode=new WeatherNodeHud),canvas.hud.weatherNode}get gridPrecision(){return canvas.scene.grid.type===CONST.GRID_TYPES.GRIDLESS?0:2}newInstanceFromData(e){switch(e.type){case o.MASK:return new MaskWeatherNode(e);case o.EMITTER:return new EmitterWeatherNode(e);default:return}}static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"sceneweather",sortActiveTop:!0,zIndex:479})}async createWeatherNodes(e,{forceId:t=!1,addToContainer:a=this.weatherNodesContainer,control:r=!1,controlOptions:n={},storeHistory:o=!0,fireEvent:s=!0}={}){const d=[],c=e.map((async e=>{const i=await WeatherNodeData.create(e,t),o=this.weatherNodeFromData(i);return a&&await a.addChild(o).draw(),r&&o.control(n),d.push(o),o}));return await Promise.all(c),o&&this.storeHistory("deleteWeatherNode",{weatherNodes:d}),Logger.debug("SceneWeatherLayer.createWeatherNodes(...)",{nodeDatas:e,forceId:t,addToContainer:a,control:r,controlOptions:n,storeHistory:o,fireEvent:s,newWeatherNodes:d}),s&&Hooks.callAll(i.CREATE_WEATHER_NODES,{update:[],deletion:[],addition:[d.map((e=>e.id))]}),d}getNode(e){return this.nodes.find((t=>t.id==e))}async updateNodes(e=[],{storeHistory:t=!0,fireEvent:a=!0}={}){const r=[],n=[],o=this.weatherNodesContainer.children.map((async t=>{const a=e.find((e=>e.id===t.id));if(a){let e={id:a.id};for(const i of Object.keys(WeatherNodeData.metadata))i in a&&("Array"==WeatherNodeData.metadata[i].type?(e[i]=t.data[i].map((({x:e,y:t,permeable:a})=>({x:e,y:t,permeable:a}))),t.data[i]=a[i].map((({x:e,y:t,permeable:a})=>({x:e,y:t,permeable:a})))):(e[i]=t.data[i],t.data[i]=a[i]));t.data.normalize(!1);const i=t.data.update();return t.refresh(),r.push(t.id),n.push(e),i}}));await Promise.all(o),t&&this.storeHistory("updateWeatherNode",{weatherNodeUpdates:n}),Logger.debug("SceneWeatherLayer.updateNodes(...)",{nodesToUpdate:e,update:r,storeHistory:t,fireEvent:a}),a&&Hooks.callAll(i.UPDATE_WEATHER_NODES,{update:r,deletion:[],addition:[]})}async deleteWeatherNodes(e,{removeFromContainer:t=this.weatherNodesContainer,storeHistory:a=!0,fireEvent:r=!0}={}){a&&this.storeHistory("createWeatherNode",{weatherNodeDatas:e.map((e=>e.data.toObject()))});let n=[];const o=e.map((e=>(this.controlledNodes.delete(e.id),n.push(e.id),t&&(this.weatherNodesContainer.removeChild(e),e.destroy()),e.data.delete())));return await Promise.all(o),Logger.debug("SceneWeatherLayer.deleteWeatherNodes(...)",{deletableNodes:e,removeFromContainer:t,storeHistory:a,fireEvent:r,deletedNodeIds:n}),r&&Hooks.callAll(i.DELETE_WEATHER_NODES,{update:[],deletion:n,addition:[]}),n}getNodesAt({x:e=0,y:t=0,onlyEnabled:a=!0}={}){return this.nodes.filter((i=>!(a&&!i.data.enabled)&&i.coversPoint(e,t)))}selectObjects({x:e,y:t,width:a,height:i,releaseOptions:r={},controlOptions:n={}}={},{releaseOthers:o=!0}={}){const s=this.controlled,d=this.nodes.filter((e=>e.visible)).filter((r=>{const n=r.center;return Number.between(n.x,e,e+a)&&Number.between(n.y,t,t+i)})),c=s.filter((e=>!d.includes(e)));if(o)for(const e of c)e.release(r);T.isEmpty(n)&&(n.releaseOthers=!1);const l=d.filter((e=>!s.includes(e)));this.controlledNodes.clear();for(const e of l)e.control(n)&&this.controlledNodes.set(e.id,e);return o&&c.length||l.length>0}clearPreviewContainer(){if(this.preview)for(const e of this.preview.removeChildren())e.destroy({children:!0})}controlAll(e={}){if(this.createState>r.NONE)return;e.releaseOthers=!1;const t=this.nodes.filter((e=>e.visible));for(let a of t)a.control(e),this.controlledNodes.set(a.id,a);return[]}releaseAll(e={}){let t=0;for(let a of this.nodes)a.controlled&&(a.release(e),t++);return this.controlledNodes.clear(),t}async deleteAll(){return Dialog.confirm({title:T.i18n("dialogs.deleteAllNodes.title"),content:T.i18n("dialogs.deleteAllNodes.content"),yes:async()=>{this.weatherNodesContainer.removeChildren(),this.controlledNodes.clear(),this.borderNodeControl=null,this._nodeFrame.refresh();const e=(await WeatherNodeData.deleteAll()).map((e=>"WeatherNode."+e));Hooks.callAll(i.DELETE_WEATHER_NODES,{update:[],deletion:e,addition:[]})}})}weatherNodeFromData(e){switch(e.type){case o.MASK:return new MaskWeatherNode(e);case o.EMITTER:return new EmitterWeatherNode(e);default:return}}_startNewNodeAt(e){if(Object.keys(SceneWeatherLayer.nodeTypes).includes(game.activeTool)||"weatherNode"==game.activeTool)return Logger.trace("SceneWeatherLayer._startNewNodeAt(...)",{selectedTool:this.selectedTool}),Object.keys(SceneWeatherLayer.nodeTypes).includes(this.selectedTool)?SceneWeatherLayer.nodeTypes[this.selectedTool].builder(e):void 0}async _draw(e){this.borderNodeControl=null,this.weatherNodesContainer=this.addChild(new PIXI.Container),this.weatherNodesContainer.sortableChildren=!0,this.weatherNodesContainer.visible=!1;if(!Permissions.hasPermission(T.userID(),"sceneSettings"))return;this.weatherNodesContainer.sortChildren=this._sortObjectsByElevation.bind(this.weatherNodesContainer),this.preview=this.addChild(new PIXI.Container),this._nodeFrame=this.addChild(new NodeFrame(this));const t=WeatherNodeData.loadAll().map((e=>this.weatherNodesContainer.addChild(this.weatherNodeFromData(e)).draw()));this.visible=!0,await Promise.all(t),this.weatherNodesContainer.visible=!0}async _tearDown(e){this._history=[];for(const e of this.controlled)e.release();this.controlledNodes.clear(),this.borderNodeControl=null,this.hud&&this.hud.clear();const t=Object.values(this.apps).map((e=>e.close()));return await Promise.all(t),this.weatherNodesContainer=null,super._tearDown()}_sortObjectsByElevation(){this.children.sort(((e,t)=>e.data.z-t.data.z)),this.sortDirty=!1}_activate(){this.weatherNodesContainer.visible=!0;for(const e of this.nodes)e.refresh();this.borderNodeControl=null,this._onkeydown=this._handleKeydown.bind(this),document.addEventListener("keydown",this._onkeydown),this._onkeyup=this._handleKeyup.bind(this),document.addEventListener("keyup",this._onkeyup),this._nodeFrame.activateListeners(),canvas.primary.interactiveChildren=!0}_deactivate(){canvas.primary.interactiveChildren=!1,this._onkeydown&&(document.removeEventListener("keydown",this._onkeydown),this._onkeydown=null),this._onkeyup&&(document.removeEventListener("keyup",this._onkeyup),this._onkeyup=null),this.borderNodeControl=null,this.weatherNodesContainer.visible=!1,this.releaseAll();for(const e of this.nodes)e.refresh();this.clearPreviewContainer()}_onClickLeft(e){this.hud&&this.hud.clear(),game.settings.get("core","leftClickRelease")&&this.releaseAll()}async _onDragLeftStart(e){this.createState=r.NONE,this.clearPreviewContainer(),e.data.preview=null;const{origin:t,originalEvent:a}=e.data;canvas.sceneweather.snapToGrid&&!a.ctrlKey&&(e.data.origin=canvas.grid.getSnappedPosition(t.x,t.y,this.gridPrecision));const i=this._startNewNodeAt(e.data.origin);if(i)return this.createState=r.POTENTIAL,e.data.preview=this.preview.addChild(i),i.draw()}async _onDragLeftMove(e){const{preview:t}=e.data;if(t&&this.createState>=r.POTENTIAL){if(S.throttleInteractivity(this))return;let{destination:a,origin:i,originalEvent:n}=e.data;canvas.sceneweather.snapToGrid&&!n.ctrlKey&&(i=canvas.grid.getSnappedPosition(i.x,i.y,canvas.sceneweather.gridPrecision),a=canvas.grid.getSnappedPosition(a.x,a.y,canvas.sceneweather.gridPrecision)),this.createState=await t.creationDragLeftMove(this.createState,a),this.createState==r.NONE&&this.clearPreviewContainer()}}async _onDragLeftDrop(e){const{preview:t}=e.data;if(this.createState===r.POTENTIAL){e.data.originalEvent.preventDefault();const{destination:a,originalEvent:i}=e.data;canvas.sceneweather.snapToGrid&&!i.ctrlKey&&(e.data.destination=canvas.grid.getSnappedPosition(a.x,a.y,this.gridPrecision)),this.createState=await t.creationDragLeftDrop(this.createState,e.data.destination),this.createState==r.NONE&&this.clearPreviewContainer()}}async _onClickLeft2(e){const{preview:t}=e.data;if(this.createState===r.POTENTIAL){e.data.originalEvent.preventDefault();const{destination:a,originalEvent:i}=e.data;canvas.sceneweather.snapToGrid&&!i.ctrlKey&&(e.data.destination=canvas.grid.getSnappedPosition(a.x,a.y,this.gridPrecision)),this.createState=await t.creationClickLeft2(this.createState,e.data.destination),this.createState==r.NONE&&this.clearPreviewContainer()}}_onDragLeftCancel(e){this.clearPreviewContainer()}_onClickRight(e){if(this.createState===r.POTENTIAL)return e.data.originalEvent.preventDefault(),this._onDragLeftCancel(e),e.data.preview=null,void(this.createState=r.NONE);this.hud&&this.hud.clear()}async _onShiftRelease(e){const t=this.controlled;if(0===t.length)return;const a=t.find((e=>e._borders.handle.find((e=>e.hover))));a&&a._onShiftRelease(e)}async _onShift(e){const t=this.controlled;if(0===t.length)return;const a=t.find((e=>e._borders.handle.find((e=>e.hover))));a&&a._onShift(e)}async _onDelete(e){const t=this.controlled;if(0===t.length)return;const a=t.reduce(((e,t)=>(t.data.locked||(e.push(t),this.borderNodeControl&&this.borderNodeControl.id===t.id&&(this.borderNodeControl=null)),e)),[]);0!==a.length&&(this.deleteWeatherNodes(a),this._nodeFrame.refresh())}_handleKeyup(e){if(!game.keyboard.hasFocus&&"Shift"===e.key)this._onShiftRelease(e)}_handleKeydown(e){if(!(game.keyboard.hasFocus||this.createState>r.NONE))switch(e.key){case"Shift":if(e.altKey||e.ctrlKey||e.metaKey)return;this._onShift(e);break;case"Delete":if(e.altKey||e.ctrlKey||e.metaKey)return;this._onDelete(e);break;case"z":if(e.altKey||e.metaKey||!e.ctrlKey)return;this._onUndo(e);break;case"c":if(e.altKey||e.metaKey)return;this._onCopy(e);break;case"v":if(e.altKey||e.metaKey)return;this._onPaste(e)}}_onCopy(e){if(""!==window.getSelection().toString())return!1;this._clipboard=this.controlled,this._clipboard.length>0&&Logger.info("Copied data for "+this._clipboard.length+" WeatherNodes",!0)}_onPaste(e){if(this._clipboard.length>0){const t=canvas.app.renderer.plugins.interaction.mouse.getLocalPosition(canvas.stage);this.pasteObjects(t,{snap:canvas.sceneweather.snapToGrid&&!e.isShift})}}async pasteObjects(e,{snap:t=!0}={}){if(0===this._clipboard.length)return;this._clipboard.sort(((e,t)=>e.data.x-t.data.x));const{x:a,y:r}=this._clipboard[0].data,n=[],o=canvas.dimensions.rect;for(let i of this._clipboard){const s=i.data.toObject();delete s._id;let d={x:e.x+(s.x-a),y:e.y+(s.y-r)};t&&(d=canvas.grid.getSnappedPosition(d.x,d.y)),d.x>=o.x&&d.x+s.width<=o.x+o.width&&d.y>=o.y&&d.y+s.height<=o.y+o.height&&n.push(foundry.utils.mergeObject(s,{x:d.x,y:d.y}))}0!==n.length&&(this.releaseAll(),await this.createWeatherNodes(n,{control:!0,controlOptions:{releaseOthers:!1}}),Hooks.call(i.PASTE_WEATHER_NODES,this._clipboard,n),Logger.info("Pasted data for "+n.length+"WeatherNodes.",!0))}storeHistory(e,a){Logger.debug("SceneWeatherLayer.storeHistory(...)",{type:e,data:a}),this._history.length>=t.UNDO_STEPS&&this._history.shift(),this._history.push({type:e,data:a})}_onUndo(e){if(!canvas.ready)return!1;if(this._history.length>0){const e=this._history.pop();switch(e.type){case"deleteWeatherNode":const t=e.data.weatherNodes;return this.deleteWeatherNodes(t,{storeHistory:!1}),this._nodeFrame.refresh(),!0;case"createWeatherNode":const a=e.data.weatherNodeDatas;return this.createWeatherNodes(a,{forceId:!0,storeHistory:!1}),!0;case"updateWeatherNode":const i=e.data.weatherNodeUpdates;return this.updateNodes(i,{storeHistory:!1}),!0}return!1}Logger.info("No more steps to undo...",!0)}}Hooks.on(i.MODULE_READY,(()=>{if(Logger.debug("->Hook:MODULE_INITIALIZED  -> (creating SFX)"),!canvas.sceneweather.sfxHandler){const e=new SfxHandler;canvas.sceneweather.sfxHandler=e,Hooks.callAll(i.REG_WEATHER_SFX,e),T.isGm()&&["trace","debug"].includes(T.getSetting("loglevel","info"))&&canvas.sceneweather.sfxHandler._injectDebugToast()}Hooks.on("globalAmbientVolumeChanged",(async e=>{Logger.debug("->Hook:globalAmbientVolumeChanged  -> (...)",{volume:e}),canvas.sceneweather.sfxHandler&&canvas.sceneweather.sfxHandler.setGlobalVolume(e)})),Hooks.on(i.SETTINGS_UPDATED,(e=>{"sfxVolume"===e.id&&(Logger.debug("->Hook:sceneWeather,sfxVolumeChanged  -> (...)",{volume:e.value/100}),canvas.sceneweather.sfxHandler.setSfxVolume(e.value/100))}))}));class SfxHandler{_sysTick=0;_soundEffects={};_globalVolume=1;_sfxVolume=1;_volumesChanged=!0;constructor(){canvas.app.ticker.add(this.tick,this),this._globalVolume=game.settings.get("core","globalAmbientVolume")||1,this._sfxVolume=T.getSetting("sfxVolume",100)/100}registerSfx(e,t,a){const i=game.audio.create({src:t,singleton:!0,preload:!0,autoplay:!1,autoplayOptions:{}});this._soundEffects[e]={options:a,sound:i,gain:0,active:!1,offset:0,targetGain:1,targetFrame:-1},i.load().then((t=>{Logger.trace("SfxHandler.preloadSound(...) loaded",{id:e,value:t})})),Logger.info("registerSfx | "+T.i18n("api.regSfx")+e+".")}disableAllSounds(e=!1){Object.values(this._soundEffects).forEach((e=>{e.targetFrame=-1,e.sourceFrame=-1,e.gain=0})),this._volumesChanged=!0,this._updateVolumes(e)}updateSounds(e,t=!0){Object.keys(this._soundEffects).forEach((t=>{const a=this._soundEffects[t],i=a.options;let r=!0;const n=i.matchAny;if(n&&(r=r&&Object.keys(n).find((t=>{const a=i.matchAny[t],r=S.getNestedLeaf(e,t);return a.includes(r)}))),!r)return void this._setTargetGain(a,0);const o=S.getNestedLeaf(e,i.baseValue),s=S.getNestedLeaf(e,i.actualValue);if(null==o||null==s)return void this._setTargetGain(a,0);const d=e.condition||0,c=i.gainMatrix[d][0]||0,l=i.gainMatrix[d][1]||0,h=Math.max(this._getGain(o,i.baseGain)*c,this._getGain(s,i.actualGain)*l);this._setTargetGain(a,h)})),this._volumesChanged=!0,this._updateVolumes(t)}tick(e){this._sysTick+=e,this._updateVolumes(),this._setDebugWindow({tick:this._sysTick,sfx:this._soundEffects})}setGlobalVolume(e){this._globalVolume=e,this._updateVolumes()}setSfxVolume(e){this._sfxVolume=e,this._updateVolumes()}_setTargetGain(e,t,a=100){a>0?(e.targetGain=t,e.sourceGain=e.gain,e.targetFrame=this._sysTick+a,e.sourceFrame=this._sysTick):(e.gain=t,e.targetFrame=-1,e.sourceFrame=-1,e.sourceGain=e.targetGain)}_updateSounds(){this._volumesChanged&&(Object.values(this._soundEffects).forEach((e=>{e.gain>0?e.sound.loaded?e.sound.playing?e.sound.volume=e.gain*this._globalVolume*this._sfxVolume:e.sound.play({loop:!0,offset:e.offset,volume:e.gain*this._globalVolume*this._sfxVolume,fade:0}):e.sound.load().then((()=>{this._volumesChanged=!0})):e.sound.playing&&(e.offset=e.sound.currentTime,e.sound.pause())})),this._volumesChanged=!1)}_updateVolumes(e=!0){Object.values(this._soundEffects).forEach((t=>{t.targetFrame>0&&(e?this._sysTick>=t.targetFrame?(t.gain=t.targetGain,t.sourceFrame=-1,t.targetFrame=-1):t.targetGain>t.sourceGain?t.gain=S.map(this._sysTick,t.sourceFrame,t.targetFrame,t.sourceGain,t.targetGain):t.gain=-S.map(this._sysTick,t.sourceFrame,t.targetFrame,-t.sourceGain,-t.targetGain):(t.gain=t.targetGain,t.sourceFrame=-1,t.targetFrame=-1)),t.active&&t.sound.playing&&(t.sound.volume=t.gain*this._globalVolume*this._sfxVolume)})),this._volumesChanged=!0,this._updateSounds()}_getGain(e,t){let a=0,i=t.length-1;if(e<=t[a].position)return t[a].gain;if(e>=t[i].position)return t[i].gain;for(;a<i-1;){const r=Math.floor((a+i)/2),n=t[r].position;if(e<n)i=r;else{if(!(e>n))return t[r].gain;a=r}}return S.map(e,t[a].position,t[i].position,t[a].gain,t[i].gain)}_debugToast=void 0;_setVisibile(e){this._debugToast&&(e?this._debugToast.css("visibility","visible"):this._debugToast.css("visibility","hidden"))}_setPosition(e){if(!this._debugToast)return;const{width:t}=e.getBoundingClientRect();t&&this._debugToast.css("right",t+40+"px")}_setDebugWindow(e){if(!this._debugToast)return;let t="t:"+Math.round(e.tick);t+="</br>v:"+this._globalVolume.toFixed(3),t+="</br>s:"+this._sfxVolume.toFixed(3),t+="<ul>",Object.keys(e.sfx).forEach((a=>{const i=e.sfx[a],r=i.sound.currentTime||0;t+="<li>"+a+" / "+i.gain.toFixed(3)+" / "+r.toFixed(1)+"</li>"})),t+="</ul>",this._debugToast.html(t)}_injectDebugToast(){const e=$("#sidebar");e&&(e.after("<div id='sceneweatherdebug'></div>"),this._debugToast=$("#sceneweatherdebug"),this._debugToast.css({position:"fixed",top:"10px",border:"1px solid white",background:"rgba(0,0,0,0.2)","border-radius":"4px",padding:"10px","font-size":"10px",color:"white",visibility:"visible","z-index":"31","pointer-events":"all"}),this._setPosition(e[0]),Hooks.on("collapseSidebar",((e,t)=>{this._setPosition(e.element[0])})))}}Hooks.on(i.REG_WEATHER_PERCIEVERS,(async()=>{SceneWeather.registerPerciever(e.ID,"icon",new IconPerciever)}));const E="meteo.icon.";class IconPerciever extends WeatherPerception{isAllowed(e){return Permissions.hasPermission(e,"perciever.scene-weather.icon")}async getTextFromModel(e){return Handlebars.compile(T.i18n("meteo.icon.templates.text"))(await this.getWeatherInfoFromModel(e))}async getUiHtmlFromModel(t){return await renderTemplate("modules/"+e.ID+"/templates/iconPerceptionUi.hbs",await this.getWeatherInfoFromModel(t))}async getChatHtmlFromModel(t){return await renderTemplate("modules/"+e.ID+"/templates/iconPerceptionChat.hbs",S.mergeObject({description:await this.getTextFromModel(t)},await this.getWeatherInfoFromModel(t)))}async getWeatherInfoFromModel(e){let t=S.mergeObject(S.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT),{temperature:{air:e.temp.air.toFixed(1),ground:e.temp.ground.toFixed(1),percieved:e.temp.percieved.toFixed(1)},humidity:{percent:NaN},wind:{speed:NaN,gusts:NaN,direction:NaN},clouds:{height:NaN,amount:30*Math.round(30*e.clouds.coverage),type:e.clouds.type},sun:{amount:e.sun.amount>.3?1:0},precipitation:{amount:e.precipitation.amount>.4?1:0,type:e.precipitation.type},composite:{sun:e.sun.amount>.3?"sun":"none",clouds:"none",preci:"none",wind:"none"},descriptive:{sun:e.sun.amount>.3?E+"sun.sun":E+"sun.none",clouds:E+"clouds.none",preci:E+"precipitation.none",wind:E+"wind.none"}});switch(e.clouds.type){case p.fog:return t.composite.clouds="fog",t.descriptive.clouds=E+"clouds.fog",t;case p.stratus:case p.cumulus:t.composite.clouds="cloud",t.descriptive.clouds=E+"clouds.cloud";break;case p.cumulunimbus:t.composite.clouds="thunder",t.descriptive.clouds=E+"clouds.thunder"}switch(e.precipitation.type){case m.drizzle:t.composite.preci="lightRain",t.descriptive.preci=E+"precipitation.lightRain";break;case m.rain:case m.downpour:t.composite.preci="rain",t.descriptive.preci=E+"precipitation.rain";break;case m.hail:case m.snow:t.composite.preci="lightSnow",t.descriptive.preci=E+"precipitation.lightSnow";break;case m.blizzard:t.composite.preci="snow",t.descriptive.preci=E+"precipitation.snow"}return e.wind.speed>50&&(t.composite.wind="wind",t.descriptive.preci=E+"wind.wind"),Logger.debug("IconPerciever.getWeatherInfoFromModel()",{modelData:e,weatherInfo:t}),t}getPercieverInfo(){const e=S.mergeObject(S.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT),{id:"icon",name:T.i18n(E+"name")});return Logger.debug("IconPerciever.getPercieverInfo()",{info:e}),e}}Hooks.on(i.REG_WEATHER_PERCIEVERS,(async()=>{SceneWeather.registerPerciever(e.ID,"perceptive",new PerceptivePerciever)}));const N="meteo.perceptive.";class PerceptivePerciever extends WeatherPerception{isAllowed(e){return Permissions.hasPermission(e,"perciever.scene-weather.perceptive")}async getTextFromModel(e){const t=await this.getWeatherInfoFromModel(e);return Handlebars.compile(T.i18n("meteo.perceptive.templates.text"))(t)}async getUiHtmlFromModel(e){const t=await this.getWeatherInfoFromModel(e);return Handlebars.compile(T.i18n("meteo.perceptive.templates.ui"))(t)}async getChatHtmlFromModel(e){return this.getUiHtmlFromModel(e)}async getWeatherInfoFromModel(e){const t=S.mergeObject(S.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT),PerceptivePerciever._calculateWeatherInfoFromModelData(e));return Logger.debug("PerceptivePerciever.getWeatherInfoFromModel()",{weatherModel:e,weatherInfo:t}),t}getPercieverInfo(){const e=S.mergeObject(S.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT),{id:"perceptive",name:T.i18n(N+"name")});return Logger.debug("PerceptivePerciever.getPercieverInfo()",{info:e}),e}static _fahrenheitToCelsius(e){return(e-32)/1.8}static _celsiusToFahrenheit(e){return 1.8*e+32}static _getPrecipitationTypeId(e){const[t]=Object.entries(m).find((([,t])=>t===e));return t?N+t:N+"none"}static _getPrecipitationAmountId(e){const[t]=Object.entries(v).find((([,t])=>e<t));return N+t}static _getSunAmountId(e){const[t]=Object.entries(y).find((([,t])=>e<t));return N+t}static _getCloudTypeId(e){const[t]=Object.entries(p).find((([,t])=>t===e));return t?N+t:N+"cumulunimbus"}static _getCloudAmountId(e){return N+["skc","few","few","sct","sct","bkn","bkn","bkn","ovc"][Math.round(8*e)]}static _getCloudHightId(e){const[t]=Object.entries(_).find((([,t])=>e<t));return N+t}static _getWindDirId(e){let t=Math.floor(e/22.5+.5);return N+["n","nne","ne","ene","e","ese","se","sse","s","ssw","sw","wsw","w","wnw","nw","nnw"][t%16]}static _getWindSpeedId(e){let t=e.gusts>5?"Gusting":"";const[a]=Object.entries(w).find((([,t])=>e.speed<t));return N+a+t}static _getHumidityId(e){const[t]=Object.entries(f).find((([,t])=>e<t));return N+t}static _getPercievedTempId(e){const[t]=Object.entries(b).find((([,t])=>e<t));return N+t}static _calculateWeatherInfoFromModelData(e){return Logger.debug("PerceptivePerciever._calculateWeatherInfoFromModelData()",{modelData:e}),{name:e.name,temperature:{air:Math.round(e.temp.air),ground:Math.round(e.temp.ground),percieved:Math.round(e.temp.percieved),percievedId:PerceptivePerciever._getPercievedTempId(e.temp.percieved)},humidity:{percent:Math.round(e.humidity),percentId:PerceptivePerciever._getHumidityId(e.humidity)},wind:{speed:Math.round(e.wind.speed),gusts:Math.round(e.wind.gusts),speedId:PerceptivePerciever._getWindSpeedId(e.wind),direction:Math.round(e.wind.direction),directionId:PerceptivePerciever._getWindDirId(e.wind.direction)},clouds:{height:Math.round(e.clouds.bottom),heightId:PerceptivePerciever._getCloudHightId(e.clouds.bottom),amount:Math.round(100*e.clouds.coverage),amountId:PerceptivePerciever._getCloudAmountId(e.clouds.coverage),type:PerceptivePerciever._getCloudTypeId(e.clouds.type)},sun:{amount:Math.round(100*e.sun.amount),amountId:PerceptivePerciever._getSunAmountId(e.sun.amount)},precipitation:{amount:Math.round(100*e.precipitation.amount),amountId:PerceptivePerciever._getPrecipitationAmountId(e.precipitation.amount),type:PerceptivePerciever._getPrecipitationTypeId(e.precipitation.type)}}}}Hooks.on(i.REG_WEATHER_PERCIEVERS,(async()=>{SceneWeather.registerPerciever(e.ID,"precise",new PrecisePerciever)}));class PrecisePerciever extends WeatherPerception{isAllowed(e){return Permissions.hasPermission(e,"perciever.scene-weather.precise")}async getTextFromModel(e){return JSON.stringify(this.getWeatherInfoFromModel(e))}async getUiHtmlFromModel(t){return await renderTemplate("modules/"+e.ID+"/templates/precisePerceptionUi.hbs",await this.getWeatherInfoFromModel(t))}async getChatHtmlFromModel(e){return this.getUiHtmlFromModel(e)}async getWeatherInfoFromModel(e){const t=S.mergeObject(S.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT),{temperature:{air:e.temp.air.toFixed(1),ground:e.temp.ground.toFixed(1),percieved:e.temp.percieved.toFixed(1)},humidity:{percent:e.humidity.toFixed(1)},wind:{speed:Math.round(e.wind.speed),gusts:Math.round(e.wind.gusts),direction:Math.round(e.wind.direction)},clouds:{height:Math.round(e.clouds.bottom),amount:Math.round(100*e.clouds.coverage),type:e.clouds.type,typeId:PrecisePerciever._getCloudTypeId(e.clouds.type)},sun:{amount:Math.round(100*e.sun.amount)},precipitation:{amount:Math.round(100*e.precipitation.amount),type:e.precipitation.type,typeId:PrecisePerciever._getPrecipitationTypeId(e.precipitation.type)}});return Logger.debug("PerceptivePerciever.getWeatherInfoFromModel()",{modelData:e,weatherInfo:t}),t}getPercieverInfo(){const e=S.mergeObject(S.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT),{id:"precise",name:T.i18n("meteo.precise.name")});return Logger.debug("PrecisePerciever.getPercieverInfo()",{info:e}),e}static _getCloudTypeId(e){const[t]=Object.entries(p).find((([,t])=>t===e));return t?`meteo.precise.cloudTypes.${t}`:"meteo.precise.cloudTypes.cumulunimbus"}static _getPrecipitationTypeId(e){const[t]=Object.entries(m).find((([,t])=>t===e));return t?`meteo.precise.precipitationTypes.${t}`:"meteo.precise.precipitationTypes.none"}}Hooks.on(i.REG_WEATHER_PERCIEVERS,(async()=>{Logger.debug("registered weatherPerciever for vague"),SceneWeather.registerPerciever(e.ID,"vague",new VaguePerciever)}));class VaguePerciever extends WeatherPerception{isAllowed(e){return Permissions.hasPermission(e,"perciever.scene-weather.vague")}async getTextFromModel(e){return Handlebars.compile(T.i18n("meteo.vague.templates.text"))(await this.getWeatherInfoFromModel(e))}async getUiHtmlFromModel(e){return Handlebars.compile(T.i18n("meteo.vague.templates.ui"))(await this.getWeatherInfoFromModel(e))}async getChatHtmlFromModel(e){return this.getUiHtmlFromModel(e)}async getWeatherInfoFromModel(e){const t=5*Math.round(e.temp.percieved/5);let a=S.mergeObject(S.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT),{temperature:{air:t,ground:NaN,percieved:t},humidity:{percent:NaN},wind:{speed:NaN,gusts:NaN,direction:NaN},clouds:{height:NaN,amount:10*Math.round(10*e.clouds.coverage),type:e.clouds.type>p.stratus?p.cumulus:p.none},sun:{amount:e.sun.amount>.3?1:0},precipitation:{amount:e.precipitation.amount>.4?1:0,type:e.precipitation.type>m.rain?m.rain:m.none},modifiers:{skyType:"none",tempType:"none",windType:"none"}});if(e.clouds.type==p.none)a.modifiers.skyType="meteo.vague.clear";else if(e.clouds.type==p.fog)a.modifiers.skyType="meteo.vague.fog";else if(e.clouds.type>=p.stratus)switch(e.precipitation.type){case m.blizzard:case m.snow:a.modifiers.skyType="meteo.vague.snow";break;case m.hail:case m.downpour:a.modifiers.skyType="meteo.vague.downpour",e.clouds.type>=p.cumulunimbus&&(a.modifiers.skyType="meteo.vague.thunderstorm");break;case m.rain:a.modifiers.skyType="meteo.vague.rain",e.clouds.type>=p.cumulunimbus&&(a.modifiers.skyType="meteo.vague.thunderstorm");break;case m.drizzle:a.modifiers.skyType="meteo.vague.drizzle";break;case m.none:default:a.modifiers.skyType="meteo.vague.cloudy"}return t>30?(a.modifiers.tempType="meteo.vague.warm",e.wind.speed>40&&(a.modifiers.windType="meteo.vague.windy")):t<5&&(a.modifiers.tempType="meteo.vague.cold",e.wind.speed>40&&(a.modifiers.windType="meteo.vague.windy")),Logger.debug("VaguePerciever.getWeatherInfoFromModel()",{modelData:e,weatherInfo:a}),a}getPercieverInfo(){const e=S.mergeObject(S.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT),{id:"vague",name:T.i18n("meteo.vague.name")});return Logger.debug("VaguePerciever.getPercieverInfo()",{info:e}),e}}Hooks.once("init",(()=>{Logger.trace("->Hook:InternalTimeProvider.init()"),TimeProvider._instances[h.INTERNAL]=new InternalTimeProvider(!0),TimeProvider._instances[h.EXTERNAL]=new InternalTimeProvider(!1)}));class InternalTimeProvider extends TimeProvider{constructor(e=!1){super(),Logger.trace("InternalTimeProvider:ctor(...)",{hasAuthority:e}),this._hasAuthoriy=e,this._monthOffset=[0,31,59,90,120,151,181,212,243,273,304,334],this._monthDays=[31,28,31,30,31,30,31,31,30,31,30,31],this._monthDaysLeapYear=[31,29,31,30,31,30,31,31,30,31,30,31]}hasTimeAuthority(){return this._hasAuthoriy}async advanceGameTime(e=0){if(Logger.debug("InternalTimeProvider.advanceGameTime(...)",{deltaSeconds:e}),this._hasAuthoriy){if(0==e)return;T.isGm()&&(T.getWorldTime(),await T.advanceWorldTime(e))}}getHoursInDay(){return 24}getDaysInYear(){return 365}getNumberOfMonths(){return 12}getMonthOffset(e){return this._monthOffset[S.clamp(e,0,11)]}getSummerSolsticeDay(){return 172}getWinterSolsticeDay(){return 355}getDaylightCyclePct(){return S.map(this.getHourOfDay(),0,24,0,1)}getSeasonCyclePct(){const e=this.getDayOfYear();let t=e<172,a=t?1-(172-e)/183:(e-172)/183;return a>1&&(a-=1,t=!t),t?a:1+a}async setDaylightCyclePct(e=.5){if(this._hasAuthoriy){const t=this._gameTimeToDate(T.getWorldTime()),a=Math.trunc(3600*t.hour+60*t.minute+t.second),i=Math.trunc(S.map(e,0,1,0,86399));return Logger.trace("InternalTimeProvider.setDaylightCyclePct()",{daylightCyclePct:e,secondsAfterMidnightCurrent:a,secondsAfterMidnightDesired:i}),this.advanceGameTime(i-a)}}async setSeasonCyclePct(e=.5){if(this._hasAuthoriy){const t=this._gameTimeToDate(T.getWorldTime()),a=this._monthOffset[t.month]+t.day,i=a>355?a-355:a+10,r=Math.trunc(S.map(e,0,1,0,364));return Logger.trace("InternalTimeProvider.setSeasonCyclePct()",{seasonCyclePct:e,daysAfterWinterSolsticeCurrent:i,daysAfterWinterSolsticeDesired:r}),this.advanceGameTime(86400*(r-i))}}getDayOfYear(e=0,t=0){const a=this._gameTimeToDate(T.getWorldTime()+3600*t+86400*e),i=this._monthOffset[a.month]+a.day;return Logger.trace("InternalTimeProvider.getDayOfYear()",{"month#":a.month,"day#":a.day,doY:i}),i}getHourOfDay(e=0,t=0){const a=T.getWorldTime()+3600*t+86400*e,i=Math.abs(Math.trunc(a%86400/3600));return Logger.trace("InternalTimeProvider.getHourOfDay()",{currentWorldTime:a,dayTime:i}),a<0?24-i:i}hourOfDayNoonPct(e=0,t=0){const a=TimeProvider.getHourOfDay(e,t)%24;return(Math.sin((a/12-.5)*Math.PI)+1)/2}dayOfYearSummerPct(e=0,t=0){let a,i=TimeProvider.getDayOfYear(e,t);return i>355&&(i-=365),a=172==i?1:i<172?(i+10)/182:1-(i-172)/183,a}static _decodeFractalString(e=0,t=""){if(""==t)return"";let a="";return t.split(",").find((t=>{const[i,r]=t.split(":");if(i.includes("-")){const[t,n]=i.split("-");if(e<=Number(n)&&e>=Number(t))return a=r,!0}else if(Number(i)==e)return a=r,!0;return!1})),a}static _isLeapYear(e){return e%4==0&&(e%100!=0||e%100==0&&e%400==0)}_gameTimeToDate(e=0){const t=e<0;e=Math.abs(e);let a=Math.floor(e/86400);e-=86400*a;let i=t?86400-e:e;const r=Math.floor(i/3600)%24;i-=3600*r;const n=Math.floor(i/60)%60;i-=60*n;const o=i%60;let s,d,c,l,h=!1;for(t?(c=1969,d=11,s=30,l=-1,0===o&&0===n&&0===r&&a--):(c=1970,d=0,s=0,l=1);a>0;){const e=h?366:365;let t=h?this._monthDaysLeapYear[d]:this._monthDays[d];if(a>=e)c+=l,h=InternalTimeProvider._isLeapYear(c),l<0&&(t=h?this._monthDaysLeapYear[d]:this._monthDays[d]),a-=e;else if(a>=t){d+=l;let e=h?this._monthDaysLeapYear[d]:this._monthDays[d],i=0;for(;0===e&&i<=12;)d+=l,e=h?this._monthDaysLeapYear[d]:this._monthDays[d],i++;l<0&&(s=h?this._monthDaysLeapYear[d]-1:this._monthDays[d]-1),a-=t}else s+=l,a--}return l>0&&c<0&&s++,{year:c,month:d,day:s,hour:r,minute:n,second:o}}getTimeStringData(){const e=T.getWorldTime(),t=this._gameTimeToDate(e);return{month:{number:Number(t.month),name:T.i18n("time.months."+t.month),prefix:InternalTimeProvider._decodeFractalString(t.month+1,T.i18n("time.monthPrefixTypes")),suffix:InternalTimeProvider._decodeFractalString(t.month+1,T.i18n("time.monthSuffixTypes"))},day:{number:Number(t.day),name:String(t.day+1),prefix:InternalTimeProvider._decodeFractalString(t.day+1,T.i18n("time.dayPrefixTypes")),suffix:InternalTimeProvider._decodeFractalString(t.day+1,T.i18n("time.daySuffixTypes"))},hour:{number:Number(t.hour),name:t.hour<10?"0"+t.hour:String(t.hour)},minute:{number:Number(t.minute),name:t.minute<10?"0"+t.minute:String(t.minute)}}}}Hooks.once("init",(()=>{Logger.trace("->Hook:init -> ScTimeProvider.init()"),T.isModuleEnabled("foundryvtt-simple-calendar")&&(TimeProvider._instances[h.SIMPLE_CALENDAR]=new ScTimeProvider)})),Hooks.once("simple-calendar-init",(()=>{Logger.trace("->Hook:simple-calendar-init -> ScTimeProvider.initConfig()"),T.isModuleEnabled("foundryvtt-simple-calendar")&&ScTimeProvider.initConfig()}));class ScTimeProvider extends TimeProvider{static _config={daysInYear:365,summerSolstice:172,winterSolstice:355,monthOffset:[0,31,59,90,120,151,181,212,243,273,304,334],hoursInDay:24,minutesInHour:60,secondsInMinute:60,secondsInHour:3600,secondsInDay:86400};constructor(){super(),Logger.trace("ScTimeProvider:ctor()")}hasTimeAuthority(){return!1}async advanceGameTime(e=0){Logger.warn("ScTimeProvider.advanceGameTime(...) -> no time authority, ignoring")}getHoursInDay(){return ScTimeProvider._config.hoursInDay}getDaysInYear(){return ScTimeProvider._config.daysInYear}getNumberOfMonths(){return ScTimeProvider._config.monthOffset.length}getMonthOffset(e){return ScTimeProvider._config.monthOffset[Utils.clamp(e,0,ScTimeProvider._config.monthOffset.length-1)]}getSummerSolsticeDay(){return ScTimeProvider._config.summerSolstice}getWinterSolsticeDay(){return ScTimeProvider._config.winterSolstice}getDaylightCyclePct(){return Utils.map(this.getHourOfDay(),0,ScTimeProvider._config.hoursInDay,0,1)}getSeasonCyclePct(){const e=ScTimeProvider._config.summerSolstice,t=ScTimeProvider._config.winterSolstice,a=this.getDayOfYear(),i=t>e?t-e:e-t;let r=a<e,n=r?1-(e-a)/i:(a-e)/i;return n>1&&(n-=1,r=!r),r?n:1+n}async setDaylightCyclePct(e){Logger.trace("ScTimeProvider.setDaylightCyclePct(...) no time authority!",{daylightCyclePct:e})}async setSeasonCyclePct(e){Logger.trace("ScTimeProvider.setSeasonCyclePct(...) no time authority!",{seasonCyclePct:e})}getDayOfYear(e=0,t=0){const a=SimpleCalendar.api.timestampToDate(T.getWorldTime()+t*ScTimeProvider._config.secondsInHour+e*ScTimeProvider._config.secondsInDay);return Logger.trace("ScTimeProvider.getDayOfYear()",{scInstance:a,_config:ScTimeProvider._config}),ScTimeProvider._config.monthOffset[a.month]+a.day}getHourOfDay(e=0,t=0){const a=T.getWorldTime()+t*ScTimeProvider._config.secondsInHour+e*ScTimeProvider._config.secondsInDay,i=Math.abs(Math.trunc(a%ScTimeProvider._config.secondsInDay/ScTimeProvider._config.secondsInHour));return Logger.trace("ScTimeProvider.getHourOfDay()",{currentWorldTime:a,dayTime:i}),a<0?ScTimeProvider._config.hoursInDay-i:i}hourOfDayNoonPct(e=0,t=0){const a=this.getHourOfDay(e,t)%ScTimeProvider._config.hoursInDay;return(Math.sin((a/(ScTimeProvider._config.hoursInDay/2)-.5)*Math.PI)+1)/2}dayOfYearSummerPct(e=0,t=0){let a=this.getDayOfYear(e,t);const i=ScTimeProvider._config.summerSolstice,r=ScTimeProvider._config.winterSolstice;let n,o=r,s=r;return r<i?s=r+ScTimeProvider._config.daysInYear:o=r-ScTimeProvider._config.daysInYear,a>s&&(a-=ScTimeProvider._config.daysInYear),n=a==i?1:a<i?(a-o)/(i-o):1-(a-i)/(s-i),n}getTimeStringData(){const e=SimpleCalendar.api.timestampToDate(T.getWorldTime());return{month:{number:e.display.month,name:e.display.monthName,prefix:"",suffix:""},day:{number:e.display.day,name:e.display.day,prefix:"",suffix:e.display.daySuffix},hour:{number:e.hour,name:e.hour<10?"0"+e.hour:e.hour},minute:{number:e.minute,name:e.minute<10?"0"+e.minute:e.minute}}}static _getHoursInDay(){return ScTimeProvider._config.hoursInDay}static initConfig(){const e=SimpleCalendar.api.getAllMonths()||[],t=SimpleCalendar.api.getTimeConfiguration(),a=e.map((e=>e.numberOfDays)),i=ScTimeProvider._getStartingDays(a),r=i[i.length-1]+a[a.length-1];ScTimeProvider._config={providerId:h.SIMPLE_CALENDAR,daysInYear:r,summerSolstice:172,winterSolstice:355,monthOffset:i,hoursInDay:t.hoursInDay,minutesInHour:t.minutesInHour,secondsInMinute:t.secondsInMinute,secondsInHour:t.secondsInMinute*t.minutesInHour,secondsInDay:t.secondsInMinute*t.minutesInHour*t.hoursInDay},ScTimeProvider._calculateSolstices(),Logger.debug("ScTimeProvider._initConfig(simple-calendar)",{_config:ScTimeProvider._config})}static _getStartingDays(e){const t=e.reduce(((e,t)=>(e.push(e[e.length-1]+t),e)),[0]).slice(0,-1);return Logger.trace("ScTimeProvider._getStartingDays(...)",{daysInMonth:e,dayOffsets:t}),t}static _calculateSolstices(){let e=[];ScTimeProvider._config.summerSolstice=-1,ScTimeProvider._config.winterSolstice=-1,SimpleCalendar.api.getAllSeasons().forEach((t=>{const a=ScTimeProvider._config.monthOffset[t.startingMonth]+t.startingDay;e.push({icon:t.icon,dayLengthSeconds:t.sunsetTime-t.sunriseTime,startingDoY:a}),"summer"==t.icon&&(ScTimeProvider._config.summerSolstice=a),"winter"==t.icon&&(ScTimeProvider._config.winterSolstice=a)}));const t=e.sort(((e,t)=>e.startingDoY-t.startingDoY));if(-1==ScTimeProvider._config.summerSolstice){const e=t.reduce(((e,t)=>e.dayLengthSeconds>=t.dayLengthSeconds?e:t),null);ScTimeProvider._config.summerSolstice=e.startingDoY}if(-1==ScTimeProvider._config.winterSolstice){const e=t.reduce(((e,t)=>e.dayLengthSeconds<=t.dayLengthSeconds?e:t),null);ScTimeProvider._config.winterSolstice=e.startingDoY}Logger.trace("ScTimeProvider._calculateSolstices()",{summerSolstice:ScTimeProvider._config.summerSolstice,winterSolstice:ScTimeProvider._config.winterSolstice})}}Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"alpine",{name:"templates.region.alpine.name",description:"templates.region.alpine.description",elevation:1e3,vegetation:0,waterAmount:0,summer:{temperature:{day:15,night:5,var:7.5},humidity:{day:50,night:60,var:5},wind:{avg:30,var:10},sun:{hours:14}},winter:{temperature:{day:0,night:-15,var:7.5},humidity:{day:70,night:60,var:5},wind:{avg:40,var:20},sun:{hours:10}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"chaparral",{name:"templates.region.chaparral.name",description:"templates.region.chaparral.description",elevation:1e3,vegetation:5,waterAmount:5,summer:{temperature:{day:32.5,night:17.5,var:5},humidity:{day:60,night:40,var:5},wind:{avg:25,var:10},sun:{hours:13}},winter:{temperature:{day:17.5,night:2.5,var:5},humidity:{day:60,night:50,var:5},wind:{avg:30,var:10},sun:{hours:11}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"coastal",{name:"templates.region.coastal.name",description:"templates.region.coastal.description",elevation:100,vegetation:20,waterAmount:70,summer:{temperature:{day:25,night:15,var:10},humidity:{day:80,night:75,var:15},wind:{avg:10,var:25},sun:{hours:14}},winter:{temperature:{day:15,night:5,var:10},humidity:{day:75,night:70,var:5},wind:{avg:20,var:25},sun:{hours:10}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"desert",{name:"templates.region.desert.name",description:"templates.region.desert.description",elevation:500,vegetation:0,waterAmount:0,summer:{temperature:{day:45,night:25,var:10},humidity:{day:10,night:20,var:5},wind:{avg:30,var:10},sun:{hours:13}},winter:{temperature:{day:25,night:5,var:10},humidity:{day:30,night:50,var:20},wind:{avg:25,var:10},sun:{hours:11}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"grassland",{name:"templates.region.grassland.name",description:"templates.region.grassland.description",elevation:200,vegetation:40,waterAmount:20,summer:{temperature:{day:30,night:15,var:10},humidity:{day:70,night:80,var:5},wind:{avg:10,var:10},sun:{hours:14}},winter:{temperature:{day:10,night:-5,var:10},humidity:{day:70,night:60,var:10},wind:{avg:10,var:10},sun:{hours:10}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"littoral",{name:"templates.region.littoral.name",description:"templates.region.littoral.description",elevation:0,vegetation:1,waterAmount:50,summer:{temperature:{day:25,night:15,var:10},humidity:{day:60,night:60,var:5},wind:{avg:10,var:5},sun:{hours:16}},winter:{temperature:{day:15,night:5,var:10},humidity:{day:60,night:60,var:10},wind:{avg:15,var:10},sun:{hours:8}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"mangrove",{name:"templates.region.mangrove.name",description:"templates.region.mangrove.description",elevation:0,vegetation:80,waterAmount:60,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:60,night:70,var:10},wind:{avg:10,var:5},sun:{hours:16}},winter:{temperature:{day:27.5,night:17.5,var:5},humidity:{day:60,night:60,var:10},wind:{avg:15,var:10},sun:{hours:8}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"mediterranean",{name:"templates.region.mediterranean.name",description:"templates.region.mediterranean.description",elevation:500,vegetation:50,waterAmount:20,summer:{temperature:{day:30,night:17.5,var:7.5},humidity:{day:60,night:65,var:5},wind:{avg:15,var:10},sun:{hours:15}},winter:{temperature:{day:17.5,night:7.5,var:5},humidity:{day:70,night:60,var:10},wind:{avg:20,var:10},sun:{hours:9}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"polar",{name:"templates.region.polar.name",description:"templates.region.polar.description",elevation:0,vegetation:0,waterAmount:30,summer:{temperature:{day:2.5,night:-2.5,var:5},humidity:{day:80,night:65,var:10},wind:{avg:35,var:20},sun:{hours:23}},winter:{temperature:{day:-15,night:-25,var:10},humidity:{day:90,night:70,var:5},wind:{avg:40,var:20},sun:{hours:1}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"rainforest",{name:"templates.region.rainforest.name",description:"templates.region.rainforest.description",elevation:200,vegetation:100,waterAmount:80,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:90,night:80,var:10},wind:{avg:5,var:5},sun:{hours:12}},winter:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:80,night:70,var:10},wind:{avg:5,var:5},sun:{hours:12}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"savanna",{name:"templates.region.savanna.name",description:"templates.region.savanna.description",elevation:300,vegetation:30,waterAmount:5,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:60,night:70,var:10},wind:{avg:20,var:10},sun:{hours:13}},winter:{temperature:{day:27.5,night:17.5,var:5},humidity:{day:40,night:30,var:10},wind:{avg:20,var:10},sun:{hours:11}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"steppe",{name:"templates.region.steppe.name",description:"templates.region.steppe.description",elevation:500,vegetation:5,waterAmount:0,summer:{temperature:{day:27.5,night:15,var:5},humidity:{day:30,night:25,var:5},wind:{avg:25,var:10},sun:{hours:14}},winter:{temperature:{day:5,night:-5,var:10},humidity:{day:40,night:30,var:10},wind:{avg:20,var:10},sun:{hours:10}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"taiga",{name:"templates.region.taiga.name",description:"templates.region.taiga.description",elevation:400,vegetation:70,waterAmount:10,summer:{temperature:{day:20,night:10,var:10},humidity:{day:70,night:80,var:5},wind:{avg:15,var:10},sun:{hours:17}},winter:{temperature:{day:-5,night:-25,var:10},humidity:{day:80,night:60,var:5},wind:{avg:25,var:10},sun:{hours:8}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"temperate",{name:"templates.region.temperate.name",description:"templates.region.temperate.description",elevation:400,vegetation:50,waterAmount:10,summer:{temperature:{day:25,night:15,var:10},humidity:{day:70,night:60,var:10},wind:{avg:15,var:10},sun:{hours:15}},winter:{temperature:{day:10,night:0,var:10},humidity:{day:60,night:65,var:5},wind:{avg:20,var:10},sun:{hours:9}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"tundra",{name:"templates.region.tundra.name",description:"templates.region.tundra.description",elevation:300,vegetation:1,waterAmount:5,summer:{temperature:{day:7.5,night:2.5,var:5},humidity:{day:60,night:50,var:10},wind:{avg:20,var:10},sun:{hours:18}},winter:{temperature:{day:-15,night:-25,var:10},humidity:{day:70,night:50,var:5},wind:{avg:25,var:10},sun:{hours:6}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"wetland",{name:"templates.region.wetland.name",description:"templates.region.wetland.description",elevation:100,vegetation:60,waterAmount:80,summer:{temperature:{day:25,night:15,var:10},humidity:{day:70,night:80,var:10},wind:{avg:15,var:10},sun:{hours:16}},winter:{temperature:{day:5,night:-5,var:10},humidity:{day:60,night:60,var:5},wind:{avg:20,var:5},sun:{hours:8}}})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"blizzard",{name:"templates.weather.blizzard.name",temp:{ground:0,air:-3,percieved:-4},wind:{speed:70,gusts:85,direction:115},clouds:{coverage:.7,bottom:1e3,top:3e3,type:p.cumulunimbus},precipitation:{amount:1,type:m.blizzard},sun:{amount:.1},humidity:10})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"densefog",{name:"templates.weather.densefog.name",temp:{ground:18,air:15,percieved:16},wind:{speed:15,gusts:16,direction:127},clouds:{coverage:.9,bottom:0,top:3e3,type:p.fog},precipitation:{amount:0,type:m.none},sun:{amount:.6},humidity:80})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"fog",{name:"templates.weather.fog.name",temp:{ground:18,air:15,percieved:16},wind:{speed:15,gusts:16,direction:127},clouds:{coverage:.3,bottom:0,top:3e3,type:p.fog},precipitation:{amount:0,type:m.none},sun:{amount:.6},humidity:80})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"frigid",{name:"templates.weather.frigid.name",temp:{ground:-5,air:-20,percieved:-25},wind:{speed:30,gusts:35,direction:70},clouds:{coverage:0,bottom:0,top:0,type:p.none},precipitation:{amount:0,type:m.none},sun:{amount:.6},humidity:10})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"heatwave",{name:"templates.weather.heatwave.name",temp:{ground:30,air:37,percieved:42},wind:{speed:0,gusts:0,direction:0},clouds:{coverage:0,bottom:0,top:0,type:p.none},precipitation:{amount:0,type:m.none},sun:{amount:1},humidity:80})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"heavyrain",{name:"templates.weather.heavyrain.name",temp:{ground:15,air:15,percieved:12},wind:{speed:25,gusts:29,direction:85},clouds:{coverage:.8,bottom:500,top:1e3,type:p.cumulus},precipitation:{amount:.9,type:m.rain},sun:{amount:.3},humidity:70})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"moderaterain",{name:"templates.weather.moderaterain.name",temp:{ground:16,air:18,percieved:16},wind:{speed:14,gusts:18,direction:75},clouds:{coverage:.6,bottom:1e3,top:3e3,type:p.cumulus},precipitation:{amount:.4,type:m.rain},sun:{amount:.6},humidity:65})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"partlycloudy",{name:"templates.weather.partlycloudy.name",temp:{ground:22,air:25,percieved:25},wind:{speed:20,gusts:25,direction:15},clouds:{coverage:.3,bottom:3e3,top:4e3,type:p.stratus},precipitation:{amount:0,type:m.none},sun:{amount:.6},humidity:60})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"rain",{name:"templates.weather.rain.name",temp:{ground:15,air:17,percieved:15},wind:{speed:22,gusts:27,direction:80},clouds:{coverage:.8,bottom:500,top:1e3,type:p.cumulus},precipitation:{amount:.6,type:m.rain},sun:{amount:.3},humidity:65})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"slightsnow",{name:"templates.weather.slightsnow.name",id:"",name:"Snowing slightly",temp:{ground:1,air:2,percieved:0},wind:{speed:14,gusts:18,direction:133},clouds:{coverage:.3,bottom:1e3,top:3e3,type:p.cumulus},precipitation:{amount:.4,type:m.snow},sun:{amount:.5},humidity:45})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"snow",{name:"templates.weather.snow.name",id:"",name:"Snowing",temp:{ground:0,air:-3,percieved:-4},wind:{speed:24,gusts:28,direction:223},clouds:{coverage:.3,bottom:1e3,top:3e3,type:p.cumulus},precipitation:{amount:.6,type:m.snow},sun:{amount:.3},humidity:45})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"default",{name:"templates.weather.default.name",temp:{ground:18,air:21,percieved:24},wind:{speed:1,gusts:0,direction:15},clouds:{coverage:0,bottom:0,top:0,type:p.none},precipitation:{amount:0,type:m.none},sun:{amount:.8},humidity:60})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"thunderstorm",{name:"templates.weather.thunderstorm.name",temp:{ground:14,air:13,percieved:11},wind:{speed:50,gusts:75,direction:90},clouds:{coverage:.95,bottom:500,top:8e3,type:p.cumulunimbus},precipitation:{amount:.95,type:m.downpour},sun:{amount:.1},humidity:70})}));export{c as AMBIENCE_MASK_COLOR,d as AMBIENCE_TYPE,AbstractWeatherNode,BorderHandle,BorderNodeHandle,_ as CLOUD_HEIGHT,p as CLOUD_TYPE,r as CREATION_STATES,ColorFilter,DashLine,i as EVENTS,EmitterWeatherNode,FlashFilter,T as FoundryAbstractionLayer,a as GENERATOR_MODES,Generators,f as HUMIDITY_LEVELS,InternalTimeProvider,Logger,n as MASK_BORDER_TYPE,g as METEO,e as MODULE,MacroConfigDialog,MacroGenerator,MaskWeatherNode,Meteo,MeteoUi,o as NODE_TYPE,NodeFrame,Noise,v as PRECI_AMOUNT,m as PRECI_TYPE,PermissionConfigDialog,Permissions,l as RAIN_MODES,RegionConfigDialog,RegionMeteo,u as SEASONS,y as SUN_INTENSITY,t as SWCONFIG,ScTimeProvider,SceneWeather$1 as SceneWeather,SceneWeatherLayer,SceneWeatherState,SfxHandler,b as TEMP_TYPES,h as TIME_PROVIDERS,TimeProvider,TokenAmbience,S as Utils,s as WIND_MODES,w as WIND_SPEED,WeatherConfigDialog,WeatherEffect,WeatherEffectsLayer,WeatherModel,WeatherNodeConfig,WeatherNodeData,WeatherNodeGraphics,WeatherNodeHud,WeatherNodeMask,WeatherPerception,WeatherTab,WeatherUi,WelcomeDialog,getSceneWeatherAPIv1,loadHandlebars,registerHbHelpers,registerSettingsPostInit,registerSettingsPreInit};
