let e={ID:"scene-weather",NAME:"Scene Weather",LCCNAME:"sceneWeather",VERSION:"development"};const t={DISABLED:"disabled",WEATHER_TEMPLATE:"weatherTemplate",WEATHER_GENERATE:"weatherAuto",REGION_TEMPLATE:"regionTemplate",REGION_GENERATE:"regionAuto"},r={REG_FX_FILTERS:e.LCCNAME+"RegisterFilters",REG_FX_GENERATORS:e.LCCNAME+"RegisterGenerators",SETTINGS_UPDATED:e.LCCNAME+"SettingsUpdated",REG_TEMPLATE_REGION:e.LCCNAME+"RegisterRegionTemplate",REG_TEMPLATE_WEATHER:e.LCCNAME+"RegisterWeatherTemplate",REG_WEATHER_PERCIEVERS:e.LCCNAME+"RegisterWeatherPercievers",MODULE_INITIALIZED:e.LCCNAME+"Initialized",WEATHER_UPDATED:e.LCCNAME+"WeatherUpdated"},i={fixed:0,procedural:1},a={WINDDIR:"winddir",TOPDOWN:"topdown",SLANTED:"slanted",WINDINFLUENCED:"windinfluence"},n={INTERNAL:"internal",EXTERNAL:"external",SIMPLE_CALENDAR:"simple-calendar"},o={isaMSLtempC:16,isaSeaLevelPa:101325,adiabaticHyDryCoeff:-.0065,g:9.80665,mAir:.0289644,R:8.3144598,Tzero:237.7},s={winter:.1667,latewinter:.3333,earlyspring:.5,spring:.6667,latespring:.8333,earlysummer:1,summer:1.1667,latesummer:1.3333,earlyfall:1.5,fall:1.6667,latefall:1.8333,earlywinter:2},c={none:0,drizzle:1,rain:2,downpour:3,hail:4,snow:5,blizzard:6},d={none:0,fog:1,stratus:2,cumulus:3,cumulunimbus:4},l={dry:20,comfortable:40,pleasant:50,sticky:65,humid:75,oppressive:1/0},g={gloomy:.1,shaded:.3,normal:.7,bright:1/0},u={nothing:.2,slight:.4,average:.7,heavy:.95,extreme:1/0},m={calm:1,light:5,lightBreeze:11,gentleBreeze:28,freshBreeze:38,strongBreeze:49,moderateGale:61,freshGale:74,strongGale:88,wholeGale:102,storm:118,hurricane:1/0},h={low:600,mid:1e3,high:4e3,veryhigh:1/0},p={freezing:-7,cold:-3,chill:3,fresh:7,moderate:18,mild:22,warm:30,hot:37,searing:1/0};class FoundryAbstractionLayer{static get worldId(){return game.world.id}static get systemID(){return game.system.id}static get systemVersion(){return game.system.version||game.system.data.version}static isGm(e=null){const t=e?FoundryAbstractionLayer.getUser(e):game.user;return!!t&&t.isGM}static userName(){const e=game.user;return e&&e.name?e.name:""}static userID(){const e=game.user;return e&&e.id?e.id:""}static getUser(e){const t=game.users;if(t)return t.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getControlledToken(){return game.canvas.tokens.controlled[0]}static getUserByToken(e){let t,r=e.actor.ownership;return game.users.forEach((e=>{null!==e.character&&e.active&&r[e._id]>0&&(t=e)})),t}static getModuleVersion(){const t=game.modules.get(e.ID);return t?t.version:""}static getLastTickTime(){return canvas.app.ticker.lastTime}static getWorldTime(){return game.time.worldTime}static async advanceWorldTime(e=0){return game.time.advance(e)}static isModuleEnabled(e){const t=game.modules.get(e);return t&&t.active}static getSetting(t,r=null){let i=r??null;try{i=game.settings.get(e.ID,t)}catch{console.log(e.NAME+` Debug | GameConfig '${t}' not found`)}return i}static async setSetting(t,r){game.settings.settings.get(`${e.ID}.${t}`)?(await game.settings.set(e.ID,t,r),Logger.debug(`GameConfig '${t}' set to '${r}'`)):Logger.debug(`GameConfig '${t}' not found`)}static getItem(e,t){return e.items.get(t)}static getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getControlledToken(){return game.canvas.tokens.controlled[0]}static getActor(e,t){let r=null;return t&&(r=canvas.tokens.placeables.find((e=>e.id===t))),r?r.actor:game.actors.get(e)}static getUserByTokenId(e){let t,r=e.actor.ownership;return game.users.forEach((e=>{null!==e.character&&e.active&&r[e._id]>0&&(t=e)})),t}static getScene(e){return e?game.scenes.get(e):canvas.scene}static getSceneFlag(t,r=null,i){let a=r??null;try{a=FoundryAbstractionLayer.getScene(i).getFlag(e.ID,t)??r}catch{Logger.debug(`SceneFlag '${t}' not found on scene`)}return a}static async setSceneFlag(t,r,i){return FoundryAbstractionLayer.getScene(i).setFlag(e.ID,t,r)}static async unsetSceneFlag(t,r){return FoundryAbstractionLayer.getScene(r).unsetFlag(e.ID,t)}static getUserFlag(t,r){let i=r??void 0;try{return game.user.getFlag(e.ID,t)}catch{console.log(e.NAME+` Debug | UserFlag '${t}' not found`)}return i}static async setUserFlag(t,r){await game.user.setFlag(e.ID,t,r)}static async unsetUserFlag(t){await game.user.unsetFlag(e.ID,t)}static i18n(e,t=null){let r=game.i18n.localize(e);return r==e?(null==t&&(r=e),r):r}static getModule(t=e.ID){return game.modules.get(t)}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}}class Logger{static info(t,r=!1){console.log("%c"+e.NAME+" | "+t,"color: cornflowerblue;"),r&&ui.notifications.info(e.NAME+` | ${t}`)}static warn(t,r=!1,i=!1){console.error("%c"+e.NAME+" | "+t,"color: gold; background-color: darkgoldenrod;"),r&&ui.notifications.warn(e.NAME+` | ${t}`,{permanent:i})}static error(t,r=!1,i=!1){console.error("%c"+e.NAME+" | "+t,"color: orangered; background-color: darkred;"),r&&ui.notifications.error(e.NAME+` | ${t}`,{permanent:i})}static _dereferencer={info:{debug:Logger._ignore,trace:Logger._ignore},debug:{debug:Logger._debug,trace:Logger._ignore},trace:{debug:Logger._debug,trace:Logger._trace}};static debug(e,t){Logger._dereferencer[FoundryAbstractionLayer.getSetting("loglevel","info")].debug(e,t)}static trace(e,t){Logger._dereferencer[FoundryAbstractionLayer.getSetting("loglevel","info")].trace(e,t)}static _ignore(e,t){}static _debug(t,r){if(r){const i=Utils$1.deepClone(r);console.log("%c"+e.NAME+" | "+t,"color: darkgrey;",i)}else console.log("%c"+e.NAME+" | "+t,"color: darkgrey;")}static _trace(t,r){if(r){const i=Utils$1.deepClone(r);console.log("%c"+e.NAME+" | "+t,"color: lime; background-color: darkgreen;",i)}else console.log("%c"+e.NAME+" | "+t,"color: lime; background-color: darkgreen;")}}class Utils$1{static getSeedFromString(e){let t=0;if(0===e.length)return t;for(let r=0;r<e.length;r++){t=(t<<5)-t+e.charCodeAt(r),t|=0}return Math.abs(t)}static objectsEqual(e,t){return void 0!==e&&void 0!==t&&(null==e||null==t||"Object"!==getType(e)||"Object"!==getType(t)?e===t:Object.keys(e).length===Object.keys(t).length&&Object.entries(e).every((([e,r])=>{const i=t[e],a=getType(r);return a===getType(i)&&(r?.equals instanceof Function?r.equals(i):"Object"===a?Utils$1.objectsEqual(r,i):r===i)})))}static mergeObject(e,t={},{insertKeys:r=!0,insertValues:i=!0,overwrite:a=!0,recursive:n=!0,inplace:o=!0,enforceTypes:s=!1,performDeletions:c=!1,expand:d=!0}={},l=0){if(t=t||{},!(e instanceof Object&&t instanceof Object))throw new Error("One of original or other are not Objects!");const g={insertKeys:r,insertValues:i,overwrite:a,recursive:n,inplace:o,enforceTypes:s,performDeletions:c,expand:d};if(0===l)if(d&&Object.keys(t).some((e=>/\./.test(e)))&&(t=expandObject(t)),Object.keys(e).some((e=>/\./.test(e)))){const t=d?expandObject(e):e;o&&d?(Object.keys(e).forEach((t=>delete e[t])),Object.assign(e,t)):e=t}else o||(e=Utils$1.deepClone(e));for(let r of Object.keys(t)){const i=t[r];e.hasOwnProperty(r)?Utils$1._mergeUpdate(e,r,i,g,l+1):Utils$1._mergeInsert(e,r,i,g,l+1)}return e}static _mergeInsert(e,t,r,{insertKeys:i,insertValues:a,performDeletions:n,expand:o}={},s){if(t.startsWith("-=")&&n)return void delete e[t.slice(2)];(s<=1&&i||s>1&&a)&&(e[t]=r?.constructor!==Object?r:Utils$1.mergeObject({},r,{insertKeys:!0,inplace:!0,performDeletions:n,expand:o}))}static _mergeUpdate(e,t,r,{insertKeys:i,insertValues:a,enforceTypes:n,overwrite:o,recursive:s,performDeletions:c,expand:d}={},l){const g=e[t],u=getType(r),m=getType(g);if("Object"===u&&"Object"===m&&s)return Utils$1.mergeObject(g,r,{insertKeys:i,insertValues:a,overwrite:o,enforceTypes:n,performDeletions:c,expand:d,inplace:!0},l);if(o){if("undefined"!==m&&u!==m&&n)throw new Error("Mismatched data types encountered during object merge.");e[t]=r}}static flattenObject(e,t=0){return flattenObject(e,t)}static copyToClipboard(e=""){let t=$("<input>");$("body").append(t),t.val(e).select(),document.execCommand("copy"),t.remove()}static arrayNext(e=[],t=""){if(!e.length)return t;const r=e.indexOf(t);return e[(r+1)%e.length]||e[0]}static arrayPrev(e=[],t=""){if(!e.length)return t;const r=e.indexOf(t);return e[(r+e.length-1)%e.length]||e[0]}static clamp(e,t,r){return Math.min(Math.max(e,t),r)}static map(e,t,r,i,a){const n=(e-t)*(a-i)/(r-t)+i;return Utils$1.clamp(n,i,a)}static mapColorHex(e,t,r,i,a){const{r:n,g:o,b:s}=foundry.utils.Color.from(i),{r:c,g:d,b:l}=foundry.utils.Color.from(a);return foundry.utils.Color.fromRGB([Utils$1.map(e,t,r,n,c),Utils$1.map(e,t,r,o,d),Utils$1.map(e,t,r,s,l)]).toString()}static roundToDecimals(e,t){return Number(Math.round(e+"e"+t)+"e-"+t)}static omit(e,t){const{[t]:r,...i}=e;return i}static isBitSet(e,t){return 0!=(e&1<<t)}static deepClone(e,t){return deepClone(e,t)}}class TimeProvider{static _instances={};static hasTimeAuthority(){return TimeProvider._getProviderInstance().hasTimeAuthority()}static getProviderIds(){return Object.keys(TimeProvider._instances)}static async advanceGameTime(e=0){return TimeProvider._getProviderInstance().advanceGameTime(e)}static getHoursInDay(){return TimeProvider._getProviderInstance().getHoursInDay()}static getDaysInYear(){return TimeProvider._getProviderInstance().getDaysInYear()}static getNumberOfMonths(){return TimeProvider._getProviderInstance().getNumberOfMonths()}static getMonthOffset(e){return TimeProvider._getProviderInstance().getMonthOffset(e)}static getSummerSolsticeDay(){return TimeProvider._getProviderInstance().getSummerSolsticeDay()}static getWinterSolsticeDay(){return TimeProvider._getProviderInstance().getWinterSolsticeDay()}static getSeasonCyclePct(){return TimeProvider._getProviderInstance().getSeasonCyclePct()}static getDaylightCyclePct(){return TimeProvider._getProviderInstance().getDaylightCyclePct()}static getDayOfYear(e=0,t=0){return TimeProvider._getProviderInstance().getDayOfYear(e,t)}static getHourOfDay(e=0,t=0){return TimeProvider._getProviderInstance().getHourOfDay(e,t)}static hourOfDayNoonPct(e=0,t=0){return TimeProvider._getProviderInstance().hourOfDayNoonPct(e,t)}static async setDaylightCyclePct(e){return TimeProvider._getProviderInstance().setDaylightCyclePct(e)}static dayOfYearSummerPct(e=0,t=0){return TimeProvider._getProviderInstance().dayOfYearSummerPct(e,t)}static async setSeasonCyclePct(e){return TimeProvider._getProviderInstance().setSeasonCyclePct(e)}static getI18nDateString(){const e=TimeProvider._getProviderInstance().getTimeStringData(),t=Handlebars.compile(FoundryAbstractionLayer.i18n("time.formatted"))(e);return Logger.trace("TimeProvider.getI18nDateString",{"TimeProvider._getProviderId()":TimeProvider._getProviderId(),timeInfo:e,timeText:t}),t}static getCurrentTimeHash(e=0,t=0){return TimeProvider.getTimeHash(TimeProvider.getDayOfYear()+e,TimeProvider.getHourOfDay()+t)}static getTimeHash(e,t){return e*TimeProvider.getHoursInDay()+t}static getDayOfYearFromTimeHash(e){return Math.trunc(e/TimeProvider.getHoursInDay())+1}static getMonthOfYearFromTimeHash(e){let t=TimeProvider.getDayOfYearFromTimeHash(e);for(let e=0;e<TimeProvider.getNumberOfMonths();e++)if(t<TimeProvider.getMonthOffset(e))return e;return TimeProvider.getNumberOfMonths()}static getDayOfMonthFromTimeHash(e){let t=TimeProvider.getMonthOfYearFromTimeHash(e);return TimeProvider.getDayOfYearFromTimeHash(e)-TimeProvider.getMonthOffset(t-1)}static getTimeOfDayFromTimeHash(e){return e%TimeProvider.getHoursInDay()}static _getProviderId(){let e=FoundryAbstractionLayer.getSceneFlag("timeProvider",n.INTERNAL);return e!=n.SIMPLE_CALENDAR||FoundryAbstractionLayer.isModuleEnabled("foundryvtt-simple-calendar")||(Logger.info("Module [simple-calendar] is not installed or disabled. Reverting time provider to internal for this scene.",!0),FoundryAbstractionLayer.setSceneFlag("timeProvider",n.INTERNAL),e=n.INTERNAL),e}static _getProviderInstance(){return TimeProvider._instances[TimeProvider._getProviderId()]}}class SceneWeatherState{static _lastUpdate=0;static _sceneWeather={};static _regionTemplates={};static _weatherTemplates={};static _generators=[];static _filters=[]}class Noise{static F2=.5*(Math.sqrt(3)-1);static G2=(3-Math.sqrt(3))/6;static F3=1/3;static G3=1/6;static F4=(Math.sqrt(5)-1)/4;static G4=(5-Math.sqrt(5))/20;static fastFloor(e){return 0|Math.floor(e)}static getMulberry32(e){return function(){var t=e+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296}}static grad2=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);static getNoisedValue(e,t,r,i,a){return i+(a*((1*e(1*(t/=r),1*t)+.5*e(2*t,2*t)+.25*e(4*t,4*t))/1.75)*2-a)}static createNoise2D(e){const t=Noise._buildPermutationTable(e),r=new Float64Array(t).map((e=>Noise.grad2[e%12*2])),i=new Float64Array(t).map((e=>Noise.grad2[e%12*2+1]));return function(e,a){let n=0,o=0,s=0;const c=(e+a)*Noise.F2,d=Noise.fastFloor(e+c),l=Noise.fastFloor(a+c),g=(d+l)*Noise.G2,u=e-(d-g),m=a-(l-g);let h,p;u>m?(h=1,p=0):(h=0,p=1);const y=u-h+Noise.G2,f=m-p+Noise.G2,v=u-1+2*Noise.G2,b=m-1+2*Noise.G2,w=255&d,T=255&l;let S=.5-u*u-m*m;if(S>=0){const e=w+t[T];S*=S,n=S*S*(r[e]*u+i[e]*m)}let _=.5-y*y-f*f;if(_>=0){const e=w+h+t[T+p];_*=_,o=_*_*(r[e]*y+i[e]*f)}let P=.5-v*v-b*b;if(P>=0){const e=w+1+t[T+1];P*=P,s=P*P*(r[e]*v+i[e]*b)}return 70*(n+o+s)}}static _buildPermutationTable(e){const t=Noise.getMulberry32(e),r=512,i=new Uint8Array(r);for(let e=0;e<256;e++)i[e]=e;for(let e=0;e<255;e++){const r=e+~~(t()*(256-e)),a=i[e];i[e]=i[r],i[r]=a}for(let e=256;e<r;e++)i[e]=i[e-256];return i}}class WeatherModel{useConfigSceneId=void 0;regionMeteo=void 0;weatherData=void 0;_cache={};static DEFAULT_MODEL_STRUCT={source:"_DISABLED_",name:"disabled",temp:{ground:0,air:0,percieved:0},wind:{speed:0,gusts:0,direction:0},clouds:{coverage:0,bottom:0,top:0,type:0},precipitation:{amount:0,type:0},sun:{amount:0},humidity:0};constructor({regionMeteo:t,templateId:r,useWeatherConfig:i}){if(Logger.debug("WeatherModel:constrctor",{regionMeteo:t,templateId:r,useWeatherConfig:i}),this._cache={},void 0!==t)this.regionMeteo=t,this.useConfigSceneId=void 0,this.updateConfig();else if(void 0!==i)this.regionMeteo=void 0,this.useConfigSceneId=i,this.updateConfig();else{if(this.regionMeteo=void 0,this.useConfigSceneId=void 0,this.weatherData=Utils$1.deepClone(SceneWeatherState._weatherTemplates[r]),void 0===this.weatherData){this.weatherData=Utils$1.deepClone(Object.values(SceneWeatherState._weatherTemplates)[0]),canvas.scene.setFlag(e.ID,"weatherTemplate",this.weatherData.id);const[t,i]=r.split(".");Logger.error("Unable to set weather template with id ["+t+"], registered by module ["+i+"]. Reverting to ["+FoundryAbstractionLayer.i18n(this.weatherData.name)+"]. Maybe you removed a SceneWeather plugin after configuring your scene.",!0)}this.weatherData.precipitation.mode=FoundryAbstractionLayer.getSceneFlag("rainMode","winddir"),this.weatherData.source="_TEMPLATE_"}}static getTemplates(){return Logger.debug("getTemplates",{t:Object.entries(SceneWeatherState._weatherTemplates)}),Object.entries(SceneWeatherState._weatherTemplates).map((e=>({id:e[0],name:e[1].name})))}static fromSceneConfig(e){return new WeatherModel({useWeatherConfig:e})}static fromTemplate(e){return new WeatherModel({templateId:e})}static fromRegion(e){return new WeatherModel({regionMeteo:e})}updateConfig(){if(void 0!==this.regionMeteo)return Logger.debug("WeatherModel.updateConfig() -> invalidating cache, invoking on regionMeteo..."),this._cache={},this.regionMeteo.updateConfig();if(void 0!==this.useConfigSceneId){Logger.debug("WeatherModel.updateConfig() -> getting weatherConfig from Scene.",{configSceneId:this.useConfigSceneId});let e=this.useConfigSceneId,t=FoundryAbstractionLayer.getSceneFlag("weatherSettings",void 0,this.useConfigSceneId);Logger.debug("WeatherModel.updateConfig() -> load from scene flags",{weatherConfig:t,sceneId:this.useConfigSceneId}),t||(t=FoundryAbstractionLayer.getSetting("defaultWeatherSettings"),e="_GLOBAL_",Logger.debug("WeatherModel.updateConfig() -> no weather on flags, using global",{weatherConfig:t}));const r=FoundryAbstractionLayer.getSceneFlag("seed",""),i=Utils$1.getSeedFromString(r);Logger.debug("WeatherModel:updateConfig(seed)",{seedString:r,seedValue:i}),this._noise=Noise.createNoise2D(i);const a=t.wind.speed+t.wind.gusts,n=Math.trunc(1==t.wind.directionType?WeatherModel._getNoisedWindDirection(this._noise,TimeProvider.getCurrentTimeHash(),a):t.wind.direction);let s=Utils$1.mergeObject(Utils$1.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),{source:e,name:"custom",temp:{ground:t.temp.ground,air:t.temp.air,percieved:Math.trunc(WeatherModel._apparentTemperature(t.temp.air,t.wind.speed,t.humidity,o.isaSeaLevelPa/100))},wind:{speed:t.wind.speed,gusts:a,direction:n,directionType:t.wind.directionType},clouds:{coverage:t.clouds.coverage/100,bottom:t.clouds.bottom,top:t.clouds.bottom+t.clouds.thickness,type:t.clouds.type},precipitation:{amount:t.precipitation.amount/100,type:t.precipitation.type,mode:FoundryAbstractionLayer.getSceneFlag("rainMode","winddir",this.useConfigSceneId)||0},sun:{amount:t.sun.amount/100},humidity:t.humidity});return Logger.debug("WeatherModel.merged",{newWeatherData:s,weatherData:this.weatherData}),Utils$1.objectsEqual(this.weatherData,s)?(Logger.debug("WeatherModel.updateConfig() -> static from sceneConfig, no changes."),!1):(this.weatherData=s,Logger.debug("WeatherModel.updateConfig() -> static from sceneConfig",{sceneId:this.useConfigSceneId,weatherData:this.weatherData}),!0)}return this.weatherData.precipitation.mode==FoundryAbstractionLayer.getSceneFlag("rainMode","winddir")?(Logger.debug("WeatherModel.updateConfig() -> static, nothing to do."),!1):(this.weatherData.precipitation.mode=FoundryAbstractionLayer.getSceneFlag("rainMode","winddir"),!0)}getWeatherData(e=0,t=0){if(void 0!==this.regionMeteo){const r=this.regionMeteo.getRegionBase(e,t);if(void 0!==this._cache[r.timeHash])return this.weatherData=this._cache[r.timeHash],Logger.trace("WeatherModel.getWeatherData(GENERATOR_MODES.REGION_*) cacheHit",{dayOffset:e,hourOffset:t,regionBaseValues:r,weatherData:this.weatherData}),this._cache[r.timeHash];this.weatherData=Utils$1.mergeObject(Utils$1.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),{source:"_REGION_",name:r.name,temp:{ground:this._groundTemp(3,3,e,t),air:r.baseTemp,percieved:0},wind:{speed:r.wind,gusts:r.gusts+r.wind,direction:0},clouds:{coverage:0,bottom:Utils$1.clamp(Math.abs(WeatherModel._liftedCondensationLevel(r.baseTemp,r.baseHumidity)),0,2e4),top:0,type:0},precipitation:{amount:0,type:0,mode:FoundryAbstractionLayer.getSceneFlag("rainMode","winddir")},sun:{amount:r.sunAmount},humidity:r.baseHumidity});let i=WeatherModel._calcAdiCloudBottomCoeff(this.weatherData,r),a=WeatherModel._calcGeopotential(r);return this.weatherData.clouds.top=i<0?this.weatherData.clouds.bottom+12.6*a:this.weatherData.clouds.bottom+.27*a,this.weatherData.clouds.coverage=Utils$1.clamp((this.weatherData.clouds.top-this.weatherData.clouds.bottom)/100,0,1),this.weatherData.clouds.bottom<r.elevation?this.weatherData.clouds.type=1:(i<0&&(this.weatherData.clouds.top-this.weatherData.clouds.bottom>1e3&&(this.weatherData.clouds.type=3),this.weatherData.clouds.top-this.weatherData.clouds.bottom>3e3&&(this.weatherData.clouds.type=4)),this.weatherData.clouds.type<3&&this.weatherData.clouds.coverage>.3&&(this.weatherData.clouds.type=2)),this.weatherData.precipitation.amount=Utils$1.clamp(1.2*this.weatherData.clouds.coverage-.4,0,1)*Noise.getNoisedValue(this.regionMeteo._noise,r.timeHash+321,8,.8,.2)*Noise.getNoisedValue(this.regionMeteo._noise,r.timeHash+321,32,1,.5),this.weatherData.wind.gusts=this.weatherData.wind.gusts*(2.5*this.weatherData.precipitation.amount+.5),this.weatherData.wind.speed=this.weatherData.wind.speed+2.2*this.weatherData.precipitation.amount*this.weatherData.wind.speed,this.weatherData.sun.amount=this.weatherData.sun.amount*Utils$1.clamp(1-this.weatherData.clouds.coverage,.2,1),this.weatherData.temp.air=this.weatherData.temp.air-.03*this.weatherData.wind.speed+this.weatherData.sun.amount*Math.max(2,.6*this.weatherData.temp.ground),this.weatherData.temp.percieved=WeatherModel._apparentTemperature(this.weatherData.temp.air,this.weatherData.wind.speed,this.weatherData.humidity,WeatherModel._heightToPressure(r.elevation)),this.weatherData.clouds.top=3*Math.max(0,this.weatherData.clouds.top-r.elevation),this.weatherData.clouds.bottom=3*Math.max(0,this.weatherData.clouds.bottom-r.elevation),this.weatherData.precipitation.type=WeatherModel._calcPrecipitationType(this.weatherData),this.weatherData.wind.direction=WeatherModel._getNoisedWindDirection(this.regionMeteo._noise,r.timeHash,this.weatherData.wind.gusts),this._cache[r.timeHash]=this.weatherData,Logger.trace("WeatherModel.getWeatherData(GENERATOR_MODES.REGION_*) cacheMiss",{dayOffset:e,hourOffset:t,regionBaseValues:r,weatherData:this.weatherData}),this.weatherData}return void 0!==this.useConfigSceneId?(1==this.weatherData.wind.directionType&&(this.weatherData.wind.direction=WeatherModel._getNoisedWindDirection(this._noise,TimeProvider.getCurrentTimeHash(e,t),this.weatherData.wind.gusts)),Logger.trace("WeatherModel.getWeatherData(GENERATOR_MODES.WEATHER_GENERATE)",{dayOffset:e,hourOffset:t,weatherData:this.weatherData}),this.weatherData):(Logger.trace("WeatherModel.getWeatherData(GENERATOR_MODES.WEATHER_TEMPLATE)",{dayOffset:e,hourOffset:t,weatherData:this.weatherData}),this.weatherData)}static _getNoisedWindDirection(e,t,r){let i=Noise.getNoisedValue(e,t+1277,512,180,180)+Noise.getNoisedValue(e,t+1277,8,16,16)*(.2*r);return i<0&&(i+=360),i>=360&&(i-=360),i}static _calcGeopotential(e){return e.vegetation*(1.3*e.sunAmount+.7*e.wind)+(.3*e.sunAmount+e.waterAmount*(1.3*e.wind))}static _heightToPressure(e){if(e<11e3)return o.isaSeaLevelPa*Math.pow(o.isaMSLtempC/(o.isaMSLtempC+o.adiabaticHyDryCoeff*e),o.g*o.mAir/(o.R*o.adiabaticHyDryCoeff))/100;if(e<=2e4){var t=o.isaSeaLevelPa*Math.pow(o.isaMSLtempC/(e+11e3*o.adiabaticHyDryCoeff),o.g*o.mAir/(o.R*o.adiabaticHyDryCoeff)),r=o.isaMSLtempC+11e3*o.adiabaticHyDryCoeff;return t*Math.exp(-o.g*o.mAir*(e-11e3)/(o.R*r))/100}return 0}static _apparentTemperature(e,t,r,i){return e<10?WeatherModel._windChill(e,t):WeatherModel._heatIndex(e,r,i)}static _windChill(e,t){if(e>=10)return Tc;let r;return r=t>=4.8&&t<=177?13.12+.6215*e+(.3965*e-11.37)*Math.pow(t,.16):t<4.8?e+.2*(.1345*e-1.59)*t:e,r}static _heatIndex(e,t,r){if(r<16)return e;if(e<27||o.R<.4||WeatherModel._dewPoint(e,t)<12)return e;return 1.61139411*e-8.784695+2.338549*t+-.14611605*e*t+-.012308094*e*e+-.016424828*t*t+.002211732*e*e*t+72546e-8*e*t*t+1e-6*-3.582*e*e*t*t}static _dewPoint(e,t){if(e<0||e>60)return e;if((t/=100)<.01||t>1)return e;let r=17.27*e/(o.Tzero+e)+Math.log(t),i=o.Tzero*r/(17.27-r);return i<0||i>50?e:i}static _calcAdiCloudBottomCoeff(e,t){return o.isaMSLtempC+(e.clouds.bottom-t.elevation)*o.adiabaticHyDryCoeff-(t.baseTemp+(e.clouds.bottom-t.elevation)*o.adiabaticHyDryCoeff)}static _calcPrecipitationType(e){return e.precipitation.amount<.1?0:e.clouds.type>3&&e.precipitation.amount>.7?e.temp.air<4?6:e.wind.speed>.2?4:3:e.clouds.type>=3?e.temp.air<4?e.wind.speed>.2?6:5:2:2==e.clouds.type||e.precipitation.amount>.7?e.temp.air<4?5:1:0}_groundTemp(e,t,r=0,i=0){let a=0,n=0;for(let o=0;o<=e;o++){let e=1/Math.log2(o+2);a+=this.regionMeteo.getRegionBase(r,i-o*t).baseTemp*e,n+=e}return a/n}static _liftedCondensationLevel(e,t){return 125*(e-(e-(100-t)/5))}}class WeatherPerception{static _registeredPercievers={};static _singleton;static DEFAULT_WEATHER_STRUCT={name:"unknown",temperature:{air:0,ground:0,percieved:0},humidity:{percent:0},wind:{speed:0,gusts:0,direction:0},clouds:{height:0,amount:0,type:0},sun:{amount:0},precipitation:{amount:0,type:0}};static DEFAULT_INFO_STRUCT={id:e.ID+".default",name:"default"};static registeredPerciever(e=null,t=null,r=null){Logger.debug("WeatherPerception.registeredPerciever(...)",{moduleId:e,id:t,weatherPerception:r}),e&&t&&r&&r instanceof WeatherPerception&&FoundryAbstractionLayer.isModuleEnabled(e)?WeatherPerception._registeredPercievers[e+"."+t]=r:Logger.error("Unable to register WeatherPerciever for moduleId:"+e+" with id:"+t,!0)}static async getAsText(t=e.ID+".default",r){const i=WeatherPerception._getPercieverById(t),a=i.getTextFromModel(Utils$1.mergeObject(Utils$1.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),r));return Logger.debug("WeatherPerception.getAsText(...)",{id:t,perciever:i,text:a}),a}static async getAsUiHtml(t=e.ID+".default",r){const i=WeatherPerception._getPercieverById(t),a=i.getUiHtmlFromModel(Utils$1.mergeObject(Utils$1.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),r));return Logger.debug("WeatherPerception.getAsUiHtml(...)",{id:t,perciever:i,uiHtml:a}),a}static async getAsChatHtml(t=e.ID+".default",r){const i=WeatherPerception._getPercieverById(t),a=i.getChatHtmlFromModel(Utils$1.mergeObject(Utils$1.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),r));return Logger.debug("WeatherPerception.getAsChatHtml(...)",{id:t,perciever:i,chatHtml:a}),a}static async getAsWeatherInfo(t=e.ID+".default",r){const i=WeatherPerception._getPercieverById(t),a=i.getWeatherInfoFromModel(Utils$1.mergeObject(Utils$1.deepClone(WeatherModel.DEFAULT_MODEL_STRUCT),r));return Logger.debug("WeatherPerception.getAsWeatherInfo(...)",{id:t,perciever:i,weatherInfo:a}),a}static getInfo(t=e.ID+".default"){const r=WeatherPerception._getPercieverById(t),i=r.getPercieverInfo();return Logger.debug("WeatherPerception.getInfo(...)",{id:t,perciever:r,percieverInfo:i}),i}static getAllowedIds(e){let t=[];for(const[r,i]of Object.entries(WeatherPerception._registeredPercievers))i.isAllowed(e)&&t.push(r);return Logger.debug("WeatherPerception.getAllowedIds(...)",{userId:e,allowedIds:t}),t}static _getSingleton(){return WeatherPerception._singleton||(WeatherPerception._singleton=new WeatherPerception),WeatherPerception._singleton}static _getPercieverById(e){return WeatherPerception._registeredPercievers[e]?WeatherPerception._registeredPercievers[e]:WeatherPerception._getSingleton()}getTextFromModel(e){return""}getUiHtmlFromModel(e){return""}getChatHtmlFromModel(e){return""}getWeatherInfoFromModel(e){return Utils$1.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT)}getPercieverInfo(){return Utils$1.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT)}}class RegionMeteo{_id=0;regionData=void 0;_noise=void 0;_cache={};constructor(e){if(this._id=randomID(),void 0!==e){if(this.regionData=Utils$1.deepClone(SceneWeatherState._regionTemplates[e]),void 0===this.regionData){this.regionData=Utils$1.deepClone(Object.values(SceneWeatherState._regionTemplates)[0]),FoundryAbstractionLayer.setSceneFlag("regionTemplate",this.regionData.id);const[t,r]=e.split(".");Logger.error("Unable to set region template with id ["+t+"], registered by module ["+r+"]. Reverting to ["+FoundryAbstractionLayer.i18n(this.regionData.name)+"]. Maybe you removed a SceneWeather plugin after configuring your scene.",!0,!0)}}else this.regionData=Utils$1.deepClone(FoundryAbstractionLayer.getSceneFlag("regionSettings",Utils$1.deepClone(FoundryAbstractionLayer.getSetting("defaultRegionSettings"))));const t=FoundryAbstractionLayer.getSceneFlag("seed",""),r=Utils$1.getSeedFromString(t);this._noise=Noise.createNoise2D(r),Logger.trace("RegionMeteo:ctor(...)",{templateId:e,id:this._id,noise:this._noise,regionData:this.regionData}),this.updateConfig()}static getTemplates(){return Object.entries(SceneWeatherState._regionTemplates).map((e=>({id:e[0],name:e[1].name})))}static fromTemplate(e){return new RegionMeteo(e)}updateConfig(){return Logger.debug("RegionMeteo.updateConfig()"),this._cache={},!0}getRegionBase(e=0,t=0){const r=TimeProvider.getCurrentTimeHash(e,t);if(void 0!==this._cache[r])return this._cache[r];let i={elevation:this.regionData.elevation,vegetation:this.regionData.vegetation,waterAmount:this.regionData.waterAmount,timeHash:r};void 0===this.regionData.name?i.name="custom":i.name=this.regionData.name;const a=TimeProvider.getHourOfDay(e,t),n=TimeProvider.hourOfDayNoonPct(e,t),o=TimeProvider.dayOfYearSummerPct(e,t);let s=(this.regionData.summer.temperature.day-this.regionData.winter.temperature.day)*o+this.regionData.winter.temperature.day,c=(this.regionData.summer.temperature.night-this.regionData.winter.temperature.night)*o+this.regionData.winter.temperature.night,d=(this.regionData.summer.temperature.var-this.regionData.winter.temperature.var)*o+this.regionData.winter.temperature.var;i.baseTemp=Noise.getNoisedValue(this._noise,r+1282,64,(s-c)*n+c,d),i.baseTemp<0&&(i.waterAmount=0);let l=(this.regionData.summer.humidity.day-this.regionData.winter.humidity.day)*o+this.regionData.winter.humidity.day,g=(this.regionData.summer.humidity.night-this.regionData.winter.humidity.night)*o+this.regionData.winter.humidity.night,u=(this.regionData.summer.humidity.var-this.regionData.winter.humidity.var)*o+this.regionData.winter.humidity.var;i.baseHumidity=Utils$1.clamp(Noise.getNoisedValue(this._noise,r+732,64,(l-g)*n+g,u),0,100);let m=((this.regionData.summer.sun.hours-this.regionData.winter.sun.hours)*o+this.regionData.winter.sun.hours)/2,h=Math.abs(12-a);i.sunAmount=h>m?0:Utils$1.clamp(m/3*(1-1/(m/h)),0,1);let p=(this.regionData.summer.wind.avg-this.regionData.winter.wind.avg)*o+this.regionData.winter.wind.avg,y=(this.regionData.summer.wind.var-this.regionData.winter.wind.var)*o+this.regionData.winter.wind.var,f=1;return f=i.sunAmount<.1?.9:i.sunAmount<.2?a>12?.8:1.2:1.1,i.wind=Utils$1.clamp(Noise.getNoisedValue(this._noise,r+978,16,f*p,y),0,80),i.gusts=Utils$1.clamp(i.wind+Noise.getNoisedValue(this._noise,r+12,8,f*y,y),0,80),this._cache[r]=i,Logger.debug("RegionMeteo.getRegionBase(...)",{dayDelta:e,hourDelta:t,timeHash:r,baseValues:i}),i}}class SceneWeather$1{sceneId=void 0;weatherModel=void 0;weatherMode=t.DISABLED;constructor(e){this.sceneId=e._id,this.weatherModel=this._getWeatherModelForMode(e),Logger.debug("SceneWeather:ctor",{weatherModel:this.weatherModel,sceneId:this.sceneId})}_getWeatherModelForMode(r){switch(this.weatherMode=r.getFlag(e.ID,"weatherMode")||t.DISABLED,Logger.debug("SceneWeather._getWeatherModelForMode(...)",{scene:r,weatherMode:this.weatherMode,this:this}),this.weatherMode){case t.WEATHER_TEMPLATE:const i=r.getFlag(e.ID,"weatherTemplate");return WeatherModel.fromTemplate(i);case t.WEATHER_GENERATE:return WeatherModel.fromSceneConfig(r._id);case t.REGION_TEMPLATE:const a=r.getFlag(e.ID,"regionTemplate");return WeatherModel.fromRegion(RegionMeteo.fromTemplate(a));case t.REGION_GENERATE:return WeatherModel.fromRegion(new RegionMeteo);case t.DISABLED:default:return}}updateConfig(){if(Logger.debug("SceneWeather.updateConfig()",{sceneId:this.sceneId,this:this}),void 0===this.weatherModel)return!1;const e=FoundryAbstractionLayer.getScene(this.sceneId);if(void 0===e)throw Logger.error("Unable to instantiate SceneWeather for non existing Scene with id "+this.sceneId),new Error("Unable to instantiate SceneWeather for non existing Scene with id "+this.sceneId);return FoundryAbstractionLayer.getSceneFlag("weatherMode",null,this.sceneId)!=this.weatherMode?(Logger.debug("SceneWeather.updateConfig() -> newMode",{sceneId:this.sceneId,prevMode:this.weatherMode,newMode:FoundryAbstractionLayer.getSceneFlag("weatherMode","-",this.sceneId)}),this.weatherModel=this._getWeatherModelForMode(e),!0):(Logger.debug("SceneWeather.updateConfig() -> unchangedMode",{sceneId:this.sceneId}),this.weatherModel.updateConfig())}static fromConfig({sceneId:e=null}={}){null==e&&(e=canvas.scene._id);const t=FoundryAbstractionLayer.getScene(e);if(void 0!==t)return new SceneWeather$1(t);Logger.error("Unable to instantiate SceneWeather for non existing Scene with id "+e)}static _weatherModelToExternal(e,r,a=t.WEATHER_TEMPLATE){const[n]=Object.entries(c).find((([,t])=>t===e.precipitation.type)),[o]=Object.entries(d).find((([,t])=>t===e.clouds.type)),[s]=Object.entries(i).find((([,r])=>r===(a==t.WEATHER_GENERATE?e.wind.directionType:0))),l=a==t.WEATHER_GENERATE?1:100,g={temp:{ground:Math.round(e.temp.ground),air:Math.round(e.temp.air)},humidity:Math.round(e.humidity),wind:{speed:Math.round(e.wind.speed),gusts:Math.round(e.wind.gusts),directionType:s||"fixed",direction:Math.round(e.wind.direction)},clouds:{type:o||"cumulunimbus",coverage:Math.round(e.clouds.coverage*l),bottom:Utils$1.clamp(Math.round(e.clouds.bottom),0,2e4),thickness:a==t.WEATHER_GENERATE?Math.round(e.clouds.thickness):Utils$1.clamp(Math.round(e.clouds.top)-Math.round(e.clouds.bottom),0,2e4)},precipitation:{type:n||"none",amount:Math.round(e.precipitation.amount*l),mode:r},sun:{amount:Math.round(e.sun.amount*l)}};return Logger.trace("SceneWeather._weatherModelToExternal(...)",{model:e,template:g}),g}getWeatherModel(e=0,t=0){if(void 0!==this.weatherModel)return this.weatherModel.getWeatherData(e,t)}getWeatherSettings(){if(void 0===this.weatherModel)return;let e={generator:{seed:FoundryAbstractionLayer.getSceneFlag("seed","",this.sceneId),mode:FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED,this.sceneId)}};switch(e.generator.mode){case t.WEATHER_TEMPLATE:const r=SceneWeatherState._weatherTemplates[FoundryAbstractionLayer.getSceneFlag("weatherTemplate","",this.sceneId)];void 0!==r&&(e.weather=SceneWeather$1._weatherModelToExternal(r,FoundryAbstractionLayer.getSceneFlag("rainMode",a.WINDDIR,this.sceneId),e.generator.mode),e.weather.templateId=r.id,e.weather.templateName=FoundryAbstractionLayer.i18n(r.name));break;case t.WEATHER_GENERATE:const i=Utils$1.deepClone(FoundryAbstractionLayer.getSceneFlag("weatherSettings",{},this.sceneId));e.weather=SceneWeather$1._weatherModelToExternal(i,FoundryAbstractionLayer.getSceneFlag("rainMode",a.WINDDIR,this.sceneId),e.generator.mode);break;case t.REGION_TEMPLATE:e.region=Utils$1.deepClone(SceneWeatherState._regionTemplates[FoundryAbstractionLayer.getSceneFlag("regionTemplate","",this.sceneId)]||{}),e.region.templateId=e.region.id,e.region.templateName=FoundryAbstractionLayer.i18n(e.region.name),delete e.region.id,delete e.region.name,delete e.region.description,e.weather=SceneWeather$1._weatherModelToExternal(this.getWeatherModel(),FoundryAbstractionLayer.getSceneFlag("rainMode",a.WINDDIR,this.sceneId),e.generator.mode);break;case t.REGION_GENERATE:e.region=Utils$1.deepClone(FoundryAbstractionLayer.getSceneFlag("regionSettings",Utils$1.deepClone(FoundryAbstractionLayer.getSetting("defaultRegionSettings")),this.sceneId)),e.weather=SceneWeather$1._weatherModelToExternal(this.getWeatherModel(),FoundryAbstractionLayer.getSceneFlag("rainMode",a.WINDDIR,this.sceneId),e.generator.mode)}return Logger.trace("SceneWeather.getWeatherSettings()",{settings:e}),e}async calculateWeather({force:e=!1}={}){if(void 0===this.weatherModel)return;const t=TimeProvider.getCurrentTimeHash(),i=this.weatherModel.getWeatherData();Logger.debug("SceneWeather.calculateWeather() -> WeatherUpdated",{model:i,timeHash:t,sceneId:this.sceneId,force:e}),Hooks.callAll(r.WEATHER_UPDATED,{model:i,timeHash:t,sceneId:this.sceneId,force:e})}}class MacroGenerator{static async buildHeader(t){return await renderTemplate("modules/"+e.ID+"/templates/macroHeader.hbs",{headline:t,currentDate:(new Date).toLocaleString(),moduleName:e.NAME,moduleId:e.ID,moduleVersion:e.VERSION})}static async buildUpdateConfig(t=!1,r=null){let i={data:{},hasSceneId:!1,hasForceParam:!1,hasParams:!1};null!=r&&(i.data.forSceneId=r,i.hasSceneId=!0,i.hasParams=!0),t&&(i.data.force="true",i.hasForceParam=!0,i.hasParams=!0);return await renderTemplate("modules/"+e.ID+"/templates/macroUpdateConfig.hbs",i)}static async buildSetSceneSeed(t=""){return await renderTemplate("modules/"+e.ID+"/templates/macroSeed.hbs",{seed:t})}static async buildSetSceneTime({dayCycle:t=-1,yearCycle:r=-1}={}){if(-1==t&&-1==r)return"";let i={};t>=0&&(i.daylightCycle=Number((100*t).toFixed(3))),r>=0&&(i.seasonCycle=Number((100*r).toFixed(3)));return await renderTemplate("modules/"+e.ID+"/templates/macroTime.hbs",{data:JSON.stringify(i,null,2)})}static async buildSetSceneWeatherTemplate(t="",r=""){const i=t.includes(".")?t.split(".")[0]:null;return await renderTemplate("modules/"+e.ID+"/templates/macroWeatherTemplate.hbs",{moduleCheck:!(null==i),moduleId:i||"",templateId:t,templateName:r})}static async buildSetSceneWeatherSettings(t){delete t.templateId,delete t.templateName;return await renderTemplate("modules/"+e.ID+"/templates/macroWeather.hbs",{data:JSON.stringify(t,null,2)})}static async buildSetSceneRegionTemplate(t="",r=""){const i=t.includes(".")?t.split(".")[0]:null;return await renderTemplate("modules/"+e.ID+"/templates/macroRegionTemplate.hbs",{moduleCheck:!(null==i),moduleId:i||"",templateId:t,templateName:r})}static async buildSetSceneRegionSettings(t){delete t.templateId,delete t.templateName;return await renderTemplate("modules/"+e.ID+"/templates/macroRegion.hbs",{data:JSON.stringify(t,null,2)})}}class MacroConfigDialog extends Application{static _app=null;static refresh(e=!1){Logger.trace("MacroConfigDialog.refresh()"),MacroConfigDialog._app&&MacroConfigDialog._app.render(e,{height:"auto"})}constructor(){super(),Logger.trace("MacroConfigDialog.ctor")}static get defaultOptions(){return Utils$1.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/macroConfig.hbs",id:"scene-weather-macro-config",title:"dialogs.macroConfig.title",closeOnSubmit:!1,submitOnChange:!1,submitOnClose:!1,resizable:!1})}activateListeners(t){super.activateListeners(t),t.find("button[type='generate']").on("click",(async function(){const r=$(this),i=t.find('input[name="macro.includeTimeOfDay"]').is(":checked")||!1,a=t.find('input[name="macro.includeDayOfYear"]').is(":checked")||!1,n=t.find('input[name="macro.includeSeed"]').is(":checked")||!1,o=r.attr("data-mode")||"";Logger.trace("MacroConfigDialog.click(generateFromWeatherTemplate)",{generatorMode:o,includeTimeOfDay:i,includeDayOfYear:a,includeSeed:n});let s={img:"modules/"+e.ID+"/assets/sw-macro-icon.svg",type:"script",scope:"global"};const c=SceneWeather.getWeatherSettings();if(void 0===c)return;let d="";switch(n&&(d+=await MacroGenerator.buildSetSceneSeed(c.generator.seed)),(i||a)&&(d+=await MacroGenerator.buildSetSceneTime({dayCycle:i?TimeProvider.getDaylightCyclePct():-1,yearCycle:a?TimeProvider.getSeasonCyclePct()/2:-1})),o){case"weatherTemplate":s.name=FoundryAbstractionLayer.i18n("dialogs.macroConfig.weatherTemplate.title")+"("+(c.weather?.templateName??" - ")+")",s.command=await MacroGenerator.buildHeader(s.name),s.command+=d,s.command+=await MacroGenerator.buildSetSceneWeatherTemplate(c.weather.templateId,c.weather.templateName);break;case"weather":s.name=FoundryAbstractionLayer.i18n("dialogs.macroConfig.weather.title")+canvas.scene.name+")",s.command=await MacroGenerator.buildHeader(s.name),s.command+=d,s.command+=await MacroGenerator.buildSetSceneWeatherSettings(c.weather);break;case"regionTemplate":s.name=FoundryAbstractionLayer.i18n("dialogs.macroConfig.regionTemplate.title")+"("+(c.region?.templateName??" - ")+")",s.command=await MacroGenerator.buildHeader(s.name),s.command+=d,s.command+=await MacroGenerator.buildSetSceneRegionTemplate(c.region.templateId,c.region.templateName);break;case"region":s.name=FoundryAbstractionLayer.i18n("dialogs.macroConfig.region.title")+canvas.scene.name+")",s.command=await MacroGenerator.buildHeader(s.name),s.command+=d,s.command+=await MacroGenerator.buildSetSceneRegionSettings(c.region)}s.command+=await MacroGenerator.buildUpdateConfig(!0);(await Macro.create(s)).sheet.render(!0)}))}async _onSubmit(e,t){return e.target.querySelectorAll("input[disabled]").forEach((e=>e.disabled=!1)),super._onSubmit(e,t)}async getData(){const e=TimeProvider.getSeasonCyclePct(),[r]=Object.entries(s).find((([,t])=>e<=t)),i=SceneWeather.getWeatherSettings();if(void 0===i)return Logger.warn(FoundryAbstractionLayer.i18n("dialogs.macroConfig.disabledWarn"),!0),{enabled:!1};const a={enabled:!0,preCheckTime:[t.REGION_TEMPLATE,t.REGION_GENERATE].includes(i.generator.mode),preCheckDate:[t.REGION_TEMPLATE,t.REGION_GENERATE].includes(i.generator.mode),scene:{name:canvas.scene.name,id:canvas.scene._id,modeName:"configTab.weatherModes."+i.generator.mode+".name",modeHint:"configTab.weatherModes."+i.generator.mode+".hint",seed:i.generator.seed},time:{summaryString:TimeProvider.getI18nDateString(),beforeSummerSolstice:!!(e<=1),pctDistanceSummerSolstice:Math.round(100*(e>1?e-1:e)),seasonString:"time."+r,seasonPct:e>1?e-1:e},weather:{detailHtml:await WeatherPerception.getAsUiHtml("scene-weather.precise",SceneWeather.getWeatherModel()),hasTemplate:!(i.generator.mode!=t.WEATHER_TEMPLATE),templateName:i.weather?.templateName??""},region:{hasRegion:[t.REGION_TEMPLATE,t.REGION_GENERATE].includes(i.generator.mode),hasTemplate:!(i.generator.mode!=t.REGION_TEMPLATE),templateName:i.region?.templateName??""}};return Logger.trace("MacroConfigDialog.getData()",{data:a}),a}_updateObject(e,t){Logger.trace("MacroConfigDialog._updateObject(...)",{formData:t})}}class Permissions{static _permissions=void 0;static DEFAULT_PERMISSION_STRUCT={player:!1,trustedPlayer:!1,assistantGameMaster:!1,users:[]};static EMPTY_PERMISSIONS={"perciever.scene-weather.vague":Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),"perciever.scene-weather.icon":Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),"perciever.scene-weather.perceptive":Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),"perciever.scene-weather.precise":Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),sceneSettings:Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),weatherUiControls:Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),timeControls:Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),meteogramUi:Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT)};static DEFAULT_PERMISSIONS={"perciever.scene-weather.vague":{player:!0,trustedPlayer:!0,assistantGameMaster:!0},"perciever.scene-weather.icon":{trustedPlayer:!0,assistantGameMaster:!0},"perciever.scene-weather.perceptive":{assistantGameMaster:!0},sceneSettings:Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),weatherUiControls:{assistantGameMaster:!0},timeControls:{assistantGameMaster:!0},meteogramUi:{assistantGameMaster:!0}};static _getDefaultPermissions(){let e=Utils$1.deepClone(Permissions.DEFAULT_PERMISSIONS);return Object.keys(WeatherPerception._registeredPercievers).forEach((t=>{e["perciever."+t]=Utils$1.mergeObject(Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT),e["perciever."+t]||{})})),Logger.debug("Permissions._getDefaultPermissions()",{defaultPermissions:e}),e}static _loadPermissions(){const e=Permissions._getDefaultPermissions(),t=FoundryAbstractionLayer.getSetting("permissions",null);if(null==t)return Logger.debug("Permissions._loadPermissions -> no stored permissions",{default:e}),Permissions._permissions=e,Permissions._permissions;{const r=Utils$1.mergeObject(e,t,{insertKeys:!1,expand:!1});return Logger.debug("Permissions._loadPermissions -> loaded from settings",{default:e,effective:r,stored:t}),Permissions._permissions=r,Permissions._permissions}}static async resetPermissions(){let e=Utils$1.deepClone(Permissions.EMPTY_PERMISSIONS);Object.keys(WeatherPerception._registeredPercievers).forEach((t=>{"perciever."+t in e||(e["perciever."+t]=Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT))})),Permissions._permissions=Utils$1.mergeObject(e,Permissions.DEFAULT_PERMISSIONS,{expand:!1}),FoundryAbstractionLayer.setSetting("permissions",Permissions._permissions),Logger.debug("Permissions.resetPermissions()",{permissions:Permissions._permissions})}static async updatePermissions(e){Object.keys(WeatherPerception._registeredPercievers).forEach((t=>{"perciever."+t in e||(e["perciever."+t]=Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT))})),Permissions._permissions=Utils$1.mergeObject(Utils$1.deepClone(Permissions.EMPTY_PERMISSIONS),e,{expand:!1}),FoundryAbstractionLayer.setSetting("permissions",Permissions._permissions),Logger.debug("Permissions.updatePermissions(...)",{permissions:Permissions._permissions})}static getPermissionNameI18n(e){return e?e.startsWith("perciever.")?FoundryAbstractionLayer.i18n("permissions.percieverName")+WeatherPerception.getInfo(e.replace("perciever.","")).name:FoundryAbstractionLayer.i18n("permissions."+e+".name"):FoundryAbstractionLayer.i18n("permissions.unknown.name")}static getPermissionHintI18n(e){return e?e.startsWith("perciever.")?FoundryAbstractionLayer.i18n("permissions.percieverHint")+WeatherPerception.getInfo(e.replace("perciever.","")).name:FoundryAbstractionLayer.i18n("permissions."+e+".hint"):FoundryAbstractionLayer.i18n("permissions.unknown.hint")+e}static getPermissionIds(){void 0===Permissions._permissions&&Permissions._loadPermissions();const e=Object.keys(Permissions._permissions);return Logger.debug("Permissions.getPermissionIds()",{permissionIds:e}),e}static getPermissionForId(e){return e?(void 0===Permissions._permissions&&Permissions._loadPermissions(),e in Permissions._permissions?(Logger.debug("Permissions.getPermissionForId(...)",{permissionId:e,permission:Permissions._permissions[e]}),Utils$1.mergeObject(Permissions.DEFAULT_PERMISSION_STRUCT,Permissions._permissions[e],{inplace:!1,expand:!1})):(Logger.debug("Permissions.getPermissionForId(unknown)",{permissionId:e}),Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT))):Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT)}static hasPermission(e="player",t=null,r=!0){if(null===e||null===t)return!1;const i=Permissions.getPermissionForId(t);switch(e){case"player":return!!i.player;case"trustedPlayer":return!!i.trustedPlayer;case"assistantGameMaster":return!!i.assistantGameMaster;default:if(FoundryAbstractionLayer.isGm(e)&&r)return!0;const t=FoundryAbstractionLayer.getUser(e);return!!t&&(!!(i.player&&t.hasRole(1)&&r)||(!!(i.trustedPlayer&&t.hasRole(2)&&r)||(!!(i.assistantGameMaster&&t.hasRole(3)&&r)||!!i.users.includes(e))))}}}function getSceneWeatherAPIv1(){const e={id:"unknown",name:"unknown",description:"unknown",elevation:0,vegetation:0,waterAmount:0,summer:{temperature:{day:0,night:0,var:0},humidity:{day:0,night:0,var:0},wind:{avg:0,var:0},sun:{hours:0}},winter:{temperature:{day:0,night:0,var:0},humidity:{day:0,night:0,var:0},wind:{avg:0,var:0},sun:{hours:0}}},r={id:"unknown",name:"unknown",temp:{ground:0,air:0,percieved:0},wind:{speed:0,gusts:0,direction:0},clouds:{coverage:0,bottom:0,top:0,type:0},precipitation:{amount:0,type:0},sun:{amount:0},humidity:0},a={daylightCycle:-50,seasonCycle:-50};async function updateWeather({force:e=!1,sceneId:t}={}){if(Logger.debug("updateWeather(...)",{sceneId:t,force:e,canvasSceneId:canvas.scene._id}),void 0===t&&(t=canvas.scene._id),t!=canvas.scene._id)return;e&&(SceneWeatherState._lastUpdate=-1);const r=TimeProvider.getCurrentTimeHash();if(SceneWeatherState._lastUpdate==r)return;SceneWeatherState._lastUpdate=r;const i=_getSceneWeatherProvider(t);void 0!==i&&i.calculateWeather({force:e})}function _getSceneWeatherProvider(e,t=!1){if(!canvas||!canvas.ready)return;let r=canvas.scene._id;return void 0!==e&&(r=e),t&&(SceneWeatherState._sceneWeather[r]=void 0),void 0!==SceneWeatherState._sceneWeather[r]?(Logger.trace("getSceneWeatherProvider(...) cacheHit",{forSceneId:e,sceneId:r,ignoreCache:t,provider:SceneWeatherState._sceneWeather[r]}),SceneWeatherState._sceneWeather[r]):(SceneWeatherState._sceneWeather[r]=SceneWeather$1.fromConfig({sceneId:r}),Logger.trace("getSceneWeatherProvider(...) cacheMiss",{forSceneId:e,sceneId:r,ignoreCache:t,provider:SceneWeatherState._sceneWeather[r]}),SceneWeatherState._sceneWeather[r])}function _checkParam(e={},t="",r=null,i=(e=>e)){if(!e||e=={}||!t)throw new Error("-");if(!t.includes(".")){if(t in e){const a=e[t];if(null!=r){const i=getType(a);if(i!=r)throw Logger.debug("_checkParam failed: invalid type",{input:e,keyName:t,value:a,vType:i,type:r}),new Error(t+"{"+i+"} != {"+r+"}")}return i(a)}throw Logger.debug("_checkParam failed: no such key",{input:e,keyName:t}),new Error(t)}{const a=t.split(".")[0];if(!(a in e))throw Logger.debug("_checkParam failed: no such key",{input:e,treeTop:a}),new Error(a);try{return _checkParam(e[a],t.slice(a.length+1),r,i)}catch(e){throw new Error(a+"."+e.message)}}}return{clearScene:async function clearScene(){if(Logger.debug("clearScene"),Permissions.hasPermission(FoundryAbstractionLayer.userID(),"sceneSettings")){if(canvas.ready&&canvas.scene)return await FoundryAbstractionLayer.setSceneFlag("weatherMode",t.DISABLED),Promise.all([FoundryAbstractionLayer.unsetSceneFlag("weatherMode"),FoundryAbstractionLayer.unsetSceneFlag("rainMode"),FoundryAbstractionLayer.unsetSceneFlag("regionTemplate"),FoundryAbstractionLayer.unsetSceneFlag("seed"),FoundryAbstractionLayer.unsetSceneFlag("timeProvider"),FoundryAbstractionLayer.unsetSceneFlag("weatherTemplate"),FoundryAbstractionLayer.unsetSceneFlag("weatherSettings"),FoundryAbstractionLayer.unsetSceneFlag("regionSettings")])}else Logger.error("clearScene | "+FoundryAbstractionLayer.i18n("api.noPermission"))},updateWeatherConfig:async function updateWeatherConfig({forSceneId:e,force:t=!1}={}){Logger.debug("updateWeatherConfig",{forSceneId:e,force:t});const r=_getSceneWeatherProvider(e,t);void 0!==r&&(r.updateConfig()||t)&&updateWeather({sceneId:e,force:!0})},updateWeather:updateWeather,getWeatherModel:function getWeatherModel(e=0,t=0){Logger.debug("getWeatherModel(...)",{dayOffset:e,hourOffset:t});const r=_getSceneWeatherProvider();if(void 0!==r)return r.getWeatherModel(e,t)},getWeatherSettings:function getWeatherSettings(){Logger.debug("getWeatherSettings()");const e=_getSceneWeatherProvider();if(void 0!==e)return e.getWeatherSettings()},setSeed:async function setSeed(e=""){Logger.debug("setSeed(...)",{seedString:e}),Permissions.hasPermission(FoundryAbstractionLayer.userID(),"sceneSettings")?canvas.ready&&canvas.scene&&(await FoundryAbstractionLayer.setSceneFlag("seed",e),MacroConfigDialog.refresh()):Logger.error("setSeed | "+FoundryAbstractionLayer.i18n("api.noPermission"))},setCycleTimes:async function setCycleTimes(e){if(Logger.debug("setCycleTimes(...)",{cycleTimes:e}),!Permissions.hasPermission(FoundryAbstractionLayer.userID(),"timeControls"))return void Logger.error("setCycleTimes | "+FoundryAbstractionLayer.i18n("api.noPermission"));if(!TimeProvider.hasTimeAuthority())return void Logger.error("setCycleTimes | "+FoundryAbstractionLayer.i18n("api.noTimeAuthority"));const t=Utils$1.mergeObject(Utils$1.deepClone(a),e,{insertKeys:!1});if(t.seasonCycle>=0){const e=Utils$1.clamp(t.seasonCycle,0,100);await TimeProvider.setSeasonCyclePct(e/100)}if(t.daylightCycle>=0){const e=Utils$1.clamp(t.daylightCycle,0,100);await TimeProvider.setDaylightCyclePct(e/100)}},setWeather:async function setWeather(e){if(Logger.debug("setWeather(...)",{weatherSettings:e}),Permissions.hasPermission(FoundryAbstractionLayer.userID(),"sceneSettings"))try{const r={temp:{ground:_checkParam(e,"temp.ground","number",(e=>Math.round(Utils$1.clamp(e,-30,50)))),air:_checkParam(e,"temp.air","number",(e=>Math.round(Utils$1.clamp(e,-30,50))))},humidity:_checkParam(e,"humidity","number",(e=>Math.round(Utils$1.clamp(e,0,100)))),wind:{speed:_checkParam(e,"wind.speed","number",(e=>Math.round(Utils$1.clamp(e,0,130)))),gusts:_checkParam(e,"wind.gusts","number",(e=>Math.round(Utils$1.clamp(e,0,130)))),directionType:_checkParam(e,"wind.directionType","string",(e=>i[e]||i.fixed)),direction:_checkParam(e,"wind.direction","number",(e=>Math.round(e)%360))},clouds:{type:_checkParam(e,"clouds.type","string",(e=>d[e]||d.none)),coverage:_checkParam(e,"clouds.coverage","number",(e=>Math.round(Utils$1.clamp(e,0,100)))),bottom:_checkParam(e,"clouds.bottom","number",(e=>Math.round(Utils$1.clamp(e,0,2e4)))),thickness:_checkParam(e,"clouds.thickness","number",(e=>Math.round(Utils$1.clamp(e,0,2e4))))},precipitation:{type:_checkParam(e,"precipitation.type","string",(e=>c[e]||c.none)),amount:_checkParam(e,"precipitation.amount","number",(e=>Math.round(Utils$1.clamp(e,0,100))))},sun:{amount:_checkParam(e,"sun.amount","number",(e=>Math.round(Utils$1.clamp(e,0,100))))}};Logger.trace("setWeather(...)",{safeWeatherData:r}),await FoundryAbstractionLayer.setSceneFlag("weatherSettings",r),Logger.info("setWeather | "+FoundryAbstractionLayer.i18n("api.updateWeather"));FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)!=t.WEATHER_GENERATE&&(await FoundryAbstractionLayer.setSceneFlag("weatherMode",t.WEATHER_GENERATE),Logger.info("setWeather | "+FoundryAbstractionLayer.i18n("api.updateWeatherMode")+t.WEATHER_GENERATE))}catch(e){Logger.error("setWeather | "+FoundryAbstractionLayer.i18n("api.updateRegionFail")+e.message,!0)}else Logger.error("setWeather | "+FoundryAbstractionLayer.i18n("api.noPermission"))},setWeatherTemplate:async function setWeatherTemplate(e=""){if(Logger.debug("setWeatherTemplate(...)",{templateId:e}),!Permissions.hasPermission(FoundryAbstractionLayer.userID(),"sceneSettings"))return void Logger.error("setWeatherTemplate | "+FoundryAbstractionLayer.i18n("api.noPermission"));if(!e.includes("."))return void Logger.error("setWeatherTemplate | "+FoundryAbstractionLayer.i18n("api.setTemplate.idFormatInvalid"));const[r,i]=e.split(".");if(!FoundryAbstractionLayer.isModuleActive(r))return void Logger.error("setWeatherTemplate | "+FoundryAbstractionLayer.i18n("api.setTemplate.moduleInactive")+r);if(!Object.keys(SceneWeatherState._weatherTemplates).includes(e))return void Logger.error("setWeatherTemplate | "+FoundryAbstractionLayer.i18n("api.setTemplate.noSuchTemplate")+e);const a=SceneWeatherState._weatherTemplates[e];FoundryAbstractionLayer.getSceneFlag("weatherTemplate",null)!=e&&(await FoundryAbstractionLayer.setSceneFlag("weatherTemplate",e),Logger.info("setWeatherTemplate | "+FoundryAbstractionLayer.i18n("api.setTemplate.updateWeatherTemplate")+FoundryAbstractionLayer.i18n(a.name)+" ("+e+")")),FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)!=t.WEATHER_TEMPLATE&&(await FoundryAbstractionLayer.setSceneFlag("weatherMode",t.WEATHER_TEMPLATE),Logger.info("setWeatherTemplate | "+FoundryAbstractionLayer.i18n("api.updateWeatherMode")+t.WEATHER_TEMPLATE))},setRegion:async function setRegion(e){if(Logger.debug("setRegion(...)",{regionSettings:e}),Permissions.hasPermission(FoundryAbstractionLayer.userID(),"sceneSettings"))try{const r={elevation:_checkParam(e,"elevation","number",(e=>Math.round(Utils$1.clamp(e,0,1e4)))),vegetation:_checkParam(e,"vegetation","number",(e=>Math.round(Utils$1.clamp(e,0,100)))),waterAmount:_checkParam(e,"waterAmount","number",(e=>Math.round(Utils$1.clamp(e,0,100)))),summer:{temperature:{day:_checkParam(e,"summer.temperature.day","number",(e=>Math.round(Utils$1.clamp(e,-30,50)))),night:_checkParam(e,"summer.temperature.night","number",(e=>Math.round(Utils$1.clamp(e,-30,50)))),var:_checkParam(e,"summer.temperature.var","number",(e=>Math.round(Utils$1.clamp(e,0,20))))},humidity:{day:_checkParam(e,"summer.humidity.day","number",(e=>Math.round(Utils$1.clamp(e,0,100)))),night:_checkParam(e,"summer.humidity.night","number",(e=>Math.round(Utils$1.clamp(e,0,100)))),var:_checkParam(e,"summer.humidity.var","number",(e=>Math.round(Utils$1.clamp(e,0,50))))},wind:{avg:_checkParam(e,"summer.wind.avg","number",(e=>Math.round(Utils$1.clamp(e,0,70)))),var:_checkParam(e,"summer.wind.var","number",(e=>Math.round(Utils$1.clamp(e,0,50))))},sun:{hours:_checkParam(e,"summer.sun.hours","number",(e=>Math.round(Utils$1.clamp(e,1,23))))}},winter:{temperature:{day:_checkParam(e,"winter.temperature.day","number",(e=>Math.round(Utils$1.clamp(e,-30,50)))),night:_checkParam(e,"winter.temperature.night","number",(e=>Math.round(Utils$1.clamp(e,-30,50)))),var:_checkParam(e,"winter.temperature.var","number",(e=>Math.round(Utils$1.clamp(e,0,20))))},humidity:{day:_checkParam(e,"winter.humidity.day","number",(e=>Math.round(Utils$1.clamp(e,0,100)))),night:_checkParam(e,"winter.humidity.night","number",(e=>Math.round(Utils$1.clamp(e,0,100)))),var:_checkParam(e,"winter.humidity.var","number",(e=>Math.round(Utils$1.clamp(e,0,50))))},wind:{avg:_checkParam(e,"winter.wind.avg","number",(e=>Math.round(Utils$1.clamp(e,0,70)))),var:_checkParam(e,"winter.wind.var","number",(e=>Math.round(Utils$1.clamp(e,0,50))))},sun:{hours:_checkParam(e,"winter.sun.hours","number",(e=>Math.round(Utils$1.clamp(e,1,23))))}}};Logger.trace("setRegion(...)",{safeRegionData:r}),await FoundryAbstractionLayer.setSceneFlag("regionSettings",r),Logger.info("setRegion | "+FoundryAbstractionLayer.i18n("api.updateRegion"));FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)!=t.REGION_GENERATE&&(await FoundryAbstractionLayer.setSceneFlag("weatherMode",t.REGION_GENERATE),Logger.info("setRegion | "+FoundryAbstractionLayer.i18n("api.updateWeatherMode")+t.REGION_GENERATE))}catch(e){Logger.error("setRegion | "+FoundryAbstractionLayer.i18n("api.updateRegionFail")+e.message,!0)}else Logger.error("setRegion | "+FoundryAbstractionLayer.i18n("api.noPermission"))},setRegionTemplate:async function setRegionTemplate(e=""){if(Logger.debug("setRegionTemplate(...)",{templateId:e}),!Permissions.hasPermission(FoundryAbstractionLayer.userID(),"sceneSettings"))return void Logger.error("setRegionTemplate | "+FoundryAbstractionLayer.i18n("api.noPermission"));if(!e.includes("."))return void Logger.error("setRegionTemplate | "+FoundryAbstractionLayer.i18n("api.setTemplate.idFormatInvalid"));const[r,i]=e.split(".");if(!FoundryAbstractionLayer.isModuleActive(r))return void Logger.error("setRegionTemplate | "+FoundryAbstractionLayer.i18n("api.setTemplate.moduleInactive")+r);if(!Object.keys(SceneWeatherState._regionTemplates).includes(e))return void Logger.error("setRegionTemplate | "+FoundryAbstractionLayer.i18n("api.setTemplate.noSuchTemplate")+e);const a=SceneWeatherState._regionTemplates[e];FoundryAbstractionLayer.getSceneFlag("regionTemplate",null)!=e&&(await FoundryAbstractionLayer.setSceneFlag("regionTemplate",e),Logger.info("setRegionTemplate | "+FoundryAbstractionLayer.i18n("api.setTemplate.updateRegionTemplate")+FoundryAbstractionLayer.i18n(a.name)+" ("+e+")")),FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)!=t.REGION_TEMPLATE&&(await FoundryAbstractionLayer.setSceneFlag("weatherMode",t.REGION_TEMPLATE),Logger.info("setRegionTemplate | "+FoundryAbstractionLayer.i18n("api.updateWeatherMode")+t.REGION_TEMPLATE))},registerPerciever:WeatherPerception.registeredPerciever,registerRegionTemplate:function registerRegionTemplate(t=null,r=null,i={}){if(t&&r&&i&&FoundryAbstractionLayer.isModuleEnabled(t)){i.id=t+"."+r;const a=Utils$1.mergeObject(Utils$1.deepClone(e),i,{insertKeys:!1,enforceTypes:!0});SceneWeatherState._regionTemplates[a.id]=a,Logger.info("registerRegionTemplate | "+FoundryAbstractionLayer.i18n("api.regRegionTemplate")+t+"."+r)}else Logger.error("registerRegionTemplate | "+FoundryAbstractionLayer.i18n("api.regRegionTemplateFail")+t+"."+r,!0)},registerWeatherTemplate:function registerWeatherTemplate(e=null,t=null,i={}){if(e&&t&&i&&FoundryAbstractionLayer.isModuleEnabled(e)){i.id=e+"."+t;const a=Utils$1.mergeObject(Utils$1.deepClone(r),i,{insertKeys:!1,enforceTypes:!0});SceneWeatherState._weatherTemplates[e+"."+t]=a,Logger.info("registerWeatherTemplate | "+FoundryAbstractionLayer.i18n("api.regWeatherTemplate")+e+"."+t)}else Logger.error("registerWeatherTemplate | "+FoundryAbstractionLayer.i18n("api.regWeatherTemplateFail")+e+"."+t,!0)},registerWeatherFxGenerator:function registerWeatherFxGenerator(e=null,t=null){Logger.info("registerWeatherFxGenerator | "+FoundryAbstractionLayer.i18n("api.regFxGenerator")+e),SceneWeatherState._generators.push({name:e,getEmitter:t})},registerWeatherFxFilter:function registerWeatherFxFilter(e=null,t=null){Logger.info("registerWeatherFxFilter | "+FoundryAbstractionLayer.i18n("api.regFxFilter")+e),SceneWeatherState._filters.push({name:e,getFilterConfig:t})},version:"1.0"}}const registerHbHelpers=function(){Handlebars.__switch_stack__=[],Handlebars.registerHelper("switch",(function(e,t){Handlebars.__switch_stack__.push({switch_match:!1,switch_value:e});var r=t.fn(this);return Handlebars.__switch_stack__.pop(),r})),Handlebars.registerHelper("case",(function(e,t){var r=Array.from(arguments),i=(t=r.pop(),r),a=Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1];return a.switch_match||-1===i.indexOf(a.switch_value)?"":(a.switch_match=!0,t.fn(this))})),Handlebars.registerHelper("default",(function(e){if(!Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1].switch_match)return e.fn(this)})),Logger.debug("HB Helpers Registered")},loadHandlebars=function(){loadTemplates({regionConfigSummer:"modules/"+e.ID+"/templates/regionConfigSummer.hbs",regionConfigWinter:"modules/"+e.ID+"/templates/regionConfigWinter.hbs"}),Logger.debug("HB partials loaded")};class RegionConfigDialog extends FormApplication{constructor(e){super(),this.applyToScene=e,Logger.debug("RegionConfigDialog:constrctor",{applyToScene:e})}static get defaultOptions(){return Utils$1.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/regionConfig.hbs",id:"region-settings",title:"dialogs.regionConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}activateListeners(e){super.activateListeners(e),Logger.debug("RegionConfigDialog:activateListeners");new Tabs({navSelector:".tabs",contentSelector:".content",initial:"summer",callback:{}}).bind(e[0]),e.find(".sceneweather-slider").each((function(t){const r=$(this),i=e.find('input[name="'+r.attr("data-min")+'"]'),a=e.find('input[name="'+r.attr("data-max")+'"]'),n=r.attr("data-range")||"0,100",o=r.attr("data-unit")||"%",s=Number(n.split(",")[0]||0),c=Number(n.split(",")[1]||s);noUiSlider.create(r[0],{start:[i.val()||0,a.val()||0],tooltips:[{to:function(e){return e+o},from:function(e){return Number(e.replace(o,""))}},{to:function(e){return e+o},from:function(e){return Number(e.replace(o,""))}}],behaviour:"drag-all",step:1,margin:0,padding:0,connect:!0,range:{min:s,max:c}}),r[0].noUiSlider.on("change",(function(e,t,r,n,o,s){Logger.debug("Slider Update",{values:e,noUiSlider:s}),i.val(e[0]),a.val(e[1])}))}))}getData(){let e={waterAmounts:[{id:0,name:"dialogs.regionConfig.waterAmounts_0"},{id:5,name:"dialogs.regionConfig.waterAmounts_5"},{id:10,name:"dialogs.regionConfig.waterAmounts_10"},{id:25,name:"dialogs.regionConfig.waterAmounts_25"},{id:50,name:"dialogs.regionConfig.waterAmounts_50"},{id:75,name:"dialogs.regionConfig.waterAmounts_75"},{id:100,name:"dialogs.regionConfig.waterAmounts_100"}]};if(void 0===this.applyToScene)return Utils$1.mergeObject(e,FoundryAbstractionLayer.getSetting("defaultRegionSettings")),Logger.debug("RegionConfigDialog:getData(general)",{applyToScene:this.applyToScene,data:e}),e;{let t=FoundryAbstractionLayer.getSceneFlag("regionSettings",void 0,this.applyToScene);return t||(t=FoundryAbstractionLayer.getSetting("defaultRegionSettings")),Utils$1.mergeObject(e,t),Logger.debug("RegionConfigDialog:getData(scene)",{applyToScene:this.applyToScene,data:e}),e}}_updateObject(e,t){const r=expandObject(t);Logger.debug("updateObject, regionConfig",{data:r,scene:this.applyToScene}),void 0===this.applyToScene?FoundryAbstractionLayer.setSetting("defaultRegionSettings",r):FoundryAbstractionLayer.setSceneFlag("regionSettings",r,this.applyToScene)}}class WeatherConfigDialog extends FormApplication{constructor(e){super(),this.applyToScene=e,Logger.debug("WeatherConfigDialog:constrctor",{applyToScene:e})}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/weatherConfig.hbs",id:"weather-settings",title:"dialogs.weatherConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}activateListeners(e){super.activateListeners(e),Logger.debug("WeatherConfigDialog:activateListeners");0!=e.find('select[name="wind.directionType"]').find(":selected").val()&&e.find("#windTypeGrp").addClass("disabled"),e.find('select[name="wind.directionType"]').on("change",(function(){0!=$(this).find(":selected").val()?e.find("#windTypeGrp").addClass("disabled"):e.find("#windTypeGrp").removeClass("disabled")}));const t=e.find('select[name="clouds.type"]').find(":selected").val();Logger.debug("cloudsType",t),0==t&&(e.find("#cloudSectionGrp").addClass("disabled"),e.find("#preciGrp").addClass("disabled")),e.find('select[name="clouds.type"]').on("change",(function(){const t=$(this).find(":selected").val();Logger.debug("cloudsType.change",t),0==t?(e.find("#cloudSectionGrp").addClass("disabled"),e.find("#preciGrp").addClass("disabled")):(e.find("#cloudSectionGrp").removeClass("disabled"),e.find("#preciGrp").removeClass("disabled"))}));const r=e.find('select[name="precipitation.type"]').find(":selected").val();Logger.debug("preciType",r),0==r&&e.find("#previAmtGrp").addClass("disabled"),e.find('select[name="precipitation.type"]').on("change",(function(){const t=$(this).find(":selected").val();Logger.debug("preciType",t),0==t?e.find("#previAmtGrp").addClass("disabled"):e.find("#previAmtGrp").removeClass("disabled")}))}getData(){let e={windSpeeds:Object.entries(m).map((([e,t])=>"hurricane"===e?{id:120,name:"dialogs.weatherConfig.wind.speeds.hurricane"}:{id:t,name:"dialogs.weatherConfig.wind.speeds."+e})),directionTypes:[{id:0,name:"dialogs.weatherConfig.directionTypes.fixed"},{id:1,name:"dialogs.weatherConfig.directionTypes.noise"}],cloudsTypes:Object.entries(d).map((([e,t])=>({id:t,name:"dialogs.weatherConfig.clouds.types."+e}))),precipitationTypes:Object.entries(c).map((([e,t])=>({id:t,name:"dialogs.weatherConfig.precipitation.types."+e}))),windGustTypes:[{id:0,name:"dialogs.weatherConfig.windGustTypes.none"},{id:6,name:"dialogs.weatherConfig.windGustTypes.some"},{id:11,name:"dialogs.weatherConfig.windGustTypes.more"}]};if(void 0===this.applyToScene)return mergeObject(e,FoundryAbstractionLayer.getSetting("defaultWeatherSettings")),Logger.debug("WeatherConfigDialog:getData(general)",{applyToScene:this.applyToScene,data:e}),e;{let t=FoundryAbstractionLayer.getSceneFlag("weatherSettings",void 0,this.applyToScene);return t||(t=FoundryAbstractionLayer.getSetting("defaultWeatherSettings")),mergeObject(e,t),Logger.debug("WeatherConfigDialog:getData(scene)",{applyToScene:this.applyToScene,data:e}),e}}_updateObject(e,t){const r=expandObject(t);Logger.trace("updateObject, weatherConfig",{data:r,scene:this.applyToScene}),void 0===this.applyToScene?FoundryAbstractionLayer.setSetting("defaultWeatherSettings",r):FoundryAbstractionLayer.setSceneFlag("weatherSettings",r,this.applyToScene)}}class PermissionConfigDialog extends FormApplication{constructor(){super(),Logger.debug("PermissionConfigDialog.ctor")}static get defaultOptions(){return Utils$1.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/permissionConfig.hbs",id:"scene-weather-permissions-config",title:"dialogs.permissionConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1,width:220+110*PermissionConfigDialog._getUserIds().length,resizable:!0})}activateListeners(e){super.activateListeners(e),e.find("button[name='reset']").click(this._onResetDefaults.bind(this))}async _onResetDefaults(e){return e.preventDefault(),await Permissions.resetPermissions(),Logger.info(FoundryAbstractionLayer.i18n("dialogs.permissionConfig.defaultsNotice"),!0),this.render()}async _onSubmit(e,t){return e.target.querySelectorAll("input[disabled]").forEach((e=>e.disabled=!1)),super._onSubmit(e,t)}static _getUserIds(){let e=[{id:"player",name:FoundryAbstractionLayer.i18n("USER.RolePlayer"),type:"role"},{id:"trustedPlayer",name:FoundryAbstractionLayer.i18n("USER.RoleTrusted"),type:"role"},{id:"assistantGameMaster",name:FoundryAbstractionLayer.i18n("USER.RoleAssistant"),type:"role"}];return game.users.forEach((t=>{e.push({id:t._id,name:t.name,type:"user",color:t.color||"#ffffff"})})),e}getData(){const e=PermissionConfigDialog._getUserIds();let t={headline:e,matrix:[]};return Permissions.getPermissionIds().forEach((r=>{let i=[];e.forEach((e=>{i.push({id:e.id,name:e.name,check:Permissions.hasPermission(e.id,r,!1),checkId:r+"::"+e.id})})),t.matrix.push({permissionId:r,permissionName:Permissions.getPermissionNameI18n(r),permissionHint:Permissions.getPermissionHintI18n(r),users:i})})),t.matrix.sort(((e,t)=>e.permissionName.localeCompare(t.permissionName))),Logger.debug("PermissionConfigDialog.getData()",{additionalData:t}),t}_updateObject(e,t){let r={};Object.keys(t).filter((e=>t[e])).forEach((e=>{const[t,i]=e.split("::");t in r||(r[t]=Utils$1.deepClone(Permissions.DEFAULT_PERMISSION_STRUCT)),["player","trustedPlayer","assistantGameMaster"].includes(i)?r[t][i]=!0:r[t].users.push(i)})),Logger.debug("PermissionConfigDialog._updateObject(...)",{formData:t,permissions:r}),Permissions.updatePermissions(r)}}function onChangeFunction(e){Hooks.callAll(r.SETTINGS_UPDATED,e)}const registerSettingsPostInit=function(){},registerSettingsPreInit=function(){game.settings.register(e.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.registerMenu(e.ID,"permissionSettingsMenu",{name:"settings.permissionSettingsMenu.name",label:"settings.permissionSettingsMenu.label",hint:"settings.permissionSettingsMenu.hint",icon:"fa-regular fa-user-lock",type:PermissionConfigDialog,restricted:!0}),game.settings.register(e.ID,"permissions",{scope:"world",config:!1,type:Object,default:Permissions._getDefaultPermissions()}),game.settings.registerMenu(e.ID,"defaultRegionSettingsMenu",{name:"settings.defaultRegionSettingsMenu.name",label:"settings.defaultRegionSettingsMenu.label",hint:"settings.defaultRegionSettingsMenu.hint",icon:"fas fa-solid fa-sliders",type:RegionConfigDialog,restricted:!0}),game.settings.register(e.ID,"defaultRegionSettings",{scope:"world",config:!1,type:Object,default:{elevation:0,vegetation:0,waterAmount:0,summer:{temperature:{day:0,night:0,var:0},humidity:{day:0,night:0,var:0},wind:{avg:0,var:0},sun:{hours:0}},winter:{temperature:{day:0,night:0,var:0},humidity:{day:0,night:0,var:0},wind:{avg:0,var:0},sun:{hours:0}}}}),game.settings.registerMenu(e.ID,"defaultWeatherSettingsMenu",{name:"settings.defaultWeatherSettingsMenu.name",label:"settings.defaultWeatherSettingsMenu.label",hint:"settings.defaultWeatherSettingsMenu.hint",icon:"fas fa-solid fa-sliders",type:WeatherConfigDialog,restricted:!0}),game.settings.register(e.ID,"defaultWeatherSettings",{scope:"world",config:!1,type:Object,default:{temp:{ground:0,air:0},wind:{speed:0,gusts:0,direction:0,directionType:0},clouds:{coverage:0,bottom:0,thickness:0,type:0},precipitation:{amount:0,type:0},sun:{amount:0},humidity:0}}),game.settings.register(e.ID,"enableFx",{name:"settings.enableFx.name",hint:"settings.enableFx.hint",scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction({id:"enableFx",value:e})}}),game.settings.register(e.ID,"cloudsAlpha",{name:"settings.cloudsAlpha.name",hint:"settings.cloudsAlpha.hint",scope:"client",config:!0,type:Number,range:{min:0,max:100,step:5},default:100,onChange:e=>{onChangeFunction({id:"cloudsAlpha",value:e})}}),game.settings.register(e.ID,"precipitationAlpha",{name:"settings.precipitationAlpha.name",hint:"settings.precipitationAlpha.hint",scope:"client",config:!0,type:Number,range:{min:0,max:100,step:5},default:100,onChange:e=>{onChangeFunction({id:"precipitationAlpha",value:e})}}),game.settings.register(e.ID,"maxParticles",{name:"settings.maxParticles.name",hint:"settings.maxParticles.hint",scope:"client",config:!0,type:Number,range:{min:200,max:32e3,step:200},default:3200,onChange:e=>{onChangeFunction({id:"maxParticles",value:e})}}),game.settings.register(e.ID,"uiVisible",{name:"settings.uiVisible.name",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"uiPosition",{name:"settings.uiPosition.name",scope:"client",config:!1,type:Object,default:{top:440,left:15}}),game.settings.register(e.ID,"meteoVisible",{name:"settings.meteoVisible.name",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"meteoPosition",{name:"settings.meteoPosition.name",hint:"settings.meteoPosition.hint",scope:"client",config:!1,type:Object,default:{top:440,left:15}}),game.settings.register(e.ID,"uiPinned",{name:"settings.uiPinned.name",hint:"settings.uiPinned.hint",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"loglevel",{name:"settings.loglevel.name",hint:"settings.loglevel.hint",scope:"client",config:!0,type:String,choices:{info:"settings.loglevel.info",debug:"settings.loglevel.debug",trace:"settings.loglevel.trace"},default:"info"}),Logger.debug("Settings Registered")};Hooks.on(r.WEATHER_UPDATED,(async e=>{Logger.debug("->Hook:WeatherUpdated -> WeatherUI.update(...)",{data:e}),e.sceneId==canvas.scene._id&&void 0!==e.model&&WeatherUi.update(e.model)})),Hooks.on(e.LCCNAME+"WeatherDisabled",(async e=>{})),Hooks.on("renderWeatherUi",(()=>{Logger.debug("->Hook:renderWeatherUi"),WeatherUi.update()})),Hooks.on("updateWorldTime",(()=>{WeatherUi._updateTimeHeadline()}));class WeatherUi extends FormApplication{static _isOpen=!1;static _weatherModel={};static _perceptionId=void 0;async _render(e=!1,r={}){Logger.debug("WeatherUi._render(...)",{force:e,options:r}),await super._render(e,r),FoundryAbstractionLayer.getSetting("uiPinned",!1)&&WeatherUi.pinApp(),WeatherUi._isOpen=!0,delete ui.windows[this.appId],FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)!=t.DISABLED&&WeatherUi._weatherModel.hasPerceiver?$("#scene-weather-app").css("visibility","visible"):(Logger.debug("WeatherUi._render() -> hiding app, DISABLED"),$("#scene-weather-app").css("visibility","hidden"))}async close(e={}){return e.sceneWeather&&(WeatherUi._isOpen=!1,await FoundryAbstractionLayer.setSetting("uiVisible",!1)),super.close(e)}constructor(){super(),Logger.debug("WeatherUi.ctor")}static get defaultOptions(){return this.initialPosition=FoundryAbstractionLayer.getSetting("uiPosition",{top:40,left:40}),mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,width:200,height:100,submitOnChange:!0,closeOnSubmit:!1,minimizable:!1,template:"modules/"+e.ID+"/templates/weatherUi.hbs",id:"scene-weather-app",title:"dialogs.weatherUi.title",top:this.initialPosition.top,left:this.initialPosition.left})}async _updateObject(e,t){Logger.debug("WeatherUi._updateObjec",{event:e,formData:t})}static _addModelFlags(){const e=FoundryAbstractionLayer.userID();WeatherUi._weatherModel.hasControls=Permissions.hasPermission(e,"weatherUiControls"),WeatherUi._weatherModel.hasPerceiver=WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID()).length>=1,WeatherUi._weatherModel.hasPerceivers=WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID()).length>1,WeatherUi._weatherModel.hasTimeAuthority=Permissions.hasPermission(e,"timeControls")&&WeatherUi._weatherModel.hasControls&&TimeProvider.hasTimeAuthority()&&[t.REGION_TEMPLATE,t.REGION_GENERATE].includes(FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)),WeatherUi._weatherModel.hasTimeAuthority?WeatherUi._weatherModel.timeHeadline=TimeProvider.getI18nDateString():WeatherUi._weatherModel.timeHeadline=""}getData(){return WeatherUi._addModelFlags(),Logger.debug("WeatherUi.getData()",{_weatherModel:WeatherUi._weatherModel}),WeatherUi._weatherModel}_attachDragHandler(e){const t=e.find("#weatherHeadline")[0],r=new Draggable(this,e,t,!1);let i=!1;r._onDragMouseMove=function _newOnDragMouseMove(e){e.preventDefault();const t=document.getElementById("players").getBoundingClientRect(),r=Date.now();if(r-this._moveTime<1e3/60)return;this._moveTime=r;const{left:a,top:n}=this.element.getBoundingClientRect();WeatherUi.unPinApp()&&Object.assign(this.position,{left:a,top:n}),this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)});let o=t.top-50,s=t.top+50;e.clientX>t.left&&e.clientX<t.left+t.width&&e.clientY>o&&e.clientY<s?($("#scene-weather-app").css("animation","jiggle 0.2s infinite"),i=!0):($("#scene-weather-app").css("animation",""),i=!1)},r._onDragMouseUp=async function _newOnDragMouseUp(e){e.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp);const t=document.getElementById("players").getBoundingClientRect().height+90;if(i)WeatherUi.pinApp(),await FoundryAbstractionLayer.setSetting("uiPinned",!0),this.app.setPosition({left:15,top:window.innerHeight-t});else{const e=$("#scene-weather-app").position(),t={top:e.top,left:e.left};await FoundryAbstractionLayer.setSetting("uiPosition",t),await FoundryAbstractionLayer.setSetting("uiPinned",!1)}$("#scene-weather-app").css("animation","")}}_attachControls(e){WeatherUi._weatherModel.hasControls&&e.find("#weatherControls li").each((function(e){const t=$(this),r=t.attr("data-func")||"none",i=Number(t.attr("data-base")||"0");switch(r){case"time":WeatherUi._weatherModel.hasTimeAuthority&&t.on("click",(function(){TimeProvider.advanceGameTime(window.event.ctrlKey?5*i:i)}));break;case"chatSingle":WeatherUi._weatherModel.hasControls&&t.on("click",(async function(){const e=FoundryAbstractionLayer.getControlledTokens();if(0==e.length)Logger.info(FoundryAbstractionLayer.i18n("dialogs.weatherUi.chatNotice"),!0);else{const t=e.map((e=>FoundryAbstractionLayer.getUserByToken(e)));Logger.debug("chatSingle",{tokens:e,userIds:t});const r=await WeatherPerception.getAsChatHtml(WeatherUi._perceptionId,WeatherUi._weatherModel);ChatMessage.create({user:FoundryAbstractionLayer.userID(),whisper:t,content:r})}}));break;case"chatAll":WeatherUi._weatherModel.hasControls&&t.on("click",(async function(){const e=await WeatherPerception.getAsChatHtml(WeatherUi._perceptionId,WeatherUi._weatherModel);ChatMessage.create({user:FoundryAbstractionLayer.userID(),content:e})}));break;case"clipboard":WeatherUi._weatherModel.hasControls&&t.on("click",(async function(){const e=await WeatherPerception.getAsText(WeatherUi._perceptionId,WeatherUi._weatherModel);Utils$1.copyToClipboard(e),Logger.info(FoundryAbstractionLayer.i18n("dialogs.weatherUi.clipboardNotice"),!0)}))}}))}_attachPerceiverControls(e){WeatherUi._weatherModel.hasPerceivers&&e.find("#weatherContainer .percControl").each((function(e){const t=$(this);switch(t.attr("data-func")||"none"){case"prevPerc":t.on("click",(async function(){const e=WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID());WeatherUi._perceptionId=Utils$1.arrayPrev(e,WeatherUi._perceptionId),Logger.debug("click()",{perceiverPrev:WeatherUi._perceptionId}),await FoundryAbstractionLayer.setUserFlag("perceptionId",WeatherUi._perceptionId),WeatherUi.update()}));break;case"nextPerc":t.on("click",(async function(){const e=WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID());WeatherUi._perceptionId=Utils$1.arrayNext(e,WeatherUi._perceptionId),Logger.debug("click()",{perceiverNext:WeatherUi._perceptionId}),await FoundryAbstractionLayer.setUserFlag("perceptionId",WeatherUi._perceptionId),WeatherUi.update()}))}}))}activateListeners(e){super.activateListeners(e),this._attachDragHandler(e),this._attachControls(e),this._attachPerceiverControls(e)}static async pinApp(){const e=FoundryAbstractionLayer.getModule().uiApp;e&&!e.element.hasClass("pinned")&&($("#players").before(e.element),e.element.addClass("pinned"))}static unPinApp(){const e=FoundryAbstractionLayer.getModule().uiApp;if(e&&e.element.hasClass("pinned")){const t=e.element;return $("body").append(t),t.removeClass("pinned"),!0}}static async toggleAppVis(e){"toggle"===e?!0===FoundryAbstractionLayer.getSetting("uiVisible",!1)?($("#scene-weather-app").stop(),$("#scene-weather-app").css({animation:"close 0.3s",opacity:"0"}),setTimeout((function(){FoundryAbstractionLayer.getModule().uiApp.close({sceneWeather:!0})}),200)):(WeatherUi._isOpen&&FoundryAbstractionLayer.getModule().uiApp.close({sceneWeather:!0}),FoundryAbstractionLayer.getModule().uiApp=await(new WeatherUi).render(!0),FoundryAbstractionLayer.setSetting("uiVisible",!0)):!0===FoundryAbstractionLayer.getSetting("uiVisible",!1)&&(FoundryAbstractionLayer.getModule().uiApp=await(new WeatherUi).render(!0))}static async _updateTimeHeadline(){Logger.debug("WeatherUi._updateTimeHeadline()",{model:WeatherUi._weatherModel}),WeatherUi._weatherModel.hasTimeAuthority&&(WeatherUi._weatherModel.timeHeadline=TimeProvider.getI18nDateString(),$("#weatherHeadline").html(WeatherUi._weatherModel.timeHeadline))}static async update(e=null){if(null==e&&(e=WeatherUi._weatherModel),Logger.debug("WeatherUi.update(...)",{weatherModel:e}),WeatherUi._weatherModel=e,!WeatherUi._perceptionId){WeatherUi._perceptionId=FoundryAbstractionLayer.getUserFlag("perceptionId",void 0);const e=WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID());e.includes(WeatherUi._perceptionId)||(WeatherUi._perceptionId=e[0]),await FoundryAbstractionLayer.setUserFlag("perceptionId",WeatherUi._perceptionId)}if(WeatherUi._addModelFlags(),!0===FoundryAbstractionLayer.getSetting("uiVisible",!1)){const e=await WeatherPerception.getAsUiHtml(WeatherUi._perceptionId,WeatherUi._weatherModel);$("#weatherDetail").html(e),WeatherUi._weatherModel.hasTimeAuthority&&WeatherUi._updateTimeHeadline()}}}Hooks.on(e.LCCNAME+"WeatherUpdated",(async e=>{e.sceneId==canvas.scene._id&&void 0!==e.model&&MeteoUi.update()}));class MeteoUi extends FormApplication{static _isOpen=!1;static _context=void 0;static _fromHr=-12;static _toHr=12;async _render(e=!1,t={}){await super._render(e,t),MeteoUi._isOpen=!0,MeteoUi._context=document.getElementById("meteogramCanvas"),MeteoUi._chart=void 0,MeteoUi._drawWeatherModelData(),delete ui.windows[this.appId]}async close(e={}){return e.sceneWeather&&(MeteoUi._isOpen=!1,MeteoUi._context=void 0,FoundryAbstractionLayer.setSetting("meteoVisible",!1)),super.close(e)}constructor(){super()}static get defaultOptions(){return this.initialPosition=FoundryAbstractionLayer.getSetting("meteoPosition",{top:40,left:40}),Utils$1.mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,width:600,height:400,submitOnChange:!1,closeOnSubmit:!1,minimizable:!1,template:"modules/"+e.ID+"/templates/meteoUi.hbs",id:"scene-weather-meteo-app",title:"SceneWeather Meteogram",top:this.initialPosition.top,left:this.initialPosition.left})}async _updateObject(e,t){Logger.debug("MeteoUi._updateObjec",{event:e,formData:t})}getData(){return{}}activateListeners(e){super.activateListeners(e);const t=e.find("#dragHandle")[0],r=new Draggable(this,e,t,!1);r._onDragMouseMove=function _newOnDragMouseMove(e){e.preventDefault();const t=Date.now();t-this._moveTime<1e3/60||(this._moveTime=t,this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)}))},r._onDragMouseUp=async function _newOnDragMouseUp(e){e.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp);let t=$("#scene-weather-meteo-app").position(),r={top:t.top,left:t.left};await FoundryAbstractionLayer.setSetting("meteoPosition",r)}}static async toggleAppVis(e){"toggle"===e?!0===FoundryAbstractionLayer.getSetting("meteoVisible",!1)?($("#scene-weather-meteo-app").stop(),$("#scene-weather-meteo-app").css({animation:"close 0.3s",opacity:"0"}),setTimeout((function(){FoundryAbstractionLayer.getModule().meteoApp.close({sceneWeather:!0})}),200)):(MeteoUi._isOpen&&FoundryAbstractionLayer.getModule().meteoApp.close({sceneWeather:!0}),FoundryAbstractionLayer.getModule().meteoApp=await(new MeteoUi).render(!0),await FoundryAbstractionLayer.setSetting("meteoVisible",!0)):!0===FoundryAbstractionLayer.getSetting("meteoVisible",!1)&&(FoundryAbstractionLayer.getModule().meteoApp=await(new MeteoUi).render(!0))}static async update(){Logger.debug("Updating MeteoUi"),!0===FoundryAbstractionLayer.getSetting("meteoVisible",!1)&&MeteoUi._drawWeatherModelData()}static async _drawWeatherModelData(){const e=MeteoUi._fromHr,t=MeteoUi._toHr,r=MeteoUi._context;if(void 0===r)return void Logger.debug("No Context Yet");let i={labels:[],datasets:[]},a={label:"tempGround",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff0000",borderDash:[5,5],yAxisID:"y"},n={label:"tempAir",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff4400",borderDash:[5,5],yAxisID:"y"},o={label:"tempPercieved",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff0044",yAxisID:"y"},s={label:"windSpeed",data:[],borderWidth:1,pointRadius:0,borderColor:"rgba(20, 200, 0, 0.9)",yAxisID:"y"},c={label:"windGusts",data:[],borderWidth:1,pointRadius:0,borderColor:"rgba(0, 200, 0, 0.8)",borderDash:[5,5],yAxisID:"y"},d={label:"windDirection",data:[],borderWidth:1,showLine:!1,borderColor:"#b74"},l={label:"cloudsCoverage",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(128, 128, 128, 0.3)",fill:!0,stepped:!0,yAxisID:"y2"},g={label:"precipitationAmount",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(60,60,255,0.2)",fill:!0,yAxisID:"y2"},u={label:"sunAmount",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(255, 255, 0, 0.6)",fill:!0,yAxisID:"y2"},m={label:"humidity",data:[],borderWidth:1,pointRadius:0,borderColor:"#9999ff",yAxisID:"y2"};const h=SceneWeatherApi.getSceneWeatherProvider();for(let r=e;r<t;r++){const e=h.weatherModel.getWeatherData(0,r);a.data.push(e.temp.ground),n.data.push(e.temp.air),o.data.push(e.temp.percieved),s.data.push(e.wind.speed),c.data.push(e.wind.gusts),d.data.push(e.wind.direction/10),l.data.push(100*e.clouds.coverage),g.data.push(100*e.precipitation.amount),u.data.push(100*e.sun.amount),m.data.push(e.humidity),r<0?i.labels.push(r+"h"):r>0?i.labels.push("+"+r+"h"):i.labels.push("now")}i.datasets.push(a),i.datasets.push(n),i.datasets.push(o),i.datasets.push(s),i.datasets.push(c),i.datasets.push(d),i.datasets.push(l),i.datasets.push(g),i.datasets.push(u),i.datasets.push(m);let p={type:"line",data:i,options:{layout:{autoPadding:!1},interaction:{mode:"nearest",axis:"x",intersect:!1},plugins:{legend:{position:"right",labels:{usePointStyle:!0}}},responsive:!1,animation:!1,scales:{x:{position:"bottom"},y:{display:!0,position:"left",type:"linear",min:-30,max:70,title:{display:!0,text:"C"},grid:{color:function(e){return 0==e.tick.value?"rgba(0,0,0,1)":"rgba(80,80,80,0.3)"}}},y2:{position:"right",type:"linear",min:0,max:100,title:{display:!0,text:"%"}}}}};if(void 0===MeteoUi._chart)MeteoUi._chart=new Chart(r,p),Logger.debug("MeteoUI::new",{ctx:r,chart:MeteoUi._chart});else{Logger.debug("MeteoUi::update");for(let e=0;e<MeteoUi._chart.data.datasets.length;e++)MeteoUi._chart.data.datasets[e].data=i.datasets[e].data;MeteoUi._chart.data.labels=i.labels,MeteoUi._chart.update()}}}class WeatherEffect extends ParticleEffect{static label="sceneweather.fxname";static _getFxEmittersForModel(e){let t=[];return SceneWeatherState._generators.forEach((r=>{let i=r.getEmitter(e);i&&t.push(i)})),Logger.debug("WeatherEffect._getFxEmittersForModel()",{model:e,gen:SceneWeatherState._generators,emitters:t}),t}static _equalizeMaxParticles(e,t){let r=0,i=0;for(let t=0;t<e.length;t++){const a=e[t];r+=a.maxParticles,i+=a.weight}if(r<=t)return e;let a=0;for(let t=0;t<e.length;t++){const r=e[t];a+=r.maxParticles*(r.weight/i)}a=t/a;for(let t=0;t<e.length;t++){const r=e[t];r.maxParticles*=a*(r.weight/i)}return Logger.debug("WeatherEffect._equalizeMaxParticles()",{totalParticles:r,maxParticles:t}),e}play({easeIn:e=!0}={}){e||this.emitters.forEach((e=>{e.autoUpdate=!1,e.emit=!0,e.update(e.maxLifetime),e.autoUpdate=!0})),super.play()}getParticleEmitters(e={}){if(Logger.debug("WeatherEffect.getParticleEmitters(...)",{options:e}),void 0===e.data||void 0===e.data.model)return Logger.debug("WeatherEffect.getParticleEmitters() no model data contained, no emitters."),[];const t=WeatherEffect._getFxEmittersForModel(e.data.model),r=FoundryAbstractionLayer.getSetting("maxParticles",3200);WeatherEffect._equalizeMaxParticles(t,r);let i=[];return t.forEach((e=>{i.push(this.createEmitter(e))})),i}async softStop({gracePeriod:e}={}){const t=this.emitters.map((t=>new Promise((r=>{let i=t._activeParticlesFirst;for(;null!=i;){const t=e,r=Math.max(i.age,i.maxLife-t);i.age=r,i.agePercent=i.age*i.oneOverLife,i=i.next}t.emitterLifetime=0,t.playOnceAndDestroy((()=>{r()}))})))),r=[Promise.all(t)];void 0!==e&&r.push(new Promise((t=>setTimeout(t,1e3*e))).then(this.destroy.bind(this))),await Promise.race(r),this.stop()}}Hooks.on(e.LCCNAME+"SettingsUpdated",(async e=>{Logger.debug("-> Hooks::SettingsUpdated -> WeatherEffectsLayer.draw*Effects",{data:e}),["cloudsAlpha","precipitationAlpha","maxParticles","enableFx"].includes(e.id)&&SceneWeather.updateWeather({force:!0})})),Hooks.on(e.LCCNAME+"WeatherDisabled",(async e=>{canvas.scene._id==e.scene.id?void 0!==canvas.sceneweatherfx?await Promise.all([canvas.sceneweatherfx.drawParticleEffects({soft:!1}),canvas.sceneweatherfx.drawFilterEffects({soft:!1})]):Logger.debug("No canvas.sceneweatherfx"):Logger.debug("WeatherDisabled for another scene, ignoring")})),Hooks.on(r.WEATHER_UPDATED,(async e=>{Logger.debug("-> Hooks::WeatherUpdated -> WeatherEffectsLayer.draw*Effects",{data:e}),void 0!==canvas.sceneweatherfx?await Promise.all([canvas.sceneweatherfx.drawParticleEffects({soft:!e.force,data:e}),canvas.sceneweatherfx.drawFilterEffects({soft:!e.force,data:e})]):Logger.debug("No canvas.sceneweatherfx")}));class WeatherEffectsLayer extends CanvasLayer{particleEffectsContainer;activeEffects=[];activeFilters={};constructor(){super(),canvas.app.ticker.add(this.handleTick,this)}static getFxFiltersForModel(e){let t={};return SceneWeatherState._filters.forEach((r=>{Utils$1.mergeObject(t,r.getFilterConfig(e))})),Logger.debug("WeatherEffectsLayer.getFxFiltersForModel()",{model:e,filter:t}),t}get elevation(){return(canvas.weather?.elevation??9999)+1}set elevation(e){const t=canvas.weather;t&&(t.elevation=e-1)}static get layerOptions(){return Utils$1.mergeObject(super.layerOptions,{name:"weather-particle-effects"})}async _draw(){Logger.debug("WeatherEffectsLayer._draw()",{this:this})}async _tearDown(){return Logger.debug("WeatherEffectsLayer._tearDown()",{effects:this.activeEffects}),this.activeEffects.forEach((e=>{e.destroy()})),this.activeEffects=[],this.particleEffectsContainer=void 0,super._tearDown()}handleTick(){for(const e in this.activeFilters)this.activeFilters[e].step()}async drawFilterEffects(e){if(Logger.debug("WeatherEffectsLayer.drawFilterEffects(...)",{options:e}),e=Utils$1.mergeObject({soft:!1},e),!canvas.scene)return;const t=Object.values(this.activeFilters).map((e=>e.destroy()));await Promise.all(t);const r=Object.values(this.activeFilters);if(canvas.environment.filters=canvas.environment.filters?.filter((function(e){return!r.find((function(t){return e===t}))}))??[],this.activeFilters={},!FoundryAbstractionLayer.getSetting("enableFx",!0))return;if(void 0===e.data||void 0===e.data.model)return void Logger.debug("WeatherEffectsLayer.drawFilterEffects() no model data contained, no filters.");const i=WeatherEffectsLayer.getFxFiltersForModel(e.data.model);Object.entries(i).map((([t,r])=>{this.activeFilters[t]=new r.type({soft:e.soft,options:Utils$1.mergeObject(r,{"-=type":null},{performDeletions:!0})}),canvas.environment.filters.push(this.activeFilters[t])}))}async drawParticleEffects(e){if(e=Utils$1.mergeObject({soft:!1},e),!canvas.scene)return;this.particleEffectsContainer||(this.particleEffectsContainer=this.addChild(new PIXI.Container));const t=Promise.all(this.activeEffects.map((async t=>{e.soft?await t.softStop({gracePeriod:10}):(t.destroy(),t.stop());const r=this.activeEffects.indexOf(t);r>-1&&this.activeEffects.splice(r,1)})));if(FoundryAbstractionLayer.getSetting("enableFx",!0)){const t=new WeatherEffect(this.particleEffectsContainer,e);t.play({easeIn:e.soft}),this.activeEffects.push(t)}Logger.debug("waiting for emitters to clean up (softly)",{effects:this.activeEffects,soft:e.soft}),await t,Logger.debug("cleaned up emitters",{effects:this.activeEffects})}}class WeatherLayer extends InteractionLayer{static registerLayers(){CONFIG.Canvas.layers.sceneweather={layerClass:WeatherLayer,group:"interface"},CONFIG.Canvas.layers.sceneweatherfx={layerClass:WeatherEffectsLayer,group:"primary"}}static registerLayerButtons(){Hooks.on("getSceneControlButtons",(r=>{const i=FoundryAbstractionLayer.userID(),a=[{name:"dialogs.weatherUi.toggleName",title:"dialogs.weatherUi.toggleTitle",icon:"fas fa-solid fa-window-maximize",visible:WeatherPerception.getAllowedIds(i).length>=1&&FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)!=t.DISABLED,toggle:!0,active:WeatherUi._isOpen,onClick:()=>{WeatherUi.toggleAppVis("toggle")}},{name:"dialogs.meteoUi.toggleName",title:"dialogs.meteoUi.toggleTitle",icon:"fas fa-solid fa-chart-line",visible:Permissions.hasPermission(i,"meteogramUi")&&[t.REGION_TEMPLATE,t.REGION_GENERATE].includes(FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)),toggle:!0,active:MeteoUi._isOpen,onClick:()=>{MeteoUi.toggleAppVis("toggle")}},{name:"dialogs.weatherConfig.toggleName",title:"dialogs.weatherConfig.toggleTitle",icon:"fas fa-solid fa-sliders",visible:Permissions.hasPermission(i,"sceneSettings")&&[t.WEATHER_GENERATE].includes(FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)),button:!0,onClick:()=>{if(Permissions.hasPermission(i,"sceneSettings")&&[t.WEATHER_GENERATE].includes(FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED))){new WeatherConfigDialog(canvas.scene._id).render(!0)}}},{name:"dialogs.regionConfig.toggleName",title:"dialogs.regionConfig.toggleTitle",icon:"fas fa-solid fa-sliders",visible:Permissions.hasPermission(i,"sceneSettings")&&[t.REGION_GENERATE].includes(FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)),button:!0,onClick:()=>{if(Permissions.hasPermission(i,"sceneSettings")&&[t.REGION_GENERATE].includes(FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED))){new RegionConfigDialog(canvas.scene._id).render(!0)}}},{name:"dialogs.macroConfig.toggleName",title:"dialogs.macroConfig.toggleTitle",icon:"fas fa-solid fa-scroll",visible:Permissions.hasPermission(i,"sceneSettings")&&FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)!=t.DISABLED,button:!0,onClick:()=>{Permissions.hasPermission(i,"sceneSettings")&&FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)!=t.DISABLED&&(MacroConfigDialog._app=new MacroConfigDialog,MacroConfigDialog._app.render(!0))}},{name:"settings.enableFx.toggleName",title:"settings.enableFx.toggleTitle",icon:"fas fa-solid fa-eye",visible:FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED)!=t.DISABLED,toggle:!0,active:FoundryAbstractionLayer.getSetting("enableFx",!0),onClick:()=>{const t=!FoundryAbstractionLayer.getSetting("enableFx",!0);FoundryAbstractionLayer.setSetting("enableFx",t),Hooks.callAll(e.LCCNAME+"SettingsUpdated",{id:"enableFx",value:t})}}];r.splice(r.findIndex((e=>"sounds"===e.name))+1,0,{name:"settings.buttonName",title:"settings.buttonTitle",icon:"fas fa-solid fa-cloud-bolt-sun",layer:"sceneweather",tools:a})}))}static get layerOptions(){return Utils$1.mergeObject(super.layerOptions,{name:"sceneweather",canDragCreate:!1,controllableObjects:!0,rotatableObjects:!0,zIndex:479})}selectObjects(e){canvas.tokens.selectObjects(e)}}class WeatherTab{static async addControlsTab(r,i){Logger.debug("WeatherTab.addControlsTab",{app:r,jQ:i});const n=r.document.flags[e.ID],o={weatherMode:"disabled",weatherTemplate:Object.values(SceneWeatherState._weatherTemplates)[0].id,regionTemplate:Object.values(SceneWeatherState._regionTemplates)[0].id,timeProvider:TimeProvider.getProviderIds()[0],seed:""},s={data:Utils$1.mergeObject(o,n,{overwrite:!0}),timeProviders:TimeProvider.getProviderIds().map((e=>({id:e,name:"configTab.general.timeSources."+e+".name",hint:"configTab.general.timeSources."+e+".hint"}))),rainModes:Object.values(a).map((e=>({id:e,name:"configTab.rainModes."+e+".name",hint:"configTab.rainModes."+e+".hint"}))),weatherModes:Object.values(t).map((e=>({id:e,name:"configTab.weatherModes."+e+".name",hint:"configTab.weatherModes."+e+".hint"}))),weatherTemplates:WeatherModel.getTemplates(),regionTemplates:RegionMeteo.getTemplates()},c=await renderTemplate("modules/"+e.ID+"/templates/weatherTab.hbs",s);$(".sheet-tabs",i).append($("<a>").addClass("item").attr("data-tab","weather").html('<i class="fas fa-solid fa-cloud-bolt-sun"></i> '+FoundryAbstractionLayer.i18n("configTab.title"))),$("<div>").addClass("tab").attr("data-tab","weather").insertAfter($('div[data-tab="ambience"]',i)).append(c),WeatherTab.activateListeners(r,i,s.data.weatherMode)}static activateListeners(e,t,r){Logger.debug("WeatherTab.activateListeners",{app:e,jQ:t,select:r}),t.find('div[id="sceneWeather.mode.'+r+'"]').addClass("active"),t.find('div[id="not_sceneWeather.mode.'+r+'"]').removeClass("active"),t.find('button[data-key="flags.scene-weather.regionConfig"]').on("click",(function(){Logger.debug("Clicked Config Region for Scene",{sceneId:e.document._id});new RegionConfigDialog(e.document._id).render(!0)})),t.find('button[data-key="flags.scene-weather.weatherConfig"]').on("click",(function(){Logger.debug("Clicked Config Weather for Scene",{sceneId:e.document._id});new WeatherConfigDialog(e.document._id).render(!0)})),t.find("#randomSeed").on("click",(async function(){const e=t.find('input[name="flags.scene-weather.seed"]');let r=[];Object.values(Utils$1.flattenObject(game.i18n.translations)).forEach((e=>{e.split(/(\s+)/).forEach((e=>{e&&e.length>5&&e.length<13&&/^\w+$/.test(e)&&r.push(e)}))}));let i=[];for(var a=0;a<3;a++)i.push(r[Math.floor(Math.random()*r.length)]);e.val(i.join(" "))})),t.find('select[name="flags.scene-weather.weatherMode"]').on("change",(function(){let r=$(this).find(":selected").val();t.find("div.sceneWeather-collapsibleModeOption").each((function(){$(this).attr("id").startsWith("not_sceneWeather.mode.")?$(this).attr("id")=="not_sceneWeather.mode."+r?$(this).removeClass("active"):$(this).addClass("active"):$(this).attr("id")=="sceneWeather.mode."+r?$(this).addClass("active"):$(this).removeClass("active")})),e.setPosition({height:"auto"}),Logger.debug("onChange",{app:e,jQ:t})}))}}Hooks.once("init",(()=>{e.VERSION=game.modules.get("scene-weather")?.version??"development",registerSettingsPreInit(),Logger.debug("->Hook:init"),registerHbHelpers(),loadHandlebars(),window.SceneWeather=getSceneWeatherAPIv1(),Logger.info("API registered at global symbol SceneWeather"),Hooks.callAll(r.REG_FX_GENERATORS),Hooks.callAll(r.REG_FX_FILTERS),Hooks.callAll(r.REG_TEMPLATE_REGION),Hooks.callAll(r.REG_TEMPLATE_WEATHER),Hooks.callAll(r.REG_WEATHER_PERCIEVERS),Logger.debug("Initialized"),Hooks.callAll(r.MODULE_INITIALIZED)})),Hooks.on(e.LCCNAME+"Initialized",(async()=>{Logger.trace("->Hook:"+e.LCCNAME+"Initialized"),Hooks.on("updateScene",(async(r,i,a,n)=>{void 0!==i.flags&&void 0!==i.flags[e.ID]&&(Logger.trace("updateScene-> ",{deltaData:i,options:a}),SceneWeather.updateWeatherConfig({forSceneId:i._id,force:!0}),i.flags[e.ID].weatherMode==t.DISABLED&&(Logger.trace("updateScene-> Disabled SceneWeather...",{scene:r,sceneId:n}),Hooks.callAll(e.LCCNAME+"WeatherDisabled",{scene:r,sceneId:n})),void 0===i.flags[e.ID].weatherMode&&void 0===i.flags[e.ID].timeProvider||(ui.controls.initialize(),MacroConfigDialog.refresh(),WeatherUi.toggleAppVis("initial")))})),Hooks.on("renderSceneConfig",(async(e,t,r)=>{Logger.trace("renderSceneConfig",{app:e,jQ:t,data:r}),WeatherTab.addControlsTab(e,t)}))})),Hooks.once("setup",(()=>{Logger.trace("->Hook:setup"),WeatherLayer.registerLayers(),WeatherLayer.registerLayerButtons()})),Hooks.on("canvasReady",(async e=>{Logger.trace("->Hook:canvasReady(...)",{canvas:e}),WeatherUi.toggleAppVis("initial"),FoundryAbstractionLayer.getSetting("uiPinned",!1)&&WeatherUi.pinApp(),MeteoUi.toggleAppVis("initial"),MacroConfigDialog.refresh(),SceneWeather.updateWeather({force:!0})})),Hooks.on("ready",(async()=>{Hooks.callAll(e.LCCNAME+"Ready"),Logger.info("Ready")})),Hooks.on(e.LCCNAME+"Ready",(async()=>{Logger.trace("->Hook:"+e.LCCNAME+"Ready")})),Hooks.on("updateWorldTime",((e,r,i,a)=>{Logger.trace("->Hook:updateWorldTime",{worldTime:e,delta:r,options:i,userId:a}),[t.REGION_TEMPLATE,t.REGION_GENERATE].includes(FoundryAbstractionLayer.getSceneFlag("weatherMode",t.DISABLED))&&SceneWeather.updateWeather()}));class ColorFilter extends PIXI.filters.AdjustmentFilter{constructor({options:e={},soft:t=!1}={}){super();const{color:r,...i}=Utils$1.mergeObject({tint:"#ffffff",saturation:1,gamma:1,brightness:1,contrast:1},e),{r:a,g:n,b:o}=foundry.utils.Color.from(e.tint),s={...i,red:a,green:n,blue:o},c=Object.keys(s);for(const e of c)this.optionContext[e]=s[e];this.enabled=!0}get optionContext(){return this}async destroy(){return this.enabled=!1,!0}async step(){}}class Generators{static _scaleValues(e,t){e.list=e.list.map((e=>({...e,value:e.value*t})))}static _scaleRange(e,t){e.min=e.min*t,e.max=e.max*t}static _getTransposedPosition(e,t,r,i,a,n){const o=e+r/2,s=t+i/2,c=n*Math.PI/180;return{x:o+a*Math.cos(c)-r/2,y:s+a*Math.sin(c)-i/2}}static applyGeneratorToEmitterConfig(e,t){const r=2/3,i=canvas.dimensions.sceneRect;t.maxParticles=canvas.dimensions.width/canvas.dimensions.size*(canvas.dimensions.height/canvas.dimensions.size)*e.density;const a=t.behaviors.find((({type:e})=>"moveSpeedStatic"===e))?.config;if(void 0!==a){const n=(a.min+a.max)/2,o=Math.sqrt(i.width*i.width+i.height*i.height),s=o/n,c=s/r/2,d=s/r;t.lifetime={min:c,max:d},t.frequency=(c+d)/2/t.maxParticles;const l=Generators._getTransposedPosition(i.x,i.y,i.width,i.height,o/4,(e.direction+180)%360);t.behaviors.push({type:"spawnShape",config:{type:"rect",data:{x:l.x,y:l.y,w:i.width,h:i.height}}})}else{t.frequency=(t.lifetime.min+t.lifetime.max)/2/t.maxParticles;const e=canvas.dimensions.sceneRect;t.behaviors.push({type:"spawnShape",config:{type:"rect",data:{x:e.x-e.width/4,y:e.y-e.height/4,w:1.5*e.width,h:1.5*e.height}}})}void 0!==e.alpha&&t.behaviors.filter((e=>"alpha"===e.type)).forEach((({config:t})=>Generators._scaleValues(t.alpha,e.alpha)));let n=e.scale*(canvas.dimensions.size/100);t.behaviors.filter((e=>"scale"===e.type)).forEach((({config:e})=>Generators._scaleValues(e.scale,n))),t.behaviors.filter((e=>"scaleStatic"===e.type)).forEach((({config:e})=>Generators._scaleRange(e,n))),n=e.speed*(canvas.dimensions.size/100),t.behaviors.filter((e=>["moveSpeed","movePath"].includes(e.type))).forEach((({config:e})=>Generators._scaleValues(e.speed,n))),t.behaviors.filter((e=>"moveSpeedStatic"===e.type)).forEach((({config:e})=>Generators._scaleRange(e,n))),Generators._scaleRange(t.lifetime,1/n),t.frequency/=n;const o=e.direction;void 0!==o&&(t.behaviors.filter((e=>"rotation"===e.type)).forEach((({config:e})=>{const t=e.maxStart-e.minStart;e.minStart=o-t/2,e.maxStart=o+t/2})),t.behaviors.filter((e=>"rotationStatic"===e.type)).forEach((({config:e})=>{const t=e.max-e.min;e.min=o-t/2,e.max=o+t/2})));const s=e.lifetime;Generators._scaleRange(t.lifetime,s),t.frequency*=s,null!=e.tint&&(t.behaviors=t.behaviors.filter((({type:e})=>"color"!==e&&"colorStatic"!==e)).concat({type:"colorStatic",config:{color:e.tint}}))}}Hooks.on(r.REG_FX_GENERATORS,(async()=>{SceneWeather.registerWeatherFxGenerator("cumulus",(function(t){if(FoundryAbstractionLayer.getSetting("cloudsAlpha",100)<2)return;if(![d.cumulus,d.cumulunimbus].includes(t.clouds.type))return null;let r={alpha:FoundryAbstractionLayer.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:Utils$1.map(t.wind.speed,10,70,.2,3),scale:Utils$1.map(t.clouds.coverage,.3,1,.8,1),lifetime:1,density:Utils$1.map(t.clouds.coverage,.2,1,.005,.02),tint:null};4==t.clouds.type&&(r.tint="#B0B0B0",r.density=.001);const i=Utils$1.deepClone({weight:.8,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.58,max:3.3}},{type:"rotationStatic",config:{min:85,max:95}},{type:"textureRandom",config:{textures:Array.fromRange(5).map((t=>"modules/"+e.ID+`/assets/cu${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(r,i),i}))}));class FlashFilter extends PIXI.filters.AdjustmentFilter{options;constructor({options:e={},soft:t=!1}={}){super(),this.options=Utils$1.mergeObject({frequency:0,duration:0,brightness:1,nextTime:FoundryAbstractionLayer.getLastTickTime()/10},e);const r=Object.keys(this.options);for(const e of r)this.optionContext[e]=this.options[e];this.enabled=!0}get optionContext(){return this}async discard(){return this.enabled=!1,!0}async step(){if(FoundryAbstractionLayer.getLastTickTime()/10>this.options.nextTime){this.options.nextTime=FoundryAbstractionLayer.getLastTickTime()/10+40+this.options.frequency*Math.random();const animate=t=>{const r=[{parent:this,attribute:"brightness",to:t}];return CanvasAnimation.animate(r,{name:e.ID+`.${this.constructor.name}.${randomID()}`,context:this,duration:100+this.options.duration*Math.random(),easing:function(e){const t=2.5949095;return e<.5?Math.pow(2*e,2)*(7.189819*e-t)/2:(Math.pow(2*e-2,2)*((t+1)*(2*e-2)+t)+2)/2}})};await animate(this.options.brightness),await animate(1)}}}Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("fog",(function(t){if(FoundryAbstractionLayer.getSetting("cloudsAlpha",100)<2)return;if(t.clouds.type!=d.fog)return null;const r={alpha:FoundryAbstractionLayer.getSetting("cloudsAlpha",100)/100,direction:0,speed:1,scale:1,lifetime:1,density:Utils$1.map(t.clouds.coverage,.2,1,.01,1),tint:null},i=Utils$1.deepClone({weight:.9,lifetime:{min:10,max:25},behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.1,time:.1},{value:.3,time:.5},{value:.1,time:.9},{value:0,time:1}]}}},{type:"moveSpeed",config:{speed:{list:[{time:0,value:15},{time:1,value:10}]},minMult:.2}},{type:"scale",config:{scale:{list:[{value:2.5,time:0},{value:2,time:1}]},minMult:.5}},{type:"rotation",config:{accel:0,minSpeed:.15,maxSpeed:.35,minStart:0,maxStart:365}},{type:"textureRandom",config:{textures:Array.fromRange(3).map((t=>"modules/"+e.ID+`/assets/fg${t+1}.webp`))}},{type:"colorStatic",config:{color:"dddddd"}}]});return Generators.applyGeneratorToEmitterConfig(r,i),i}))})),Hooks.on(r.REG_FX_FILTERS,(async()=>{SceneWeather.registerWeatherFxFilter("freeze",(function(e){let t={};return e.temp.air<0&&(t.freeze={type:ColorFilter,tint:Utils$1.mapColorHex(e.temp.air+10,0,10,"#E1F3FE","#FFFFFF"),saturation:1-Utils$1.map(e.temp.air+10,10,0,0,.4),gamma:1,brightness:1,contrast:1}),t}))})),Hooks.on(r.REG_FX_FILTERS,(async()=>{SceneWeather.registerWeatherFxFilter("heatglare",(function(e){let t={};return e.sun.amount>.8&&e.temp.air>30&&(t.heatglare={type:ColorFilter,tint:Utils$1.mapColorHex(e.sun.amount,.8,1,"#ffffff","#FFF3D1"),saturation:1,gamma:1,brightness:Utils$1.map(e.sun.amount,.8,1,1,1.4),contrast:Utils$1.map(e.temp.air,30,50,1,1.5)}),t}))})),Hooks.on(r.REG_FX_FILTERS,(async()=>{SceneWeather.registerWeatherFxFilter("lightning",(function(e){let t={};return e.clouds.type>d.cumulus&&[c.rain,c.downpour,c.hail].includes(e.precipitation.type)&&e.precipitation.amount>.3&&(t.lightning={type:FlashFilter,frequency:2e3-Utils$1.map(e.precipitation.amount,.3,1,0,1600),duration:100,brightness:1.2},t.cloudcolor={type:ColorFilter,tint:"#D1CBD7",saturation:1,gamma:1,brightness:1,contrast:1}),t}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("nimbus",(function(t){if(FoundryAbstractionLayer.getSetting("cloudsAlpha",100)<2)return;if(t.clouds.type!=d.cumulunimbus)return null;let r={alpha:FoundryAbstractionLayer.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:Utils$1.map(t.wind.speed,10,70,.2,3),scale:Utils$1.map(t.clouds.coverage,.3,1,.8,1),lifetime:1,density:Utils$1.map(t.clouds.coverage,.2,1,.005,.02),tint:null};const i=Utils$1.deepClone({weight:.9,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.08,max:2.8}},{type:"rotationStatic",config:{min:90,max:90}},{type:"textureRandom",config:{textures:Array.fromRange(4).map((t=>"modules/"+e.ID+`/assets/tcu${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(r,i),i}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("rain",(function(e){if(FoundryAbstractionLayer.getSetting("precipitationAlpha",100)<2)return;if(![c.drizzle,c.rain,c.downpour,c.hail].includes(e.precipitation.type))return null;let t=90;switch(e.precipitation.mode??"winddir"){case"winddir":default:t=(Math.round(e.wind.direction)+90)%360;break;case"topdown":t=90;break;case"slanted":t=75;break;case"windinfluence":t=90+Math.sin(e.wind.direction*Math.PI/180)*Utils$1.map(e.wind.speed,10,70,3,45)}const r={alpha:FoundryAbstractionLayer.getSetting("precipitationAlpha",100)/100,direction:t,speed:Utils$1.map(e.precipitation.amount,.4,.95,.6,2),scale:1,lifetime:Utils$1.map(e.precipitation.amount,.4,.95,1,.5),density:Utils$1.map(e.precipitation.amount,.4,.95,.01,4),tint:null},i=Utils$1.deepClone({weight:.2,lifetime:{min:.5,max:.5},pos:{x:0,y:0},behaviors:[{type:"alpha",config:{alpha:{list:[{time:0,value:.7},{time:1,value:.1}]}}},{type:"moveSpeedStatic",config:{min:2800,max:3500}},{type:"scaleStatic",config:{min:.8,max:1}},{type:"rotationStatic",config:{min:89,max:91}},{type:"textureSingle",config:{texture:"ui/particles/rain.png"}}]});return Generators.applyGeneratorToEmitterConfig(r,i),i}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("snow",(function(e){if(FoundryAbstractionLayer.getSetting("precipitationAlpha",100)<2)return;if(![c.snow,c.blizzard].includes(e.precipitation.type))return null;let t=90;switch(e.precipitation.mode??"winddir"){case"winddir":default:t=(Math.round(e.wind.direction)+90)%360;break;case"topdown":t=90;break;case"slanted":t=75;break;case"windinfluence":t=90+Math.sin(e.wind.direction*Math.PI/180)*Utils$1.map(e.wind.speed,10,70,10,90)}const r={alpha:FoundryAbstractionLayer.getSetting("precipitationAlpha",100)/100,direction:t,speed:Utils$1.map(e.wind.speed,10,70,.3,5),scale:1,lifetime:Utils$1.map(e.precipitation.amount,.4,.95,1,.7),density:Utils$1.map(e.precipitation.amount,.4,.95,.01,3),tint:null},i=Utils$1.deepClone({weight:.2,lifetime:{min:4,max:4},behaviors:[{type:"alpha",config:{alpha:{list:[{time:0,value:.9},{time:1,value:.5}]}}},{type:"moveSpeed",config:{speed:{list:[{time:0,value:190},{time:1,value:210}]},minMult:.6}},{type:"scale",config:{scale:{list:[{time:0,value:.2},{time:1,value:.4}]},minMult:.5}},{type:"rotation",config:{accel:0,minSpeed:0,maxSpeed:200,minStart:50,maxStart:75}},{type:"textureSingle",config:{texture:"ui/particles/snow.png"}}]});return Generators.applyGeneratorToEmitterConfig(r,i),i}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("stratus",(function(t){if(FoundryAbstractionLayer.getSetting("cloudsAlpha",100)<2)return;if(![d.stratus,d.cumulus,d.cumulunimbus].includes(t.clouds.type))return null;let r={alpha:FoundryAbstractionLayer.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:Utils$1.map(t.wind.speed,10,100,.2,2.5),scale:Utils$1.map(t.clouds.coverage,.3,1,1,2),lifetime:1,density:Utils$1.map(t.clouds.coverage,.2,1,.001,.01),tint:null};3==t.clouds.type&&(r.tint="#A0A0A0",r.density=.007,r.scale=1),4==t.clouds.type&&(r.tint="#808080",r.density=.01,r.scale=1.2);const i=Utils$1.deepClone({weight:.7,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.58,max:3.3}},{type:"rotationStatic",config:{min:80,max:100}},{type:"textureRandom",config:{textures:Array.fromRange(6).map((t=>"modules/"+e.ID+`/assets/st${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(r,i),i}))})),Hooks.on(r.REG_WEATHER_PERCIEVERS,(async()=>{SceneWeather.registerPerciever(e.ID,"icon",new IconPerciever)}));const y="meteo.icon.";class IconPerciever extends WeatherPerception{isAllowed(e){return Permissions.hasPermission(e,"perciever.scene-weather.icon")}async getTextFromModel(e){return Handlebars.compile(FoundryAbstractionLayer.i18n("meteo.icon.templates.text"))(await this.getWeatherInfoFromModel(e))}async getUiHtmlFromModel(t){return await renderTemplate("modules/"+e.ID+"/templates/iconPerceptionUi.hbs",await this.getWeatherInfoFromModel(t))}async getChatHtmlFromModel(t){return await renderTemplate("modules/"+e.ID+"/templates/iconPerceptionChat.hbs",Utils$1.mergeObject({description:await this.getTextFromModel(t)},await this.getWeatherInfoFromModel(t)))}async getWeatherInfoFromModel(e){let t=Utils$1.mergeObject(Utils$1.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT),{temperature:{air:e.temp.air.toFixed(1),ground:e.temp.ground.toFixed(1),percieved:e.temp.percieved.toFixed(1)},humidity:{percent:NaN},wind:{speed:NaN,gusts:NaN,direction:NaN},clouds:{height:NaN,amount:30*Math.round(30*e.clouds.coverage),type:e.clouds.type},sun:{amount:e.sun.amount>.3?1:0},precipitation:{amount:e.precipitation.amount>.4?1:0,type:e.precipitation.type},composite:{sun:e.sun.amount>.3?"sun":"none",clouds:"none",preci:"none",wind:"none"},descriptive:{sun:e.sun.amount>.3?y+"sun.sun":y+"sun.none",clouds:y+"clouds.none",preci:y+"precipitation.none",wind:y+"wind.none"}});switch(e.clouds.type){case d.fog:return t.composite.clouds="fog",t.descriptive.clouds=y+"clouds.fog",t;case d.stratus:case d.cumulus:t.composite.clouds="cloud",t.descriptive.clouds=y+"clouds.cloud";break;case d.cumulunimbus:t.composite.clouds="thunder",t.descriptive.clouds=y+"clouds.thunder"}switch(e.precipitation.type){case c.drizzle:t.composite.preci="lightRain",t.descriptive.preci=y+"precipitation.lightRain";break;case c.rain:case c.downpour:t.composite.preci="rain",t.descriptive.preci=y+"precipitation.rain";break;case c.hail:case c.snow:t.composite.preci="lightSnow",t.descriptive.preci=y+"precipitation.lightSnow";break;case c.blizzard:t.composite.preci="snow",t.descriptive.preci=y+"precipitation.snow"}return e.wind.speed>50&&(t.composite.wind="wind",t.descriptive.preci=y+"wind.wind"),Logger.debug("IconPerciever.getWeatherInfoFromModel()",{modelData:e,weatherInfo:t}),t}getPercieverInfo(){const e=Utils$1.mergeObject(Utils$1.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT),{id:"icon",name:FoundryAbstractionLayer.i18n(y+"name")});return Logger.debug("IconPerciever.getPercieverInfo()",{info:e}),e}}Hooks.on(r.REG_WEATHER_PERCIEVERS,(async()=>{SceneWeather.registerPerciever(e.ID,"perceptive",new PerceptivePerciever)}));const f="meteo.perceptive.";class PerceptivePerciever extends WeatherPerception{isAllowed(e){return Permissions.hasPermission(e,"perciever.scene-weather.perceptive")}async getTextFromModel(e){const t=await this.getWeatherInfoFromModel(e);return Handlebars.compile(FoundryAbstractionLayer.i18n("meteo.perceptive.templates.text"))(t)}async getUiHtmlFromModel(e){const t=await this.getWeatherInfoFromModel(e);return Handlebars.compile(FoundryAbstractionLayer.i18n("meteo.perceptive.templates.ui"))(t)}async getChatHtmlFromModel(e){return this.getUiHtmlFromModel(e)}async getWeatherInfoFromModel(e){const t=Utils$1.mergeObject(Utils$1.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT),PerceptivePerciever._calculateWeatherInfoFromModelData(e));return Logger.debug("PerceptivePerciever.getWeatherInfoFromModel()",{weatherModel:e,weatherInfo:t}),t}getPercieverInfo(){const e=Utils$1.mergeObject(Utils$1.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT),{id:"perceptive",name:FoundryAbstractionLayer.i18n(f+"name")});return Logger.debug("PerceptivePerciever.getPercieverInfo()",{info:e}),e}static _fahrenheitToCelsius(e){return(e-32)/1.8}static _celsiusToFahrenheit(e){return 1.8*e+32}static _getPrecipitationTypeId(e){const[t]=Object.entries(c).find((([,t])=>t===e));return t?f+t:f+"none"}static _getPrecipitationAmountId(e){const[t]=Object.entries(u).find((([,t])=>e<t));return f+t}static _getSunAmountId(e){const[t]=Object.entries(g).find((([,t])=>e<t));return f+t}static _getCloudTypeId(e){const[t]=Object.entries(d).find((([,t])=>t===e));return t?f+t:f+"cumulunimbus"}static _getCloudAmountId(e){return f+["skc","few","few","sct","sct","bkn","bkn","bkn","ovc"][Math.round(8*e)]}static _getCloudHightId(e){const[t]=Object.entries(h).find((([,t])=>e<t));return f+t}static _getWindDirId(e){let t=Math.floor(e/22.5+.5);return f+["n","nne","ne","ene","e","ese","se","sse","s","ssw","sw","wsw","w","wnw","nw","nnw"][t%16]}static _getWindSpeedId(e){let t=e.gusts>5?"Gusting":"";const[r]=Object.entries(m).find((([,t])=>e.speed<t));return f+r+t}static _getHumidityId(e){const[t]=Object.entries(l).find((([,t])=>e<t));return f+t}static _getPercievedTempId(e){const[t]=Object.entries(p).find((([,t])=>e<t));return f+t}static _calculateWeatherInfoFromModelData(e){return Logger.debug("PerceptivePerciever._calculateWeatherInfoFromModelData()",{modelData:e}),{name:e.name,temperature:{air:Math.round(e.temp.air),ground:Math.round(e.temp.ground),percieved:Math.round(e.temp.percieved),percievedId:PerceptivePerciever._getPercievedTempId(e.temp.percieved)},humidity:{percent:Math.round(e.humidity),percentId:PerceptivePerciever._getHumidityId(e.humidity)},wind:{speed:Math.round(e.wind.speed),gusts:Math.round(e.wind.gusts),speedId:PerceptivePerciever._getWindSpeedId(e.wind),direction:Math.round(e.wind.direction),directionId:PerceptivePerciever._getWindDirId(e.wind.direction)},clouds:{height:Math.round(e.clouds.bottom),heightId:PerceptivePerciever._getCloudHightId(e.clouds.bottom),amount:Math.round(100*e.clouds.coverage),amountId:PerceptivePerciever._getCloudAmountId(e.clouds.coverage),type:PerceptivePerciever._getCloudTypeId(e.clouds.type)},sun:{amount:Math.round(100*e.sun.amount),amountId:PerceptivePerciever._getSunAmountId(e.sun.amount)},precipitation:{amount:Math.round(100*e.precipitation.amount),amountId:PerceptivePerciever._getPrecipitationAmountId(e.precipitation.amount),type:PerceptivePerciever._getPrecipitationTypeId(e.precipitation.type)}}}}Hooks.on(r.REG_WEATHER_PERCIEVERS,(async()=>{SceneWeather.registerPerciever(e.ID,"precise",new PrecisePerciever)}));class PrecisePerciever extends WeatherPerception{isAllowed(e){return Permissions.hasPermission(e,"perciever.scene-weather.precise")}async getTextFromModel(e){return JSON.stringify(this.getWeatherInfoFromModel(e))}async getUiHtmlFromModel(t){return await renderTemplate("modules/"+e.ID+"/templates/precisePerceptionUi.hbs",await this.getWeatherInfoFromModel(t))}async getChatHtmlFromModel(e){return this.getUiHtmlFromModel(e)}async getWeatherInfoFromModel(e){const t=Utils$1.mergeObject(Utils$1.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT),{temperature:{air:e.temp.air.toFixed(1),ground:e.temp.ground.toFixed(1),percieved:e.temp.percieved.toFixed(1)},humidity:{percent:e.humidity.toFixed(1)},wind:{speed:Math.round(e.wind.speed),gusts:Math.round(e.wind.gusts),direction:Math.round(e.wind.direction)},clouds:{height:Math.round(e.clouds.bottom),amount:Math.round(100*e.clouds.coverage),type:e.clouds.type,typeId:PrecisePerciever._getCloudTypeId(e.clouds.type)},sun:{amount:Math.round(100*e.sun.amount)},precipitation:{amount:Math.round(100*e.precipitation.amount),type:e.precipitation.type,typeId:PrecisePerciever._getPrecipitationTypeId(e.precipitation.type)}});return Logger.debug("PerceptivePerciever.getWeatherInfoFromModel()",{modelData:e,weatherInfo:t}),t}getPercieverInfo(){const e=Utils$1.mergeObject(Utils$1.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT),{id:"precise",name:FoundryAbstractionLayer.i18n("meteo.precise.name")});return Logger.debug("PrecisePerciever.getPercieverInfo()",{info:e}),e}static _getCloudTypeId(e){const[t]=Object.entries(d).find((([,t])=>t===e));return t?`meteo.precise.cloudTypes.${t}`:"meteo.precise.cloudTypes.cumulunimbus"}static _getPrecipitationTypeId(e){const[t]=Object.entries(c).find((([,t])=>t===e));return t?`meteo.precise.precipitationTypes.${t}`:"meteo.precise.precipitationTypes.none"}}Hooks.on(r.REG_WEATHER_PERCIEVERS,(async()=>{Logger.debug("registered weatherPerciever for vague"),SceneWeather.registerPerciever(e.ID,"vague",new VaguePerciever)}));class VaguePerciever extends WeatherPerception{isAllowed(e){return Permissions.hasPermission(e,"perciever.scene-weather.vague")}async getTextFromModel(e){return Handlebars.compile(FoundryAbstractionLayer.i18n("meteo.vague.templates.text"))(await this.getWeatherInfoFromModel(e))}async getUiHtmlFromModel(e){return Handlebars.compile(FoundryAbstractionLayer.i18n("meteo.vague.templates.ui"))(await this.getWeatherInfoFromModel(e))}async getChatHtmlFromModel(e){return this.getUiHtmlFromModel(e)}async getWeatherInfoFromModel(e){const t=5*Math.round(e.temp.percieved/5);let r=Utils$1.mergeObject(Utils$1.deepClone(WeatherPerception.DEFAULT_WEATHER_STRUCT),{temperature:{air:t,ground:NaN,percieved:t},humidity:{percent:NaN},wind:{speed:NaN,gusts:NaN,direction:NaN},clouds:{height:NaN,amount:10*Math.round(10*e.clouds.coverage),type:e.clouds.type>d.stratus?d.cumulus:d.none},sun:{amount:e.sun.amount>.3?1:0},precipitation:{amount:e.precipitation.amount>.4?1:0,type:e.precipitation.type>c.rain?c.rain:c.none},modifiers:{skyType:"none",tempType:"none",windType:"none"}});if(e.clouds.type==d.none)r.modifiers.skyType="meteo.vague.clear";else if(e.clouds.type==d.fog)r.modifiers.skyType="meteo.vague.fog";else if(e.clouds.type>=d.stratus)switch(e.precipitation.type){case c.blizzard:case c.snow:r.modifiers.skyType="meteo.vague.snow";break;case c.hail:case c.downpour:r.modifiers.skyType="meteo.vague.downpour",e.clouds.type>=d.cumulunimbus&&(r.modifiers.skyType="meteo.vague.thunderstorm");break;case c.rain:r.modifiers.skyType="meteo.vague.rain",e.clouds.type>=d.cumulunimbus&&(r.modifiers.skyType="meteo.vague.thunderstorm");break;case c.drizzle:r.modifiers.skyType="meteo.vague.drizzle";break;case c.none:default:r.modifiers.skyType="meteo.vague.cloudy"}return t>30?(r.modifiers.tempType="meteo.vague.warm",e.wind.speed>40&&(r.modifiers.windType="meteo.vague.windy")):t<5&&(r.modifiers.tempType="meteo.vague.cold",e.wind.speed>40&&(r.modifiers.windType="meteo.vague.windy")),Logger.debug("VaguePerciever.getWeatherInfoFromModel()",{modelData:e,weatherInfo:r}),r}getPercieverInfo(){const e=Utils$1.mergeObject(Utils$1.deepClone(WeatherPerception.DEFAULT_INFO_STRUCT),{id:"vague",name:FoundryAbstractionLayer.i18n("meteo.vague.name")});return Logger.debug("VaguePerciever.getPercieverInfo()",{info:e}),e}}Hooks.once("init",(()=>{Logger.trace("->Hook:InternalTimeProvider.init()"),TimeProvider._instances[n.INTERNAL]=new InternalTimeProvider(!0),TimeProvider._instances[n.EXTERNAL]=new InternalTimeProvider(!1)}));class InternalTimeProvider extends TimeProvider{constructor(e=!1){super(),Logger.trace("InternalTimeProvider:ctor(...)",{hasAuthority:e}),this._hasAuthoriy=e,this._monthOffset=[0,31,59,90,120,151,181,212,243,273,304,334],this._monthDays=[31,28,31,30,31,30,31,31,30,31,30,31],this._monthDaysLeapYear=[31,29,31,30,31,30,31,31,30,31,30,31]}hasTimeAuthority(){return this._hasAuthoriy}async advanceGameTime(e=0){if(Logger.debug("InternalTimeProvider.advanceGameTime(...)",{deltaSeconds:e}),this._hasAuthoriy){if(0==e)return;FoundryAbstractionLayer.isGm()&&(FoundryAbstractionLayer.getWorldTime(),await FoundryAbstractionLayer.advanceWorldTime(e))}}getHoursInDay(){return 24}getDaysInYear(){return 365}getNumberOfMonths(){return 12}getMonthOffset(e){return this._monthOffset[Utils$1.clamp(e,0,11)]}getSummerSolsticeDay(){return 172}getWinterSolsticeDay(){return 355}getDaylightCyclePct(){return Utils$1.map(this.getHourOfDay(),0,24,0,1)}getSeasonCyclePct(){const e=this.getDayOfYear();let t=e<172,r=t?1-(172-e)/183:(e-172)/183;return r>1&&(r-=1,t=!t),t?r:1+r}async setDaylightCyclePct(e=.5){if(this._hasAuthoriy){const t=this._gameTimeToDate(FoundryAbstractionLayer.getWorldTime()),r=Math.trunc(3600*t.hour+60*t.minute+t.second),i=Math.trunc(Utils$1.map(e,0,1,0,86399));return Logger.trace("InternalTimeProvider.setDaylightCyclePct()",{daylightCyclePct:e,secondsAfterMidnightCurrent:r,secondsAfterMidnightDesired:i}),this.advanceGameTime(i-r)}}async setSeasonCyclePct(e=.5){if(this._hasAuthoriy){const t=this._gameTimeToDate(FoundryAbstractionLayer.getWorldTime()),r=this._monthOffset[t.month]+t.day,i=r>355?r-355:r+10,a=Math.trunc(Utils$1.map(e,0,1,0,364));return Logger.trace("InternalTimeProvider.setSeasonCyclePct()",{seasonCyclePct:e,daysAfterWinterSolsticeCurrent:i,daysAfterWinterSolsticeDesired:a}),this.advanceGameTime(86400*(a-i))}}getDayOfYear(e=0,t=0){const r=this._gameTimeToDate(FoundryAbstractionLayer.getWorldTime()+3600*t+86400*e),i=this._monthOffset[r.month]+r.day;return Logger.trace("InternalTimeProvider.getDayOfYear()",{"month#":r.month,"day#":r.day,doY:i}),i}getHourOfDay(e=0,t=0){const r=FoundryAbstractionLayer.getWorldTime()+3600*t+86400*e,i=Math.abs(Math.trunc(r%86400/3600));return Logger.trace("InternalTimeProvider.getHourOfDay()",{currentWorldTime:r,dayTime:i}),r<0?24-i:i}hourOfDayNoonPct(e=0,t=0){const r=TimeProvider.getHourOfDay(e,t)%24;return(Math.sin((r/12-.5)*Math.PI)+1)/2}dayOfYearSummerPct(e=0,t=0){let r,i=TimeProvider.getDayOfYear(e,t);return i>355&&(i-=365),r=172==i?1:i<172?(i+10)/182:1-(i-172)/183,r}static _decodeFractalString(e=0,t=""){if(""==t)return"";let r="";return t.split(",").find((t=>{const[i,a]=t.split(":");if(i.includes("-")){const[t,n]=i.split("-");if(e<=Number(n)&&e>=Number(t))return r=a,!0}else if(Number(i)==e)return r=a,!0;return!1})),r}static _isLeapYear(e){return e%4==0&&(e%100!=0||e%100==0&&e%400==0)}_gameTimeToDate(e=0){const t=e<0;e=Math.abs(e);let r=Math.floor(e/86400);e-=86400*r;let i=t?86400-e:e;const a=Math.floor(i/3600)%24;i-=3600*a;const n=Math.floor(i/60)%60;i-=60*n;const o=i%60;let s,c,d,l,g=!1;for(t?(d=1969,c=11,s=30,l=-1,0===o&&0===n&&0===a&&r--):(d=1970,c=0,s=0,l=1);r>0;){const e=g?366:365;let t=g?this._monthDaysLeapYear[c]:this._monthDays[c];if(r>=e)d+=l,g=InternalTimeProvider._isLeapYear(d),l<0&&(t=g?this._monthDaysLeapYear[c]:this._monthDays[c]),r-=e;else if(r>=t){c+=l;let e=g?this._monthDaysLeapYear[c]:this._monthDays[c],i=0;for(;0===e&&i<=12;)c+=l,e=g?this._monthDaysLeapYear[c]:this._monthDays[c],i++;l<0&&(s=g?this._monthDaysLeapYear[c]-1:this._monthDays[c]-1),r-=t}else s+=l,r--}return l>0&&d<0&&s++,{year:d,month:c,day:s,hour:a,minute:n,second:o}}getTimeStringData(){const e=FoundryAbstractionLayer.getWorldTime(),t=this._gameTimeToDate(e);return{month:{number:Number(t.month),name:FoundryAbstractionLayer.i18n("time.months."+t.month),prefix:InternalTimeProvider._decodeFractalString(t.month+1,FoundryAbstractionLayer.i18n("time.monthPrefixTypes")),suffix:InternalTimeProvider._decodeFractalString(t.month+1,FoundryAbstractionLayer.i18n("time.monthSuffixTypes"))},day:{number:Number(t.day),name:String(t.day+1),prefix:InternalTimeProvider._decodeFractalString(t.day+1,FoundryAbstractionLayer.i18n("time.dayPrefixTypes")),suffix:InternalTimeProvider._decodeFractalString(t.day+1,FoundryAbstractionLayer.i18n("time.daySuffixTypes"))},hour:{number:Number(t.hour),name:t.hour<10?"0"+t.hour:String(t.hour)},minute:{number:Number(t.minute),name:t.minute<10?"0"+t.minute:String(t.minute)}}}}Hooks.once("init",(()=>{Logger.trace("->Hook:init -> ScTimeProvider.init()"),FoundryAbstractionLayer.isModuleEnabled("foundryvtt-simple-calendar")&&(TimeProvider._instances[n.SIMPLE_CALENDAR]=new ScTimeProvider)})),Hooks.once("simple-calendar-init",(()=>{Logger.trace("->Hook:simple-calendar-init -> ScTimeProvider.initConfig()"),FoundryAbstractionLayer.isModuleEnabled("foundryvtt-simple-calendar")&&ScTimeProvider.initConfig()}));class ScTimeProvider extends TimeProvider{static _config={daysInYear:365,summerSolstice:172,winterSolstice:355,monthOffset:[0,31,59,90,120,151,181,212,243,273,304,334],hoursInDay:24,minutesInHour:60,secondsInMinute:60,secondsInHour:3600,secondsInDay:86400};constructor(){super(),Logger.trace("ScTimeProvider:ctor()")}hasTimeAuthority(){return!1}async advanceGameTime(e=0){Logger.warn("ScTimeProvider.advanceGameTime(...) -> no time authority, ignoring")}getHoursInDay(){return ScTimeProvider._config.hoursInDay}getDaysInYear(){return ScTimeProvider._config.daysInYear}getNumberOfMonths(){return ScTimeProvider._config.monthOffset.length}getMonthOffset(e){return ScTimeProvider._config.monthOffset[Utils.clamp(e,0,ScTimeProvider._config.monthOffset.length-1)]}getSummerSolsticeDay(){return ScTimeProvider._config.summerSolstice}getWinterSolsticeDay(){return ScTimeProvider._config.winterSolstice}getDaylightCyclePct(){return Utils.map(this.getHourOfDay(),0,ScTimeProvider._config.hoursInDay,0,1)}getSeasonCyclePct(){const e=ScTimeProvider._config.summerSolstice,t=ScTimeProvider._config.winterSolstice,r=this.getDayOfYear(),i=t>e?t-e:e-t;let a=r<e,n=a?1-(e-r)/i:(r-e)/i;return n>1&&(n-=1,a=!a),a?n:1+n}async setDaylightCyclePct(e){Logger.trace("ScTimeProvider.setDaylightCyclePct(...) no time authority!",{daylightCyclePct:e})}async setSeasonCyclePct(e){Logger.trace("ScTimeProvider.setSeasonCyclePct(...) no time authority!",{seasonCyclePct:e})}getDayOfYear(e=0,t=0){const r=SimpleCalendar.api.timestampToDate(FoundryAbstractionLayer.getWorldTime()+t*ScTimeProvider._config.secondsInHour+e*ScTimeProvider._config.secondsInDay);return Logger.trace("ScTimeProvider.getDayOfYear()",{scInstance:r,_config:ScTimeProvider._config}),ScTimeProvider._config.monthOffset[r.month]+r.day}getHourOfDay(e=0,t=0){const r=FoundryAbstractionLayer.getWorldTime()+t*ScTimeProvider._config.secondsInHour+e*ScTimeProvider._config.secondsInDay,i=Math.abs(Math.trunc(r%ScTimeProvider._config.secondsInDay/ScTimeProvider._config.secondsInHour));return Logger.trace("ScTimeProvider.getHourOfDay()",{currentWorldTime:r,dayTime:i}),r<0?ScTimeProvider._config.hoursInDay-i:i}hourOfDayNoonPct(e=0,t=0){const r=this.getHourOfDay(e,t)%ScTimeProvider._config.hoursInDay;return(Math.sin((r/(ScTimeProvider._config.hoursInDay/2)-.5)*Math.PI)+1)/2}dayOfYearSummerPct(e=0,t=0){let r=this.getDayOfYear(e,t);const i=ScTimeProvider._config.summerSolstice,a=ScTimeProvider._config.winterSolstice;let n,o=a,s=a;return a<i?s=a+ScTimeProvider._config.daysInYear:o=a-ScTimeProvider._config.daysInYear,r>s&&(r-=ScTimeProvider._config.daysInYear),n=r==i?1:r<i?(r-o)/(i-o):1-(r-i)/(s-i),n}getTimeStringData(){const e=SimpleCalendar.api.timestampToDate(FoundryAbstractionLayer.getWorldTime());return{month:{number:e.display.month,name:e.display.monthName,prefix:"",suffix:""},day:{number:e.display.day,name:e.display.day,prefix:"",suffix:e.display.daySuffix},hour:{number:e.hour,name:e.hour<10?"0"+e.hour:e.hour},minute:{number:e.minute,name:e.minute<10?"0"+e.minute:e.minute}}}static _getHoursInDay(){return ScTimeProvider._config.hoursInDay}static initConfig(){const e=SimpleCalendar.api.getAllMonths()||[],t=SimpleCalendar.api.getTimeConfiguration(),r=e.map((e=>e.numberOfDays)),i=ScTimeProvider._getStartingDays(r),a=i[i.length-1]+r[r.length-1];ScTimeProvider._config={providerId:n.SIMPLE_CALENDAR,daysInYear:a,summerSolstice:172,winterSolstice:355,monthOffset:i,hoursInDay:t.hoursInDay,minutesInHour:t.minutesInHour,secondsInMinute:t.secondsInMinute,secondsInHour:t.secondsInMinute*t.minutesInHour,secondsInDay:t.secondsInMinute*t.minutesInHour*t.hoursInDay},ScTimeProvider._calculateSolstices(),Logger.debug("ScTimeProvider._initConfig(simple-calendar)",{_config:ScTimeProvider._config})}static _getStartingDays(e){const t=e.reduce(((e,t)=>(e.push(e[e.length-1]+t),e)),[0]).slice(0,-1);return Logger.trace("ScTimeProvider._getStartingDays(...)",{daysInMonth:e,dayOffsets:t}),t}static _calculateSolstices(){let e=[];ScTimeProvider._config.summerSolstice=-1,ScTimeProvider._config.winterSolstice=-1,SimpleCalendar.api.getAllSeasons().forEach((t=>{const r=ScTimeProvider._config.monthOffset[t.startingMonth]+t.startingDay;e.push({icon:t.icon,dayLengthSeconds:t.sunsetTime-t.sunriseTime,startingDoY:r}),"summer"==t.icon&&(ScTimeProvider._config.summerSolstice=r),"winter"==t.icon&&(ScTimeProvider._config.winterSolstice=r)}));const t=e.sort(((e,t)=>e.startingDoY-t.startingDoY));if(-1==ScTimeProvider._config.summerSolstice){const e=t.reduce(((e,t)=>e.dayLengthSeconds>=t.dayLengthSeconds?e:t),null);ScTimeProvider._config.summerSolstice=e.startingDoY}if(-1==ScTimeProvider._config.winterSolstice){const e=t.reduce(((e,t)=>e.dayLengthSeconds<=t.dayLengthSeconds?e:t),null);ScTimeProvider._config.winterSolstice=e.startingDoY}Logger.trace("ScTimeProvider._calculateSolstices()",{summerSolstice:ScTimeProvider._config.summerSolstice,winterSolstice:ScTimeProvider._config.winterSolstice})}}Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"alpine",{name:"templates.region.alpine.name",description:"templates.region.alpine.description",elevation:1e3,vegetation:0,waterAmount:0,summer:{temperature:{day:15,night:5,var:7.5},humidity:{day:50,night:60,var:5},wind:{avg:30,var:10},sun:{hours:14}},winter:{temperature:{day:0,night:-15,var:7.5},humidity:{day:70,night:60,var:5},wind:{avg:40,var:20},sun:{hours:10}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"chaparral",{name:"templates.region.chaparral.name",description:"templates.region.chaparral.description",elevation:1e3,vegetation:5,waterAmount:5,summer:{temperature:{day:32.5,night:17.5,var:5},humidity:{day:60,night:40,var:5},wind:{avg:25,var:10},sun:{hours:13}},winter:{temperature:{day:17.5,night:2.5,var:5},humidity:{day:60,night:50,var:5},wind:{avg:30,var:10},sun:{hours:11}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"coastal",{name:"templates.region.coastal.name",description:"templates.region.coastal.description",elevation:100,vegetation:20,waterAmount:70,summer:{temperature:{day:25,night:15,var:10},humidity:{day:80,night:75,var:15},wind:{avg:10,var:25},sun:{hours:14}},winter:{temperature:{day:15,night:5,var:10},humidity:{day:75,night:70,var:5},wind:{avg:20,var:25},sun:{hours:10}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"desert",{name:"templates.region.desert.name",description:"templates.region.desert.description",elevation:500,vegetation:0,waterAmount:0,summer:{temperature:{day:45,night:25,var:10},humidity:{day:10,night:20,var:5},wind:{avg:30,var:10},sun:{hours:13}},winter:{temperature:{day:25,night:5,var:10},humidity:{day:30,night:50,var:20},wind:{avg:25,var:10},sun:{hours:11}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"grassland",{name:"templates.region.grassland.name",description:"templates.region.grassland.description",elevation:200,vegetation:40,waterAmount:20,summer:{temperature:{day:30,night:15,var:10},humidity:{day:70,night:80,var:5},wind:{avg:10,var:10},sun:{hours:14}},winter:{temperature:{day:10,night:-5,var:10},humidity:{day:70,night:60,var:10},wind:{avg:10,var:10},sun:{hours:10}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"littoral",{name:"templates.region.littoral.name",description:"templates.region.littoral.description",elevation:0,vegetation:1,waterAmount:50,summer:{temperature:{day:25,night:15,var:10},humidity:{day:60,night:60,var:5},wind:{avg:10,var:5},sun:{hours:16}},winter:{temperature:{day:15,night:5,var:10},humidity:{day:60,night:60,var:10},wind:{avg:15,var:10},sun:{hours:8}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"mangrove",{name:"templates.region.mangrove.name",description:"templates.region.mangrove.description",elevation:0,vegetation:80,waterAmount:60,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:60,night:70,var:10},wind:{avg:10,var:5},sun:{hours:16}},winter:{temperature:{day:27.5,night:17.5,var:5},humidity:{day:60,night:60,var:10},wind:{avg:15,var:10},sun:{hours:8}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"mediterranean",{name:"templates.region.mediterranean.name",description:"templates.region.mediterranean.description",elevation:500,vegetation:50,waterAmount:20,summer:{temperature:{day:30,night:17.5,var:7.5},humidity:{day:60,night:65,var:5},wind:{avg:15,var:10},sun:{hours:15}},winter:{temperature:{day:17.5,night:7.5,var:5},humidity:{day:70,night:60,var:10},wind:{avg:20,var:10},sun:{hours:9}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"polar",{name:"templates.region.polar.name",description:"templates.region.polar.description",elevation:0,vegetation:0,waterAmount:30,summer:{temperature:{day:2.5,night:-2.5,var:5},humidity:{day:80,night:65,var:10},wind:{avg:35,var:20},sun:{hours:23}},winter:{temperature:{day:-15,night:-25,var:10},humidity:{day:90,night:70,var:5},wind:{avg:40,var:20},sun:{hours:1}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"rainforest",{name:"templates.region.rainforest.name",description:"templates.region.rainforest.description",elevation:200,vegetation:100,waterAmount:80,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:90,night:80,var:10},wind:{avg:5,var:5},sun:{hours:12}},winter:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:80,night:70,var:10},wind:{avg:5,var:5},sun:{hours:12}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"savanna",{name:"templates.region.savanna.name",description:"templates.region.savanna.description",elevation:300,vegetation:30,waterAmount:5,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:60,night:70,var:10},wind:{avg:20,var:10},sun:{hours:13}},winter:{temperature:{day:27.5,night:17.5,var:5},humidity:{day:40,night:30,var:10},wind:{avg:20,var:10},sun:{hours:11}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"steppe",{name:"templates.region.steppe.name",description:"templates.region.steppe.description",elevation:500,vegetation:5,waterAmount:0,summer:{temperature:{day:27.5,night:15,var:5},humidity:{day:30,night:25,var:5},wind:{avg:25,var:10},sun:{hours:14}},winter:{temperature:{day:5,night:-5,var:10},humidity:{day:40,night:30,var:10},wind:{avg:20,var:10},sun:{hours:10}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"taiga",{name:"templates.region.taiga.name",description:"templates.region.taiga.description",elevation:400,vegetation:70,waterAmount:10,summer:{temperature:{day:20,night:10,var:10},humidity:{day:70,night:80,var:5},wind:{avg:15,var:10},sun:{hours:17}},winter:{temperature:{day:-5,night:-25,var:10},humidity:{day:80,night:60,var:5},wind:{avg:25,var:10},sun:{hours:8}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"temperate",{name:"templates.region.temperate.name",description:"templates.region.temperate.description",elevation:400,vegetation:50,waterAmount:10,summer:{temperature:{day:25,night:15,var:10},humidity:{day:70,night:60,var:10},wind:{avg:15,var:10},sun:{hours:15}},winter:{temperature:{day:10,night:0,var:10},humidity:{day:60,night:65,var:5},wind:{avg:20,var:10},sun:{hours:9}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"tundra",{name:"templates.region.tundra.name",description:"templates.region.tundra.description",elevation:300,vegetation:1,waterAmount:5,summer:{temperature:{day:7.5,night:2.5,var:5},humidity:{day:60,night:50,var:10},wind:{avg:20,var:10},sun:{hours:18}},winter:{temperature:{day:-15,night:-25,var:10},humidity:{day:70,night:50,var:5},wind:{avg:25,var:10},sun:{hours:6}}})})),Hooks.on(r.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"wetland",{name:"templates.region.wetland.name",description:"templates.region.wetland.description",elevation:100,vegetation:60,waterAmount:80,summer:{temperature:{day:25,night:15,var:10},humidity:{day:70,night:80,var:10},wind:{avg:15,var:10},sun:{hours:16}},winter:{temperature:{day:5,night:-5,var:10},humidity:{day:60,night:60,var:5},wind:{avg:20,var:5},sun:{hours:8}}})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"blizzard",{name:"templates.weather.blizzard.name",temp:{ground:0,air:-3,percieved:-4},wind:{speed:70,gusts:85,direction:115},clouds:{coverage:.7,bottom:1e3,top:3e3,type:d.cumulunimbus},precipitation:{amount:1,type:c.blizzard},sun:{amount:.1},humidity:10})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"densefog",{name:"templates.weather.densefog.name",temp:{ground:18,air:15,percieved:16},wind:{speed:15,gusts:16,direction:127},clouds:{coverage:.9,bottom:0,top:3e3,type:d.fog},precipitation:{amount:0,type:c.none},sun:{amount:.6},humidity:80})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"frigid",{name:"templates.weather.frigid.name",temp:{ground:-5,air:-20,percieved:-25},wind:{speed:30,gusts:35,direction:70},clouds:{coverage:0,bottom:0,top:0,type:d.none},precipitation:{amount:0,type:c.none},sun:{amount:.6},humidity:10})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"fog",{name:"templates.weather.fog.name",temp:{ground:18,air:15,percieved:16},wind:{speed:15,gusts:16,direction:127},clouds:{coverage:.3,bottom:0,top:3e3,type:d.fog},precipitation:{amount:0,type:c.none},sun:{amount:.6},humidity:80})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"heatwave",{name:"templates.weather.heatwave.name",temp:{ground:30,air:37,percieved:42},wind:{speed:0,gusts:0,direction:0},clouds:{coverage:0,bottom:0,top:0,type:d.none},precipitation:{amount:0,type:c.none},sun:{amount:1},humidity:80})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"heavyrain",{name:"templates.weather.heavyrain.name",temp:{ground:15,air:15,percieved:12},wind:{speed:25,gusts:29,direction:85},clouds:{coverage:.8,bottom:500,top:1e3,type:d.cumulus},precipitation:{amount:.9,type:c.rain},sun:{amount:.3},humidity:70})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"moderaterain",{name:"templates.weather.moderaterain.name",temp:{ground:16,air:18,percieved:16},wind:{speed:14,gusts:18,direction:75},clouds:{coverage:.6,bottom:1e3,top:3e3,type:d.cumulus},precipitation:{amount:.4,type:c.rain},sun:{amount:.6},humidity:65})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"partlycloudy",{name:"templates.weather.partlycloudy.name",temp:{ground:22,air:25,percieved:25},wind:{speed:20,gusts:25,direction:15},clouds:{coverage:.3,bottom:3e3,top:4e3,type:d.stratus},precipitation:{amount:0,type:c.none},sun:{amount:.6},humidity:60})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"rain",{name:"templates.weather.rain.name",temp:{ground:15,air:17,percieved:15},wind:{speed:22,gusts:27,direction:80},clouds:{coverage:.8,bottom:500,top:1e3,type:d.cumulus},precipitation:{amount:.6,type:c.rain},sun:{amount:.3},humidity:65})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"slightsnow",{name:"templates.weather.slightsnow.name",id:"",name:"Snowing slightly",temp:{ground:1,air:2,percieved:0},wind:{speed:14,gusts:18,direction:133},clouds:{coverage:.3,bottom:1e3,top:3e3,type:d.cumulus},precipitation:{amount:.4,type:c.snow},sun:{amount:.5},humidity:45})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"snow",{name:"templates.weather.snow.name",id:"",name:"Snowing",temp:{ground:0,air:-3,percieved:-4},wind:{speed:24,gusts:28,direction:223},clouds:{coverage:.3,bottom:1e3,top:3e3,type:d.cumulus},precipitation:{amount:.6,type:c.snow},sun:{amount:.3},humidity:45})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"snow",{name:"templates.weather.snow.name",id:"",name:"Snowing",temp:{ground:0,air:-3,percieved:-4},wind:{speed:24,gusts:28,direction:223},clouds:{coverage:.3,bottom:1e3,top:3e3,type:d.cumulus},precipitation:{amount:.6,type:c.snow},sun:{amount:.3},humidity:45})})),Hooks.on(r.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"thunderstorm",{name:"templates.weather.thunderstorm.name",temp:{ground:14,air:13,percieved:11},wind:{speed:50,gusts:75,direction:90},clouds:{coverage:.95,bottom:500,top:8e3,type:d.cumulunimbus},precipitation:{amount:.95,type:c.downpour},sun:{amount:.1},humidity:70})}));export{h as CLOUD_HEIGHT,d as CLOUD_TYPE,ColorFilter,r as EVENTS,FlashFilter,FoundryAbstractionLayer,t as GENERATOR_MODES,Generators,l as HUMIDITY_LEVELS,InternalTimeProvider,Logger,o as METEO,e as MODULE,MacroConfigDialog,MacroGenerator,MeteoUi,Noise,u as PRECI_AMOUNT,c as PRECI_TYPE,PermissionConfigDialog,Permissions,a as RAIN_MODES,RegionConfigDialog,RegionMeteo,s as SEASONS,g as SUN_INTENSITY,ScTimeProvider,SceneWeather$1 as SceneWeather,SceneWeatherState,p as TEMP_TYPES,n as TIME_PROVIDERS,TimeProvider,Utils$1 as Utils,i as WIND_MODES,m as WIND_SPEED,WeatherConfigDialog,WeatherEffect,WeatherEffectsLayer,WeatherLayer,WeatherModel,WeatherPerception,WeatherTab,WeatherUi,getSceneWeatherAPIv1,loadHandlebars,registerHbHelpers,registerSettingsPostInit,registerSettingsPreInit};
