const e={ID:"scene-weather",NAME:"Scene Weather",LCCNAME:"sceneWeather"},t={isaMSLtempC:16,isaSeaLevelPa:101325,adiabaticHyDryCoeff:-.0065,g:9.80665,mAir:.0289644,R:8.3144598,Tzero:237.7};class Logger{static info(t,a=!1){console.log(e.NAME+` Info | ${t}`),a&&ui.notifications.info(e.NAME+` | ${t}`)}static error(t,a=!1){console.error(e.NAME+` Error | ${t}`),a&&ui.notifications.error(e.NAME+` | ${t}`)}static debug(t,a){if(game.gmTokenTools?game.gmTokenTools.isDebug:Utils.getSetting("debug",!1)){if(!a)return void console.log(e.NAME+` Debug | ${t}`);const i=Utils.deepClone(a);console.log(e.NAME+` Debug | ${t}`,i)}}}class Utils{static clamp(e,t,a){return Math.min(Math.max(e,t),a)}static roundToDecimals(e,t){return Number(Math.round(e+"e"+t)+"e-"+t)}static omit(e,t){const{[t]:a,...i}=e;return i}static isBitSet(e,t){return 0!=(e&1<<t)}static deepClone(e,t){return deepClone(e,t)}static getActor(e,t){let a=null;return t&&(a=canvas.tokens.placeables.find((e=>e.id===t))),a?a.actor:game.actors.get(e)}static getItem(e,t){return e.items.get(t)}static getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getControlledToken(){return game.canvas.tokens.controlled[0]}static getUserByTokenId(e){let t,a=e.actor.ownership;return game.users.forEach((e=>{null!==e.character&&e.active&&a[e._id]>0&&(t=e)})),t}static getSetting(t,a=null){let i=a??null;try{i=game.settings.get(e.ID,t)}catch{console.log(e.NAME+` Debug | GameConfig '${t}' not found`)}return i}static async setSetting(t,a){game.settings.settings.get(`${e.ID}.${t}`)?(await game.settings.set(e.ID,t,a),Logger.debug(`GameConfig '${t}' set to '${a}'`)):Logger.debug(`GameConfig '${t}' not found`)}static getUserFlag(t){return game.user.getFlag(e.ID,t)}static async setUserFlag(t,a){await game.user.setFlag(e.ID,t,a)}static async unsetUserFlag(t){await game.user.unsetFlag(e.ID,t)}static i18n(e,t=null){let a=game.i18n.localize(e);return a==e?(null==t&&(a=e),a):a}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}}class SceneWeather{constructor(e){this.weatherModel=e,Logger.debug("SceneWeather:constrctor",{weatherModel:e})}update(){this.weatherModel.update()}async applyFxToScene(){}static _getPercievedTempId(e){return e<-7?"freezing":e<-3?"cold":e<3?"chill":e<7?"fresh":e<18?"moderate":e<22?"mild":e<30?"warm":e<37?"hot":"searing"}static _getWindDirId(e){return["n","nne","ne","ene","e","ese","se","sse","s","ssw","sw","wsw","w","wnw","nw","nnw"][Math.floor(e/22.5+.5)%16]}static _getCloudHightId(e){return e<600?"low":e<1e3?"mid":e<4e3?"high":"veryhigh"}static _getCloudAmountId(e){return["skc","few","few","sct","sct","bkn","bkn","bkn","ovc"][Math.round(8*e)]}static _getCloudTypeId(e){switch(e){case 0:return"none";case 1:return"fog";case 2:return"stratus";case 3:return"cumulus";default:return"cumulunimbus"}}static _getHumidityId(e){return e<20?"dry":e<40?"comfortable":e<50?"pleasant":e<65?"sticky":e<75?"humid":"oppressive"}static _getSunAmountId(e){return e<.3?"gloomy":e<.6?"shaded":e<.9?"normal":"bright"}static _getPrecipitationAmountId(e){return e<.2?"nothing":e<.4?"slight":e<.7?"average":e<.95?"heavy":"extreme"}static _getPrecipitationTypeId(e){switch(e){case 0:default:return"none";case 1:return"drizzle";case 2:return"rain";case 3:return"downpour";case 4:return"hail";case 5:return"snow";case 6:return"blizzard"}}static _getWindSpeedId(e){let t="";return e.gusts>5&&(t="Gusting"),e.speed<1?"calm"+t:e.speed<5?"light"+t:e.speed<11?"lightBreeze"+t:e.speed<28?"gentleBreeze"+t:e.speed<38?"freshBreeze"+t:e.speed<49?"strongBreeze"+t:e.speed<61?"moderateGale"+t:e.speed<74?"freshGale"+t:e.speed<88?"strongGale"+t:e.speed<102?"wholeGale"+t:e.speed<118?"storm"+t:"hurricane"+t}getWeatherInfo(e=0,t=0){let a=this.weatherModel.getWeatherData(e,t);return{name:a.name,temperature:{air:Math.round(a.temp.air),ground:Math.round(a.temp.ground),percieved:Math.round(a.temp.percieved),percievedId:SceneWeather._getPercievedTempId(a.temp.percieved)},humidity:{percent:Math.round(a.humidity),percentId:SceneWeather._getHumidityId(a.humidity)},wind:{speed:Math.round(a.wind.speed),gusts:Math.round(a.wind.gusts),speedId:SceneWeather._getWindSpeedId(a.wind),direction:a.wind.direction,directionId:SceneWeather._getWindDirId(a.wind.direction)},clouds:{height:Math.round(a.clouds.bottom),heightId:SceneWeather._getCloudHightId(a.clouds.bottom),amount:Math.round(100*a.clouds.coverage),amountId:SceneWeather._getCloudAmountId(a.clouds.coverage),type:SceneWeather._getCloudTypeId(a.clouds.type)},sun:{amount:Math.round(100*a.sun.amount),amountId:SceneWeather._getSunAmountId(a.sun.amount)},precipitation:{amount:Math.round(100*a.precipitation.amount),amountId:SceneWeather._getPrecipitationAmountId(a.precipitation.amount),type:SceneWeather._getPrecipitationTypeId(a.precipitation.type)}}}fahrenheitToCelsius(e){return(e-32)/1.8}celsiusToFahrenheit(e){return 1.8*e+32}}class WeatherModel{static templates={default:{name:"Default",temp:{ground:14,air:18,percieved:18},wind:{speed:0,gusts:0,direction:0},clouds:{coverage:0,bottom:0,top:0,type:0},precipitation:{amount:0,type:0},sun:{amount:.5},humidity:0}};constructor({regionMeteo:e,templateId:t="default"}){Logger.debug("WeatherModel:constrctor",{regionMeteo:e,templateId:t}),this._cache={},void 0===e?(this.regionMeteo=void 0,this.weatherData=WeatherModel.templates[t]):(this.regionMeteo=e,this.update())}static getTemplates(){let e=[];for(let t in WeatherModel.templates)e.push({id:t,name:WeatherModel.templates[t].name});return e}static fromTemplate(e){return new WeatherModel({templateId:e})}static fromRegion(e){return new WeatherModel({regionMeteo:e})}update(){void 0!==this.regionMeteo?(this._cache={},this.regionMeteo.update()):Logger.debug("WeatherModel.update -> nothing to do.")}getWeatherData(e=0,t=0){if(void 0===this.regionMeteo)return this.weatherData;{let a=this.regionMeteo.getRegionBase(e,t);if(void 0!==this._cache[a.timeHash])return this.weatherData=this._cache[a.timeHash],this._cache[a.timeHash];this.weatherData={name:a.name,temp:{ground:this._groundTemp(3,3,e,t),air:a.baseTemp,percieved:0},wind:{speed:a.wind,gusts:a.gusts,direction:0},clouds:{coverage:0,bottom:Utils.clamp(Math.abs(WeatherModel._liftedCondensationLevel(a.baseTemp,a.baseHumidity)),0,2e4),top:0,type:0},precipitation:{amount:0,type:0},sun:{amount:a.sunAmount},humidity:a.baseHumidity};let i=WeatherModel._calcAdiCloudBottomCoeff(this.weatherData,a),n=WeatherModel._calcGeopotential(a);return this.weatherData.clouds.top=i<0?this.weatherData.clouds.bottom+12.6*n:this.weatherData.clouds.bottom+.27*n,this.weatherData.clouds.coverage=Utils.clamp((this.weatherData.clouds.top-this.weatherData.clouds.bottom)/100,0,1),this.weatherData.clouds.bottom<a.elevation?this.weatherData.clouds.type=1:(i<0&&(this.weatherData.clouds.top-this.weatherData.clouds.bottom>1e3&&(this.weatherData.clouds.type=3),this.weatherData.clouds.top-this.weatherData.clouds.bottom>3e3&&(this.weatherData.clouds.type=4)),this.weatherData.clouds.type<3&&this.weatherData.clouds.coverage>.7&&(this.weatherData.clouds.type=2)),this.weatherData.precipitation.amount=Utils.clamp(1.4*this.weatherData.clouds.coverage-.4,0,1)*this.regionMeteo._getNoisedValue(a.timeHash+321,8,.8,.2),this.weatherData.wind.gusts=this.weatherData.wind.gusts*(2.5*this.weatherData.precipitation.amount+.5),this.weatherData.wind.speed=this.weatherData.wind.speed+2.2*this.weatherData.precipitation.amount*this.weatherData.wind.speed,this.weatherData.sun.amount=this.weatherData.sun.amount*(1-this.weatherData.clouds.coverage),this.weatherData.temp.air=this.weatherData.temp.air-.03*this.weatherData.wind.speed+this.weatherData.sun.amount*Math.max(2,.6*this.weatherData.temp.ground),this.weatherData.temp.percieved=WeatherModel._apparentTemperature(this.weatherData.temp.air,this.weatherData.wind.speed,this.weatherData.humidity,WeatherModel._heightToPressure(a.elevation)),this.weatherData.clouds.top=3*Math.max(0,this.weatherData.clouds.top-a.elevation),this.weatherData.clouds.bottom=3*Math.max(0,this.weatherData.clouds.bottom-a.elevation),this.weatherData.precipitation.type=WeatherModel._calcPrecipitationType(this.weatherData),this.weatherData.wind.direction=this.regionMeteo._getNoisedValue(a.timeHash+1277,512,180,180),this.weatherData.wind.direction=this.weatherData.wind.direction+this.regionMeteo._getNoisedValue(a.timeHash+1277,8,16,16)*this.weatherData.wind.gusts,this.weatherData.wind.direction<0&&(this.weatherData.wind.direction+=360),this.weatherData.wind.direction>=360&&(this.weatherData.wind.direction-=360),this._cache[a.timeHash]=this.weatherData,this.weatherData}}static _calcGeopotential(e){return e.vegetation*(1.3*e.sunAmount+.7*e.wind)+(.3*e.sunAmount+e.waterAmount*(1.3*e.wind))}static _heightToPressure(e){if(e<11e3)return t.isaSeaLevelPa*Math.pow(t.isaMSLtempC/(t.isaMSLtempC+t.adiabaticHyDryCoeff*e),t.g*t.mAir/(t.R*t.adiabaticHyDryCoeff))/100;if(e<=2e4){var a=t.isaSeaLevelPa*Math.pow(t.isaMSLtempC/(e+11e3*t.adiabaticHyDryCoeff),t.g*t.mAir/(t.R*t.adiabaticHyDryCoeff)),i=t.isaMSLtempC+11e3*t.adiabaticHyDryCoeff;return a*Math.exp(-t.g*t.mAir*(e-11e3)/(t.R*i))/100}return 0}static _apparentTemperature(e,t,a,i){return e<10?WeatherModel._windChill(e,t):WeatherModel._heatIndex(e,a,i)}static _windChill(e,t){if(e>=10)return Tc;let a;return a=t>=4.8&&t<=177?13.12+.6215*e+(.3965*e-11.37)*Math.pow(t,.16):t<4.8?e+.2*(.1345*e-1.59)*t:e,a}static _heatIndex(e,a,i){if(i<16)return e;if(e<27||t.R<.4||WeatherModel._dewPoint(e,a)<12)return e;return 1.61139411*e-8.784695+2.338549*a+-.14611605*e*a+-.012308094*e*e+-.016424828*a*a+.002211732*e*e*a+72546e-8*e*a*a+1e-6*-3.582*e*e*a*a}static _dewPoint(e,a){if(e<0||e>60)return e;if((a/=100)<.01||a>1)return e;let i=17.27*e/(t.Tzero+e)+Math.log(a),n=t.Tzero*i/(17.27-i);return n<0||n>50?e:n}static _calcAdiCloudBottomCoeff(e,a){return t.isaMSLtempC+(e.clouds.bottom-a.elevation)*t.adiabaticHyDryCoeff-(a.baseTemp+(e.clouds.bottom-a.elevation)*t.adiabaticHyDryCoeff)}static _calcPrecipitationType(e){return e.precipitation.amount<.1?0:e.clouds.type>3&&e.precipitation.amount>.7?e.temp.air<4?6:e.wind.speed>.2?4:3:e.clouds.type>=3?e.temp.air<4?e.wind.speed>.2?6:5:2:2==e.clouds.type||e.precipitation.amount>.7?e.temp.air<4?5:1:0}_groundTemp(e,t,a=0,i=0){let n=0,r=0;for(let s=0;s<=e;s++){let e=1/Math.log2(s+2);n+=this.regionMeteo.getRegionBase(a,i-s*t).baseTemp*e,r+=e}return n/r}static _liftedCondensationLevel(e,t){return 125*(e-(e-(100-t)/5))}}class TimeProvider{static config={daysInYear:365,summerSolstice:172,winterSolstice:355,monthOffset:[0,31,59,90,120,151,181,212,243,273,304,334],hoursInDay:24};static initConfig(){}static _getTimeProvider(){return"simple-calendar"}static getTimeHash(e,t){return e*TimeProvider.config.hoursInDay+t}static getDayOfYearFromTimeHash(e){return Math.trunc(e/TimeProvider.config.hoursInDay)+1}static getMonthOfYearFromTimeHash(e){let t=TimeProvider.getDayOfYearFromTimeHash(e);for(let e=0;e<TimeProvider.config.monthOffset.length;e++)if(t<TimeProvider.config.monthOffset[e])return e;return TimeProvider.config.monthOffset.length}static getDayOfMonthFromTimeHash(e){let t=TimeProvider.getMonthOfYearFromTimeHash(e);return TimeProvider.getDayOfYearFromTimeHash(e)-TimeProvider.config.monthOffset[t-1]}static getTimeOfDayFromTimeHash(e){return e%TimeProvider.config.hoursInDay}static getDayOfYear(){if(game.modules.get("foundryvtt-simple-calendar")?.active&&"simple-calendar"===TimeProvider._getTimeProvider()){let e=SimpleCalendar.api.timestampToDate(game.time.worldTime);return TimeProvider.config.monthOffset[e.month]+e.day}{let t=canvas.scene.getFlag(e.ID,"timeSeason");return void 0===t&&(t=Util.getSetting("timeSeason",150)),sceneManualData}}static getHourOfDay(){const e=game.time.worldTime+0,t=Math.abs(Math.trunc(e%86400/3600));return e<0?24-t:t}}class Noise{static F2=.5*(Math.sqrt(3)-1);static G2=(3-Math.sqrt(3))/6;static F3=1/3;static G3=1/6;static F4=(Math.sqrt(5)-1)/4;static G4=(5-Math.sqrt(5))/20;static fastFloor(e){return 0|Math.floor(e)}static getMulberry32(e){return function(){var t=e+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296}}static grad2=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);static createNoise2D(e){const t=Noise._buildPermutationTable(e),a=new Float64Array(t).map((e=>Noise.grad2[e%12*2])),i=new Float64Array(t).map((e=>Noise.grad2[e%12*2+1]));return function(e,n){let r=0,s=0,o=0;const d=(e+n)*Noise.F2,h=Noise.fastFloor(e+d),g=Noise.fastFloor(n+d),u=(h+g)*Noise.G2,l=e-(h-u),c=n-(g-u);let m,p;l>c?(m=1,p=0):(m=0,p=1);const v=l-m+Noise.G2,w=c-p+Noise.G2,f=l-1+2*Noise.G2,y=c-1+2*Noise.G2,D=255&h,b=255&g;let W=.5-l*l-c*c;if(W>=0){const e=D+t[b];W*=W,r=W*W*(a[e]*l+i[e]*c)}let T=.5-v*v-w*w;if(T>=0){const e=D+m+t[b+p];T*=T,s=T*T*(a[e]*v+i[e]*w)}let _=.5-f*f-y*y;if(_>=0){const e=D+1+t[b+1];_*=_,o=_*_*(a[e]*f+i[e]*y)}return 70*(r+s+o)}}static _buildPermutationTable(e){const t=Noise.getMulberry32(e),a=512,i=new Uint8Array(a);for(let e=0;e<256;e++)i[e]=e;for(let e=0;e<255;e++){const a=e+~~(t()*(256-e)),n=i[e];i[e]=i[a],i[a]=n}for(let e=256;e<a;e++)i[e]=i[e-256];return i}}class RegionMeteo{static templates={rainforest:{name:"Tropical Rainforest",description:"Dense forest with high amounts of rainfall and high biodiversity.",elevation:200,vegetation:100,waterAmount:80,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:90,night:80,var:10},wind:{avg:5,var:5},sun:{hours:12}},winter:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:80,night:70,var:10},wind:{avg:5,var:5},sun:{hours:12}}},desert:{name:"Desert",description:"Dry region with little rainfall and high temperatures during the day, but can be cold at night.",elevation:500,vegetation:0,waterAmount:0,summer:{temperature:{day:45,night:25,var:10},humidity:{day:10,night:20,var:5},wind:{avg:30,var:10},sun:{hours:13}},winter:{temperature:{day:25,night:5,var:10},humidity:{day:30,night:50,var:20},wind:{avg:25,var:10},sun:{hours:11}}},grassland:{name:"Grassland",description:"Open, flat region dominated by grasses and characterized by seasonal rainfall.",elevation:200,vegetation:40,waterAmount:20,summer:{temperature:{day:30,night:15,var:10},humidity:{day:70,night:80,var:5},wind:{avg:10,var:10},sun:{hours:14}},winter:{temperature:{day:10,night:-5,var:10},humidity:{day:70,night:60,var:10},wind:{avg:10,var:10},sun:{hours:10}}},temperate:{name:"Temperate Forest",description:"TODO",elevation:400,vegetation:50,waterAmount:10,summer:{temperature:{day:25,night:15,var:10},humidity:{day:70,night:60,var:10},wind:{avg:15,var:10},sun:{hours:15}},winter:{temperature:{day:10,night:0,var:10},humidity:{day:60,night:65,var:5},wind:{avg:20,var:10},sun:{hours:9}}},taiga:{name:"Boreal Forest",description:"Dense forest of coniferous trees found in colder regions with long winters.",elevation:400,vegetation:70,waterAmount:10,summer:{temperature:{day:20,night:10,var:10},humidity:{day:70,night:80,var:5},wind:{avg:15,var:10},sun:{hours:17}},winter:{temperature:{day:-5,night:-25,var:10},humidity:{day:80,night:60,var:5},wind:{avg:25,var:10},sun:{hours:8}}},tundra:{name:"Tundra",description:"Cold, treeless region with permafrost and a short growing season.",elevation:300,vegetation:1,waterAmount:5,summer:{temperature:{day:7.5,night:2.5,var:5},humidity:{day:60,night:50,var:10},wind:{avg:20,var:10},sun:{hours:18}},winter:{temperature:{day:-15,night:-25,var:10},humidity:{day:70,night:50,var:5},wind:{avg:25,var:10},sun:{hours:6}}},mediterranean:{name:"Mediterranean",description:"Region with mild, rainy winters and hot, dry summers, known for its characteristic vegetation.",elevation:500,vegetation:50,waterAmount:20,summer:{temperature:{day:30,night:17.5,var:7.5},humidity:{day:60,night:65,var:5},wind:{avg:15,var:10},sun:{hours:15}},winter:{temperature:{day:17.5,night:7.5,var:5},humidity:{day:70,night:60,var:10},wind:{avg:20,var:10},sun:{hours:9}}},savanna:{name:"Savanna",description:"Open grassland region with scattered trees and distinct dry and wet seasons.",elevation:300,vegetation:30,waterAmount:5,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:60,night:70,var:10},wind:{avg:20,var:10},sun:{hours:13}},winter:{temperature:{day:27.5,night:17.5,var:5},humidity:{day:40,night:30,var:10},wind:{avg:20,var:10},sun:{hours:11}}},alpine:{name:"Alpine",description:"High-altitude region with low temperatures and often covered in snow and ice.",elevation:1e3,vegetation:0,waterAmount:0,summer:{temperature:{day:15,night:5,var:7.5},humidity:{day:50,night:60,var:5},wind:{avg:30,var:10},sun:{hours:14}},winter:{temperature:{day:0,night:-15,var:7.5},humidity:{day:70,night:60,var:5},wind:{avg:40,var:20},sun:{hours:10}}},coastal:{name:"Coastal",description:"Region influenced by the ocean with relatively mild temperatures and often high humidity.",elevation:100,vegetation:20,waterAmount:70,summer:{temperature:{day:25,night:15,var:10},humidity:{day:80,night:75,var:15},wind:{avg:10,var:25},sun:{hours:14}},winter:{temperature:{day:15,night:5,var:10},humidity:{day:75,night:70,var:5},wind:{avg:20,var:25},sun:{hours:10}}},polar:{name:"Polar",description:"Regions with permanently frozen water and very low temperatures.",elevation:0,vegetation:0,waterAmount:30,summer:{temperature:{day:2.5,night:-2.5,var:5},humidity:{day:80,night:65,var:10},wind:{avg:35,var:20},sun:{hours:23}},winter:{temperature:{day:-15,night:-25,var:10},humidity:{day:90,night:70,var:5},wind:{avg:40,var:20},sun:{hours:1}}},chaparral:{name:"Chaparral",description:"Dry, shrubland region with hot summers and mild, rainy winters.",elevation:1e3,vegetation:5,waterAmount:5,summer:{temperature:{day:32.5,night:17.5,var:5},humidity:{day:60,night:40,var:5},wind:{avg:25,var:10},sun:{hours:13}},winter:{temperature:{day:17.5,night:2.5,var:5},humidity:{day:60,night:50,var:5},wind:{avg:30,var:10},sun:{hours:11}}},steppe:{name:"Steppe",description:"Large, flat region with low rainfall and characteristic grasses.",elevation:500,vegetation:5,waterAmount:0,summer:{temperature:{day:27.5,night:15,var:5},humidity:{day:30,night:25,var:5},wind:{avg:25,var:10},sun:{hours:14}},winter:{temperature:{day:5,night:-5,var:10},humidity:{day:40,night:30,var:10},wind:{avg:20,var:10},sun:{hours:10}}},wetland:{name:"Wetland",description:"Area with high water saturation, often with distinctive vegetation.",elevation:100,vegetation:60,waterAmount:80,summer:{temperature:{day:25,night:15,var:10},humidity:{day:70,night:80,var:10},wind:{avg:15,var:10},sun:{hours:16}},winter:{temperature:{day:5,night:-5,var:10},humidity:{day:60,night:60,var:5},wind:{avg:20,var:5},sun:{hours:8}}},mangrove:{name:"Mangrove",description:"Coastal wetland region characterized by trees and shrubs adapted to saltwater and often submerged in water.",elevation:0,vegetation:80,waterAmount:60,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:60,night:70,var:10},wind:{avg:10,var:5},sun:{hours:16}},winter:{temperature:{day:27.5,night:17.5,var:5},humidity:{day:60,night:60,var:10},wind:{avg:15,var:10},sun:{hours:8}}},littoral:{name:"Littoral",description:"The region where the land meets the water in a lake, river, or ocean, with unique plants and animals adapted to this interface.",elevation:0,vegetation:1,waterAmount:50,summer:{temperature:{day:25,night:15,var:10},humidity:{day:60,night:60,var:5},wind:{avg:10,var:5},sun:{hours:16}},winter:{temperature:{day:15,night:5,var:10},humidity:{day:60,night:60,var:10},wind:{avg:15,var:10},sun:{hours:8}}}};constructor(t){Logger.debug("RegionMeteo:constrctor",{templateId:t}),this.regionData=void 0!==t?RegionMeteo.templates[t]:canvas.scene.getFlag(e.ID,"regionSettings"),this._noise=Noise.createNoise2D(0),this.update()}static getTemplates(){let e=[];for(let t in RegionMeteo.templates)e.push({id:t,name:RegionMeteo.templates[t].name});return e}static fromTemplate(e){return new RegionMeteo(e)}update(){this._cache={}}getRegionBase(e=0,t=0){void 0===e&&(e=0),void 0===t&&(t=0);let a=TimeProvider.getDayOfYear(),i=TimeProvider.getHourOfDay();if(i+=t,i<0)for(;i<0;)i+=24,a--;if(i>=24)for(;i>=24;)i-=24,a++;if(a+=e,a<0)for(;a<0;)a+=TimeProvider.config.daysInYear;if(a>=TimeProvider.config.daysInYear)for(;a>=TimeProvider.config.daysInYear;)a-=TimeProvider.config.daysInYear;let n=TimeProvider.getTimeHash(a,i);if(void 0!==this._cache[n])return this._cache[n];let r={elevation:this.regionData.elevation,vegetation:this.regionData.vegetation,waterAmount:this.regionData.waterAmount,timeHash:n};void 0===this.regionData.name?r.name="custom":r.name=this.regionData.name;let s=RegionMeteo._hodPct(i),o=RegionMeteo._doyPct(a),d=(this.regionData.summer.temperature.day-this.regionData.winter.temperature.day)*o+this.regionData.winter.temperature.day,h=(this.regionData.summer.temperature.night-this.regionData.winter.temperature.night)*o+this.regionData.winter.temperature.night,g=(this.regionData.summer.temperature.var-this.regionData.winter.temperature.var)*o+this.regionData.winter.temperature.var;r.baseTemp=this._getNoisedValue(n+1282,64,(d-h)*s+h,g),r.baseTemp<0&&(r.waterAmount=0);let u=(this.regionData.summer.humidity.day-this.regionData.winter.humidity.day)*o+this.regionData.winter.humidity.day,l=(this.regionData.summer.humidity.night-this.regionData.winter.humidity.night)*o+this.regionData.winter.humidity.night,c=(this.regionData.summer.humidity.var-this.regionData.winter.humidity.var)*o+this.regionData.winter.humidity.var;r.baseHumidity=Utils.clamp(this._getNoisedValue(n+732,64,(u-l)*s+l,c),0,100);let m=((this.regionData.summer.sun.hours-this.regionData.winter.sun.hours)*o+this.regionData.winter.sun.hours)/2,p=Math.abs(12-i);r.sunAmount=p>m?0:Utils.clamp(m/3*(1-1/(m/p)),0,1);let v=(this.regionData.summer.wind.avg-this.regionData.winter.wind.avg)*o+this.regionData.winter.wind.avg,w=(this.regionData.summer.wind.var-this.regionData.winter.wind.var)*o+this.regionData.winter.wind.var,f=1;return f=r.sunAmount<.1?.9:r.sunAmount<.2?i>12?.8:1.2:1.1,r.wind=Utils.clamp(this._getNoisedValue(n+978,16,f*v,w),0,80),r.gusts=Utils.clamp(r.wind+this._getNoisedValue(n+12,8,f*w,w),0,80),this._cache[n]=r,r}_getNoisedValue(e,t,a,i){return e/=t,a+(i*((1*this._noise(1*e,1*e)+.5*this._noise(2*e,2*e)+.25*this._noise(4*e,4*e))/1.75)*2-i)}static _hodPct(e){return e%=24,(Math.sin((e/12-.5)*Math.PI)+1)/2}static _doyPct(e){const t=TimeProvider.config.summerSolstice%TimeProvider.config.daysInYear,a=TimeProvider.config.winterSolstice%TimeProvider.config.daysInYear;let i,n=a,r=a;return a<t?r=a+TimeProvider.config.daysInYear:n=a-TimeProvider.config.daysInYear,e>r&&(e-=TimeProvider.config.daysInYear),i=e==t?1:e<t?(e-n)/(t-n):1-(e-t)/(r-t),i}}class RegionConfigDialog extends FormApplication{constructor(e){super(),this.applyToScene=e,Logger.debug("RegionConfigDialog:constrctor",{applyToScene:e})}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/regionConfig.hbs",id:"region-settings",title:"Region Settings",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}activateListeners(e){super.activateListeners(e),Logger.debug("RegionConfigDialog:activateListeners")}getData(){let t={waterAmounts:[{id:0,name:"Desert, Rocky Wasteland (0%)"},{id:5,name:"Plains, City (5%)"},{id:10,name:"Meadow, Shrubland (10%)"},{id:25,name:"Marsh, Some Rivers, Forest (25%)"},{id:50,name:"Shoreline, Huge Lake (50%)"},{id:75,name:"Small Island (75%)"},{id:100,name:"Ocean (100%)"}]};if(void 0===this.applyToScene)return mergeObject(t,game.settings.get(e.ID,"defaultRegionSettings")),Logger.debug("RegionConfigDialog:getData(general)",{applyToScene:this.applyToScene,data:t}),t;{let a=game.scenes.get(this.applyToScene).getFlag(e.ID,"regionSettings");return mergeObject(t,a),Logger.debug("RegionConfigDialog:getData(scene)",{applyToScene:this.applyToScene,data:t}),t}}_updateObject(t,a){const i=expandObject(a);Logger.debug("updateObject, regionConfig",{data:i,scene:this.applyToScene}),void 0===this.applyToScene?game.settings.set(e.ID,"defaultRegionSettings",i):game.scenes.get(this.applyToScene).setFlag(e.ID,"regionSettings",i)}}class WeatherUi extends FormApplication{static _isOpen=!1;async _render(t=!1,a={}){await super._render(t,a),game.settings.get(e.ID,"uiPinned")&&WeatherUi.pinApp(),WeatherUi._isOpen=!0,delete ui.windows[this.appId]}async close(t={}){return t.sceneWeather&&(WeatherUi._isOpen=!1,game.settings.set(e.ID,"uiVisible",!1)),super.close(t)}constructor(){super()}static get defaultOptions(){return document.getElementById("players"),this.initialPosition=game.settings.get(e.ID,"uiPosition"),mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,submitOnChange:!0,closeOnSubmit:!1,minimizable:!1,template:"modules/"+e.ID+"/templates/weatherUi.hbs",id:"scene-weather-app",title:"SceneWeather",top:this.initialPosition.top,left:this.initialPosition.left})}async _updateObject(e,t){Logger.debug("WeatherUi._updateObjec",{event:e,formData:t})}getData(){return game.sceneWeather.get().getWeatherInfo()}activateListeners(t){super.activateListeners(t);const a=t.find("#dragHandle")[0],i=new Draggable(this,t,a,!1);let n=!1;i._onDragMouseMove=function _newOnDragMouseMove(e){e.preventDefault();const t=document.getElementById("players").getBoundingClientRect(),a=Date.now();if(a-this._moveTime<1e3/60)return;this._moveTime=a;const{left:i,top:r}=this.element.getBoundingClientRect();WeatherUi.unPinApp()&&Object.assign(this.position,{left:i,top:r}),this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)});let s=t.top-50,o=t.top+50;e.clientX>t.left&&e.clientX<t.left+t.width&&e.clientY>s&&e.clientY<o?($("#scene-weather-app").css("animation","jiggle 0.2s infinite"),n=!0):($("#scene-weather-app").css("animation",""),n=!1)},i._onDragMouseUp=async function _newOnDragMouseUp(t){t.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp);let a=document.getElementById("players").getBoundingClientRect().height+50;if(n)WeatherUi.pinApp(),await game.settings.set(e.ID,"uiPinned",!0),this.app.setPosition({left:15,top:window.innerHeight-a});else{let t=$("#scene-weather-app").position(),a={top:t.top,left:t.left};await game.settings.set(e.ID,"uiPosition",a),await game.settings.set(e.ID,"uiPinned",!1)}$("#scene-weather-app").css("animation","")}}static async pinApp(){const t=game.modules.get(e.ID).uiApp;t&&!t.element.hasClass("pinned")&&($("#players").before(t.element),t.element.addClass("pinned"))}static unPinApp(){const t=game.modules.get(e.ID).uiApp;if(t&&t.element.hasClass("pinned")){const e=t.element;return $("body").append(e),e.removeClass("pinned"),!0}}static async toggleAppVis(t){"toggle"===t?!0===game.settings.get(e.ID,"uiVisible")?($("#scene-weather-app").stop(),$("#scene-weather-app").css({animation:"close 0.3s",opacity:"0"}),setTimeout((function(){game.modules.get(e.ID).uiApp.close({sceneWeather:!0})}),200)):(WeatherUi._isOpen&&game.modules.get(e.ID).uiApp.close({sceneWeather:!0}),game.modules.get(e.ID).uiApp=await(new WeatherUi).render(!0),game.settings.set(e.ID,"uiVisible",!0)):!0===game.settings.get(e.ID,"uiVisible")&&(game.modules.get(e.ID).uiApp=await(new WeatherUi).render(!0))}static async update(){if(Logger.debug("Updating WeatherUI"),!0===game.settings.get(e.ID,"uiVisible")){let t=game.modules.get(e.ID).uiApp.getData(),a=await renderTemplate("modules/"+e.ID+"/templates/weatherMeteogram.hbs",t);$("#weatherMeteogram").html(a),document.getElementById("meteogramCanvas"),game.sceneWeather.debug()?.drawWeatherModelData("meteogramCanvas",-12,12)}}}class SceneWeatherApi{static _lastUpdate=0;static _sceneWeather={};static async registerApi(){game.sceneWeather?Logger.debug("SceneWeather API aleady registered!"):(game.sceneWeather={},game.sceneWeather.get=SceneWeatherApi.getSceneWeatherProvider,game.sceneWeather.updateSettings=SceneWeatherApi.updateSettings,game.sceneWeather.updateWeather=SceneWeatherApi.updateWeather,Logger.debug("sceneWeather API registered as game.sceneWeather"))}static async updateSettings(){}static updateWeather(e,t=!1){Logger.debug("API:updateWeather"),t&&(SceneWeatherApi._lastUpdate=-1,SceneWeatherApi.getSceneWeatherProvider(e,!0).update());let a=TimeProvider.getTimeHash();SceneWeatherApi._lastUpdate!==a&&(SceneWeatherApi._lastUpdate=a,WeatherUi.update())}static getSceneWeatherProvider(t,a=!1){let i=canvas.scene._id;if(void 0!==t&&(i=t),a&&(SceneWeatherApi._sceneWeather[i]=void 0),void 0!==SceneWeatherApi._sceneWeather[i])return Logger.debug("api, found in cache",{sceneId:i,sceneWeather:SceneWeatherApi._sceneWeather[i]}),SceneWeatherApi._sceneWeather[i];switch(canvas.scene.getFlag(e.ID,"weatherMode")){case"weatherTemplate":let t=canvas.scene.getFlag(e.ID,"weatherTemplate");Logger.debug("getSceneWeatherProvider:weatherTemplate",{weatherTemplate:t,sceneId:i,noCache:a}),SceneWeatherApi._sceneWeather[i]=new SceneWeather(WeatherModel.fromTemplate(t));break;case"regionTemplate":let n=canvas.scene.getFlag(e.ID,"regionTemplate");Logger.debug("getSceneWeatherProvider:regionTemplate",{regionTemplate:n,sceneId:i,noCache:a}),SceneWeatherApi._sceneWeather[i]=new SceneWeather(WeatherModel.fromRegion(RegionMeteo.fromTemplate(n)));break;case"regionAuto":SceneWeatherApi._sceneWeather[i]=new SceneWeather(WeatherModel.fromRegion(new RegionMeteo));break;default:Logger.debug("getSceneWeatherProvider:disabled"),SceneWeatherApi._sceneWeather[i]=void 0}return SceneWeatherApi._sceneWeather[i]}}const registerHbHelpers=function(){Handlebars.__switch_stack__=[],Handlebars.registerHelper("switch",(function(e,t){Handlebars.__switch_stack__.push({switch_match:!1,switch_value:e});var a=t.fn(this);return Handlebars.__switch_stack__.pop(),a})),Handlebars.registerHelper("case",(function(e,t){var a=Array.from(arguments),i=(t=a.pop(),a),n=Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1];return n.switch_match||-1===i.indexOf(n.switch_value)?"":(n.switch_match=!0,t.fn(this))})),Handlebars.registerHelper("default",(function(e){if(!Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1].switch_match)return e.fn(this)})),Logger.debug("HB Helpers Registered")},loadHandlebars=function(){loadTemplates({manualTime:"modules/"+e.ID+"/templates/manualTime.hbs",manualSeason:"modules/"+e.ID+"/templates/manualSeason.hbs",weatherMeteogram:"modules/"+e.ID+"/templates/weatherMeteogram.hbs"}),Logger.debug("HB partials loaded")};function onChangeFunction(t){game[e.LCCNAME]&&game[e.LCCNAME].updateSettings()}const registerSettings=function(){game.settings.register(e.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.registerMenu(e.ID,"defaultRegionSettingsMenu",{name:"Default Region Settings",label:"Default Region Settings",hint:"A description of what will occur in the submenu dialog.",icon:"fas fa-bars",type:RegionConfigDialog,restricted:!0}),game.settings.register(e.ID,"defaultRegionSettings",{scope:"world",config:!1,type:Object,default:{elevation:0,vegetation:0,waterAmount:0,summer:{temperature:{max:0,avg:0,min:0,var:0},humidity:{max:0,avg:0,min:0,var:0},wind:{avg:0,var:0}},winter:{temperature:{max:0,avg:0,min:0,var:0},humidity:{max:0,avg:0,min:0,var:0},wind:{avg:0,var:0}}}}),game.settings.register(e.ID,"uiVisible",{name:Utils.i18n("settings.uiVisible.name"),hint:Utils.i18n("settings.uiVisible.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"uiPosition",{name:Utils.i18n("settings.uiPosition.name"),hint:Utils.i18n("settings.uiPosition.hint"),scope:"client",config:!1,type:Object,default:{top:440,left:15},onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"uiPinned",{name:Utils.i18n("settings.uiPinned.name"),hint:Utils.i18n("settings.uiPinned.hint"),scope:"client",config:!1,type:Boolean,default:!0,onChange:e=>{onChangeFunction()}}),game.settings.register(e.ID,"debug",{name:Utils.i18n("settings.debug.name"),hint:Utils.i18n("settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{onChangeFunction()}}),Logger.debug("Settings Registered")};class WeatherMenu{static registerButtons(){CONFIG.Canvas.layers.weather={layerClass:WeatherLayer,group:"interface"},Hooks.on("getSceneControlButtons",(e=>{const t=[{name:"Toggle Weather UI",title:"Toggle Weather UI",icon:"fas fa-solid fa-eye",button:!0,onClick:()=>{WeatherUi.toggleAppVis("toggle")}},{name:"Update clients",title:"Update clients",icon:"fas fa-solid fa-arrows-rotate",button:!0,onClick:()=>{}},{name:"Remove All Weather",title:"Remove All Weather",icon:"fas fa-solid fa-trash",button:!0,onClick:()=>{}}];e.splice(e.findIndex((e=>"sounds"===e.name))+1,0,{name:"Scene Weather",title:"Scene Weather",icon:"fas fa-solid fa-cloud-bolt-sun",layer:"weather",tools:t})}))}}class WeatherLayer extends InteractionLayer{static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"weather",canDragCreate:!1,controllableObjects:!0,rotatableObjects:!0,zIndex:666})}selectObjects(e){canvas.tokens.selectObjects(e)}}class WeatherTab{static async addControlsTab(t,a){Logger.debug("addControlsTab",{app:t,jQ:a});let i=t.document.flags[e.ID],n={weatherMode:"disabled",weatherTemplate:"default",regionTemplate:"plains",timeProvider:"manual",dateProvider:"manual",timeHour:0,timeSeason:0};mergeObject(n,i,{overwrite:!0});let r={data:n,timeSeasons:[{id:0,name:"Winter"},{id:90,name:"Spring"},{id:180,name:"Summer"},{id:270,name:"Fall"}],timeProviders:[{id:"small-time",name:"SmallTime"},{id:"simple-calendar",name:"Simple Calendar"},{id:"manual",name:"Manual"}],dateProviders:[{id:"simple-calendar",name:"Simple Calendar"},{id:"manual",name:"Manual"}],weatherModes:[{id:"disabled",name:"Disabled (Use foundry default ambience)",hint:"Scene Weather is disabled. All ambience effects and types are set via the foundry default settings in Ambience."},{id:"weatherTemplate",name:"Use weather template (static)",hint:"Set a weather for the scene from a select choice of templates. The weather is static and will remain like that unless manually changed."},{id:"regionTemplate",name:"Use region template (dynamic)",hint:"Let the weather be generated based on a selected region template from a choice list. The weather will change dynamically based on given time of day and the season in the year. If an automatic calendar or time module is installed, it will change with the flow of time."},{id:"regionAuto",name:"Auto generate via region template (generated)",hint:"Let the weather be generated based on set attributes for the scene like mean temperature or elevation. The weather is dependant on a current time/date that needs to be provided to generate the dynamic weather based on all those parameters."}],weatherTemplates:[],regionTemplates:[]};r.weatherTemplates=WeatherModel.getTemplates(),r.regionTemplates=RegionMeteo.getTemplates(),Logger.debug("Render TabData with",{tabData:r});let s=await renderTemplate("modules/"+e.ID+"/templates/weatherTab.hbs",r);$(".sheet-tabs",a).append($("<a>").addClass("item").attr("data-tab","weather").html('<i class="fas fa-solid fa-cloud-bolt-sun"></i> Weather')),$("<div>").addClass("tab").attr("data-tab","weather").insertAfter($('div[data-tab="ambience"]',a)).append(s),WeatherTab.activateListeners(t,a,r.data.weatherMode)}static activateListeners(e,t,a){Logger.debug("WeatherTab.activateListeners",{app:e,jQ:t,select:a}),t.find('div[id="sceneWeather.mode.'+a+'"]').addClass("active"),t.find('button[data-key="flags.scene-weather.regionConfig"]').on("click",(function(){Logger.debug("Clicked Config Region for Scene",{sceneId:e.document._id});new RegionConfigDialog(e.document._id).render(!0)})),t.find('select[name="flags.scene-weather.weatherMode"]').on("change",(function(){let a=$(this).find(":selected").val();t.find("div.sceneWeather-collapsibleModeOption").each((function(){$(this).attr("id")=="sceneWeather.mode."+a?$(this).addClass("active"):$(this).removeClass("active")})),e.setPosition({height:"auto"}),Logger.debug("onChange",{app:e,jQ:t})}))}}Hooks.on("ready",(async()=>{Hooks.callAll(e.LCCNAME+"Initialized"),Logger.info("Ready")})),Hooks.once("setup",(()=>{WeatherMenu.registerButtons()})),Hooks.on("renderWeatherUi",(()=>{Logger.debug("Hook:renderWeatherUi"),game.sceneWeather.debugChart=void 0,SceneWeatherApi.updateWeather()})),Hooks.once("init",(()=>{registerSettings(),registerHbHelpers(),loadHandlebars(),SceneWeatherApi.registerApi(),Logger.debug("Init Done")})),Hooks.on("updateWorldTime",(()=>{SceneWeatherApi.updateWeather()})),Hooks.on("pauseGame",(()=>{SceneWeatherApi.updateWeather()})),Hooks.on("simple-calendar-clock-start-stop",(()=>{SceneWeatherApi.updateWeather()})),Hooks.on("simple-calendar-date-time-change",(e=>{SceneWeatherApi.updateWeather()})),Hooks.on("canvasReady",(async()=>{Hooks.on(e.LCCNAME+"Initialized",(async()=>{Hooks.on("preUpdateScene",(async(t,a,i,n)=>{void 0!==a.flags&&null!=a.flags[e.ID]&&(Logger.debug("preUpdateScene-> ",{deltaData:a,options:i}),SceneWeatherApi.updateWeather(a._id,!0))})),Hooks.on("updateScene",(async(t,a,i,n)=>{void 0!==a.flags&&null!=a.flags[e.ID]&&(Logger.debug("preUpdateScene-> ",{deltaData:a,options:i}),SceneWeatherApi.updateWeather(a._id,!0))}))})),WeatherUi.toggleAppVis("initial"),game.settings.get(e.ID,"uiPinned")&&WeatherUi.pinApp()})),Hooks.on("renderSceneConfig",(async(e,t,a)=>{Logger.debug("renderSceneConfig",{app:e,jQ:t,data:a}),WeatherTab.addControlsTab(e,t)}));export{Logger,t as METEO,e as MODULE,Noise,RegionConfigDialog,RegionMeteo,SceneWeather,SceneWeatherApi,TimeProvider,Utils,WeatherMenu,WeatherModel,WeatherTab,WeatherUi,loadHandlebars,registerHbHelpers,registerSettings};
