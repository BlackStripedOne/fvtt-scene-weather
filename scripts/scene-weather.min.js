const e={ID:"scene-weather",NAME:"Scene Weather",LCCNAME:"sceneWeather"},t={WEATHER_TEMPLATE:"weatherTemplate",WEATHER_GENERATE:"weatherAuto",REGION_TEMPLATE:"regionTemplate",REGION_GENERATE:"regionAuto",DISABLED:"disabled"},i={SETTINGS_UPDATED:e.LCCNAME+"SettingsUpdated",REG_TEMPLATE_REGION:e.LCCNAME+"RegisterRegionTemplate",REG_TEMPLATE_WEATHER:e.LCCNAME+"RegisterWeatherTemplate"},a={isaMSLtempC:16,isaSeaLevelPa:101325,adiabaticHyDryCoeff:-.0065,g:9.80665,mAir:.0289644,R:8.3144598,Tzero:237.7},n={none:0,drizzle:1,rain:2,downpour:3,hail:4,snow:5,blizzard:6},s={none:0,fog:1,stratus:2,cumulus:3,cumulunimbus:4},r={dry:20,comfortable:40,pleasant:50,sticky:65,humid:75,oppressive:1/0},o={gloomy:.1,shaded:.3,normal:.7,bright:1/0},l={nothing:.2,slight:.4,average:.7,heavy:.95,extreme:1/0},d={calm:1,light:5,lightBreeze:11,gentleBreeze:28,freshBreeze:38,strongBreeze:49,moderateGale:61,freshGale:74,strongGale:88,wholeGale:102,storm:118,hurricane:1/0},c={low:600,mid:1e3,high:4e3,veryhigh:1/0},g={freezing:-7,cold:-3,chill:3,fresh:7,moderate:18,mild:22,warm:30,hot:37,searing:1/0};class Logger{static info(t,i=!1){console.log(e.NAME+` Info | ${t}`),i&&ui.notifications.info(e.NAME+` | ${t}`)}static error(t,i=!1){console.error(e.NAME+` Error | ${t}`),i&&ui.notifications.error(e.NAME+` | ${t}`)}static debug(t,i){if(game.gmTokenTools?game.gmTokenTools.isDebug:Utils.getSetting("debug",!1)){if(!i)return void console.log(e.NAME+` Debug | ${t}`);const a=Utils.deepClone(i);console.log(e.NAME+` Debug | ${t}`,a)}}}class Utils{static getApi(){return game.sceneWeather}static clamp(e,t,i){return Math.min(Math.max(e,t),i)}static map(e,t,i,a,n){const s=(e-t)*(n-a)/(i-t)+a;return Utils.clamp(s,a,n)}static mapColorHex(e,t,i,a,n){const{r:s,g:r,b:o}=foundry.utils.Color.from(a),{r:l,g:d,b:c}=foundry.utils.Color.from(n);return foundry.utils.Color.fromRGB([Utils.map(e,t,i,s,l),Utils.map(e,t,i,r,d),Utils.map(e,t,i,o,c)]).toString()}static roundToDecimals(e,t){return Number(Math.round(e+"e"+t)+"e-"+t)}static omit(e,t){const{[t]:i,...a}=e;return a}static isBitSet(e,t){return 0!=(e&1<<t)}static deepClone(e,t){return deepClone(e,t)}static getActor(e,t){let i=null;return t&&(i=canvas.tokens.placeables.find((e=>e.id===t))),i?i.actor:game.actors.get(e)}static getItem(e,t){return e.items.get(t)}static getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getControlledToken(){return game.canvas.tokens.controlled[0]}static getUserByTokenId(e){let t,i=e.actor.ownership;return game.users.forEach((e=>{null!==e.character&&e.active&&i[e._id]>0&&(t=e)})),t}static getSetting(t,i=null){let a=i??null;try{a=game.settings.get(e.ID,t)}catch{console.log(e.NAME+` Debug | GameConfig '${t}' not found`)}return a}static async setSetting(t,i){game.settings.settings.get(`${e.ID}.${t}`)?(await game.settings.set(e.ID,t,i),Logger.debug(`GameConfig '${t}' set to '${i}'`)):Logger.debug(`GameConfig '${t}' not found`)}static getSceneFlag(t,i=null){let a=i??null;try{a=canvas.scene?.getFlag(e.ID,t)??i}catch{Logger.debug(`SceneFlag '${t}' not found on current scene`)}return a}static getUserFlag(t){return game.user.getFlag(e.ID,t)}static async setUserFlag(t,i){await game.user.setFlag(e.ID,t,i)}static async unsetUserFlag(t){await game.user.unsetFlag(e.ID,t)}static i18n(e,t=null){let i=game.i18n.localize(e);return i==e?(null==t&&(i=e),i):i}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}}class TimeProvider{static config={daysInYear:365,summerSolstice:172,winterSolstice:355,monthOffset:[0,31,59,90,120,151,181,212,243,273,304,334],hoursInDay:24};static initConfig(){}static _getTimeProvider(){return"simple-calendar"}static getCurrentTimeHash(){return TimeProvider.getTimeHash(TimeProvider.getDayOfYear(),TimeProvider.getHourOfDay())}static getTimeHash(e,t){return e*TimeProvider.config.hoursInDay+t}static getDayOfYearFromTimeHash(e){return Math.trunc(e/TimeProvider.config.hoursInDay)+1}static getMonthOfYearFromTimeHash(e){let t=TimeProvider.getDayOfYearFromTimeHash(e);for(let e=0;e<TimeProvider.config.monthOffset.length;e++)if(t<TimeProvider.config.monthOffset[e])return e;return TimeProvider.config.monthOffset.length}static getDayOfMonthFromTimeHash(e){let t=TimeProvider.getMonthOfYearFromTimeHash(e);return TimeProvider.getDayOfYearFromTimeHash(e)-TimeProvider.config.monthOffset[t-1]}static getTimeOfDayFromTimeHash(e){return e%TimeProvider.config.hoursInDay}static getDayOfYear(){if(game.modules.get("foundryvtt-simple-calendar")?.active&&"simple-calendar"===TimeProvider._getTimeProvider()){let e=SimpleCalendar.api.timestampToDate(game.time.worldTime);return TimeProvider.config.monthOffset[e.month]+e.day}{let t=canvas.scene.getFlag(e.ID,"timeSeason");return void 0===t&&(t=Util.getSetting("timeSeason",150)),sceneManualData}}static getHourOfDay(){const e=game.time.worldTime+0,t=Math.abs(Math.trunc(e%86400/3600));return e<0?24-t:t}}class Noise{static F2=.5*(Math.sqrt(3)-1);static G2=(3-Math.sqrt(3))/6;static F3=1/3;static G3=1/6;static F4=(Math.sqrt(5)-1)/4;static G4=(5-Math.sqrt(5))/20;static fastFloor(e){return 0|Math.floor(e)}static getMulberry32(e){return function(){var t=e+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296}}static grad2=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);static getNoisedValue(e,t,i,a,n){return a+(n*((1*e(1*(t/=i),1*t)+.5*e(2*t,2*t)+.25*e(4*t,4*t))/1.75)*2-n)}static createNoise2D(e){const t=Noise._buildPermutationTable(e),i=new Float64Array(t).map((e=>Noise.grad2[e%12*2])),a=new Float64Array(t).map((e=>Noise.grad2[e%12*2+1]));return function(e,n){let s=0,r=0,o=0;const l=(e+n)*Noise.F2,d=Noise.fastFloor(e+l),c=Noise.fastFloor(n+l),g=(d+c)*Noise.G2,u=e-(d-g),h=n-(c-g);let m,p;u>h?(m=1,p=0):(m=0,p=1);const f=u-m+Noise.G2,w=h-p+Noise.G2,y=u-1+2*Noise.G2,b=h-1+2*Noise.G2,v=255&d,D=255&c;let C=.5-u*u-h*h;if(C>=0){const e=v+t[D];C*=C,s=C*C*(i[e]*u+a[e]*h)}let M=.5-f*f-w*w;if(M>=0){const e=v+m+t[D+p];M*=M,r=M*M*(i[e]*f+a[e]*w)}let S=.5-y*y-b*b;if(S>=0){const e=v+1+t[D+1];S*=S,o=S*S*(i[e]*y+a[e]*b)}return 70*(s+r+o)}}static _buildPermutationTable(e){const t=Noise.getMulberry32(e),i=512,a=new Uint8Array(i);for(let e=0;e<256;e++)a[e]=e;for(let e=0;e<255;e++){const i=e+~~(t()*(256-e)),n=a[e];a[e]=a[i],a[i]=n}for(let e=256;e<i;e++)a[e]=a[e-256];return a}}class WeatherModel{constructor({regionMeteo:t,templateId:i="default",useWeatherConfig:a}){Logger.debug("WeatherModel:constrctor",{regionMeteo:t,templateId:i,useWeatherConfig:a}),this._cache={},void 0!==t?(this.regionMeteo=t,this.useConfigSceneId=void 0,this.updateConfig()):void 0!==a?(this.regionMeteo=void 0,this.useConfigSceneId=a,this.updateConfig()):(this.regionMeteo=void 0,this.useConfigSceneId=void 0,this.weatherData=Utils.getApi().weatherTemplates.find((e=>e.id==i)),void 0===this.weatherData&&(this.weatherData=Utils.getApi().weatherTemplates[0],canvas.scene.setFlag(e.ID,"weatherTemplate",this.weatherData.id),Logger.error("Unable to set weather template with id ["+i+"] reverting to ["+this.weatherData.id+"]. Maybe you removed a SceneWeather plugin after configuring your scene.",!0)),this.weatherData.precipitation.mode=Utils.getSceneFlag("rainMode","winddir"))}static getTemplates(){let e=[];return Utils.getApi().weatherTemplates.forEach((t=>{e.push({id:t.id,name:t.name})})),e}static fromSceneConfig(e){return new WeatherModel({useWeatherConfig:e})}static fromTemplate(e){return new WeatherModel({templateId:e})}static fromRegion(e){return new WeatherModel({regionMeteo:e})}updateConfig(){if(void 0!==this.regionMeteo)return Logger.debug("WeatherModel.updateConfig() -> invalidating cache, invoking on regionMeteo..."),this._cache={},this.regionMeteo.updateConfig();if(void 0!==this.useConfigSceneId){Logger.debug("WeatherModel.updateConfig() -> getting weatherConfig from Scene.",{configSceneId:this.useConfigSceneId});let t=this.useConfigSceneId,i=game.scenes.get(this.useConfigSceneId)?.getFlag(e.ID,"weatherSettings")??void 0;Logger.debug("WeatherModel.updateConfig()",{weatherConfig:i}),i||(i=Utils.getSetting("defaultWeatherSettings"),t="_GLOBAL_"),this._noise=Noise.createNoise2D(0);const n=i.wind.speed+i.wind.gusts,s=Math.trunc(1==i.wind.directionType?WeatherModel._getNoisedWindDirection(this._noise,TimeProvider.getCurrentTimeHash(),n):i.wind.direction);let r={source:t,name:"custom",temp:{ground:i.temp.ground,air:i.temp.air,percieved:Math.trunc(WeatherModel._apparentTemperature(i.temp.air,i.wind.speed,i.humidity,a.isaSeaLevelPa/100))},wind:{speed:i.wind.speed,gusts:n,direction:s,directionType:i.wind.directionType},clouds:{coverage:i.clouds.coverage/100,bottom:i.clouds.bottom,top:i.clouds.bottom+i.clouds.thickness,type:i.clouds.type},precipitation:{amount:i.precipitation.amount/100,type:i.precipitation.type,mode:Utils.getSceneFlag("rainMode","winddir")},sun:{amount:i.sun.amount/100},humidity:i.humidity};return foundry.utils.objectsEqual(this.weatherData,r)?(Logger.debug("WeatherModel.updateConfig() -> static from sceneConfig, no changes."),!1):(this.weatherData=r,Logger.debug("WeatherModel.updateConfig() -> static from sceneConfig",{sceneId:this.useConfigSceneId,weatherData:this.weatherData}),!0)}return this.weatherData.precipitation.mode==Utils.getSceneFlag("rainMode","winddir")?(Logger.debug("WeatherModel.updateConfig() -> static, nothing to do."),!1):(this.weatherData.precipitation.mode=Utils.getSceneFlag("rainMode","winddir"),!0)}getWeatherData(e=0,t=0){if(void 0!==this.regionMeteo){let i=this.regionMeteo.getRegionBase(e,t);if(void 0!==this._cache[i.timeHash])return this.weatherData=this._cache[i.timeHash],this._cache[i.timeHash];this.weatherData={name:i.name,temp:{ground:this._groundTemp(3,3,e,t),air:i.baseTemp,percieved:0},wind:{speed:i.wind,gusts:i.gusts+i.wind,direction:0},clouds:{coverage:0,bottom:Utils.clamp(Math.abs(WeatherModel._liftedCondensationLevel(i.baseTemp,i.baseHumidity)),0,2e4),top:0,type:0},precipitation:{amount:0,type:0,mode:Utils.getSceneFlag("rainMode","winddir")},sun:{amount:i.sunAmount},humidity:i.baseHumidity};let a=WeatherModel._calcAdiCloudBottomCoeff(this.weatherData,i),n=WeatherModel._calcGeopotential(i);return this.weatherData.clouds.top=a<0?this.weatherData.clouds.bottom+12.6*n:this.weatherData.clouds.bottom+.27*n,this.weatherData.clouds.coverage=Utils.clamp((this.weatherData.clouds.top-this.weatherData.clouds.bottom)/100,0,1),this.weatherData.clouds.bottom<i.elevation?this.weatherData.clouds.type=1:(a<0&&(this.weatherData.clouds.top-this.weatherData.clouds.bottom>1e3&&(this.weatherData.clouds.type=3),this.weatherData.clouds.top-this.weatherData.clouds.bottom>3e3&&(this.weatherData.clouds.type=4)),this.weatherData.clouds.type<3&&this.weatherData.clouds.coverage>.3&&(this.weatherData.clouds.type=2)),this.weatherData.precipitation.amount=Utils.clamp(1.2*this.weatherData.clouds.coverage-.4,0,1)*Noise.getNoisedValue(this.regionMeteo._noise,i.timeHash+321,8,.8,.2)*Noise.getNoisedValue(this.regionMeteo._noise,i.timeHash+321,32,1,.5),this.weatherData.wind.gusts=this.weatherData.wind.gusts*(2.5*this.weatherData.precipitation.amount+.5),this.weatherData.wind.speed=this.weatherData.wind.speed+2.2*this.weatherData.precipitation.amount*this.weatherData.wind.speed,this.weatherData.sun.amount=this.weatherData.sun.amount*Utils.clamp(1-this.weatherData.clouds.coverage,.2,1),this.weatherData.temp.air=this.weatherData.temp.air-.03*this.weatherData.wind.speed+this.weatherData.sun.amount*Math.max(2,.6*this.weatherData.temp.ground),this.weatherData.temp.percieved=WeatherModel._apparentTemperature(this.weatherData.temp.air,this.weatherData.wind.speed,this.weatherData.humidity,WeatherModel._heightToPressure(i.elevation)),this.weatherData.clouds.top=3*Math.max(0,this.weatherData.clouds.top-i.elevation),this.weatherData.clouds.bottom=3*Math.max(0,this.weatherData.clouds.bottom-i.elevation),this.weatherData.precipitation.type=WeatherModel._calcPrecipitationType(this.weatherData),this.weatherData.wind.direction=WeatherModel._getNoisedWindDirection(this.regionMeteo._noise,i.timeHash,this.weatherData.wind.gusts),this._cache[i.timeHash]=this.weatherData,this.weatherData}return void 0!==this.useConfigSceneId?(Logger.debug("Updating wind direction for weatherConfig based weatherData...",{"this.weatherData":this.weatherData}),1==this.weatherData.wind.directionType&&(this.weatherData.wind.direction=WeatherModel._getNoisedWindDirection(this._noise,TimeProvider.getCurrentTimeHash(e,t),this.weatherData.wind.gusts)),this.weatherData):this.weatherData}static _getNoisedWindDirection(e,t,i){let a=Noise.getNoisedValue(e,t+1277,512,180,180)+Noise.getNoisedValue(e,t+1277,8,16,16)*(.2*i);return a<0&&(a+=360),a>=360&&(a-=360),a}static _calcGeopotential(e){return e.vegetation*(1.3*e.sunAmount+.7*e.wind)+(.3*e.sunAmount+e.waterAmount*(1.3*e.wind))}static _heightToPressure(e){if(e<11e3)return a.isaSeaLevelPa*Math.pow(a.isaMSLtempC/(a.isaMSLtempC+a.adiabaticHyDryCoeff*e),a.g*a.mAir/(a.R*a.adiabaticHyDryCoeff))/100;if(e<=2e4){var t=a.isaSeaLevelPa*Math.pow(a.isaMSLtempC/(e+11e3*a.adiabaticHyDryCoeff),a.g*a.mAir/(a.R*a.adiabaticHyDryCoeff)),i=a.isaMSLtempC+11e3*a.adiabaticHyDryCoeff;return t*Math.exp(-a.g*a.mAir*(e-11e3)/(a.R*i))/100}return 0}static _apparentTemperature(e,t,i,a){return e<10?WeatherModel._windChill(e,t):WeatherModel._heatIndex(e,i,a)}static _windChill(e,t){if(e>=10)return Tc;let i;return i=t>=4.8&&t<=177?13.12+.6215*e+(.3965*e-11.37)*Math.pow(t,.16):t<4.8?e+.2*(.1345*e-1.59)*t:e,i}static _heatIndex(e,t,i){if(i<16)return e;if(e<27||a.R<.4||WeatherModel._dewPoint(e,t)<12)return e;return 1.61139411*e-8.784695+2.338549*t+-.14611605*e*t+-.012308094*e*e+-.016424828*t*t+.002211732*e*e*t+72546e-8*e*t*t+1e-6*-3.582*e*e*t*t}static _dewPoint(e,t){if(e<0||e>60)return e;if((t/=100)<.01||t>1)return e;let i=17.27*e/(a.Tzero+e)+Math.log(t),n=a.Tzero*i/(17.27-i);return n<0||n>50?e:n}static _calcAdiCloudBottomCoeff(e,t){return a.isaMSLtempC+(e.clouds.bottom-t.elevation)*a.adiabaticHyDryCoeff-(t.baseTemp+(e.clouds.bottom-t.elevation)*a.adiabaticHyDryCoeff)}static _calcPrecipitationType(e){return e.precipitation.amount<.1?0:e.clouds.type>3&&e.precipitation.amount>.7?e.temp.air<4?6:e.wind.speed>.2?4:3:e.clouds.type>=3?e.temp.air<4?e.wind.speed>.2?6:5:2:2==e.clouds.type||e.precipitation.amount>.7?e.temp.air<4?5:1:0}_groundTemp(e,t,i=0,a=0){let n=0,s=0;for(let r=0;r<=e;r++){let e=1/Math.log2(r+2);n+=this.regionMeteo.getRegionBase(i,a-r*t).baseTemp*e,s+=e}return n/s}static _liftedCondensationLevel(e,t){return 125*(e-(e-(100-t)/5))}}class RegionMeteo{constructor(t){Logger.debug("RegionMeteo:constrctor",{templateId:t}),void 0!==t?(this.regionData=Utils.getApi().regionTemplates.find((e=>e.id==t)),void 0===this.regionData&&(this.regionData=Utils.getApi().regionTemplates[0],canvas.scene.setFlag(e.ID,"regionTemplate",this.regionData.id),Logger.error("Unable to set region template with id ["+t+"] reverting to ["+this.regionData.id+"]. Maybe you removed a SceneWeather plugin after configuring your scene.",!0))):this.regionData=canvas.scene.getFlag(e.ID,"regionSettings"),this._noise=Noise.createNoise2D(0),this.updateConfig()}static getTemplates(){let e=[];return Utils.getApi().regionTemplates.forEach((t=>{e.push({id:t.id,name:t.name})})),e}static fromTemplate(e){return new RegionMeteo(e)}updateConfig(){return Logger.debug("RegionMeteo.updateConfig()"),this._cache={},!0}getRegionBase(e=0,t=0){void 0===e&&(e=0),void 0===t&&(t=0);let i=TimeProvider.getDayOfYear(),a=TimeProvider.getHourOfDay();if(a+=t,a<0)for(;a<0;)a+=24,i--;if(a>=24)for(;a>=24;)a-=24,i++;if(i+=e,i<0)for(;i<0;)i+=TimeProvider.config.daysInYear;if(i>=TimeProvider.config.daysInYear)for(;i>=TimeProvider.config.daysInYear;)i-=TimeProvider.config.daysInYear;let n=TimeProvider.getTimeHash(i,a);if(void 0!==this._cache[n])return this._cache[n];let s={elevation:this.regionData.elevation,vegetation:this.regionData.vegetation,waterAmount:this.regionData.waterAmount,timeHash:n};void 0===this.regionData.name?s.name="custom":s.name=this.regionData.name;let r=RegionMeteo._hodPct(a),o=RegionMeteo._doyPct(i),l=(this.regionData.summer.temperature.day-this.regionData.winter.temperature.day)*o+this.regionData.winter.temperature.day,d=(this.regionData.summer.temperature.night-this.regionData.winter.temperature.night)*o+this.regionData.winter.temperature.night,c=(this.regionData.summer.temperature.var-this.regionData.winter.temperature.var)*o+this.regionData.winter.temperature.var;s.baseTemp=Noise.getNoisedValue(this._noise,n+1282,64,(l-d)*r+d,c),s.baseTemp<0&&(s.waterAmount=0);let g=(this.regionData.summer.humidity.day-this.regionData.winter.humidity.day)*o+this.regionData.winter.humidity.day,u=(this.regionData.summer.humidity.night-this.regionData.winter.humidity.night)*o+this.regionData.winter.humidity.night,h=(this.regionData.summer.humidity.var-this.regionData.winter.humidity.var)*o+this.regionData.winter.humidity.var;s.baseHumidity=Utils.clamp(Noise.getNoisedValue(this._noise,n+732,64,(g-u)*r+u,h),0,100);let m=((this.regionData.summer.sun.hours-this.regionData.winter.sun.hours)*o+this.regionData.winter.sun.hours)/2,p=Math.abs(12-a);s.sunAmount=p>m?0:Utils.clamp(m/3*(1-1/(m/p)),0,1);let f=(this.regionData.summer.wind.avg-this.regionData.winter.wind.avg)*o+this.regionData.winter.wind.avg,w=(this.regionData.summer.wind.var-this.regionData.winter.wind.var)*o+this.regionData.winter.wind.var,y=1;return y=s.sunAmount<.1?.9:s.sunAmount<.2?a>12?.8:1.2:1.1,s.wind=Utils.clamp(Noise.getNoisedValue(this._noise,n+978,16,y*f,w),0,80),s.gusts=Utils.clamp(s.wind+Noise.getNoisedValue(this._noise,n+12,8,y*w,w),0,80),this._cache[n]=s,s}static _hodPct(e){return e%=24,(Math.sin((e/12-.5)*Math.PI)+1)/2}static _doyPct(e){const t=TimeProvider.config.summerSolstice%TimeProvider.config.daysInYear,i=TimeProvider.config.winterSolstice%TimeProvider.config.daysInYear;let a,n=i,s=i;return i<t?s=i+TimeProvider.config.daysInYear:n=i-TimeProvider.config.daysInYear,e>s&&(e-=TimeProvider.config.daysInYear),a=e==t?1:e<t?(e-n)/(t-n):1-(e-t)/(s-t),a}}class SceneWeather{constructor(e){this.sceneId=e._id,this.weatherModel=this._getWeatherModelForMode(e),Logger.debug("SceneWeather:constrctor",{weatherModel:this.weatherModel,sceneId:this.sceneId})}_getWeatherModelForMode(i){switch(this.weatherMode=i.getFlag(e.ID,"weatherMode")||t.DISABLED,Logger.debug("SceneWeather._getWeatherModelForMode(...)",{scene:i,weatherMode:this.weatherMode}),this.weatherMode){case t.WEATHER_TEMPLATE:const a=i.getFlag(e.ID,"weatherTemplate");return WeatherModel.fromTemplate(a);case t.WEATHER_GENERATE:return WeatherModel.fromSceneConfig(i._id);case t.REGION_TEMPLATE:const n=i.getFlag(e.ID,"regionTemplate");return WeatherModel.fromRegion(RegionMeteo.fromTemplate(n));case t.REGION_GENERATE:return WeatherModel.fromRegion(new RegionMeteo);case t.DISABLED:default:throw new Error("Unable to instantiate new SceneWeather, while being disabled.")}}updateConfig(){Logger.debug("SceneWeather.updateConfig()",{sceneId:this.sceneId});const t=game.scenes.get(this.sceneId);if(void 0===t)throw Logger.error("Unable to instantiate SceneWeather for non existing Scene with id "+this.sceneId),new Error("Unable to instantiate SceneWeather for non existing Scene with id "+this.sceneId);return t.getFlag(e.ID,"weatherMode")!=this.weatherMode?(Logger.debug("SceneWeather.updateConfig() -> new mode",{sceneId:this.sceneId,prevMode:this.weatherMode,newMode:t.getFlag(e.ID,"weatherMode")}),this.weatherModel=this._getWeatherModelForMode(t),!0):(Logger.debug("SceneWeather.updateConfig() -> unchanged mode",{sceneId:this.sceneId}),this.weatherModel.updateConfig())}static fromConfig({sceneId:e=null}={}){null==e&&(e=canvas.scene._id);const t=game.scenes.get(e);if(void 0!==t)try{return new SceneWeather(t)}catch(e){return}else Logger.error("Unable to instantiate SceneWeather for non existing Scene with id "+e)}calculateWeather({force:t=!1}={}){const i=TimeProvider.getCurrentTimeHash(),a=this.weatherModel.getWeatherData(),n=this._calculateWeatherInfoFromModelData(a);Hooks.callAll(e.LCCNAME+"WeatherUpdated",{info:n,model:a,timeHash:i,sceneId:this.sceneId,force:t})}static _getPercievedTempId(e){const[t]=Object.entries(g).find((([,t])=>e<t));return`meteo.${t}`}static _getWindDirId(e){return"meteo."+["n","nne","ne","ene","e","ese","se","sse","s","ssw","sw","wsw","w","wnw","nw","nnw"][Math.floor(e/22.5+.5)%16]}static _getCloudHightId(e){const[t]=Object.entries(c).find((([,t])=>e<t));return`meteo.${t}`}static _getCloudAmountId(e){return["meteo.skc","meteo.few","meteo.few","meteo.sct","meteo.sct","meteo.bkn","meteo.bkn","meteo.bkn","meteo.ovc"][Math.round(8*e)]}static _getCloudTypeId(e){const[t]=Object.entries(s).find((([,t])=>t===e));return t?`meteo.${t}`:"meteo.cumulunimbus"}static _getHumidityId(e){const[t]=Object.entries(r).find((([,t])=>e<t));return`meteo.${t}`}static _getSunAmountId(e){const[t]=Object.entries(o).find((([,t])=>e<t));return`meteo.${t}`}static _getPrecipitationAmountId(e){const[t]=Object.entries(l).find((([,t])=>e<t));return`meteo.${t}`}static _getPrecipitationTypeId(e){const[t]=Object.entries(n).find((([,t])=>t===e));return t?`meteo.${t}`:"meteo.none"}static _getWindSpeedId(e){let t=e.gusts>5?"Gusting":"";const[i]=Object.entries(d).find((([,t])=>e.speed<t));return`meteo.${i}${t}`}static getPerceptiveWeatherI18n(e){return Handlebars.compile(Utils.i18n("meteo.perceptive"))(e)}_calculateWeatherInfoFromModelData(e){return{name:e.name,temperature:{air:Math.round(e.temp.air),ground:Math.round(e.temp.ground),percieved:Math.round(e.temp.percieved),percievedId:SceneWeather._getPercievedTempId(e.temp.percieved)},humidity:{percent:Math.round(e.humidity),percentId:SceneWeather._getHumidityId(e.humidity)},wind:{speed:Math.round(e.wind.speed),gusts:Math.round(e.wind.gusts),speedId:SceneWeather._getWindSpeedId(e.wind),direction:Math.round(e.wind.direction),directionId:SceneWeather._getWindDirId(e.wind.direction)},clouds:{height:Math.round(e.clouds.bottom),heightId:SceneWeather._getCloudHightId(e.clouds.bottom),amount:Math.round(100*e.clouds.coverage),amountId:SceneWeather._getCloudAmountId(e.clouds.coverage),type:SceneWeather._getCloudTypeId(e.clouds.type)},sun:{amount:Math.round(100*e.sun.amount),amountId:SceneWeather._getSunAmountId(e.sun.amount)},precipitation:{amount:Math.round(100*e.precipitation.amount),amountId:SceneWeather._getPrecipitationAmountId(e.precipitation.amount),type:SceneWeather._getPrecipitationTypeId(e.precipitation.type)}}}getWeatherInfo(e=0,t=0){return this._calculateWeatherInfoFromModelData(this.weatherModel.getWeatherData(e,t))}fahrenheitToCelsius(e){return(e-32)/1.8}celsiusToFahrenheit(e){return 1.8*e+32}}class SceneWeatherApi{static _lastUpdate=0;static _sceneWeather={};static async registerApi(){game.sceneWeather?Logger.debug("SceneWeather API aleady registered!"):(game.sceneWeather={},game.sceneWeather.get=SceneWeatherApi.getSceneWeatherProvider,game.sceneWeather.updateSettings=SceneWeatherApi.updateSettings,game.sceneWeather.updateWeatherConfig=SceneWeatherApi.updateWeatherConfig,game.sceneWeather.calculateWeather=SceneWeatherApi.calculateWeather,game.sceneWeather.generators=[],game.sceneWeather.filters=[],game.sceneWeather.regionTemplates=[],game.sceneWeather.weatherTemplates=[],Logger.debug("sceneWeather API registered as game.sceneWeather"))}static async updateSettings(){Logger.debug("api::updateSettings")}static calculateWeather({force:e=!1,sceneId:t}={}){if(Logger.debug("api::calculateWeather(...)",{sceneId:t,force:e}),void 0===t&&(t=canvas.scene._id),t!=canvas.scene._id)return void Logger.debug("Not calculating weather for non current scene...");e&&(SceneWeatherApi._lastUpdate=-1);let i=TimeProvider.getCurrentTimeHash();if(SceneWeatherApi._lastUpdate==i)return;SceneWeatherApi._lastUpdate=i;SceneWeatherApi.getSceneWeatherProvider(t).calculateWeather({force:e})}static updateWeatherConfig({forSceneId:e,force:t=!1,prewarm:i=!1,fade:a=!0}={}){Logger.debug("api::updateWeatherConfig(...)",{forSceneId:e,force:t}),(SceneWeatherApi.getSceneWeatherProvider(e,t).updateConfig()||t)&&SceneWeatherApi.calculateWeather({sceneId:e,force:!0})}static getSceneWeatherProvider(e,t=!1){let i=canvas.scene._id;return void 0!==e&&(i=e),Logger.debug("api::getSceneWeatherProvider()",{forSceneId:e,sceneId:i,ignoreCache:t}),t&&(SceneWeatherApi._sceneWeather[i]=void 0),void 0!==SceneWeatherApi._sceneWeather[i]||(SceneWeatherApi._sceneWeather[i]=SceneWeather.fromConfig({sceneId:i})),SceneWeatherApi._sceneWeather[i]}}const registerHbHelpers=function(){Handlebars.__switch_stack__=[],Handlebars.registerHelper("switch",(function(e,t){Handlebars.__switch_stack__.push({switch_match:!1,switch_value:e});var i=t.fn(this);return Handlebars.__switch_stack__.pop(),i})),Handlebars.registerHelper("case",(function(e,t){var i=Array.from(arguments),a=(t=i.pop(),i),n=Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1];return n.switch_match||-1===a.indexOf(n.switch_value)?"":(n.switch_match=!0,t.fn(this))})),Handlebars.registerHelper("default",(function(e){if(!Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1].switch_match)return e.fn(this)})),Logger.debug("HB Helpers Registered")},loadHandlebars=function(){loadTemplates({regionConfigSummer:"modules/"+e.ID+"/templates/regionConfigSummer.hbs",regionConfigWinter:"modules/"+e.ID+"/templates/regionConfigWinter.hbs"}),Logger.debug("HB partials loaded")};class RegionConfigDialog extends FormApplication{constructor(e){super(),this.applyToScene=e,Logger.debug("RegionConfigDialog:constrctor",{applyToScene:e})}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/regionConfig.hbs",id:"region-settings",title:"dialogs.regionConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}activateListeners(e){super.activateListeners(e),Logger.debug("RegionConfigDialog:activateListeners");new Tabs({navSelector:".tabs",contentSelector:".content",initial:"summer",callback:{}}).bind(e[0]),e.find(".sceneweather-slider").each((function(t){const i=$(this),a=e.find('input[name="'+i.attr("data-min")+'"]'),n=e.find('input[name="'+i.attr("data-max")+'"]'),s=i.attr("data-range")||"0,100",r=i.attr("data-unit")||"%",o=Number(s.split(",")[0]||0),l=Number(s.split(",")[1]||o);noUiSlider.create(i[0],{start:[a.val()||0,n.val()||0],tooltips:[{to:function(e){return e+r},from:function(e){return Number(e.replace(r,""))}},{to:function(e){return e+r},from:function(e){return Number(e.replace(r,""))}}],behaviour:"drag-all",step:1,margin:0,padding:0,connect:!0,range:{min:o,max:l}}),i[0].noUiSlider.on("change",(function(e,t,i,s,r,o){Logger.debug("Slider Update",{values:e,noUiSlider:o}),a.val(e[0]),n.val(e[1])}))}))}getData(){let t={waterAmounts:[{id:0,name:"dialogs.regionConfig.waterAmounts_0"},{id:5,name:"dialogs.regionConfig.waterAmounts_5"},{id:10,name:"dialogs.regionConfig.waterAmounts_10"},{id:25,name:"dialogs.regionConfig.waterAmounts_25"},{id:50,name:"dialogs.regionConfig.waterAmounts_50"},{id:75,name:"dialogs.regionConfig.waterAmounts_75"},{id:100,name:"dialogs.regionConfig.waterAmounts_100"}]};if(void 0===this.applyToScene)return mergeObject(t,Utils.getSetting("defaultRegionSettings")),Logger.debug("RegionConfigDialog:getData(general)",{applyToScene:this.applyToScene,data:t}),t;{let i=game.scenes.get(this.applyToScene)?.getFlag(e.ID,"regionSettings")??void 0;return i||(i=Utils.getSetting("defaultRegionSettings")),mergeObject(t,i),Logger.debug("RegionConfigDialog:getData(scene)",{applyToScene:this.applyToScene,data:t}),t}}_updateObject(t,i){const a=expandObject(i);Logger.debug("updateObject, regionConfig",{data:a,scene:this.applyToScene}),void 0===this.applyToScene?Utils.setSetting("defaultRegionSettings",a):game.scenes.get(this.applyToScene).setFlag(e.ID,"regionSettings",a)}}class WeatherConfigDialog extends FormApplication{constructor(e){super(),this.applyToScene=e,Logger.debug("WeatherConfigDialog:constrctor",{applyToScene:e})}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/weatherConfig.hbs",id:"weather-settings",title:"dialogs.weatherConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}activateListeners(e){super.activateListeners(e),Logger.debug("WeatherConfigDialog:activateListeners");0!=e.find('select[name="wind.directionType"]').find(":selected").val()&&e.find("#windTypeGrp").addClass("disabled"),e.find('select[name="wind.directionType"]').on("change",(function(){0!=$(this).find(":selected").val()?e.find("#windTypeGrp").addClass("disabled"):e.find("#windTypeGrp").removeClass("disabled")}));const t=e.find('select[name="clouds.type"]').find(":selected").val();Logger.debug("cloudsType",t),0==t&&(e.find("#cloudSectionGrp").addClass("disabled"),e.find("#preciGrp").addClass("disabled")),e.find('select[name="clouds.type"]').on("change",(function(){const t=$(this).find(":selected").val();Logger.debug("cloudsType.change",t),0==t?(e.find("#cloudSectionGrp").addClass("disabled"),e.find("#preciGrp").addClass("disabled")):(e.find("#cloudSectionGrp").removeClass("disabled"),e.find("#preciGrp").removeClass("disabled"))}));const i=e.find('select[name="precipitation.type"]').find(":selected").val();Logger.debug("preciType",i),0==i&&e.find("#previAmtGrp").addClass("disabled"),e.find('select[name="precipitation.type"]').on("change",(function(){const t=$(this).find(":selected").val();Logger.debug("preciType",t),0==t?e.find("#previAmtGrp").addClass("disabled"):e.find("#previAmtGrp").removeClass("disabled")}))}getData(){let t={windSpeeds:Object.entries(d).map((([e,t])=>"hurricane"===e?{id:120,name:"meteo.hurricane"}:{id:t,name:"meteo."+e})),directionTypes:[{id:0,name:"dialogs.weatherConfig.directionTypes.fixed"},{id:1,name:"dialogs.weatherConfig.directionTypes.noise"}],cloudsTypes:Object.entries(s).map((([e,t])=>"none"===e?{id:0,name:"dialogs.weatherConfig.noClouds"}:{id:t,name:"meteo."+e})),precipitationTypes:Object.entries(n).map((([e,t])=>"none"===e?{id:0,name:"dialogs.weatherConfig.noPrecipitation"}:{id:t,name:"meteo."+e})),windGustTypes:[{id:0,name:"dialogs.weatherConfig.windGustTypes.none"},{id:6,name:"dialogs.weatherConfig.windGustTypes.some"},{id:11,name:"dialogs.weatherConfig.windGustTypes.more"}]};if(void 0===this.applyToScene)return mergeObject(t,Utils.getSetting("defaultWeatherSettings")),Logger.debug("WeatherConfigDialog:getData(general)",{applyToScene:this.applyToScene,data:t}),t;{let i=game.scenes.get(this.applyToScene)?.getFlag(e.ID,"weatherSettings")??void 0;return i||(i=Utils.getSetting("defaultWeatherSettings")),mergeObject(t,i),Logger.debug("WeatherConfigDialog:getData(scene)",{applyToScene:this.applyToScene,data:t}),t}}_updateObject(t,i){const a=expandObject(i);Logger.debug("updateObject, weatherConfig",{data:a,scene:this.applyToScene}),void 0===this.applyToScene?Utils.setSetting("defaultWeatherSettings",a):game.scenes.get(this.applyToScene).setFlag(e.ID,"weatherSettings",a)}}function onChangeFunction(e){Hooks.callAll(i.SETTINGS_UPDATED,e)}const registerSettings=function(){game.settings.register(e.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.registerMenu(e.ID,"defaultRegionSettingsMenu",{name:Utils.i18n("settings.defaultRegionSettingsMenu.name"),label:Utils.i18n("settings.defaultRegionSettingsMenu.label"),hint:Utils.i18n("settings.defaultRegionSettingsMenu.hint"),icon:"fas fa-bars",type:RegionConfigDialog,restricted:!0}),game.settings.register(e.ID,"defaultRegionSettings",{scope:"world",config:!1,type:Object,default:{elevation:0,vegetation:0,waterAmount:0,summer:{temperature:{max:0,avg:0,min:0,var:0},humidity:{max:0,avg:0,min:0,var:0},wind:{avg:0,var:0}},winter:{temperature:{max:0,avg:0,min:0,var:0},humidity:{max:0,avg:0,min:0,var:0},wind:{avg:0,var:0}}}}),game.settings.registerMenu(e.ID,"defaultWeatherSettingsMenu",{name:Utils.i18n("settings.defaultWeatherSettingsMenu.name"),label:Utils.i18n("settings.defaultWeatherSettingsMenu.label"),hint:Utils.i18n("settings.defaultWeatherSettingsMenu.hint"),icon:"fas fa-bars",type:WeatherConfigDialog,restricted:!0}),game.settings.register(e.ID,"defaultWeatherSettings",{scope:"world",config:!1,type:Object,default:{temp:{ground:0,air:0},wind:{speed:0,gusts:0,direction:0,directionType:0},clouds:{coverage:0,bottom:0,thickness:0,type:0},precipitation:{amount:0,type:0},sun:{amount:0},humidity:0}}),game.settings.register(e.ID,"enableFx",{name:Utils.i18n("settings.enableFx.name"),hint:Utils.i18n("settings.enableFx.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction({id:"enableFx",value:e})}}),game.settings.register(e.ID,"cloudsAlpha",{name:Utils.i18n("settings.cloudsAlpha.name"),hint:Utils.i18n("settings.cloudsAlpha.hint"),scope:"client",config:!0,type:Number,range:{min:0,max:100,step:5},default:100,onChange:e=>{onChangeFunction({id:"cloudsAlpha",value:e})}}),game.settings.register(e.ID,"precipitationAlpha",{name:Utils.i18n("settings.precipitationAlpha.name"),hint:Utils.i18n("settings.precipitationAlpha.hint"),scope:"client",config:!0,type:Number,range:{min:0,max:100,step:5},default:100,onChange:e=>{onChangeFunction({id:"precipitationAlpha",value:e})}}),game.settings.register(e.ID,"maxParticles",{name:Utils.i18n("settings.maxParticles.name"),hint:Utils.i18n("settings.maxParticles.hint"),scope:"client",config:!0,type:Number,range:{min:200,max:32e3,step:200},default:3200,onChange:e=>{onChangeFunction({id:"maxParticles",value:e})}}),game.settings.register(e.ID,"uiVisible",{name:"settings.uiVisible.name",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"uiPosition",{name:"settings.uiPosition.name",scope:"client",config:!1,type:Object,default:{top:440,left:15}}),game.settings.register(e.ID,"meteoVisible",{name:"settings.meteoVisible.name",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"meteoPosition",{name:Utils.i18n("settings.meteoPosition.name"),hint:Utils.i18n("settings.meteoPosition.hint"),scope:"client",config:!1,type:Object,default:{top:440,left:15}}),game.settings.register(e.ID,"uiPinned",{name:Utils.i18n("settings.uiPinned.name"),hint:Utils.i18n("settings.uiPinned.hint"),scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"debug",{name:Utils.i18n("settings.debug.name"),hint:Utils.i18n("settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1}),Logger.debug("Settings Registered")};Hooks.on(e.LCCNAME+"WeatherUpdated",(async e=>{Logger.debug("->Hook:WeatherUpdated -> WeatherUI.update(...)"),e.sceneId==canvas.scene._id&&void 0!==e.info&&WeatherUi.update(e.info)})),Hooks.on("renderWeatherUi",(()=>{Logger.debug("->Hook:renderWeatherUi"),WeatherUi.update()}));class WeatherUi extends FormApplication{static _isOpen=!1;static _weatherInfo={};async _render(t=!1,i={}){await super._render(t,i),game.settings.get(e.ID,"uiPinned")&&WeatherUi.pinApp(),WeatherUi._isOpen=!0,delete ui.windows[this.appId]}async close(t={}){return t.sceneWeather&&(WeatherUi._isOpen=!1,game.settings.set(e.ID,"uiVisible",!1)),super.close(t)}constructor(){super()}static get defaultOptions(){return document.getElementById("players"),this.initialPosition=game.settings.get(e.ID,"uiPosition"),mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,width:200,height:100,submitOnChange:!0,closeOnSubmit:!1,minimizable:!1,template:"modules/"+e.ID+"/templates/weatherUi.hbs",id:"scene-weather-app",title:"SceneWeather",top:this.initialPosition.top,left:this.initialPosition.left})}async _updateObject(e,t){Logger.debug("WeatherUi._updateObjec",{event:e,formData:t})}getData(){return WeatherUi._weatherInfo}activateListeners(t){super.activateListeners(t);const i=t.find("#dragHandle")[0],a=new Draggable(this,t,i,!1);let n=!1;a._onDragMouseMove=function _newOnDragMouseMove(e){e.preventDefault();const t=document.getElementById("players").getBoundingClientRect(),i=Date.now();if(i-this._moveTime<1e3/60)return;this._moveTime=i;const{left:a,top:s}=this.element.getBoundingClientRect();WeatherUi.unPinApp()&&Object.assign(this.position,{left:a,top:s}),this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)});let r=t.top-50,o=t.top+50;e.clientX>t.left&&e.clientX<t.left+t.width&&e.clientY>r&&e.clientY<o?($("#scene-weather-app").css("animation","jiggle 0.2s infinite"),n=!0):($("#scene-weather-app").css("animation",""),n=!1)},a._onDragMouseUp=async function _newOnDragMouseUp(t){t.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp);let i=document.getElementById("players").getBoundingClientRect().height+50;if(n)WeatherUi.pinApp(),await game.settings.set(e.ID,"uiPinned",!0),this.app.setPosition({left:15,top:window.innerHeight-i});else{let t=$("#scene-weather-app").position(),i={top:t.top,left:t.left};await game.settings.set(e.ID,"uiPosition",i),await game.settings.set(e.ID,"uiPinned",!1)}$("#scene-weather-app").css("animation","")}}static async pinApp(){const t=game.modules.get(e.ID).uiApp;t&&!t.element.hasClass("pinned")&&($("#players").before(t.element),t.element.addClass("pinned"))}static unPinApp(){const t=game.modules.get(e.ID).uiApp;if(t&&t.element.hasClass("pinned")){const e=t.element;return $("body").append(e),e.removeClass("pinned"),!0}}static async toggleAppVis(t){"toggle"===t?!0===game.settings.get(e.ID,"uiVisible")?($("#scene-weather-app").stop(),$("#scene-weather-app").css({animation:"close 0.3s",opacity:"0"}),setTimeout((function(){game.modules.get(e.ID).uiApp.close({sceneWeather:!0})}),200)):(WeatherUi._isOpen&&game.modules.get(e.ID).uiApp.close({sceneWeather:!0}),game.modules.get(e.ID).uiApp=await(new WeatherUi).render(!0),game.settings.set(e.ID,"uiVisible",!0)):!0===game.settings.get(e.ID,"uiVisible")&&(game.modules.get(e.ID).uiApp=await(new WeatherUi).render(!0))}static async update(t=null){if(null==t&&(t=WeatherUi._weatherInfo),Logger.debug("WeatherUi.update(...)",{weatherInfo:t}),WeatherUi._weatherInfo=t,!0===game.settings.get(e.ID,"uiVisible")){const e=SceneWeather.getPerceptiveWeatherI18n(t);$("#weatherInfo").html(e)}}}Hooks.on(e.LCCNAME+"WeatherUpdated",(async e=>{e.sceneId==canvas.scene._id&&void 0!==e.model&&MeteoUi.update()}));class MeteoUi extends FormApplication{static _isOpen=!1;static _context=void 0;static _fromHr=-12;static _toHr=12;async _render(e=!1,t={}){await super._render(e,t),MeteoUi._isOpen=!0,MeteoUi._context=document.getElementById("meteogramCanvas"),MeteoUi._chart=void 0,MeteoUi._drawWeatherModelData(),delete ui.windows[this.appId]}async close(t={}){return t.sceneWeather&&(MeteoUi._isOpen=!1,MeteoUi._context=void 0,game.settings.set(e.ID,"meteoVisible",!1)),super.close(t)}constructor(){super()}static get defaultOptions(){return this.initialPosition=game.settings.get(e.ID,"meteoPosition"),mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,width:600,height:400,submitOnChange:!1,closeOnSubmit:!1,minimizable:!1,template:"modules/"+e.ID+"/templates/meteoUi.hbs",id:"scene-weather-meteo-app",title:"SceneWeather Meteogram",top:this.initialPosition.top,left:this.initialPosition.left})}async _updateObject(e,t){Logger.debug("MeteoUi._updateObjec",{event:e,formData:t})}getData(){return{}}activateListeners(t){super.activateListeners(t);const i=t.find("#dragHandle")[0],a=new Draggable(this,t,i,!1);a._onDragMouseMove=function _newOnDragMouseMove(e){e.preventDefault();const t=Date.now();t-this._moveTime<1e3/60||(this._moveTime=t,this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)}))},a._onDragMouseUp=async function _newOnDragMouseUp(t){t.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp);let i=$("#scene-weather-meteo-app").position(),a={top:i.top,left:i.left};await game.settings.set(e.ID,"meteoPosition",a)}}static async toggleAppVis(t){"toggle"===t?!0===game.settings.get(e.ID,"meteoVisible")?($("#scene-weather-meteo-app").stop(),$("#scene-weather-meteo-app").css({animation:"close 0.3s",opacity:"0"}),setTimeout((function(){game.modules.get(e.ID).meteoApp.close({sceneWeather:!0})}),200)):(MeteoUi._isOpen&&game.modules.get(e.ID).meteoApp.close({sceneWeather:!0}),game.modules.get(e.ID).meteoApp=await(new MeteoUi).render(!0),game.settings.set(e.ID,"meteoVisible",!0)):!0===game.settings.get(e.ID,"meteoVisible")&&(game.modules.get(e.ID).meteoApp=await(new MeteoUi).render(!0))}static async update(){Logger.debug("Updating MeteoUi"),!0===game.settings.get(e.ID,"meteoVisible")&&MeteoUi._drawWeatherModelData()}static async _drawWeatherModelData(){const e=MeteoUi._fromHr,t=MeteoUi._toHr,i=MeteoUi._context;if(void 0===i)return void Logger.debug("No Context Yet");let a={labels:[],datasets:[]},n={label:"tempGround",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff0000",borderDash:[5,5],yAxisID:"y"},s={label:"tempAir",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff4400",borderDash:[5,5],yAxisID:"y"},r={label:"tempPercieved",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff0044",yAxisID:"y"},o={label:"windSpeed",data:[],borderWidth:1,pointRadius:0,borderColor:"rgba(20, 200, 0, 0.9)",yAxisID:"y"},l={label:"windGusts",data:[],borderWidth:1,pointRadius:0,borderColor:"rgba(0, 200, 0, 0.8)",borderDash:[5,5],yAxisID:"y"},d={label:"windDirection",data:[],borderWidth:1,showLine:!1,borderColor:"#b74"},c={label:"cloudsCoverage",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(128, 128, 128, 0.3)",fill:!0,stepped:!0,yAxisID:"y2"},g={label:"precipitationAmount",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(60,60,255,0.2)",fill:!0,yAxisID:"y2"},u={label:"sunAmount",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(255, 255, 0, 0.6)",fill:!0,yAxisID:"y2"},h={label:"humidity",data:[],borderWidth:1,pointRadius:0,borderColor:"#9999ff",yAxisID:"y2"};const m=SceneWeatherApi.getSceneWeatherProvider();for(let i=e;i<t;i++){const e=m.weatherModel.getWeatherData(0,i);n.data.push(e.temp.ground),s.data.push(e.temp.air),r.data.push(e.temp.percieved),o.data.push(e.wind.speed),l.data.push(e.wind.gusts),d.data.push(e.wind.direction/10),c.data.push(100*e.clouds.coverage),g.data.push(100*e.precipitation.amount),u.data.push(100*e.sun.amount),h.data.push(e.humidity),i<0?a.labels.push(i+"h"):i>0?a.labels.push("+"+i+"h"):a.labels.push("now")}a.datasets.push(n),a.datasets.push(s),a.datasets.push(r),a.datasets.push(o),a.datasets.push(l),a.datasets.push(d),a.datasets.push(c),a.datasets.push(g),a.datasets.push(u),a.datasets.push(h);let p={type:"line",data:a,options:{layout:{autoPadding:!1},interaction:{mode:"nearest",axis:"x",intersect:!1},plugins:{legend:{position:"right",labels:{usePointStyle:!0}}},responsive:!1,animation:!1,scales:{x:{position:"bottom"},y:{display:!0,position:"left",type:"linear",min:-30,max:70,title:{display:!0,text:"°C"},grid:{color:function(e){return 0==e.tick.value?"rgba(0,0,0,1)":"rgba(80,80,80,0.3)"}}},y2:{position:"right",type:"linear",min:0,max:100,title:{display:!0,text:"%"}}}}};if(void 0===MeteoUi._chart)MeteoUi._chart=new Chart(i,p),Logger.debug("MeteoUI::new",{ctx:i,chart:MeteoUi._chart});else{Logger.debug("MeteoUi::update");for(let e=0;e<MeteoUi._chart.data.datasets.length;e++)MeteoUi._chart.data.datasets[e].data=a.datasets[e].data;MeteoUi._chart.data.labels=a.labels,MeteoUi._chart.update()}}}class WeatherEffect extends ParticleEffect{static label="sceneweather.fxname";static _getFxEmittersForModel(e){let t=[];return game.sceneWeather.generators.forEach((i=>{let a=i.getEmitter(e);a&&t.push(a)})),Logger.debug("WeatherEffect._getFxEmittersForModel()",{model:e,gen:game.sceneWeather.generators,emitters:t}),t}static _equalizeMaxParticles(e,t){let i=0,a=0;for(let t=0;t<e.length;t++){const n=e[t];i+=n.maxParticles,a+=n.weight}if(i<=t)return e;let n=0;for(let t=0;t<e.length;t++){const i=e[t];n+=i.maxParticles*(i.weight/a)}n=t/n;for(let t=0;t<e.length;t++){const i=e[t];i.maxParticles*=n*(i.weight/a)}return Logger.debug("WeatherEffect._equalizeMaxParticles()",{totalParticles:i,maxParticles:t}),e}play({easeIn:e=!0}={}){e||this.emitters.forEach((e=>{e.autoUpdate=!1,e.emit=!0,e.update(e.maxLifetime),e.autoUpdate=!0})),super.play()}getParticleEmitters(e={}){if(Logger.debug("WeatherEffect.getParticleEmitters(...)",{options:e}),void 0===e.data||void 0===e.data.model)return Logger.debug("WeatherEffect.getParticleEmitters() no model data contained, no emitters."),[];const t=WeatherEffect._getFxEmittersForModel(e.data.model),i=Utils.getSetting("maxParticles",3200);WeatherEffect._equalizeMaxParticles(t,i);let a=[];return t.forEach((e=>{a.push(this.createEmitter(e))})),a}async softStop({gracePeriod:e}={}){const t=this.emitters.map((t=>new Promise((i=>{let a=t._activeParticlesFirst;for(;null!=a;){const t=e,i=Math.max(a.age,a.maxLife-t);a.age=i,a.agePercent=a.age*a.oneOverLife,a=a.next}t.emitterLifetime=0,t.playOnceAndDestroy((()=>{i()}))})))),i=[Promise.all(t)];void 0!==e&&i.push(new Promise((t=>setTimeout(t,1e3*e))).then(this.destroy.bind(this))),await Promise.race(i),this.stop()}}Hooks.on(e.LCCNAME+"SettingsUpdated",(async e=>{Logger.debug("-> Hooks::SettingsUpdated -> WeatherEffectsLayer.draw*Effects",{data:e}),["cloudsAlpha","precipitationAlpha","maxParticles","enableFx"].includes(e.id)&&SceneWeatherApi.calculateWeather({force:!0})})),Hooks.on(e.LCCNAME+"WeatherUpdated",(async e=>{Logger.debug("-> Hooks::WeatherUpdated -> WeatherEffectsLayer.draw*Effects",{data:e}),void 0!==canvas.sceneweatherfx?await Promise.all([canvas.sceneweatherfx.drawParticleEffects({soft:!e.force,data:e}),canvas.sceneweatherfx.drawFilterEffects({soft:!e.force,data:e})]):Logger.debug("No canvas.sceneweatherfx")}));class WeatherEffectsLayer extends CanvasLayer{particleEffectsContainer;activeEffects=[];activeFilters={};constructor(){super(),canvas.app.ticker.add(this.handleTick,this)}static getFxFiltersForModel(e){let t={};return game.sceneWeather.filters.forEach((i=>{foundry.utils.mergeObject(t,i.getFilterConfig(e))})),Logger.debug("WeatherEffectsLayer.getFxFiltersForModel()",{model:e,filter:t}),t}get elevation(){return(canvas.weather?.elevation??9999)+1}set elevation(e){const t=canvas.weather;t&&(t.elevation=e-1)}static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"weather-particle-effects"})}async _draw(){Logger.debug("WeatherEffectsLayer._draw()",{this:this})}async _tearDown(){return Logger.debug("WeatherEffectsLayer._tearDown()",{effects:this.activeEffects}),this.activeEffects.forEach((e=>{e.destroy()})),this.activeEffects=[],this.particleEffectsContainer=void 0,super._tearDown()}handleTick(){for(const e in this.activeFilters)this.activeFilters[e].step()}async drawFilterEffects(e){if(Logger.debug("WeatherEffectsLayer.drawFilterEffects(...)",{options:e}),e=foundry.utils.mergeObject({soft:!1},e),!canvas.scene)return;const t=Object.values(this.activeFilters).map((e=>e.destroy()));await Promise.all(t);const i=Object.values(this.activeFilters);if(canvas.environment.filters=canvas.environment.filters?.filter((function(e){return!i.find((function(t){return e===t}))}))??[],this.activeFilters={},!Utils.getSetting("enableFx",!0))return;if(void 0===e.data||void 0===e.data.model)return void Logger.debug("WeatherEffectsLayer.drawFilterEffects() no model data contained, no filters.");const a=WeatherEffectsLayer.getFxFiltersForModel(e.data.model);Object.entries(a).map((([t,i])=>{this.activeFilters[t]=new i.type({soft:e.soft,options:foundry.utils.mergeObject(i,{"-=type":null},{performDeletions:!0})}),canvas.environment.filters.push(this.activeFilters[t])}))}async drawParticleEffects(e){if(e=foundry.utils.mergeObject({soft:!1},e),!canvas.scene)return;this.particleEffectsContainer||(this.particleEffectsContainer=this.addChild(new PIXI.Container));const t=Promise.all(this.activeEffects.map((async t=>{e.soft?await t.softStop({gracePeriod:10}):(t.destroy(),t.stop());const i=this.activeEffects.indexOf(t);i>-1&&this.activeEffects.splice(i,1)})));if(Utils.getSetting("enableFx",!0)){const t=new WeatherEffect(this.particleEffectsContainer,e);t.play({easeIn:e.soft}),this.activeEffects.push(t)}Logger.debug("waiting for emitters to clean up (softly)",{effects:this.activeEffects,soft:e.soft}),await t,Logger.debug("cleaned up emitters",{effects:this.activeEffects})}}class WeatherLayer extends InteractionLayer{static registerLayers(){CONFIG.Canvas.layers.sceneweather={layerClass:WeatherLayer,group:"interface"},CONFIG.Canvas.layers.sceneweatherfx={layerClass:WeatherEffectsLayer,group:"primary"}}static registerLayerButtons(){Hooks.on("getSceneControlButtons",(i=>{const a=[{name:"Toggle Weather UI",title:"Toggle Weather UI",icon:"fas fa-solid fa-window-maximize",visible:game.user.isGM,toggle:!0,active:WeatherUi._isOpen,onClick:()=>{WeatherUi.toggleAppVis("toggle")}},{name:"Toggle Meteogram",title:"Toggle Meteogram",icon:"fas fa-solid fa-chart-line",visible:game.user.isGM&&[t.REGION_TEMPLATE,t.REGION_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED)),toggle:!0,active:MeteoUi._isOpen,onClick:()=>{MeteoUi.toggleAppVis("toggle")}},{name:"Weather Settings",title:"Weather Settings",icon:"fas fa-solid fa-sliders",visible:game.user.isGM&&[t.WEATHER_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED)),button:!0,onClick:()=>{if(game.user.isGM&&[t.WEATHER_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED))){new WeatherConfigDialog(canvas.scene._id).render(!0)}}},{name:"Region Settings",title:"Region Settings",icon:"fas fa-solid fa-sliders",visible:game.user.isGM&&[t.REGION_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED)),button:!0,onClick:()=>{if(game.user.isGM&&[t.REGION_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED))){new RegionConfigDialog(canvas.scene._id).render(!0)}}},{name:"Weather Effects Enabled",title:"Weather Effects Enabled",icon:"fas fa-solid fa-eye",toggle:!0,active:Utils.getSetting("enableFx",!0),onClick:()=>{const t=!Utils.getSetting("enableFx",!0);Utils.setSetting("enableFx",t),Hooks.callAll(e.LCCNAME+"SettingsUpdated",{id:"enableFx",value:t})}},{name:"Some Button",title:"Some Button",icon:"fas fa-solid fa-square-xmark",button:!0,onClick:()=>{}}];i.splice(i.findIndex((e=>"sounds"===e.name))+1,0,{name:"Scene Weather",title:"Scene Weather",icon:"fas fa-solid fa-cloud-bolt-sun",layer:"sceneweather",tools:a})}))}static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"sceneweather",canDragCreate:!1,controllableObjects:!0,rotatableObjects:!0,zIndex:666})}selectObjects(e){canvas.tokens.selectObjects(e)}}class WeatherTab{static async addControlsTab(t,i){Logger.debug("addControlsTab",{app:t,jQ:i});let a=t.document.flags[e.ID],n={weatherMode:"disabled",weatherTemplate:"default",regionTemplate:"plains",timeProvider:"manual",seed:0};mergeObject(n,a,{overwrite:!0});let s={data:n,timeProviders:[{id:"internal",name:"Use SceneWeather as time source"},{id:"external",name:"Use an external time source"},{id:"simple-calendar",name:"Use Simple Calendar as time source"}],rainModes:[{id:"winddir",name:"Same as winddirection"},{id:"topdown",name:"Always straight from top to bottom"},{id:"slanted",name:"Always slanted, from top to bottom"},{id:"windinfluence",name:"Direction influenced by winddirection and speed"}],weatherModes:[{id:"disabled",name:"Disabled (Use foundry default ambience)",hint:"Scene Weather is disabled. All ambience effects and types are set via the foundry default settings in Ambience."},{id:"weatherTemplate",name:"Use weather template (static)",hint:"Set a weather for the scene from a select choice of templates. The weather is static and will remain like that unless manually changed."},{id:"weatherAuto",name:"Manual weather settings (static)",hint:"Set the weather for the scene from manual set individual settings. The weather is static and will remain like that unless manually changed."},{id:"regionTemplate",name:"Use region template (dynamic)",hint:"Let the weather be generated based on a selected region template from a choice list. The weather will change dynamically based on given time of day and the season in the year. If an automatic calendar or time module is installed, it will change with the flow of time."},{id:"regionAuto",name:"Manual region settings (dynamic)",hint:"Let the weather be generated based on set attributes for the scene like mean temperature or elevation. The weather is dependant on a current time/date that needs to be provided to generate the dynamic weather based on all those parameters."}],weatherTemplates:[],regionTemplates:[]};s.weatherTemplates=WeatherModel.getTemplates(),s.regionTemplates=RegionMeteo.getTemplates(),Logger.debug("Render TabData with",{tabData:s});const r=await renderTemplate("modules/"+e.ID+"/templates/weatherTab.hbs",s);$(".sheet-tabs",i).append($("<a>").addClass("item").attr("data-tab","weather").html('<i class="fas fa-solid fa-cloud-bolt-sun"></i> Weather')),$("<div>").addClass("tab").attr("data-tab","weather").insertAfter($('div[data-tab="ambience"]',i)).append(r),WeatherTab.activateListeners(t,i,s.data.weatherMode)}static activateListeners(e,t,i){Logger.debug("WeatherTab.activateListeners",{app:e,jQ:t,select:i}),t.find('div[id="sceneWeather.mode.'+i+'"]').addClass("active"),t.find('div[id="not_sceneWeather.mode.'+i+'"]').removeClass("active"),t.find('button[data-key="flags.scene-weather.regionConfig"]').on("click",(function(){Logger.debug("Clicked Config Region for Scene",{sceneId:e.document._id});new RegionConfigDialog(e.document._id).render(!0)})),t.find('button[data-key="flags.scene-weather.weatherConfig"]').on("click",(function(){Logger.debug("Clicked Config Weather for Scene",{sceneId:e.document._id});new WeatherConfigDialog(e.document._id).render(!0)})),t.find('select[name="flags.scene-weather.weatherMode"]').on("change",(function(){let i=$(this).find(":selected").val();t.find("div.sceneWeather-collapsibleModeOption").each((function(){$(this).attr("id").startsWith("not_sceneWeather.mode.")?$(this).attr("id")=="not_sceneWeather.mode."+i?$(this).removeClass("active"):$(this).addClass("active"):$(this).attr("id")=="sceneWeather.mode."+i?$(this).addClass("active"):$(this).removeClass("active")})),e.setPosition({height:"auto"}),Logger.debug("onChange",{app:e,jQ:t})}))}}Hooks.once("init",(()=>{registerSettings(),Logger.debug("->Hook:init"),registerHbHelpers(),loadHandlebars(),SceneWeatherApi.registerApi(),Hooks.callAll(e.LCCNAME+"RegisterGenerators"),Hooks.callAll(e.LCCNAME+"RegisterFilters"),Hooks.callAll(i.REG_TEMPLATE_REGION),Hooks.callAll(i.REG_TEMPLATE_WEATHER),Logger.debug("Init Done",{api:game.sceneWeather}),Hooks.callAll(e.LCCNAME+"Initialized")})),Hooks.on(e.LCCNAME+"Initialized",(async()=>{Logger.debug("->Hook:"+e.LCCNAME+"Initialized"),Hooks.on("updateScene",(async(t,i,a,n)=>{void 0!==i.flags&&void 0!==i.flags[e.ID]&&(Logger.debug("updateScene-> ",{deltaData:i,options:a}),SceneWeatherApi.updateWeatherConfig({forSceneId:i._id,force:!0}))})),Hooks.on("renderSceneConfig",(async(e,t,i)=>{Logger.debug("renderSceneConfig",{app:e,jQ:t,data:i}),WeatherTab.addControlsTab(e,t)}))})),Hooks.once("setup",(()=>{Logger.debug("->Hook:setup"),WeatherLayer.registerLayers(),WeatherLayer.registerLayerButtons()})),Hooks.on("canvasReady",(async t=>{Logger.debug("->Hook:canvasReady(...)",{canvas:t}),WeatherUi.toggleAppVis("initial"),game.settings.get(e.ID,"uiPinned")&&WeatherUi.pinApp(),MeteoUi.toggleAppVis("initial"),SceneWeatherApi.calculateWeather({force:!0})})),Hooks.on("ready",(async()=>{Hooks.callAll(e.LCCNAME+"Ready"),Logger.info("Ready")})),Hooks.on(e.LCCNAME+"Ready",(async()=>{Logger.debug("->Hook:"+e.LCCNAME+"Ready")})),Hooks.on("updateWorldTime",((e,t,i,a)=>{Logger.debug("->Hook:updateWorldTime",{worldTime:e,delta:t,options:i,userId:a}),["regionTemplate","regionAuto"].includes(Utils.getSceneFlag("weatherMode","disabled"))&&SceneWeatherApi.calculateWeather()}));class ColorFilter extends PIXI.filters.AdjustmentFilter{constructor({options:e={},soft:t=!1}={}){super();const{color:i,...a}=foundry.utils.mergeObject({tint:"#ffffff",saturation:1,gamma:1,brightness:1,contrast:1},e),{r:n,g:s,b:r}=foundry.utils.Color.from(e.tint),o={...a,red:n,green:s,blue:r},l=Object.keys(o);for(const e of l)this.optionContext[e]=o[e];this.enabled=!0}get optionContext(){return this}async destroy(){return this.enabled=!1,!0}async step(){}}class Generators{static _scaleValues(e,t){e.list=e.list.map((e=>({...e,value:e.value*t})))}static _scaleRange(e,t){e.min=e.min*t,e.max=e.max*t}static _getTransposedPosition(e,t,i,a,n,s){const r=e+i/2,o=t+a/2,l=s*Math.PI/180;return{x:r+n*Math.cos(l)-i/2,y:o+n*Math.sin(l)-a/2}}static applyGeneratorToEmitterConfig(e,t){const i=2/3,a=canvas.dimensions.sceneRect;t.maxParticles=canvas.dimensions.width/canvas.dimensions.size*(canvas.dimensions.height/canvas.dimensions.size)*e.density;const n=t.behaviors.find((({type:e})=>"moveSpeedStatic"===e))?.config;if(void 0!==n){const s=(n.min+n.max)/2,r=Math.sqrt(a.width*a.width+a.height*a.height),o=r/s,l=o/i/2,d=o/i;t.lifetime={min:l,max:d},t.frequency=(l+d)/2/t.maxParticles;const c=Generators._getTransposedPosition(a.x,a.y,a.width,a.height,r/4,(e.direction+180)%360);t.behaviors.push({type:"spawnShape",config:{type:"rect",data:{x:c.x,y:c.y,w:a.width,h:a.height}}})}else{t.frequency=(t.lifetime.min+t.lifetime.max)/2/t.maxParticles;const e=canvas.dimensions.sceneRect;t.behaviors.push({type:"spawnShape",config:{type:"rect",data:{x:e.x-e.width/4,y:e.y-e.height/4,w:1.5*e.width,h:1.5*e.height}}})}void 0!==e.alpha&&t.behaviors.filter((e=>"alpha"===e.type)).forEach((({config:t})=>Generators._scaleValues(t.alpha,e.alpha)));let s=e.scale*(canvas.dimensions.size/100);t.behaviors.filter((e=>"scale"===e.type)).forEach((({config:e})=>Generators._scaleValues(e.scale,s))),t.behaviors.filter((e=>"scaleStatic"===e.type)).forEach((({config:e})=>Generators._scaleRange(e,s))),s=e.speed*(canvas.dimensions.size/100),t.behaviors.filter((e=>["moveSpeed","movePath"].includes(e.type))).forEach((({config:e})=>Generators._scaleValues(e.speed,s))),t.behaviors.filter((e=>"moveSpeedStatic"===e.type)).forEach((({config:e})=>Generators._scaleRange(e,s))),Generators._scaleRange(t.lifetime,1/s),t.frequency/=s;const r=e.direction;void 0!==r&&(t.behaviors.filter((e=>"rotation"===e.type)).forEach((({config:e})=>{const t=e.maxStart-e.minStart;e.minStart=r-t/2,e.maxStart=r+t/2})),t.behaviors.filter((e=>"rotationStatic"===e.type)).forEach((({config:e})=>{const t=e.max-e.min;e.min=r-t/2,e.max=r+t/2})));const o=e.lifetime;Generators._scaleRange(t.lifetime,o),t.frequency*=o,null!=e.tint&&(t.behaviors=t.behaviors.filter((({type:e})=>"color"!==e&&"colorStatic"!==e)).concat({type:"colorStatic",config:{color:e.tint}}))}}Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{Logger.debug("registered generator for cumulus"),game.sceneWeather.generators.push({name:"cumulus",getEmitter:function(t){if(Utils.getSetting("cloudsAlpha",100)<2)return;if(![s.cumulus,s.cumulunimbus].includes(t.clouds.type))return null;let i={alpha:Utils.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:Utils.map(t.wind.speed,10,70,.2,3),scale:Utils.map(t.clouds.coverage,.3,1,.8,1),lifetime:1,density:Utils.map(t.clouds.coverage,.2,1,.005,.02),tint:null};4==t.clouds.type&&(i.tint="#B0B0B0",i.density=.001);const a=foundry.utils.deepClone({weight:.8,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.58,max:3.3}},{type:"rotationStatic",config:{min:85,max:95}},{type:"textureRandom",config:{textures:Array.fromRange(5).map((t=>"modules/"+e.ID+`/assets/cu${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}})}));class FlashFilter extends PIXI.filters.AdjustmentFilter{options;constructor({options:e={},soft:t=!1}={}){super(),this.options=foundry.utils.mergeObject({frequency:0,duration:0,brightness:1,nextTime:canvas.app.ticker.lastTime/10},e);const i=Object.keys(this.options);for(const e of i)this.optionContext[e]=this.options[e];this.enabled=!0}get optionContext(){return this}async discard(){return this.enabled=!1,!0}async step(){if(canvas.app.ticker.lastTime/10>this.options.nextTime){this.options.nextTime=canvas.app.ticker.lastTime/10+40+this.options.frequency*Math.random();const animate=t=>{const i=[{parent:this,attribute:"brightness",to:t}];return CanvasAnimation.animate(i,{name:e.ID+`.${this.constructor.name}.${randomID()}`,context:this,duration:100+this.options.duration*Math.random(),easing:function(e){const t=2.5949095;return e<.5?Math.pow(2*e,2)*(7.189819*e-t)/2:(Math.pow(2*e-2,2)*((t+1)*(2*e-2)+t)+2)/2}})};await animate(this.options.brightness),await animate(1)}}}Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{Logger.debug("registered generator for fog"),game.sceneWeather.generators.push({name:"fog",getEmitter:function(t){if(Utils.getSetting("cloudsAlpha",100)<2)return;if(t.clouds.type!=s.fog)return null;const i={alpha:Utils.getSetting("cloudsAlpha",100)/100,direction:0,speed:1,scale:1,lifetime:1,density:Utils.map(t.clouds.coverage,.2,1,.01,1),tint:null},a=foundry.utils.deepClone({weight:.9,lifetime:{min:10,max:25},behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.1,time:.1},{value:.3,time:.5},{value:.1,time:.9},{value:0,time:1}]}}},{type:"moveSpeed",config:{speed:{list:[{time:0,value:15},{time:1,value:10}]},minMult:.2}},{type:"scale",config:{scale:{list:[{value:2.5,time:0},{value:2,time:1}]},minMult:.5}},{type:"rotation",config:{accel:0,minSpeed:.15,maxSpeed:.35,minStart:0,maxStart:365}},{type:"textureRandom",config:{textures:Array.fromRange(3).map((t=>"modules/"+e.ID+`/assets/fg${t+1}.webp`))}},{type:"colorStatic",config:{color:"dddddd"}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}})})),Hooks.on(e.LCCNAME+"RegisterFilters",(async()=>{Logger.debug("registered filter for freeze"),game.sceneWeather.filters.push({name:"freeze",getFilterConfig:function(e){let t={};return e.temp.air<0&&(t.freeze={type:ColorFilter,tint:Utils.mapColorHex(e.temp.air+10,0,10,"#E1F3FE","#FFFFFF"),saturation:1-Utils.map(e.temp.air+10,10,0,0,.4),gamma:1,brightness:1,contrast:1}),t}})})),Hooks.on(e.LCCNAME+"RegisterFilters",(async()=>{Logger.debug("registered filter for heatglare"),game.sceneWeather.filters.push({name:"heatglare",getFilterConfig:function(e){let t={};return e.sun.amount>.8&&e.temp.air>30&&(t.heatglare={type:ColorFilter,tint:Utils.mapColorHex(e.sun.amount,.8,1,"#ffffff","#FFF3D1"),saturation:1,gamma:1,brightness:Utils.map(e.sun.amount,.8,1,1,1.4),contrast:Utils.map(e.temp.air,30,50,1,1.5)}),t}})})),Hooks.on(e.LCCNAME+"RegisterFilters",(async()=>{Logger.debug("registered filter for lightning"),game.sceneWeather.filters.push({name:"lightning",getFilterConfig:function(e){let t={};return e.clouds.type>s.cumulus&&[n.rain,n.downpour,n.hail].includes(e.precipitation.type)&&e.precipitation.amount>.3&&(t.lightning={type:FlashFilter,frequency:2e3-Utils.map(e.precipitation.amount,.3,1,0,1600),duration:100,brightness:1.2},t.cloudcolor={type:ColorFilter,tint:"#D1CBD7",saturation:1,gamma:1,brightness:1,contrast:1}),t}})})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{Logger.debug("registered generator for cumulus"),game.sceneWeather.generators.push({name:"cumulus",getEmitter:function(t){if(Utils.getSetting("cloudsAlpha",100)<2)return;if(t.clouds.type!=s.cumulunimbus)return null;let i={alpha:Utils.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:Utils.map(t.wind.speed,10,70,.2,3),scale:Utils.map(t.clouds.coverage,.3,1,.8,1),lifetime:1,density:Utils.map(t.clouds.coverage,.2,1,.005,.02),tint:null};const a=foundry.utils.deepClone({weight:.9,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.08,max:2.8}},{type:"rotationStatic",config:{min:90,max:90}},{type:"textureRandom",config:{textures:Array.fromRange(4).map((t=>"modules/"+e.ID+`/assets/tcu${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}})})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{Logger.debug("registered generator for rain"),game.sceneWeather.generators.push({name:"rain",getEmitter:function(e){if(Utils.getSetting("precipitationAlpha",100)<2)return;if(![n.drizzle,n.rain,n.downpour,n.hail].includes(e.precipitation.type))return null;let t=90;switch(e.precipitation.mode??"winddir"){case"winddir":default:t=(Math.round(e.wind.direction)+90)%360;break;case"topdown":t=90;break;case"slanted":t=75;break;case"windinfluence":t=90+Math.sin(e.wind.direction*Math.PI/180)*Utils.map(e.wind.speed,10,70,3,45)}const i={alpha:Utils.getSetting("precipitationAlpha",100)/100,direction:t,speed:Utils.map(e.precipitation.amount,.4,.95,.6,2),scale:1,lifetime:Utils.map(e.precipitation.amount,.4,.95,1,.5),density:Utils.map(e.precipitation.amount,.4,.95,.01,4),tint:null},a=foundry.utils.deepClone({weight:.2,lifetime:{min:.5,max:.5},pos:{x:0,y:0},behaviors:[{type:"alpha",config:{alpha:{list:[{time:0,value:.7},{time:1,value:.1}]}}},{type:"moveSpeedStatic",config:{min:2800,max:3500}},{type:"scaleStatic",config:{min:.8,max:1}},{type:"rotationStatic",config:{min:89,max:91}},{type:"textureSingle",config:{texture:"ui/particles/rain.png"}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}})})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{Logger.debug("registered generator for snow"),game.sceneWeather.generators.push({name:"snow",getEmitter:function(e){if(Utils.getSetting("precipitationAlpha",100)<2)return;if(![n.snow,n.blizzard].includes(e.precipitation.type))return null;let t=90;switch(e.precipitation.mode??"winddir"){case"winddir":default:t=(Math.round(e.wind.direction)+90)%360;break;case"topdown":t=90;break;case"slanted":t=75;break;case"windinfluence":t=90+Math.sin(e.wind.direction*Math.PI/180)*Utils.map(e.wind.speed,10,70,10,90)}const i={alpha:Utils.getSetting("precipitationAlpha",100)/100,direction:t,speed:Utils.map(e.wind.speed,10,70,.3,5),scale:1,lifetime:Utils.map(e.precipitation.amount,.4,.95,1,.7),density:Utils.map(e.precipitation.amount,.4,.95,.01,3),tint:null},a=Utils.deepClone({weight:.2,lifetime:{min:4,max:4},behaviors:[{type:"alpha",config:{alpha:{list:[{time:0,value:.9},{time:1,value:.5}]}}},{type:"moveSpeed",config:{speed:{list:[{time:0,value:190},{time:1,value:210}]},minMult:.6}},{type:"scale",config:{scale:{list:[{time:0,value:.2},{time:1,value:.4}]},minMult:.5}},{type:"rotation",config:{accel:0,minSpeed:0,maxSpeed:200,minStart:50,maxStart:75}},{type:"textureSingle",config:{texture:"ui/particles/snow.png"}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}})})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{Logger.debug("registered generator for stratus"),game.sceneWeather.generators.push({name:"stratus",getEmitter:function(t){if(Utils.getSetting("cloudsAlpha",100)<2)return;if(![s.stratus,s.cumulus,s.cumulunimbus].includes(t.clouds.type))return null;let i={alpha:Utils.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:Utils.map(t.wind.speed,10,100,.2,2.5),scale:Utils.map(t.clouds.coverage,.3,1,1,2),lifetime:1,density:Utils.map(t.clouds.coverage,.2,1,.001,.01),tint:null};3==t.clouds.type&&(i.tint="#A0A0A0",i.density=.007,i.scale=1),4==t.clouds.type&&(i.tint="#808080",i.density=.01,i.scale=1.2);const a=foundry.utils.deepClone({weight:.7,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.58,max:3.3}},{type:"rotationStatic",config:{min:80,max:100}},{type:"textureRandom",config:{textures:Array.fromRange(6).map((t=>"modules/"+e.ID+`/assets/st${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{Logger.debug("registered regionTemplate for alpine"),Utils.getApi().regionTemplates.push({id:"alpine",name:"templates.region.alpine.name",description:"templates.region.alpine.description",elevation:1e3,vegetation:0,waterAmount:0,summer:{temperature:{day:15,night:5,var:7.5},humidity:{day:50,night:60,var:5},wind:{avg:30,var:10},sun:{hours:14}},winter:{temperature:{day:0,night:-15,var:7.5},humidity:{day:70,night:60,var:5},wind:{avg:40,var:20},sun:{hours:10}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{Logger.debug("registered regionTemplate for chaparral"),Utils.getApi().regionTemplates.push({id:"chaparral",name:"templates.region.chaparral.name",description:"templates.region.chaparral.description",elevation:1e3,vegetation:5,waterAmount:5,summer:{temperature:{day:32.5,night:17.5,var:5},humidity:{day:60,night:40,var:5},wind:{avg:25,var:10},sun:{hours:13}},winter:{temperature:{day:17.5,night:2.5,var:5},humidity:{day:60,night:50,var:5},wind:{avg:30,var:10},sun:{hours:11}}})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{Logger.debug("registered weatherTemplate for blizzard"),Utils.getApi().weatherTemplates.push({id:"blizzard",name:"Blizzard",temp:{ground:0,air:-3,percieved:-4},wind:{speed:70,gusts:85,direction:115},clouds:{coverage:.7,bottom:1e3,top:3e3,type:s.cumulunimbus},precipitation:{amount:1,type:n.blizzard},sun:{amount:.1},humidity:10})}));export{c as CLOUD_HEIGHT,s as CLOUD_TYPE,ColorFilter,i as EVENTS,FlashFilter,t as GENERATOR_MODES,Generators,r as HUMIDITY_LEVELS,Logger,a as METEO,e as MODULE,MeteoUi,Noise,l as PRECI_AMOUNT,n as PRECI_TYPE,RegionConfigDialog,RegionMeteo,o as SUN_INTENSITY,SceneWeather,SceneWeatherApi,g as TEMP_TYPES,TimeProvider,Utils,d as WIND_SPEED,WeatherConfigDialog,WeatherEffect,WeatherEffectsLayer,WeatherLayer,WeatherModel,WeatherTab,WeatherUi,loadHandlebars,registerHbHelpers,registerSettings};
