const e={ID:"scene-weather",NAME:"Scene Weather",LCCNAME:"sceneWeather"},t={WEATHER_TEMPLATE:"weatherTemplate",WEATHER_GENERATE:"weatherAuto",REGION_TEMPLATE:"regionTemplate",REGION_GENERATE:"regionAuto",DISABLED:"disabled"},i={SETTINGS_UPDATED:e.LCCNAME+"SettingsUpdated",REG_TEMPLATE_REGION:e.LCCNAME+"RegisterRegionTemplate",REG_TEMPLATE_WEATHER:e.LCCNAME+"RegisterWeatherTemplate"},a={isaMSLtempC:16,isaSeaLevelPa:101325,adiabaticHyDryCoeff:-.0065,g:9.80665,mAir:.0289644,R:8.3144598,Tzero:237.7},r={none:0,drizzle:1,rain:2,downpour:3,hail:4,snow:5,blizzard:6},n={none:0,fog:1,stratus:2,cumulus:3,cumulunimbus:4},o={dry:20,comfortable:40,pleasant:50,sticky:65,humid:75,oppressive:1/0},s={gloomy:.1,shaded:.3,normal:.7,bright:1/0},c={nothing:.2,slight:.4,average:.7,heavy:.95,extreme:1/0},d={calm:1,light:5,lightBreeze:11,gentleBreeze:28,freshBreeze:38,strongBreeze:49,moderateGale:61,freshGale:74,strongGale:88,wholeGale:102,storm:118,hurricane:1/0},l={low:600,mid:1e3,high:4e3,veryhigh:1/0},g={freezing:-7,cold:-3,chill:3,fresh:7,moderate:18,mild:22,warm:30,hot:37,searing:1/0};class Logger{static info(t,i=!1){console.log(e.NAME+` Info | ${t}`),i&&ui.notifications.info(e.NAME+` | ${t}`)}static error(t,i=!1){console.error(e.NAME+` Error | ${t}`),i&&ui.notifications.error(e.NAME+` | ${t}`)}static debug(t,i){if(game.gmTokenTools?game.gmTokenTools.isDebug:Utils.getSetting("debug",!1)){if(!i)return void console.log(e.NAME+` Debug | ${t}`);const a=Utils.deepClone(i);console.log(e.NAME+` Debug | ${t}`,a)}}}class Utils{static mergeObject(e,t={},i={},a=0){return foundry.utils.mergeObject(e,t,i,a)}static copyToClipboard(e=""){let t=$("<input>");$("body").append(t),t.val(e).select(),document.execCommand("copy"),t.remove()}static arrayNext(e=[],t=""){if(!e.length)return t;const i=e.indexOf(t);return e[(i+1)%e.length]||e[0]}static arrayPrev(e=[],t=""){if(!e.length)return t;const i=e.indexOf(t);return e[(i+e.length-1)%e.length]||e[0]}static getApi(){return game.sceneWeather}static clamp(e,t,i){return Math.min(Math.max(e,t),i)}static map(e,t,i,a,r){const n=(e-t)*(r-a)/(i-t)+a;return Utils.clamp(n,a,r)}static mapColorHex(e,t,i,a,r){const{r:n,g:o,b:s}=foundry.utils.Color.from(a),{r:c,g:d,b:l}=foundry.utils.Color.from(r);return foundry.utils.Color.fromRGB([Utils.map(e,t,i,n,c),Utils.map(e,t,i,o,d),Utils.map(e,t,i,s,l)]).toString()}static roundToDecimals(e,t){return Number(Math.round(e+"e"+t)+"e-"+t)}static omit(e,t){const{[t]:i,...a}=e;return a}static isBitSet(e,t){return 0!=(e&1<<t)}static deepClone(e,t){return deepClone(e,t)}static getActor(e,t){let i=null;return t&&(i=canvas.tokens.placeables.find((e=>e.id===t))),i?i.actor:game.actors.get(e)}static getItem(e,t){return e.items.get(t)}static getToken(e){return canvas.tokens.placeables.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getControlledToken(){return game.canvas.tokens.controlled[0]}static getUserByTokenId(e){let t,i=e.actor.ownership;return game.users.forEach((e=>{null!==e.character&&e.active&&i[e._id]>0&&(t=e)})),t}static getSetting(t,i=null){let a=i??null;try{a=game.settings.get(e.ID,t)}catch{console.log(e.NAME+` Debug | GameConfig '${t}' not found`)}return a}static async setSetting(t,i){game.settings.settings.get(`${e.ID}.${t}`)?(await game.settings.set(e.ID,t,i),Logger.debug(`GameConfig '${t}' set to '${i}'`)):Logger.debug(`GameConfig '${t}' not found`)}static getSceneFlag(t,i=null){let a=i??null;try{a=canvas.scene?.getFlag(e.ID,t)??i}catch{Logger.debug(`SceneFlag '${t}' not found on current scene`)}return a}static getUserFlag(t){return game.user.getFlag(e.ID,t)}static async setUserFlag(t,i){await game.user.setFlag(e.ID,t,i)}static async unsetUserFlag(t){await game.user.unsetFlag(e.ID,t)}static i18n(e,t=null){let i=game.i18n.localize(e);return i==e?(null==t&&(i=e),i):i}static isModuleActive(e){const t=game.modules.get(e);return t&&t.active}}class FoundryAbstractionLayer{canDo(e=null,t){return null!==e&&FoundryAbstractionLayer.isGm}static get worldId(){return game.world.id}static get systemID(){return game.system.id}static get systemVersion(){return game.system.version||game.system.data.version}static isGm(e=null){const t=e?FoundryAbstractionLayer.getUser(e):game.user;return!!t&&t.isGM}static userName(){const e=game.user;return e&&e.name?e.name:""}static userID(){const e=game.user;return e&&e.id?e.id:""}static getUser(e){const t=game.users;if(t)return t.find((t=>t.id===e))}static getControlledTokens(){return game.canvas.tokens.controlled}static getControlledToken(){return game.canvas.tokens.controlled[0]}static getUserByToken(e){let t,i=e.actor.ownership;return game.users.forEach((e=>{null!==e.character&&e.active&&i[e._id]>0&&(t=e)})),t}static getModuleVersion(){const t=game.modules.get(e.ID);return t?t.version:""}static i18n(e,t=null){let i=game.i18n.localize(e);return i==e?(null==t&&(i=e),i):i}static mergeObject(e,t={},i={},a=0){return foundry.utils.mergeObject(e,t,i,a)}}class TimeProvider{static config={daysInYear:365,summerSolstice:172,winterSolstice:355,monthOffset:[0,31,59,90,120,151,181,212,243,273,304,334],hoursInDay:24};static hasTimeAuthority(){return!0}static getI18nDateString(){const e=SimpleCalendar.api.timestampToDate(game.time.worldTime),t={month:{number:e.display.month,name:e.display.monthName,prefix:"",suffix:""},day:{number:e.display.day,name:e.display.day,prefix:"",suffix:e.display.daySuffix},hour:{number:e.hour,name:e.hour<10?"0"+e.hour:e.hour},minute:{number:e.minute,name:e.minute<10?"0"+e.minute:e.minute}},i=Handlebars.compile(FoundryAbstractionLayer.i18n("time.formatted"))(t);return Logger.debug("TimeProvider.getI18nDateString",{scInstance:e,timeInfo:t,timeText:i}),i}static async advanceGameTime(e=0){0!=e&&FoundryAbstractionLayer.isGm()&&(game.time.worldTime,await game.time.advance(e))}static initConfig(){}static _getTimeProvider(){return"simple-calendar"}static getCurrentTimeHash(e=0,t=0){return TimeProvider.getTimeHash(TimeProvider.getDayOfYear()+e,TimeProvider.getHourOfDay()+t)}static getTimeHash(e,t){return e*TimeProvider.config.hoursInDay+t}static getDayOfYearFromTimeHash(e){return Math.trunc(e/TimeProvider.config.hoursInDay)+1}static getMonthOfYearFromTimeHash(e){let t=TimeProvider.getDayOfYearFromTimeHash(e);for(let e=0;e<TimeProvider.config.monthOffset.length;e++)if(t<TimeProvider.config.monthOffset[e])return e;return TimeProvider.config.monthOffset.length}static getDayOfMonthFromTimeHash(e){let t=TimeProvider.getMonthOfYearFromTimeHash(e);return TimeProvider.getDayOfYearFromTimeHash(e)-TimeProvider.config.monthOffset[t-1]}static getTimeOfDayFromTimeHash(e){return e%TimeProvider.config.hoursInDay}static getDayOfYear(){if(game.modules.get("foundryvtt-simple-calendar")?.active&&"simple-calendar"===TimeProvider._getTimeProvider()){let e=SimpleCalendar.api.timestampToDate(game.time.worldTime);return TimeProvider.config.monthOffset[e.month]+e.day}{let t=canvas.scene.getFlag(e.ID,"timeSeason");return void 0===t&&(t=Util.getSetting("timeSeason",150)),sceneManualData}}static getHourOfDay(){const e=game.time.worldTime+0,t=Math.abs(Math.trunc(e%86400/3600));return e<0?24-t:t}}class Noise{static F2=.5*(Math.sqrt(3)-1);static G2=(3-Math.sqrt(3))/6;static F3=1/3;static G3=1/6;static F4=(Math.sqrt(5)-1)/4;static G4=(5-Math.sqrt(5))/20;static fastFloor(e){return 0|Math.floor(e)}static getMulberry32(e){return function(){var t=e+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296}}static grad2=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]);static getNoisedValue(e,t,i,a,r){return a+(r*((1*e(1*(t/=i),1*t)+.5*e(2*t,2*t)+.25*e(4*t,4*t))/1.75)*2-r)}static createNoise2D(e){const t=Noise._buildPermutationTable(e),i=new Float64Array(t).map((e=>Noise.grad2[e%12*2])),a=new Float64Array(t).map((e=>Noise.grad2[e%12*2+1]));return function(e,r){let n=0,o=0,s=0;const c=(e+r)*Noise.F2,d=Noise.fastFloor(e+c),l=Noise.fastFloor(r+c),g=(d+l)*Noise.G2,u=e-(d-g),m=r-(l-g);let p,h;u>m?(p=1,h=0):(p=0,h=1);const f=u-p+Noise.G2,y=m-h+Noise.G2,v=u-1+2*Noise.G2,w=m-1+2*Noise.G2,b=255&d,T=255&l;let W=.5-u*u-m*m;if(W>=0){const e=b+t[T];W*=W,n=W*W*(i[e]*u+a[e]*m)}let _=.5-f*f-y*y;if(_>=0){const e=b+p+t[T+h];_*=_,o=_*_*(i[e]*f+a[e]*y)}let E=.5-v*v-w*w;if(E>=0){const e=b+1+t[T+1];E*=E,s=E*E*(i[e]*v+a[e]*w)}return 70*(n+o+s)}}static _buildPermutationTable(e){const t=Noise.getMulberry32(e),i=512,a=new Uint8Array(i);for(let e=0;e<256;e++)a[e]=e;for(let e=0;e<255;e++){const i=e+~~(t()*(256-e)),r=a[e];a[e]=a[i],a[i]=r}for(let e=256;e<i;e++)a[e]=a[e-256];return a}}class WeatherModel{static DEFAULT_MODEL_STRUCT={source:"_DISABLED_",name:"disabled",temp:{ground:0,air:0,percieved:0},wind:{speed:0,gusts:0,direction:0},clouds:{coverage:0,bottom:0,top:0,type:0},precipitation:{amount:0,type:0},sun:{amount:0},humidity:0};constructor({regionMeteo:t,templateId:i="default",useWeatherConfig:a}){Logger.debug("WeatherModel:constrctor",{regionMeteo:t,templateId:i,useWeatherConfig:a}),this._cache={},void 0!==t?(this.regionMeteo=t,this.useConfigSceneId=void 0,this.updateConfig()):void 0!==a?(this.regionMeteo=void 0,this.useConfigSceneId=a,this.updateConfig()):(this.regionMeteo=void 0,this.useConfigSceneId=void 0,this.weatherData=Utils.getApi().weatherTemplates.find((e=>e.id==i)),void 0===this.weatherData&&(this.weatherData=Utils.getApi().weatherTemplates[0],canvas.scene.setFlag(e.ID,"weatherTemplate",this.weatherData.id),Logger.error("Unable to set weather template with id ["+i+"] reverting to ["+this.weatherData.id+"]. Maybe you removed a SceneWeather plugin after configuring your scene.",!0)),this.weatherData.precipitation.mode=Utils.getSceneFlag("rainMode","winddir"))}static getTemplates(){let e=[];return Utils.getApi().weatherTemplates.forEach((t=>{e.push({id:t.id,name:t.name})})),e}static fromSceneConfig(e){return new WeatherModel({useWeatherConfig:e})}static fromTemplate(e){return new WeatherModel({templateId:e})}static fromRegion(e){return new WeatherModel({regionMeteo:e})}updateConfig(){if(void 0!==this.regionMeteo)return Logger.debug("WeatherModel.updateConfig() -> invalidating cache, invoking on regionMeteo..."),this._cache={},this.regionMeteo.updateConfig();if(void 0!==this.useConfigSceneId){Logger.debug("WeatherModel.updateConfig() -> getting weatherConfig from Scene.",{configSceneId:this.useConfigSceneId});let t=this.useConfigSceneId,i=game.scenes.get(this.useConfigSceneId)?.getFlag(e.ID,"weatherSettings")??void 0;Logger.debug("WeatherModel.updateConfig()",{weatherConfig:i}),i||(i=Utils.getSetting("defaultWeatherSettings"),t="_GLOBAL_"),this._noise=Noise.createNoise2D(0);const r=i.wind.speed+i.wind.gusts,n=Math.trunc(1==i.wind.directionType?WeatherModel._getNoisedWindDirection(this._noise,TimeProvider.getCurrentTimeHash(),r):i.wind.direction);let o=Utils.mergeObject(WeatherModel.DEFAULT_MODEL_STRUCT,{source:t,name:"custom",temp:{ground:i.temp.ground,air:i.temp.air,percieved:Math.trunc(WeatherModel._apparentTemperature(i.temp.air,i.wind.speed,i.humidity,a.isaSeaLevelPa/100))},wind:{speed:i.wind.speed,gusts:r,direction:n,directionType:i.wind.directionType},clouds:{coverage:i.clouds.coverage/100,bottom:i.clouds.bottom,top:i.clouds.bottom+i.clouds.thickness,type:i.clouds.type},precipitation:{amount:i.precipitation.amount/100,type:i.precipitation.type,mode:Utils.getSceneFlag("rainMode","winddir")},sun:{amount:i.sun.amount/100},humidity:i.humidity});return foundry.utils.objectsEqual(this.weatherData,o)?(Logger.debug("WeatherModel.updateConfig() -> static from sceneConfig, no changes."),!1):(this.weatherData=o,Logger.debug("WeatherModel.updateConfig() -> static from sceneConfig",{sceneId:this.useConfigSceneId,weatherData:this.weatherData}),!0)}return this.weatherData.precipitation.mode==Utils.getSceneFlag("rainMode","winddir")?(Logger.debug("WeatherModel.updateConfig() -> static, nothing to do."),!1):(this.weatherData.precipitation.mode=Utils.getSceneFlag("rainMode","winddir"),!0)}getWeatherData(e=0,t=0){if(void 0!==this.regionMeteo){let i=this.regionMeteo.getRegionBase(e,t);if(void 0!==this._cache[i.timeHash])return this.weatherData=this._cache[i.timeHash],this._cache[i.timeHash];this.weatherData=Utils.mergeObject(WeatherModel.DEFAULT_MODEL_STRUCT,{name:i.name,temp:{ground:this._groundTemp(3,3,e,t),air:i.baseTemp,percieved:0},wind:{speed:i.wind,gusts:i.gusts+i.wind,direction:0},clouds:{coverage:0,bottom:Utils.clamp(Math.abs(WeatherModel._liftedCondensationLevel(i.baseTemp,i.baseHumidity)),0,2e4),top:0,type:0},precipitation:{amount:0,type:0,mode:Utils.getSceneFlag("rainMode","winddir")},sun:{amount:i.sunAmount},humidity:i.baseHumidity});let a=WeatherModel._calcAdiCloudBottomCoeff(this.weatherData,i),r=WeatherModel._calcGeopotential(i);return this.weatherData.clouds.top=a<0?this.weatherData.clouds.bottom+12.6*r:this.weatherData.clouds.bottom+.27*r,this.weatherData.clouds.coverage=Utils.clamp((this.weatherData.clouds.top-this.weatherData.clouds.bottom)/100,0,1),this.weatherData.clouds.bottom<i.elevation?this.weatherData.clouds.type=1:(a<0&&(this.weatherData.clouds.top-this.weatherData.clouds.bottom>1e3&&(this.weatherData.clouds.type=3),this.weatherData.clouds.top-this.weatherData.clouds.bottom>3e3&&(this.weatherData.clouds.type=4)),this.weatherData.clouds.type<3&&this.weatherData.clouds.coverage>.3&&(this.weatherData.clouds.type=2)),this.weatherData.precipitation.amount=Utils.clamp(1.2*this.weatherData.clouds.coverage-.4,0,1)*Noise.getNoisedValue(this.regionMeteo._noise,i.timeHash+321,8,.8,.2)*Noise.getNoisedValue(this.regionMeteo._noise,i.timeHash+321,32,1,.5),this.weatherData.wind.gusts=this.weatherData.wind.gusts*(2.5*this.weatherData.precipitation.amount+.5),this.weatherData.wind.speed=this.weatherData.wind.speed+2.2*this.weatherData.precipitation.amount*this.weatherData.wind.speed,this.weatherData.sun.amount=this.weatherData.sun.amount*Utils.clamp(1-this.weatherData.clouds.coverage,.2,1),this.weatherData.temp.air=this.weatherData.temp.air-.03*this.weatherData.wind.speed+this.weatherData.sun.amount*Math.max(2,.6*this.weatherData.temp.ground),this.weatherData.temp.percieved=WeatherModel._apparentTemperature(this.weatherData.temp.air,this.weatherData.wind.speed,this.weatherData.humidity,WeatherModel._heightToPressure(i.elevation)),this.weatherData.clouds.top=3*Math.max(0,this.weatherData.clouds.top-i.elevation),this.weatherData.clouds.bottom=3*Math.max(0,this.weatherData.clouds.bottom-i.elevation),this.weatherData.precipitation.type=WeatherModel._calcPrecipitationType(this.weatherData),this.weatherData.wind.direction=WeatherModel._getNoisedWindDirection(this.regionMeteo._noise,i.timeHash,this.weatherData.wind.gusts),this._cache[i.timeHash]=this.weatherData,this.weatherData}return void 0!==this.useConfigSceneId?(Logger.debug("Updating wind direction for weatherConfig based weatherData...",{"this.weatherData":this.weatherData}),1==this.weatherData.wind.directionType&&(this.weatherData.wind.direction=WeatherModel._getNoisedWindDirection(this._noise,TimeProvider.getCurrentTimeHash(e,t),this.weatherData.wind.gusts)),this.weatherData):this.weatherData}static _getNoisedWindDirection(e,t,i){let a=Noise.getNoisedValue(e,t+1277,512,180,180)+Noise.getNoisedValue(e,t+1277,8,16,16)*(.2*i);return a<0&&(a+=360),a>=360&&(a-=360),a}static _calcGeopotential(e){return e.vegetation*(1.3*e.sunAmount+.7*e.wind)+(.3*e.sunAmount+e.waterAmount*(1.3*e.wind))}static _heightToPressure(e){if(e<11e3)return a.isaSeaLevelPa*Math.pow(a.isaMSLtempC/(a.isaMSLtempC+a.adiabaticHyDryCoeff*e),a.g*a.mAir/(a.R*a.adiabaticHyDryCoeff))/100;if(e<=2e4){var t=a.isaSeaLevelPa*Math.pow(a.isaMSLtempC/(e+11e3*a.adiabaticHyDryCoeff),a.g*a.mAir/(a.R*a.adiabaticHyDryCoeff)),i=a.isaMSLtempC+11e3*a.adiabaticHyDryCoeff;return t*Math.exp(-a.g*a.mAir*(e-11e3)/(a.R*i))/100}return 0}static _apparentTemperature(e,t,i,a){return e<10?WeatherModel._windChill(e,t):WeatherModel._heatIndex(e,i,a)}static _windChill(e,t){if(e>=10)return Tc;let i;return i=t>=4.8&&t<=177?13.12+.6215*e+(.3965*e-11.37)*Math.pow(t,.16):t<4.8?e+.2*(.1345*e-1.59)*t:e,i}static _heatIndex(e,t,i){if(i<16)return e;if(e<27||a.R<.4||WeatherModel._dewPoint(e,t)<12)return e;return 1.61139411*e-8.784695+2.338549*t+-.14611605*e*t+-.012308094*e*e+-.016424828*t*t+.002211732*e*e*t+72546e-8*e*t*t+1e-6*-3.582*e*e*t*t}static _dewPoint(e,t){if(e<0||e>60)return e;if((t/=100)<.01||t>1)return e;let i=17.27*e/(a.Tzero+e)+Math.log(t),r=a.Tzero*i/(17.27-i);return r<0||r>50?e:r}static _calcAdiCloudBottomCoeff(e,t){return a.isaMSLtempC+(e.clouds.bottom-t.elevation)*a.adiabaticHyDryCoeff-(t.baseTemp+(e.clouds.bottom-t.elevation)*a.adiabaticHyDryCoeff)}static _calcPrecipitationType(e){return e.precipitation.amount<.1?0:e.clouds.type>3&&e.precipitation.amount>.7?e.temp.air<4?6:e.wind.speed>.2?4:3:e.clouds.type>=3?e.temp.air<4?e.wind.speed>.2?6:5:2:2==e.clouds.type||e.precipitation.amount>.7?e.temp.air<4?5:1:0}_groundTemp(e,t,i=0,a=0){let r=0,n=0;for(let o=0;o<=e;o++){let e=1/Math.log2(o+2);r+=this.regionMeteo.getRegionBase(i,a-o*t).baseTemp*e,n+=e}return r/n}static _liftedCondensationLevel(e,t){return 125*(e-(e-(100-t)/5))}}class RegionMeteo{constructor(t){Logger.debug("RegionMeteo:constrctor",{templateId:t}),void 0!==t?(this.regionData=Utils.getApi().regionTemplates.find((e=>e.id==t)),void 0===this.regionData&&(this.regionData=Utils.getApi().regionTemplates[0],canvas.scene.setFlag(e.ID,"regionTemplate",this.regionData.id),Logger.error("Unable to set region template with id ["+t+"] reverting to ["+this.regionData.id+"]. Maybe you removed a SceneWeather plugin after configuring your scene.",!0))):this.regionData=canvas.scene.getFlag(e.ID,"regionSettings"),this._noise=Noise.createNoise2D(0),this.updateConfig()}static getTemplates(){let e=[];return Utils.getApi().regionTemplates.forEach((t=>{e.push({id:t.id,name:t.name})})),e}static fromTemplate(e){return new RegionMeteo(e)}updateConfig(){return Logger.debug("RegionMeteo.updateConfig()"),this._cache={},!0}getRegionBase(e=0,t=0){void 0===e&&(e=0),void 0===t&&(t=0);let i=TimeProvider.getDayOfYear(),a=TimeProvider.getHourOfDay();if(a+=t,a<0)for(;a<0;)a+=24,i--;if(a>=24)for(;a>=24;)a-=24,i++;if(i+=e,i<0)for(;i<0;)i+=TimeProvider.config.daysInYear;if(i>=TimeProvider.config.daysInYear)for(;i>=TimeProvider.config.daysInYear;)i-=TimeProvider.config.daysInYear;let r=TimeProvider.getTimeHash(i,a);if(void 0!==this._cache[r])return this._cache[r];let n={elevation:this.regionData.elevation,vegetation:this.regionData.vegetation,waterAmount:this.regionData.waterAmount,timeHash:r};void 0===this.regionData.name?n.name="custom":n.name=this.regionData.name;let o=RegionMeteo._hodPct(a),s=RegionMeteo._doyPct(i),c=(this.regionData.summer.temperature.day-this.regionData.winter.temperature.day)*s+this.regionData.winter.temperature.day,d=(this.regionData.summer.temperature.night-this.regionData.winter.temperature.night)*s+this.regionData.winter.temperature.night,l=(this.regionData.summer.temperature.var-this.regionData.winter.temperature.var)*s+this.regionData.winter.temperature.var;n.baseTemp=Noise.getNoisedValue(this._noise,r+1282,64,(c-d)*o+d,l),n.baseTemp<0&&(n.waterAmount=0);let g=(this.regionData.summer.humidity.day-this.regionData.winter.humidity.day)*s+this.regionData.winter.humidity.day,u=(this.regionData.summer.humidity.night-this.regionData.winter.humidity.night)*s+this.regionData.winter.humidity.night,m=(this.regionData.summer.humidity.var-this.regionData.winter.humidity.var)*s+this.regionData.winter.humidity.var;n.baseHumidity=Utils.clamp(Noise.getNoisedValue(this._noise,r+732,64,(g-u)*o+u,m),0,100);let p=((this.regionData.summer.sun.hours-this.regionData.winter.sun.hours)*s+this.regionData.winter.sun.hours)/2,h=Math.abs(12-a);n.sunAmount=h>p?0:Utils.clamp(p/3*(1-1/(p/h)),0,1);let f=(this.regionData.summer.wind.avg-this.regionData.winter.wind.avg)*s+this.regionData.winter.wind.avg,y=(this.regionData.summer.wind.var-this.regionData.winter.wind.var)*s+this.regionData.winter.wind.var,v=1;return v=n.sunAmount<.1?.9:n.sunAmount<.2?a>12?.8:1.2:1.1,n.wind=Utils.clamp(Noise.getNoisedValue(this._noise,r+978,16,v*f,y),0,80),n.gusts=Utils.clamp(n.wind+Noise.getNoisedValue(this._noise,r+12,8,v*y,y),0,80),this._cache[r]=n,n}static _hodPct(e){return e%=24,(Math.sin((e/12-.5)*Math.PI)+1)/2}static _doyPct(e){const t=TimeProvider.config.summerSolstice%TimeProvider.config.daysInYear,i=TimeProvider.config.winterSolstice%TimeProvider.config.daysInYear;let a,r=i,n=i;return i<t?n=i+TimeProvider.config.daysInYear:r=i-TimeProvider.config.daysInYear,e>n&&(e-=TimeProvider.config.daysInYear),a=e==t?1:e<t?(e-r)/(t-r):1-(e-t)/(n-t),a}}class WeatherPerception{static _registeredPercievers={};static _singleton;static DEFAULT_WEATHER_STRUCT={name:"unknown",temperature:{air:0,ground:0,percieved:0},humidity:{percent:0},wind:{speed:0,gusts:0,direction:0},clouds:{height:0,amount:0,type:0},sun:{amount:0},precipitation:{amount:0,type:0}};static DEFAULT_INFO_STRUCT={id:"default",name:"default"};static registeredPerciever(e=null,t=null){Logger.debug("WeatherPerception.registeredPerciever(...)",{id:e,weatherPerception:t}),e&&t&&t instanceof WeatherPerception&&(WeatherPerception._registeredPercievers[e]=t)}static async getAsText(e="default",t){const i=WeatherPerception._getPercieverById(e),a=i.getTextFromModel(Utils.mergeObject(WeatherModel.DEFAULT_MODEL_STRUCT,t));return Logger.debug("WeatherPerception.getAsText(...)",{id:e,perciever:i,text:a}),a}static async getAsUiHtml(e="default",t){const i=WeatherPerception._getPercieverById(e),a=i.getUiHtmlFromModel(Utils.mergeObject(WeatherModel.DEFAULT_MODEL_STRUCT,t));return Logger.debug("WeatherPerception.getAsUiHtml(...)",{id:e,perciever:i,uiHtml:a}),a}static async getAsChatHtml(e="default",t){const i=WeatherPerception._getPercieverById(e),a=i.getChatHtmlFromModel(Utils.mergeObject(WeatherModel.DEFAULT_MODEL_STRUCT,t));return Logger.debug("WeatherPerception.getAsChatHtml(...)",{id:e,perciever:i,chatHtml:a}),a}static async getAsWeatherInfo(e="default",t){const i=WeatherPerception._getPercieverById(e),a=i.getWeatherInfoFromModel(Utils.mergeObject(WeatherModel.DEFAULT_MODEL_STRUCT,t));return Logger.debug("WeatherPerception.getAsWeatherInfo(...)",{id:e,perciever:i,weatherInfo:a}),a}static getInfo(e="default"){const t=WeatherPerception._getPercieverById(e),i=t.getPercieverInfo();return Logger.debug("WeatherPerception.getInfo(...)",{id:e,perciever:t,percieverInfo:i}),i}static getAllowedIds(e){let t=[];for(const[i,a]of Object.entries(WeatherPerception._registeredPercievers))a.isAllowed(e)&&t.push(i);return Logger.debug("WeatherPerception.getAllowedIds(...)",{userId:e,allowedIds:t}),t}static _getSingleton(){return WeatherPerception._singleton||(WeatherPerception._singleton=new WeatherPerception),WeatherPerception._singleton}static _getPercieverById(e){return WeatherPerception._registeredPercievers[e]?WeatherPerception._registeredPercievers[e]:WeatherPerception._getSingleton()}getTextFromModel(e){return""}getUiHtmlFromModel(e){return""}getChatHtmlFromModel(e){return""}getWeatherInfoFromModel(e){return Utils.deepClone(DEFAULT_WEATHER_STRUCT)}getPercieverInfo(){return Utils.deepClone(DEFAULT_INFO_STRUCT)}}class SceneWeather$1{constructor(e){this.sceneId=e._id,this.weatherModel=this._getWeatherModelForMode(e),Logger.debug("SceneWeather:constrctor",{weatherModel:this.weatherModel,sceneId:this.sceneId})}_getWeatherModelForMode(i){switch(this.weatherMode=i.getFlag(e.ID,"weatherMode")||t.DISABLED,Logger.debug("SceneWeather._getWeatherModelForMode(...)",{scene:i,weatherMode:this.weatherMode}),this.weatherMode){case t.WEATHER_TEMPLATE:const a=i.getFlag(e.ID,"weatherTemplate");return WeatherModel.fromTemplate(a);case t.WEATHER_GENERATE:return WeatherModel.fromSceneConfig(i._id);case t.REGION_TEMPLATE:const r=i.getFlag(e.ID,"regionTemplate");return WeatherModel.fromRegion(RegionMeteo.fromTemplate(r));case t.REGION_GENERATE:return WeatherModel.fromRegion(new RegionMeteo);case t.DISABLED:default:throw new Error("Unable to instantiate new SceneWeather, while being disabled.")}}updateConfig(){Logger.debug("SceneWeather.updateConfig()",{sceneId:this.sceneId});const t=game.scenes.get(this.sceneId);if(void 0===t)throw Logger.error("Unable to instantiate SceneWeather for non existing Scene with id "+this.sceneId),new Error("Unable to instantiate SceneWeather for non existing Scene with id "+this.sceneId);return t.getFlag(e.ID,"weatherMode")!=this.weatherMode?(Logger.debug("SceneWeather.updateConfig() -> new mode",{sceneId:this.sceneId,prevMode:this.weatherMode,newMode:t.getFlag(e.ID,"weatherMode")}),this.weatherModel=this._getWeatherModelForMode(t),!0):(Logger.debug("SceneWeather.updateConfig() -> unchanged mode",{sceneId:this.sceneId}),this.weatherModel.updateConfig())}static fromConfig({sceneId:e=null}={}){null==e&&(e=canvas.scene._id);const t=game.scenes.get(e);if(void 0!==t)try{return new SceneWeather$1(t)}catch(e){return}else Logger.error("Unable to instantiate SceneWeather for non existing Scene with id "+e)}calculateWeather({force:t=!1}={}){const i=TimeProvider.getCurrentTimeHash(),a=this.weatherModel.getWeatherData(),r=WeatherPerception.getAsWeatherInfo("perceptive",a);Hooks.callAll(e.LCCNAME+"WeatherUpdated",{info:r,model:a,timeHash:i,sceneId:this.sceneId,force:t})}}function getSceneWeatherAPIv1(){return{updateWeatherConfig:async function updateWeatherConfig({forSceneId:e,force:t=!1}={}){SceneWeatherApi.updateWeatherConfig({forSceneId:e,force:t})},updateWeather:async function updateWeather({force:e=!1}={}){SceneWeatherApi.calculateWeather({force:e})},version:"1.0"}}class SceneWeatherApi{static _lastUpdate=0;static _sceneWeather={};static async registerApi(){game.sceneWeather?Logger.debug("SceneWeather API aleady registered!"):(game.sceneWeather={},game.sceneWeather.get=SceneWeatherApi.getSceneWeatherProvider,game.sceneWeather.updateSettings=SceneWeatherApi.updateSettings,game.sceneWeather.updateWeatherConfig=SceneWeatherApi.updateWeatherConfig,game.sceneWeather.calculateWeather=SceneWeatherApi.calculateWeather,game.sceneWeather.generators=[],game.sceneWeather.filters=[],game.sceneWeather.regionTemplates=[],game.sceneWeather.weatherTemplates=[],game.sceneWeather.registerPerciever=WeatherPerception.registeredPerciever,Logger.debug("sceneWeather API registered as game.sceneWeather"))}static async updateSettings(){Logger.debug("api::updateSettings")}static calculateWeather({force:e=!1,sceneId:t}={}){if(Logger.debug("api::calculateWeather(...)",{sceneId:t,force:e}),void 0===t&&(t=canvas.scene._id),t!=canvas.scene._id)return void Logger.debug("Not calculating weather for non current scene...");e&&(SceneWeatherApi._lastUpdate=-1);let i=TimeProvider.getCurrentTimeHash();if(SceneWeatherApi._lastUpdate==i)return;SceneWeatherApi._lastUpdate=i;const a=SceneWeatherApi.getSceneWeatherProvider(t);void 0!==a?a.calculateWeather({force:e}):Logger.debug("Not calculating weather for disabled setting...")}static updateWeatherConfig({forSceneId:e,force:t=!1,prewarm:i=!1,fade:a=!0}={}){Logger.debug("api::updateWeatherConfig(...)",{forSceneId:e,force:t});const r=SceneWeatherApi.getSceneWeatherProvider(e,t);null==r?Logger.debug("api::updateWeatherConfig(...) -> disabled by config"):(r.updateConfig()||t)&&SceneWeatherApi.calculateWeather({sceneId:e,force:!0})}static getSceneWeatherProvider(e,t=!1){let i=canvas.scene._id;return void 0!==e&&(i=e),Logger.debug("api::getSceneWeatherProvider()",{forSceneId:e,sceneId:i,ignoreCache:t}),t&&(SceneWeatherApi._sceneWeather[i]=void 0),void 0!==SceneWeatherApi._sceneWeather[i]||(SceneWeatherApi._sceneWeather[i]=SceneWeather$1.fromConfig({sceneId:i})),SceneWeatherApi._sceneWeather[i]}}const registerHbHelpers=function(){Handlebars.__switch_stack__=[],Handlebars.registerHelper("switch",(function(e,t){Handlebars.__switch_stack__.push({switch_match:!1,switch_value:e});var i=t.fn(this);return Handlebars.__switch_stack__.pop(),i})),Handlebars.registerHelper("case",(function(e,t){var i=Array.from(arguments),a=(t=i.pop(),i),r=Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1];return r.switch_match||-1===a.indexOf(r.switch_value)?"":(r.switch_match=!0,t.fn(this))})),Handlebars.registerHelper("default",(function(e){if(!Handlebars.__switch_stack__[Handlebars.__switch_stack__.length-1].switch_match)return e.fn(this)})),Logger.debug("HB Helpers Registered")},loadHandlebars=function(){loadTemplates({regionConfigSummer:"modules/"+e.ID+"/templates/regionConfigSummer.hbs",regionConfigWinter:"modules/"+e.ID+"/templates/regionConfigWinter.hbs"}),Logger.debug("HB partials loaded")};class RegionConfigDialog extends FormApplication{constructor(e){super(),this.applyToScene=e,Logger.debug("RegionConfigDialog:constrctor",{applyToScene:e})}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/regionConfig.hbs",id:"region-settings",title:"dialogs.regionConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}activateListeners(e){super.activateListeners(e),Logger.debug("RegionConfigDialog:activateListeners");new Tabs({navSelector:".tabs",contentSelector:".content",initial:"summer",callback:{}}).bind(e[0]),e.find(".sceneweather-slider").each((function(t){const i=$(this),a=e.find('input[name="'+i.attr("data-min")+'"]'),r=e.find('input[name="'+i.attr("data-max")+'"]'),n=i.attr("data-range")||"0,100",o=i.attr("data-unit")||"%",s=Number(n.split(",")[0]||0),c=Number(n.split(",")[1]||s);noUiSlider.create(i[0],{start:[a.val()||0,r.val()||0],tooltips:[{to:function(e){return e+o},from:function(e){return Number(e.replace(o,""))}},{to:function(e){return e+o},from:function(e){return Number(e.replace(o,""))}}],behaviour:"drag-all",step:1,margin:0,padding:0,connect:!0,range:{min:s,max:c}}),i[0].noUiSlider.on("change",(function(e,t,i,n,o,s){Logger.debug("Slider Update",{values:e,noUiSlider:s}),a.val(e[0]),r.val(e[1])}))}))}getData(){let t={waterAmounts:[{id:0,name:"dialogs.regionConfig.waterAmounts_0"},{id:5,name:"dialogs.regionConfig.waterAmounts_5"},{id:10,name:"dialogs.regionConfig.waterAmounts_10"},{id:25,name:"dialogs.regionConfig.waterAmounts_25"},{id:50,name:"dialogs.regionConfig.waterAmounts_50"},{id:75,name:"dialogs.regionConfig.waterAmounts_75"},{id:100,name:"dialogs.regionConfig.waterAmounts_100"}]};if(void 0===this.applyToScene)return mergeObject(t,Utils.getSetting("defaultRegionSettings")),Logger.debug("RegionConfigDialog:getData(general)",{applyToScene:this.applyToScene,data:t}),t;{let i=game.scenes.get(this.applyToScene)?.getFlag(e.ID,"regionSettings")??void 0;return i||(i=Utils.getSetting("defaultRegionSettings")),mergeObject(t,i),Logger.debug("RegionConfigDialog:getData(scene)",{applyToScene:this.applyToScene,data:t}),t}}_updateObject(t,i){const a=expandObject(i);Logger.debug("updateObject, regionConfig",{data:a,scene:this.applyToScene}),void 0===this.applyToScene?Utils.setSetting("defaultRegionSettings",a):game.scenes.get(this.applyToScene).setFlag(e.ID,"regionSettings",a)}}class WeatherConfigDialog extends FormApplication{constructor(e){super(),this.applyToScene=e,Logger.debug("WeatherConfigDialog:constrctor",{applyToScene:e})}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,template:"modules/"+e.ID+"/templates/weatherConfig.hbs",id:"weather-settings",title:"dialogs.weatherConfig.title",closeOnSubmit:!0,submitOnChange:!1,submitOnClose:!1})}activateListeners(e){super.activateListeners(e),Logger.debug("WeatherConfigDialog:activateListeners");0!=e.find('select[name="wind.directionType"]').find(":selected").val()&&e.find("#windTypeGrp").addClass("disabled"),e.find('select[name="wind.directionType"]').on("change",(function(){0!=$(this).find(":selected").val()?e.find("#windTypeGrp").addClass("disabled"):e.find("#windTypeGrp").removeClass("disabled")}));const t=e.find('select[name="clouds.type"]').find(":selected").val();Logger.debug("cloudsType",t),0==t&&(e.find("#cloudSectionGrp").addClass("disabled"),e.find("#preciGrp").addClass("disabled")),e.find('select[name="clouds.type"]').on("change",(function(){const t=$(this).find(":selected").val();Logger.debug("cloudsType.change",t),0==t?(e.find("#cloudSectionGrp").addClass("disabled"),e.find("#preciGrp").addClass("disabled")):(e.find("#cloudSectionGrp").removeClass("disabled"),e.find("#preciGrp").removeClass("disabled"))}));const i=e.find('select[name="precipitation.type"]').find(":selected").val();Logger.debug("preciType",i),0==i&&e.find("#previAmtGrp").addClass("disabled"),e.find('select[name="precipitation.type"]').on("change",(function(){const t=$(this).find(":selected").val();Logger.debug("preciType",t),0==t?e.find("#previAmtGrp").addClass("disabled"):e.find("#previAmtGrp").removeClass("disabled")}))}getData(){let t={windSpeeds:Object.entries(d).map((([e,t])=>"hurricane"===e?{id:120,name:"dialogs.weatherConfig.wind.speeds.hurricane"}:{id:t,name:"dialogs.weatherConfig.wind.speeds."+e})),directionTypes:[{id:0,name:"dialogs.weatherConfig.directionTypes.fixed"},{id:1,name:"dialogs.weatherConfig.directionTypes.noise"}],cloudsTypes:Object.entries(n).map((([e,t])=>({id:t,name:"dialogs.weatherConfig.clouds.types."+e}))),precipitationTypes:Object.entries(r).map((([e,t])=>({id:t,name:"dialogs.weatherConfig.precipitation.types."+e}))),windGustTypes:[{id:0,name:"dialogs.weatherConfig.windGustTypes.none"},{id:6,name:"dialogs.weatherConfig.windGustTypes.some"},{id:11,name:"dialogs.weatherConfig.windGustTypes.more"}]};if(void 0===this.applyToScene)return mergeObject(t,Utils.getSetting("defaultWeatherSettings")),Logger.debug("WeatherConfigDialog:getData(general)",{applyToScene:this.applyToScene,data:t}),t;{let i=game.scenes.get(this.applyToScene)?.getFlag(e.ID,"weatherSettings")??void 0;return i||(i=Utils.getSetting("defaultWeatherSettings")),mergeObject(t,i),Logger.debug("WeatherConfigDialog:getData(scene)",{applyToScene:this.applyToScene,data:t}),t}}_updateObject(t,i){const a=expandObject(i);Logger.debug("updateObject, weatherConfig",{data:a,scene:this.applyToScene}),void 0===this.applyToScene?Utils.setSetting("defaultWeatherSettings",a):game.scenes.get(this.applyToScene).setFlag(e.ID,"weatherSettings",a)}}function onChangeFunction(e){Hooks.callAll(i.SETTINGS_UPDATED,e)}const registerSettingsPostInit=function(){},registerSettingsPreInit=function(){game.settings.register(e.ID,"startup",{name:"One-Time Startup Prompt",scope:"world",config:!1,type:Boolean,default:!1}),game.settings.registerMenu(e.ID,"defaultRegionSettingsMenu",{name:Utils.i18n("settings.defaultRegionSettingsMenu.name"),label:Utils.i18n("settings.defaultRegionSettingsMenu.label"),hint:Utils.i18n("settings.defaultRegionSettingsMenu.hint"),icon:"fas fa-bars",type:RegionConfigDialog,restricted:!0}),game.settings.register(e.ID,"defaultRegionSettings",{scope:"world",config:!1,type:Object,default:{elevation:0,vegetation:0,waterAmount:0,summer:{temperature:{max:0,avg:0,min:0,var:0},humidity:{max:0,avg:0,min:0,var:0},wind:{avg:0,var:0}},winter:{temperature:{max:0,avg:0,min:0,var:0},humidity:{max:0,avg:0,min:0,var:0},wind:{avg:0,var:0}}}}),game.settings.registerMenu(e.ID,"defaultWeatherSettingsMenu",{name:Utils.i18n("settings.defaultWeatherSettingsMenu.name"),label:Utils.i18n("settings.defaultWeatherSettingsMenu.label"),hint:Utils.i18n("settings.defaultWeatherSettingsMenu.hint"),icon:"fas fa-bars",type:WeatherConfigDialog,restricted:!0}),game.settings.register(e.ID,"defaultWeatherSettings",{scope:"world",config:!1,type:Object,default:{temp:{ground:0,air:0},wind:{speed:0,gusts:0,direction:0,directionType:0},clouds:{coverage:0,bottom:0,thickness:0,type:0},precipitation:{amount:0,type:0},sun:{amount:0},humidity:0}}),game.settings.register(e.ID,"enableFx",{name:Utils.i18n("settings.enableFx.name"),hint:Utils.i18n("settings.enableFx.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{onChangeFunction({id:"enableFx",value:e})}}),game.settings.register(e.ID,"cloudsAlpha",{name:Utils.i18n("settings.cloudsAlpha.name"),hint:Utils.i18n("settings.cloudsAlpha.hint"),scope:"client",config:!0,type:Number,range:{min:0,max:100,step:5},default:100,onChange:e=>{onChangeFunction({id:"cloudsAlpha",value:e})}}),game.settings.register(e.ID,"precipitationAlpha",{name:Utils.i18n("settings.precipitationAlpha.name"),hint:Utils.i18n("settings.precipitationAlpha.hint"),scope:"client",config:!0,type:Number,range:{min:0,max:100,step:5},default:100,onChange:e=>{onChangeFunction({id:"precipitationAlpha",value:e})}}),game.settings.register(e.ID,"maxParticles",{name:Utils.i18n("settings.maxParticles.name"),hint:Utils.i18n("settings.maxParticles.hint"),scope:"client",config:!0,type:Number,range:{min:200,max:32e3,step:200},default:3200,onChange:e=>{onChangeFunction({id:"maxParticles",value:e})}}),game.settings.register(e.ID,"uiVisible",{name:"settings.uiVisible.name",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"uiPosition",{name:"settings.uiPosition.name",scope:"client",config:!1,type:Object,default:{top:440,left:15}}),game.settings.register(e.ID,"meteoVisible",{name:"settings.meteoVisible.name",scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"meteoPosition",{name:Utils.i18n("settings.meteoPosition.name"),hint:Utils.i18n("settings.meteoPosition.hint"),scope:"client",config:!1,type:Object,default:{top:440,left:15}}),game.settings.register(e.ID,"uiPinned",{name:Utils.i18n("settings.uiPinned.name"),hint:Utils.i18n("settings.uiPinned.hint"),scope:"client",config:!1,type:Boolean,default:!1}),game.settings.register(e.ID,"debug",{name:Utils.i18n("settings.debug.name"),hint:Utils.i18n("settings.debug.hint"),scope:"client",config:!0,type:Boolean,default:!1}),Logger.debug("Settings Registered")};Hooks.on(e.LCCNAME+"WeatherUpdated",(async e=>{Logger.debug("->Hook:WeatherUpdated -> WeatherUI.update(...)",{data:e}),e.sceneId==canvas.scene._id&&void 0!==e.info&&WeatherUi.update(e.model)})),Hooks.on("renderWeatherUi",(()=>{Logger.debug("->Hook:renderWeatherUi"),WeatherUi.update()})),Hooks.on("updateWorldTime",(()=>{WeatherUi._updateTimeHeadline()}));class WeatherUi extends FormApplication{static _isOpen=!1;static _weatherModel={};static _perceptionId="perceptive";async _render(i=!1,a={}){Logger.debug("WeatherUi._render(...)",{force:i,options:a}),await super._render(i,a),game.settings.get(e.ID,"uiPinned")&&WeatherUi.pinApp(),WeatherUi._isOpen=!0,delete ui.windows[this.appId],Utils.getSceneFlag("weatherMode",t.DISABLED)==t.DISABLED?(Logger.debug("WeatherUi._render() -> hiding app, DISABLED"),$("#scene-weather-app").css("visibility","hidden")):$("#scene-weather-app").css("visibility","visible")}async close(t={}){return t.sceneWeather&&(WeatherUi._isOpen=!1,game.settings.set(e.ID,"uiVisible",!1)),super.close(t)}constructor(){super(),Logger.debug("WeatherUi.ctor")}static get defaultOptions(){return this.initialPosition=game.settings.get(e.ID,"uiPosition"),mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,width:200,height:100,submitOnChange:!0,closeOnSubmit:!1,minimizable:!1,template:"modules/"+e.ID+"/templates/weatherUi.hbs",id:"scene-weather-app",title:"dialogs.weatherUi.title",top:this.initialPosition.top,left:this.initialPosition.left})}async _updateObject(e,t){Logger.debug("WeatherUi._updateObjec",{event:e,formData:t})}static _addModelFlags(){WeatherUi._weatherModel.hasControls=FoundryAbstractionLayer.isGm(),WeatherUi._weatherModel.hasPerceivers=FoundryAbstractionLayer.isGm()||WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID()).length>1,WeatherUi._weatherModel.hasTimeAuthority=FoundryAbstractionLayer.isGm()&&TimeProvider.hasTimeAuthority()&&[t.REGION_TEMPLATE,t.REGION_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED)),WeatherUi._weatherModel.hasTimeAuthority?WeatherUi._weatherModel.timeHeadline=TimeProvider.getI18nDateString():WeatherUi._weatherModel.timeHeadline=""}getData(){return WeatherUi._addModelFlags(),Logger.debug("WeatherUi.getData()",{_weatherModel:WeatherUi._weatherModel}),WeatherUi._weatherModel}_attachDragHandler(t){const i=t.find("#weatherHeadline")[0],a=new Draggable(this,t,i,!1);let r=!1;a._onDragMouseMove=function _newOnDragMouseMove(e){e.preventDefault();const t=document.getElementById("players").getBoundingClientRect(),i=Date.now();if(i-this._moveTime<1e3/60)return;this._moveTime=i;const{left:a,top:n}=this.element.getBoundingClientRect();WeatherUi.unPinApp()&&Object.assign(this.position,{left:a,top:n}),this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)});let o=t.top-50,s=t.top+50;e.clientX>t.left&&e.clientX<t.left+t.width&&e.clientY>o&&e.clientY<s?($("#scene-weather-app").css("animation","jiggle 0.2s infinite"),r=!0):($("#scene-weather-app").css("animation",""),r=!1)},a._onDragMouseUp=async function _newOnDragMouseUp(t){t.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp);const i=document.getElementById("players").getBoundingClientRect().height+90;if(r)WeatherUi.pinApp(),await game.settings.set(e.ID,"uiPinned",!0),this.app.setPosition({left:15,top:window.innerHeight-i});else{const t=$("#scene-weather-app").position(),i={top:t.top,left:t.left};await game.settings.set(e.ID,"uiPosition",i),await game.settings.set(e.ID,"uiPinned",!1)}$("#scene-weather-app").css("animation","")}}_attachControls(e){FoundryAbstractionLayer.isGm()&&e.find("#weatherControls li").each((function(e){const t=$(this),i=t.attr("data-func")||"none",a=Number(t.attr("data-base")||"0");switch(i){case"time":t.on("click",(function(){TimeProvider.advanceGameTime(window.event.ctrlKey?5*a:a)}));break;case"chatSingle":t.on("click",(async function(){const e=FoundryAbstractionLayer.getControlledTokens();if(0==e.length)Logger.info(FoundryAbstractionLayer.i18n("dialogs.weatherUi.chatNotice"),!0);else{const t=e.map((e=>FoundryAbstractionLayer.getUserByToken(e)));Logger.debug("chatSingle",{tokens:e,userIds:t});const i=await WeatherPerception.getAsChatHtml(WeatherUi._perceptionId,WeatherUi._weatherModel);ChatMessage.create({user:FoundryAbstractionLayer.userID(),whisper:t,content:i})}}));break;case"chatAll":t.on("click",(async function(){const e=await WeatherPerception.getAsChatHtml(WeatherUi._perceptionId,WeatherUi._weatherModel);ChatMessage.create({user:FoundryAbstractionLayer.userID(),content:e})}));break;case"clipboard":t.on("click",(async function(){const e=await WeatherPerception.getAsText(WeatherUi._perceptionId,WeatherUi._weatherModel);Utils.copyToClipboard(e),Logger.info(FoundryAbstractionLayer.i18n("dialogs.weatherUi.clipboardNotice"),!0)}))}}))}_attachPerceiverControls(e){(FoundryAbstractionLayer.isGm()||WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID()).length>1)&&e.find("#weatherContainer .percControl").each((function(e){const t=$(this);switch(t.attr("data-func")||"none"){case"prevPerc":t.on("click",(function(){const e=WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID());WeatherUi._perceptionId=Utils.arrayPrev(e,WeatherUi._perceptionId),Logger.debug("click()",{perceiverPrev:WeatherUi._perceptionId}),WeatherUi.update()}));break;case"nextPerc":t.on("click",(function(){const e=WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID());WeatherUi._perceptionId=Utils.arrayNext(e,WeatherUi._perceptionId),Logger.debug("click()",{perceiverNext:WeatherUi._perceptionId}),WeatherUi.update()}))}}))}activateListeners(e){super.activateListeners(e),this._attachDragHandler(e),FoundryAbstractionLayer.isGm()&&this._attachControls(e),(FoundryAbstractionLayer.isGm()||WeatherPerception.getAllowedIds(FoundryAbstractionLayer.userID()).length)&&this._attachPerceiverControls(e)}static async pinApp(){const t=game.modules.get(e.ID).uiApp;t&&!t.element.hasClass("pinned")&&($("#players").before(t.element),t.element.addClass("pinned"))}static unPinApp(){const t=game.modules.get(e.ID).uiApp;if(t&&t.element.hasClass("pinned")){const e=t.element;return $("body").append(e),e.removeClass("pinned"),!0}}static async toggleAppVis(t){"toggle"===t?!0===game.settings.get(e.ID,"uiVisible")?($("#scene-weather-app").stop(),$("#scene-weather-app").css({animation:"close 0.3s",opacity:"0"}),setTimeout((function(){game.modules.get(e.ID).uiApp.close({sceneWeather:!0})}),200)):(WeatherUi._isOpen&&game.modules.get(e.ID).uiApp.close({sceneWeather:!0}),game.modules.get(e.ID).uiApp=await(new WeatherUi).render(!0),game.settings.set(e.ID,"uiVisible",!0)):!0===game.settings.get(e.ID,"uiVisible")&&(game.modules.get(e.ID).uiApp=await(new WeatherUi).render(!0))}static async _updateTimeHeadline(){Logger.debug("WeatherUi._updateTimeHeadline()",{model:WeatherUi._weatherModel}),WeatherUi._weatherModel.hasTimeAuthority&&(WeatherUi._weatherModel.timeHeadline=TimeProvider.getI18nDateString(),$("#weatherHeadline").html(WeatherUi._weatherModel.timeHeadline))}static async update(t=null){if(null==t&&(t=WeatherUi._weatherModel),Logger.debug("WeatherUi.update(...)",{weatherModel:t}),WeatherUi._weatherModel=t,WeatherUi._addModelFlags(),!0===game.settings.get(e.ID,"uiVisible")){const e=await WeatherPerception.getAsUiHtml(WeatherUi._perceptionId,WeatherUi._weatherModel);$("#weatherDetail").html(e),WeatherUi._updateTimeHeadline()}}}Hooks.on(e.LCCNAME+"WeatherUpdated",(async e=>{e.sceneId==canvas.scene._id&&void 0!==e.model&&MeteoUi.update()}));class MeteoUi extends FormApplication{static _isOpen=!1;static _context=void 0;static _fromHr=-12;static _toHr=12;async _render(e=!1,t={}){await super._render(e,t),MeteoUi._isOpen=!0,MeteoUi._context=document.getElementById("meteogramCanvas"),MeteoUi._chart=void 0,MeteoUi._drawWeatherModelData(),delete ui.windows[this.appId]}async close(t={}){return t.sceneWeather&&(MeteoUi._isOpen=!1,MeteoUi._context=void 0,game.settings.set(e.ID,"meteoVisible",!1)),super.close(t)}constructor(){super()}static get defaultOptions(){return this.initialPosition=game.settings.get(e.ID,"meteoPosition"),mergeObject(super.defaultOptions,{classes:["form"],popOut:!0,width:600,height:400,submitOnChange:!1,closeOnSubmit:!1,minimizable:!1,template:"modules/"+e.ID+"/templates/meteoUi.hbs",id:"scene-weather-meteo-app",title:"SceneWeather Meteogram",top:this.initialPosition.top,left:this.initialPosition.left})}async _updateObject(e,t){Logger.debug("MeteoUi._updateObjec",{event:e,formData:t})}getData(){return{}}activateListeners(t){super.activateListeners(t);const i=t.find("#dragHandle")[0],a=new Draggable(this,t,i,!1);a._onDragMouseMove=function _newOnDragMouseMove(e){e.preventDefault();const t=Date.now();t-this._moveTime<1e3/60||(this._moveTime=t,this.app.setPosition({left:this.position.left+(e.clientX-this._initial.x),top:this.position.top+(e.clientY-this._initial.y)}))},a._onDragMouseUp=async function _newOnDragMouseUp(t){t.preventDefault(),window.removeEventListener(...this.handlers.dragMove),window.removeEventListener(...this.handlers.dragUp);let i=$("#scene-weather-meteo-app").position(),a={top:i.top,left:i.left};await game.settings.set(e.ID,"meteoPosition",a)}}static async toggleAppVis(t){"toggle"===t?!0===game.settings.get(e.ID,"meteoVisible")?($("#scene-weather-meteo-app").stop(),$("#scene-weather-meteo-app").css({animation:"close 0.3s",opacity:"0"}),setTimeout((function(){game.modules.get(e.ID).meteoApp.close({sceneWeather:!0})}),200)):(MeteoUi._isOpen&&game.modules.get(e.ID).meteoApp.close({sceneWeather:!0}),game.modules.get(e.ID).meteoApp=await(new MeteoUi).render(!0),game.settings.set(e.ID,"meteoVisible",!0)):!0===game.settings.get(e.ID,"meteoVisible")&&(game.modules.get(e.ID).meteoApp=await(new MeteoUi).render(!0))}static async update(){Logger.debug("Updating MeteoUi"),!0===game.settings.get(e.ID,"meteoVisible")&&MeteoUi._drawWeatherModelData()}static async _drawWeatherModelData(){const e=MeteoUi._fromHr,t=MeteoUi._toHr,i=MeteoUi._context;if(void 0===i)return void Logger.debug("No Context Yet");let a={labels:[],datasets:[]},r={label:"tempGround",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff0000",borderDash:[5,5],yAxisID:"y"},n={label:"tempAir",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff4400",borderDash:[5,5],yAxisID:"y"},o={label:"tempPercieved",data:[],borderWidth:1,pointRadius:0,borderColor:"#ff0044",yAxisID:"y"},s={label:"windSpeed",data:[],borderWidth:1,pointRadius:0,borderColor:"rgba(20, 200, 0, 0.9)",yAxisID:"y"},c={label:"windGusts",data:[],borderWidth:1,pointRadius:0,borderColor:"rgba(0, 200, 0, 0.8)",borderDash:[5,5],yAxisID:"y"},d={label:"windDirection",data:[],borderWidth:1,showLine:!1,borderColor:"#b74"},l={label:"cloudsCoverage",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(128, 128, 128, 0.3)",fill:!0,stepped:!0,yAxisID:"y2"},g={label:"precipitationAmount",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(60,60,255,0.2)",fill:!0,yAxisID:"y2"},u={label:"sunAmount",data:[],borderWidth:1,pointRadius:0,backgroundColor:"rgba(255, 255, 0, 0.6)",fill:!0,yAxisID:"y2"},m={label:"humidity",data:[],borderWidth:1,pointRadius:0,borderColor:"#9999ff",yAxisID:"y2"};const p=SceneWeatherApi.getSceneWeatherProvider();for(let i=e;i<t;i++){const e=p.weatherModel.getWeatherData(0,i);r.data.push(e.temp.ground),n.data.push(e.temp.air),o.data.push(e.temp.percieved),s.data.push(e.wind.speed),c.data.push(e.wind.gusts),d.data.push(e.wind.direction/10),l.data.push(100*e.clouds.coverage),g.data.push(100*e.precipitation.amount),u.data.push(100*e.sun.amount),m.data.push(e.humidity),i<0?a.labels.push(i+"h"):i>0?a.labels.push("+"+i+"h"):a.labels.push("now")}a.datasets.push(r),a.datasets.push(n),a.datasets.push(o),a.datasets.push(s),a.datasets.push(c),a.datasets.push(d),a.datasets.push(l),a.datasets.push(g),a.datasets.push(u),a.datasets.push(m);let h={type:"line",data:a,options:{layout:{autoPadding:!1},interaction:{mode:"nearest",axis:"x",intersect:!1},plugins:{legend:{position:"right",labels:{usePointStyle:!0}}},responsive:!1,animation:!1,scales:{x:{position:"bottom"},y:{display:!0,position:"left",type:"linear",min:-30,max:70,title:{display:!0,text:"Â°C"},grid:{color:function(e){return 0==e.tick.value?"rgba(0,0,0,1)":"rgba(80,80,80,0.3)"}}},y2:{position:"right",type:"linear",min:0,max:100,title:{display:!0,text:"%"}}}}};if(void 0===MeteoUi._chart)MeteoUi._chart=new Chart(i,h),Logger.debug("MeteoUI::new",{ctx:i,chart:MeteoUi._chart});else{Logger.debug("MeteoUi::update");for(let e=0;e<MeteoUi._chart.data.datasets.length;e++)MeteoUi._chart.data.datasets[e].data=a.datasets[e].data;MeteoUi._chart.data.labels=a.labels,MeteoUi._chart.update()}}}class WeatherEffect extends ParticleEffect{static label="sceneweather.fxname";static _getFxEmittersForModel(e){let t=[];return game.sceneWeather.generators.forEach((i=>{let a=i.getEmitter(e);a&&t.push(a)})),Logger.debug("WeatherEffect._getFxEmittersForModel()",{model:e,gen:game.sceneWeather.generators,emitters:t}),t}static _equalizeMaxParticles(e,t){let i=0,a=0;for(let t=0;t<e.length;t++){const r=e[t];i+=r.maxParticles,a+=r.weight}if(i<=t)return e;let r=0;for(let t=0;t<e.length;t++){const i=e[t];r+=i.maxParticles*(i.weight/a)}r=t/r;for(let t=0;t<e.length;t++){const i=e[t];i.maxParticles*=r*(i.weight/a)}return Logger.debug("WeatherEffect._equalizeMaxParticles()",{totalParticles:i,maxParticles:t}),e}play({easeIn:e=!0}={}){e||this.emitters.forEach((e=>{e.autoUpdate=!1,e.emit=!0,e.update(e.maxLifetime),e.autoUpdate=!0})),super.play()}getParticleEmitters(e={}){if(Logger.debug("WeatherEffect.getParticleEmitters(...)",{options:e}),void 0===e.data||void 0===e.data.model)return Logger.debug("WeatherEffect.getParticleEmitters() no model data contained, no emitters."),[];const t=WeatherEffect._getFxEmittersForModel(e.data.model),i=Utils.getSetting("maxParticles",3200);WeatherEffect._equalizeMaxParticles(t,i);let a=[];return t.forEach((e=>{a.push(this.createEmitter(e))})),a}async softStop({gracePeriod:e}={}){const t=this.emitters.map((t=>new Promise((i=>{let a=t._activeParticlesFirst;for(;null!=a;){const t=e,i=Math.max(a.age,a.maxLife-t);a.age=i,a.agePercent=a.age*a.oneOverLife,a=a.next}t.emitterLifetime=0,t.playOnceAndDestroy((()=>{i()}))})))),i=[Promise.all(t)];void 0!==e&&i.push(new Promise((t=>setTimeout(t,1e3*e))).then(this.destroy.bind(this))),await Promise.race(i),this.stop()}}Hooks.on(e.LCCNAME+"SettingsUpdated",(async e=>{Logger.debug("-> Hooks::SettingsUpdated -> WeatherEffectsLayer.draw*Effects",{data:e}),["cloudsAlpha","precipitationAlpha","maxParticles","enableFx"].includes(e.id)&&SceneWeatherApi.calculateWeather({force:!0})})),Hooks.on(e.LCCNAME+"WeatherUpdated",(async e=>{Logger.debug("-> Hooks::WeatherUpdated -> WeatherEffectsLayer.draw*Effects",{data:e}),void 0!==canvas.sceneweatherfx?await Promise.all([canvas.sceneweatherfx.drawParticleEffects({soft:!e.force,data:e}),canvas.sceneweatherfx.drawFilterEffects({soft:!e.force,data:e})]):Logger.debug("No canvas.sceneweatherfx")}));class WeatherEffectsLayer extends CanvasLayer{particleEffectsContainer;activeEffects=[];activeFilters={};constructor(){super(),canvas.app.ticker.add(this.handleTick,this)}static getFxFiltersForModel(e){let t={};return game.sceneWeather.filters.forEach((i=>{foundry.utils.mergeObject(t,i.getFilterConfig(e))})),Logger.debug("WeatherEffectsLayer.getFxFiltersForModel()",{model:e,filter:t}),t}get elevation(){return(canvas.weather?.elevation??9999)+1}set elevation(e){const t=canvas.weather;t&&(t.elevation=e-1)}static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"weather-particle-effects"})}async _draw(){Logger.debug("WeatherEffectsLayer._draw()",{this:this})}async _tearDown(){return Logger.debug("WeatherEffectsLayer._tearDown()",{effects:this.activeEffects}),this.activeEffects.forEach((e=>{e.destroy()})),this.activeEffects=[],this.particleEffectsContainer=void 0,super._tearDown()}handleTick(){for(const e in this.activeFilters)this.activeFilters[e].step()}async drawFilterEffects(e){if(Logger.debug("WeatherEffectsLayer.drawFilterEffects(...)",{options:e}),e=foundry.utils.mergeObject({soft:!1},e),!canvas.scene)return;const t=Object.values(this.activeFilters).map((e=>e.destroy()));await Promise.all(t);const i=Object.values(this.activeFilters);if(canvas.environment.filters=canvas.environment.filters?.filter((function(e){return!i.find((function(t){return e===t}))}))??[],this.activeFilters={},!Utils.getSetting("enableFx",!0))return;if(void 0===e.data||void 0===e.data.model)return void Logger.debug("WeatherEffectsLayer.drawFilterEffects() no model data contained, no filters.");const a=WeatherEffectsLayer.getFxFiltersForModel(e.data.model);Object.entries(a).map((([t,i])=>{this.activeFilters[t]=new i.type({soft:e.soft,options:foundry.utils.mergeObject(i,{"-=type":null},{performDeletions:!0})}),canvas.environment.filters.push(this.activeFilters[t])}))}async drawParticleEffects(e){if(e=foundry.utils.mergeObject({soft:!1},e),!canvas.scene)return;this.particleEffectsContainer||(this.particleEffectsContainer=this.addChild(new PIXI.Container));const t=Promise.all(this.activeEffects.map((async t=>{e.soft?await t.softStop({gracePeriod:10}):(t.destroy(),t.stop());const i=this.activeEffects.indexOf(t);i>-1&&this.activeEffects.splice(i,1)})));if(Utils.getSetting("enableFx",!0)){const t=new WeatherEffect(this.particleEffectsContainer,e);t.play({easeIn:e.soft}),this.activeEffects.push(t)}Logger.debug("waiting for emitters to clean up (softly)",{effects:this.activeEffects,soft:e.soft}),await t,Logger.debug("cleaned up emitters",{effects:this.activeEffects})}}class WeatherLayer extends InteractionLayer{static registerLayers(){CONFIG.Canvas.layers.sceneweather={layerClass:WeatherLayer,group:"interface"},CONFIG.Canvas.layers.sceneweatherfx={layerClass:WeatherEffectsLayer,group:"primary"}}static registerLayerButtons(){Hooks.on("getSceneControlButtons",(i=>{const a=[{name:"dialogs.weatherUi.toggleName",title:"dialogs.weatherUi.toggleTitle",icon:"fas fa-solid fa-window-maximize",visible:!0,toggle:!0,active:WeatherUi._isOpen,onClick:()=>{WeatherUi.toggleAppVis("toggle")}},{name:"Toggle Meteogram",title:"Toggle Meteogram",icon:"fas fa-solid fa-chart-line",visible:game.user.isGM&&[t.REGION_TEMPLATE,t.REGION_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED)),toggle:!0,active:MeteoUi._isOpen,onClick:()=>{MeteoUi.toggleAppVis("toggle")}},{name:"Weather Settings",title:"Weather Settings",icon:"fas fa-solid fa-sliders",visible:game.user.isGM&&[t.WEATHER_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED)),button:!0,onClick:()=>{if(game.user.isGM&&[t.WEATHER_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED))){new WeatherConfigDialog(canvas.scene._id).render(!0)}}},{name:"Region Settings",title:"Region Settings",icon:"fas fa-solid fa-sliders",visible:game.user.isGM&&[t.REGION_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED)),button:!0,onClick:()=>{if(game.user.isGM&&[t.REGION_GENERATE].includes(Utils.getSceneFlag("weatherMode",t.DISABLED))){new RegionConfigDialog(canvas.scene._id).render(!0)}}},{name:"Weather Effects Enabled",title:"Weather Effects Enabled",icon:"fas fa-solid fa-eye",visible:!0,toggle:!0,active:Utils.getSetting("enableFx",!0),onClick:()=>{const t=!Utils.getSetting("enableFx",!0);Utils.setSetting("enableFx",t),Hooks.callAll(e.LCCNAME+"SettingsUpdated",{id:"enableFx",value:t})}}];i.splice(i.findIndex((e=>"sounds"===e.name))+1,0,{name:"Scene Weather",title:"Scene Weather",icon:"fas fa-solid fa-cloud-bolt-sun",layer:"sceneweather",tools:a})}))}static get layerOptions(){return foundry.utils.mergeObject(super.layerOptions,{name:"sceneweather",canDragCreate:!1,controllableObjects:!0,rotatableObjects:!0,zIndex:666})}selectObjects(e){canvas.tokens.selectObjects(e)}}class WeatherTab{static async addControlsTab(t,i){Logger.debug("addControlsTab",{app:t,jQ:i});let a=t.document.flags[e.ID],r={weatherMode:"disabled",weatherTemplate:"default",regionTemplate:"plains",timeProvider:"manual",seed:0};mergeObject(r,a,{overwrite:!0});let n={data:r,timeProviders:[{id:"internal",name:"Use SceneWeather as time source"},{id:"external",name:"Use an external time source"},{id:"simple-calendar",name:"Use Simple Calendar as time source"}],rainModes:[{id:"winddir",name:"Same as winddirection"},{id:"topdown",name:"Always straight from top to bottom"},{id:"slanted",name:"Always slanted, from top to bottom"},{id:"windinfluence",name:"Direction influenced by winddirection and speed"}],weatherModes:[{id:"disabled",name:"Disabled (Use foundry default ambience)",hint:"Scene Weather is disabled. All ambience effects and types are set via the foundry default settings in Ambience."},{id:"weatherTemplate",name:"Use weather template (static)",hint:"Set a weather for the scene from a select choice of templates. The weather is static and will remain like that unless manually changed."},{id:"weatherAuto",name:"Manual weather settings (static)",hint:"Set the weather for the scene from manual set individual settings. The weather is static and will remain like that unless manually changed."},{id:"regionTemplate",name:"Use region template (dynamic)",hint:"Let the weather be generated based on a selected region template from a choice list. The weather will change dynamically based on given time of day and the season in the year. If an automatic calendar or time module is installed, it will change with the flow of time."},{id:"regionAuto",name:"Manual region settings (dynamic)",hint:"Let the weather be generated based on set attributes for the scene like mean temperature or elevation. The weather is dependant on a current time/date that needs to be provided to generate the dynamic weather based on all those parameters."}],weatherTemplates:[],regionTemplates:[]};n.weatherTemplates=WeatherModel.getTemplates(),n.regionTemplates=RegionMeteo.getTemplates(),Logger.debug("Render TabData with",{tabData:n});const o=await renderTemplate("modules/"+e.ID+"/templates/weatherTab.hbs",n);$(".sheet-tabs",i).append($("<a>").addClass("item").attr("data-tab","weather").html('<i class="fas fa-solid fa-cloud-bolt-sun"></i> Weather')),$("<div>").addClass("tab").attr("data-tab","weather").insertAfter($('div[data-tab="ambience"]',i)).append(o),WeatherTab.activateListeners(t,i,n.data.weatherMode)}static activateListeners(e,t,i){Logger.debug("WeatherTab.activateListeners",{app:e,jQ:t,select:i}),t.find('div[id="sceneWeather.mode.'+i+'"]').addClass("active"),t.find('div[id="not_sceneWeather.mode.'+i+'"]').removeClass("active"),t.find('button[data-key="flags.scene-weather.regionConfig"]').on("click",(function(){Logger.debug("Clicked Config Region for Scene",{sceneId:e.document._id});new RegionConfigDialog(e.document._id).render(!0)})),t.find('button[data-key="flags.scene-weather.weatherConfig"]').on("click",(function(){Logger.debug("Clicked Config Weather for Scene",{sceneId:e.document._id});new WeatherConfigDialog(e.document._id).render(!0)})),t.find('select[name="flags.scene-weather.weatherMode"]').on("change",(function(){let i=$(this).find(":selected").val();t.find("div.sceneWeather-collapsibleModeOption").each((function(){$(this).attr("id").startsWith("not_sceneWeather.mode.")?$(this).attr("id")=="not_sceneWeather.mode."+i?$(this).removeClass("active"):$(this).addClass("active"):$(this).attr("id")=="sceneWeather.mode."+i?$(this).addClass("active"):$(this).removeClass("active")})),e.setPosition({height:"auto"}),Logger.debug("onChange",{app:e,jQ:t})}))}}Hooks.once("init",(()=>{registerSettingsPreInit(),Logger.debug("->Hook:init"),registerHbHelpers(),loadHandlebars(),SceneWeatherApi.registerApi(),Hooks.callAll(e.LCCNAME+"RegisterGenerators"),Hooks.callAll(e.LCCNAME+"RegisterFilters"),Hooks.callAll(i.REG_TEMPLATE_REGION),Hooks.callAll(i.REG_TEMPLATE_WEATHER),Hooks.callAll(i.REG_WEATHER_PERCIEVERS),Logger.debug("Init Done",{api:game.sceneWeather}),Hooks.callAll(e.LCCNAME+"Initialized")})),Hooks.on(e.LCCNAME+"Initialized",(async()=>{Logger.debug("->Hook:"+e.LCCNAME+"Initialized"),Hooks.on("updateScene",(async(i,a,r,n)=>{void 0!==a.flags&&void 0!==a.flags[e.ID]&&(Logger.debug("updateScene-> ",{deltaData:a,options:r}),a.flags[e.ID].weatherMode,t.DISABLED,SceneWeatherApi.updateWeatherConfig({forSceneId:a._id,force:!0}),void 0!==a.flags[e.ID].weatherMode&&(Logger.debug("updateScene-> WeatherUi needs update..."),WeatherUi.toggleAppVis("initial")))})),Hooks.on("renderSceneConfig",(async(e,t,i)=>{Logger.debug("renderSceneConfig",{app:e,jQ:t,data:i}),WeatherTab.addControlsTab(e,t)}))})),Hooks.once("setup",(()=>{Logger.debug("->Hook:setup"),WeatherLayer.registerLayers(),WeatherLayer.registerLayerButtons()})),Hooks.on("canvasReady",(async t=>{Logger.debug("->Hook:canvasReady(...)",{canvas:t}),WeatherUi.toggleAppVis("initial"),game.settings.get(e.ID,"uiPinned")&&WeatherUi.pinApp(),MeteoUi.toggleAppVis("initial"),SceneWeatherApi.calculateWeather({force:!0})})),Hooks.on("ready",(async()=>{window.SceneWeather=getSceneWeatherAPIv1(),Hooks.callAll(e.LCCNAME+"Ready"),Logger.info("Ready")})),Hooks.on(e.LCCNAME+"Ready",(async()=>{Logger.debug("->Hook:"+e.LCCNAME+"Ready")})),Hooks.on("updateWorldTime",((e,t,i,a)=>{Logger.debug("->Hook:updateWorldTime",{worldTime:e,delta:t,options:i,userId:a}),["regionTemplate","regionAuto"].includes(Utils.getSceneFlag("weatherMode","disabled"))&&SceneWeatherApi.calculateWeather()}));class ColorFilter extends PIXI.filters.AdjustmentFilter{constructor({options:e={},soft:t=!1}={}){super();const{color:i,...a}=Utils.mergeObject({tint:"#ffffff",saturation:1,gamma:1,brightness:1,contrast:1},e),{r:r,g:n,b:o}=foundry.utils.Color.from(e.tint),s={...a,red:r,green:n,blue:o},c=Object.keys(s);for(const e of c)this.optionContext[e]=s[e];this.enabled=!0}get optionContext(){return this}async destroy(){return this.enabled=!1,!0}async step(){}}class Generators{static _scaleValues(e,t){e.list=e.list.map((e=>({...e,value:e.value*t})))}static _scaleRange(e,t){e.min=e.min*t,e.max=e.max*t}static _getTransposedPosition(e,t,i,a,r,n){const o=e+i/2,s=t+a/2,c=n*Math.PI/180;return{x:o+r*Math.cos(c)-i/2,y:s+r*Math.sin(c)-a/2}}static applyGeneratorToEmitterConfig(e,t){const i=2/3,a=canvas.dimensions.sceneRect;t.maxParticles=canvas.dimensions.width/canvas.dimensions.size*(canvas.dimensions.height/canvas.dimensions.size)*e.density;const r=t.behaviors.find((({type:e})=>"moveSpeedStatic"===e))?.config;if(void 0!==r){const n=(r.min+r.max)/2,o=Math.sqrt(a.width*a.width+a.height*a.height),s=o/n,c=s/i/2,d=s/i;t.lifetime={min:c,max:d},t.frequency=(c+d)/2/t.maxParticles;const l=Generators._getTransposedPosition(a.x,a.y,a.width,a.height,o/4,(e.direction+180)%360);t.behaviors.push({type:"spawnShape",config:{type:"rect",data:{x:l.x,y:l.y,w:a.width,h:a.height}}})}else{t.frequency=(t.lifetime.min+t.lifetime.max)/2/t.maxParticles;const e=canvas.dimensions.sceneRect;t.behaviors.push({type:"spawnShape",config:{type:"rect",data:{x:e.x-e.width/4,y:e.y-e.height/4,w:1.5*e.width,h:1.5*e.height}}})}void 0!==e.alpha&&t.behaviors.filter((e=>"alpha"===e.type)).forEach((({config:t})=>Generators._scaleValues(t.alpha,e.alpha)));let n=e.scale*(canvas.dimensions.size/100);t.behaviors.filter((e=>"scale"===e.type)).forEach((({config:e})=>Generators._scaleValues(e.scale,n))),t.behaviors.filter((e=>"scaleStatic"===e.type)).forEach((({config:e})=>Generators._scaleRange(e,n))),n=e.speed*(canvas.dimensions.size/100),t.behaviors.filter((e=>["moveSpeed","movePath"].includes(e.type))).forEach((({config:e})=>Generators._scaleValues(e.speed,n))),t.behaviors.filter((e=>"moveSpeedStatic"===e.type)).forEach((({config:e})=>Generators._scaleRange(e,n))),Generators._scaleRange(t.lifetime,1/n),t.frequency/=n;const o=e.direction;void 0!==o&&(t.behaviors.filter((e=>"rotation"===e.type)).forEach((({config:e})=>{const t=e.maxStart-e.minStart;e.minStart=o-t/2,e.maxStart=o+t/2})),t.behaviors.filter((e=>"rotationStatic"===e.type)).forEach((({config:e})=>{const t=e.max-e.min;e.min=o-t/2,e.max=o+t/2})));const s=e.lifetime;Generators._scaleRange(t.lifetime,s),t.frequency*=s,null!=e.tint&&(t.behaviors=t.behaviors.filter((({type:e})=>"color"!==e&&"colorStatic"!==e)).concat({type:"colorStatic",config:{color:e.tint}}))}}Hooks.on(i.REG_FX_GENERATORS,(async()=>{SceneWeather.registerWeatherFxGenerator("cumulus",(function(t){if(FoundryAbstractionLayer.getSetting("cloudsAlpha",100)<2)return;if(![n.cumulus,n.cumulunimbus].includes(t.clouds.type))return null;let i={alpha:FoundryAbstractionLayer.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:Utils.map(t.wind.speed,10,70,.2,3),scale:Utils.map(t.clouds.coverage,.3,1,.8,1),lifetime:1,density:Utils.map(t.clouds.coverage,.2,1,.005,.02),tint:null};4==t.clouds.type&&(i.tint="#B0B0B0",i.density=.001);const a=Utils.deepClone({weight:.8,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.58,max:3.3}},{type:"rotationStatic",config:{min:85,max:95}},{type:"textureRandom",config:{textures:Array.fromRange(5).map((t=>"modules/"+e.ID+`/assets/cu${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}))}));class FlashFilter extends PIXI.filters.AdjustmentFilter{options;constructor({options:e={},soft:t=!1}={}){super(),this.options=Utils.mergeObject({frequency:0,duration:0,brightness:1,nextTime:FoundryAbstractionLayer.getLastTickTime()/10},e);const i=Object.keys(this.options);for(const e of i)this.optionContext[e]=this.options[e];this.enabled=!0}get optionContext(){return this}async discard(){return this.enabled=!1,!0}async step(){if(FoundryAbstractionLayer.getLastTickTime()/10>this.options.nextTime){this.options.nextTime=FoundryAbstractionLayer.getLastTickTime()/10+40+this.options.frequency*Math.random();const animate=t=>{const i=[{parent:this,attribute:"brightness",to:t}];return CanvasAnimation.animate(i,{name:e.ID+`.${this.constructor.name}.${randomID()}`,context:this,duration:100+this.options.duration*Math.random(),easing:function(e){const t=2.5949095;return e<.5?Math.pow(2*e,2)*(7.189819*e-t)/2:(Math.pow(2*e-2,2)*((t+1)*(2*e-2)+t)+2)/2}})};await animate(this.options.brightness),await animate(1)}}}Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("fog",(function(t){if(FoundryAbstractionLayer.getSetting("cloudsAlpha",100)<2)return;if(t.clouds.type!=n.fog)return null;const i={alpha:FoundryAbstractionLayer.getSetting("cloudsAlpha",100)/100,direction:0,speed:1,scale:1,lifetime:1,density:Utils.map(t.clouds.coverage,.2,1,.01,1),tint:null},a=Utils.deepClone({weight:.9,lifetime:{min:10,max:25},behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.1,time:.1},{value:.3,time:.5},{value:.1,time:.9},{value:0,time:1}]}}},{type:"moveSpeed",config:{speed:{list:[{time:0,value:15},{time:1,value:10}]},minMult:.2}},{type:"scale",config:{scale:{list:[{value:2.5,time:0},{value:2,time:1}]},minMult:.5}},{type:"rotation",config:{accel:0,minSpeed:.15,maxSpeed:.35,minStart:0,maxStart:365}},{type:"textureRandom",config:{textures:Array.fromRange(3).map((t=>"modules/"+e.ID+`/assets/fg${t+1}.webp`))}},{type:"colorStatic",config:{color:"dddddd"}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}))})),Hooks.on(i.REG_FX_FILTERS,(async()=>{SceneWeather.registerWeatherFxFilter("freeze",(function(e){let t={};return e.temp.air<0&&(t.freeze={type:ColorFilter,tint:Utils.mapColorHex(e.temp.air+10,0,10,"#E1F3FE","#FFFFFF"),saturation:1-Utils.map(e.temp.air+10,10,0,0,.4),gamma:1,brightness:1,contrast:1}),t}))})),Hooks.on(i.REG_FX_FILTERS,(async()=>{SceneWeather.registerWeatherFxFilter("heatglare",(function(e){let t={};return e.sun.amount>.8&&e.temp.air>30&&(t.heatglare={type:ColorFilter,tint:Utils.mapColorHex(e.sun.amount,.8,1,"#ffffff","#FFF3D1"),saturation:1,gamma:1,brightness:Utils.map(e.sun.amount,.8,1,1,1.4),contrast:Utils.map(e.temp.air,30,50,1,1.5)}),t}))})),Hooks.on(i.REG_FX_FILTERS,(async()=>{SceneWeather.registerWeatherFxFilter("lightning",(function(e){let t={};return e.clouds.type>n.cumulus&&[r.rain,r.downpour,r.hail].includes(e.precipitation.type)&&e.precipitation.amount>.3&&(t.lightning={type:FlashFilter,frequency:2e3-Utils.map(e.precipitation.amount,.3,1,0,1600),duration:100,brightness:1.2},t.cloudcolor={type:ColorFilter,tint:"#D1CBD7",saturation:1,gamma:1,brightness:1,contrast:1}),t}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("nimbus",(function(t){if(FoundryAbstractionLayer.getSetting("cloudsAlpha",100)<2)return;if(t.clouds.type!=n.cumulunimbus)return null;let i={alpha:FoundryAbstractionLayer.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:Utils.map(t.wind.speed,10,70,.2,3),scale:Utils.map(t.clouds.coverage,.3,1,.8,1),lifetime:1,density:Utils.map(t.clouds.coverage,.2,1,.005,.02),tint:null};const a=Utils.deepClone({weight:.9,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.08,max:2.8}},{type:"rotationStatic",config:{min:90,max:90}},{type:"textureRandom",config:{textures:Array.fromRange(4).map((t=>"modules/"+e.ID+`/assets/tcu${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("rain",(function(e){if(FoundryAbstractionLayer.getSetting("precipitationAlpha",100)<2)return;if(![r.drizzle,r.rain,r.downpour,r.hail].includes(e.precipitation.type))return null;let t=90;switch(e.precipitation.mode??"winddir"){case"winddir":default:t=(Math.round(e.wind.direction)+90)%360;break;case"topdown":t=90;break;case"slanted":t=75;break;case"windinfluence":t=90+Math.sin(e.wind.direction*Math.PI/180)*Utils.map(e.wind.speed,10,70,3,45)}const i={alpha:FoundryAbstractionLayer.getSetting("precipitationAlpha",100)/100,direction:t,speed:Utils.map(e.precipitation.amount,.4,.95,.6,2),scale:1,lifetime:Utils.map(e.precipitation.amount,.4,.95,1,.5),density:Utils.map(e.precipitation.amount,.4,.95,.01,4),tint:null},a=Utils.deepClone({weight:.2,lifetime:{min:.5,max:.5},pos:{x:0,y:0},behaviors:[{type:"alpha",config:{alpha:{list:[{time:0,value:.7},{time:1,value:.1}]}}},{type:"moveSpeedStatic",config:{min:2800,max:3500}},{type:"scaleStatic",config:{min:.8,max:1}},{type:"rotationStatic",config:{min:89,max:91}},{type:"textureSingle",config:{texture:"ui/particles/rain.png"}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("snow",(function(e){if(FoundryAbstractionLayer.getSetting("precipitationAlpha",100)<2)return;if(![r.snow,r.blizzard].includes(e.precipitation.type))return null;let t=90;switch(e.precipitation.mode??"winddir"){case"winddir":default:t=(Math.round(e.wind.direction)+90)%360;break;case"topdown":t=90;break;case"slanted":t=75;break;case"windinfluence":t=90+Math.sin(e.wind.direction*Math.PI/180)*Utils.map(e.wind.speed,10,70,10,90)}const i={alpha:FoundryAbstractionLayer.getSetting("precipitationAlpha",100)/100,direction:t,speed:Utils.map(e.wind.speed,10,70,.3,5),scale:1,lifetime:Utils.map(e.precipitation.amount,.4,.95,1,.7),density:Utils.map(e.precipitation.amount,.4,.95,.01,3),tint:null},a=Utils.deepClone({weight:.2,lifetime:{min:4,max:4},behaviors:[{type:"alpha",config:{alpha:{list:[{time:0,value:.9},{time:1,value:.5}]}}},{type:"moveSpeed",config:{speed:{list:[{time:0,value:190},{time:1,value:210}]},minMult:.6}},{type:"scale",config:{scale:{list:[{time:0,value:.2},{time:1,value:.4}]},minMult:.5}},{type:"rotation",config:{accel:0,minSpeed:0,maxSpeed:200,minStart:50,maxStart:75}},{type:"textureSingle",config:{texture:"ui/particles/snow.png"}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}))})),Hooks.on(e.LCCNAME+"RegisterGenerators",(async()=>{SceneWeather.registerWeatherFxGenerator("stratus",(function(t){if(FoundryAbstractionLayer.getSetting("cloudsAlpha",100)<2)return;if(![n.stratus,n.cumulus,n.cumulunimbus].includes(t.clouds.type))return null;let i={alpha:FoundryAbstractionLayer.getSetting("cloudsAlpha",100)/100,direction:(Math.round(t.wind.direction)+90)%360,speed:Utils.map(t.wind.speed,10,100,.2,2.5),scale:Utils.map(t.clouds.coverage,.3,1,1,2),lifetime:1,density:Utils.map(t.clouds.coverage,.2,1,.001,.01),tint:null};3==t.clouds.type&&(i.tint="#A0A0A0",i.density=.007,i.scale=1),4==t.clouds.type&&(i.tint="#808080",i.density=.01,i.scale=1.2);const a=Utils.deepClone({weight:.7,behaviors:[{type:"alpha",config:{alpha:{list:[{value:0,time:0},{value:.5,time:.05},{value:.5,time:.95},{value:0,time:1}]}}},{type:"moveSpeedStatic",config:{min:30,max:100}},{type:"scaleStatic",config:{min:2.58,max:3.3}},{type:"rotationStatic",config:{min:80,max:100}},{type:"textureRandom",config:{textures:Array.fromRange(6).map((t=>"modules/"+e.ID+`/assets/st${t+1}.webp`))}}]});return Generators.applyGeneratorToEmitterConfig(i,a),a}))})),Hooks.on(i.REG_WEATHER_PERCIEVERS,(async()=>{Logger.debug("registered weatherPerciever for icon"),Utils.getApi().registerPerciever("icon",new IconPerciever)}));const u="meteo.icon.";class IconPerciever extends WeatherPerception{isAllowed(e){return FoundryAbstractionLayer.isGm(e)}async getTextFromModel(e){return Handlebars.compile(Utils.i18n("meteo.icon.templates.text"))(await this.getWeatherInfoFromModel(e))}async getUiHtmlFromModel(t){return await renderTemplate("modules/"+e.ID+"/templates/iconPerceptionUi.hbs",await this.getWeatherInfoFromModel(t))}async getChatHtmlFromModel(t){return await renderTemplate("modules/"+e.ID+"/templates/iconPerceptionChat.hbs",Utils.mergeObject({description:await this.getTextFromModel(t)},await this.getWeatherInfoFromModel(t)))}async getWeatherInfoFromModel(e){let t=FoundryAbstractionLayer.mergeObject(WeatherPerception.DEFAULT_WEATHER_STRUCT,{temperature:{air:e.temp.air.toFixed(1),ground:e.temp.ground.toFixed(1),percieved:e.temp.percieved.toFixed(1)},humidity:{percent:NaN},wind:{speed:NaN,gusts:NaN,direction:NaN},clouds:{height:NaN,amount:30*Math.round(30*e.clouds.coverage),type:e.clouds.type},sun:{amount:e.sun.amount>.3?1:0},precipitation:{amount:e.precipitation.amount>.4?1:0,type:e.precipitation.type},composite:{sun:e.sun.amount>.3?"sun":"none",clouds:"none",preci:"none",wind:"none"},descriptive:{sun:e.sun.amount>.3?u+"sun.sun":u+"sun.none",clouds:u+"clouds.none",preci:u+"precipitation.none",wind:u+"wind.none"}});switch(e.clouds.type){case n.fog:return t.composite.clouds="fog",t.descriptive.clouds=u+"clouds.fog",t;case n.stratus:case n.cumulus:t.composite.clouds="cloud",t.descriptive.clouds=u+"clouds.cloud";break;case n.cumulunimbus:t.composite.clouds="thunder",t.descriptive.clouds=u+"clouds.thunder"}switch(e.precipitation.type){case r.drizzle:t.composite.preci="lightRain",t.descriptive.preci=u+"precipitation.lightRain";break;case r.rain:case r.downpour:t.composite.preci="rain",t.descriptive.preci=u+"precipitation.rain";break;case r.hail:case r.snow:t.composite.preci="lightSnow",t.descriptive.preci=u+"precipitation.lightSnow";break;case r.blizzard:t.composite.preci="snow",t.descriptive.preci=u+"precipitation.snow"}return e.wind.speed>50&&(t.composite.wind="wind",t.descriptive.preci=u+"wind.wind"),Logger.debug("IconPerciever.getWeatherInfoFromModel()",{modelData:e,weatherInfo:t}),t}getPercieverInfo(){const e=FoundryAbstractionLayer.mergeObject(WeatherPerception.DEFAULT_INFO_STRUCT,{id:"icon",name:"meteo.icon.name"});return Logger.debug("IconPerciever.getPercieverInfo()",{info:e}),e}}Hooks.on(i.REG_WEATHER_PERCIEVERS,(async()=>{Logger.debug("registered weatherPerciever for perceptive"),Utils.getApi().registerPerciever("perceptive",new PerceptivePerciever)}));const m="meteo.perceptive.";class PerceptivePerciever extends WeatherPerception{isAllowed(e){return!0}async getTextFromModel(e){const t=await this.getWeatherInfoFromModel(e);return Handlebars.compile(Utils.i18n("meteo.perceptive.templates.text"))(t)}async getUiHtmlFromModel(e){const t=await this.getWeatherInfoFromModel(e);return Handlebars.compile(Utils.i18n("meteo.perceptive.templates.ui"))(t)}async getChatHtmlFromModel(e){return this.getUiHtmlFromModel(e)}async getWeatherInfoFromModel(e){const t=FoundryAbstractionLayer.mergeObject(WeatherPerception.DEFAULT_WEATHER_STRUCT,PerceptivePerciever._calculateWeatherInfoFromModelData(e));return Logger.debug("PerceptivePerciever.getWeatherInfoFromModel()",{weatherModel:e,weatherInfo:t}),t}getPercieverInfo(){const e=FoundryAbstractionLayer.mergeObject(WeatherPerception.DEFAULT_INFO_STRUCT,{id:"perceptive",name:m+"name"});return Logger.debug("PerceptivePerciever.getPercieverInfo()",{info:e}),e}static _fahrenheitToCelsius(e){return(e-32)/1.8}static _celsiusToFahrenheit(e){return 1.8*e+32}static _getPrecipitationTypeId(e){const[t]=Object.entries(r).find((([,t])=>t===e));return t?m+t:m+"none"}static _getPrecipitationAmountId(e){const[t]=Object.entries(c).find((([,t])=>e<t));return m+t}static _getSunAmountId(e){const[t]=Object.entries(s).find((([,t])=>e<t));return m+t}static _getCloudTypeId(e){const[t]=Object.entries(n).find((([,t])=>t===e));return t?m+t:m+"cumulunimbus"}static _getCloudAmountId(e){return m+["skc","few","few","sct","sct","bkn","bkn","bkn","ovc"][Math.round(8*e)]}static _getCloudHightId(e){const[t]=Object.entries(l).find((([,t])=>e<t));return m+t}static _getWindDirId(e){let t=Math.floor(e/22.5+.5);return m+["n","nne","ne","ene","e","ese","se","sse","s","ssw","sw","wsw","w","wnw","nw","nnw"][t%16]}static _getWindSpeedId(e){let t=e.gusts>5?"Gusting":"";const[i]=Object.entries(d).find((([,t])=>e.speed<t));return m+i+t}static _getHumidityId(e){const[t]=Object.entries(o).find((([,t])=>e<t));return m+t}static _getPercievedTempId(e){const[t]=Object.entries(g).find((([,t])=>e<t));return m+t}static _calculateWeatherInfoFromModelData(e){return Logger.debug("PerceptivePerciever._calculateWeatherInfoFromModelData()",{modelData:e}),{name:e.name,temperature:{air:Math.round(e.temp.air),ground:Math.round(e.temp.ground),percieved:Math.round(e.temp.percieved),percievedId:PerceptivePerciever._getPercievedTempId(e.temp.percieved)},humidity:{percent:Math.round(e.humidity),percentId:PerceptivePerciever._getHumidityId(e.humidity)},wind:{speed:Math.round(e.wind.speed),gusts:Math.round(e.wind.gusts),speedId:PerceptivePerciever._getWindSpeedId(e.wind),direction:Math.round(e.wind.direction),directionId:PerceptivePerciever._getWindDirId(e.wind.direction)},clouds:{height:Math.round(e.clouds.bottom),heightId:PerceptivePerciever._getCloudHightId(e.clouds.bottom),amount:Math.round(100*e.clouds.coverage),amountId:PerceptivePerciever._getCloudAmountId(e.clouds.coverage),type:PerceptivePerciever._getCloudTypeId(e.clouds.type)},sun:{amount:Math.round(100*e.sun.amount),amountId:PerceptivePerciever._getSunAmountId(e.sun.amount)},precipitation:{amount:Math.round(100*e.precipitation.amount),amountId:PerceptivePerciever._getPrecipitationAmountId(e.precipitation.amount),type:PerceptivePerciever._getPrecipitationTypeId(e.precipitation.type)}}}}Hooks.on(i.REG_WEATHER_PERCIEVERS,(async()=>{Logger.debug("registered weatherPerciever for precise"),Utils.getApi().registerPerciever("precise",new PrecisePerciever)}));class PrecisePerciever extends WeatherPerception{isAllowed(e){return FoundryAbstractionLayer.isGm(e)}async getTextFromModel(e){return JSON.stringify(this.getWeatherInfoFromModel(e))}async getUiHtmlFromModel(t){return await renderTemplate("modules/"+e.ID+"/templates/precisePerceptionUi.hbs",await this.getWeatherInfoFromModel(t))}async getChatHtmlFromModel(e){return this.getUiHtmlFromModel(e)}async getWeatherInfoFromModel(e){const t=FoundryAbstractionLayer.mergeObject(WeatherPerception.DEFAULT_WEATHER_STRUCT,{temperature:{air:e.temp.air.toFixed(1),ground:e.temp.ground.toFixed(1),percieved:e.temp.percieved.toFixed(1)},humidity:{percent:e.humidity.toFixed(1)},wind:{speed:Math.round(e.wind.speed),gusts:Math.round(e.wind.gusts),direction:Math.round(e.wind.direction)},clouds:{height:Math.round(e.clouds.bottom),amount:Math.round(100*e.clouds.coverage),type:e.clouds.type,typeId:PrecisePerciever._getCloudTypeId(e.clouds.type)},sun:{amount:Math.round(100*e.sun.amount)},precipitation:{amount:Math.round(100*e.precipitation.amount),type:e.precipitation.type,typeId:PrecisePerciever._getPrecipitationTypeId(e.precipitation.type)}});return Logger.debug("PerceptivePerciever.getWeatherInfoFromModel()",{modelData:e,weatherInfo:t}),t}getPercieverInfo(){const e=Utils.mergeObject(WeatherPerception.DEFAULT_INFO_STRUCT,{id:"precise",name:"meteo.precise.name"});return Logger.debug("PrecisePerciever.getPercieverInfo()",{info:e}),e}static _getCloudTypeId(e){const[t]=Object.entries(n).find((([,t])=>t===e));return t?`meteo.precise.cloudTypes.${t}`:"meteo.precise.cloudTypes.cumulunimbus"}static _getPrecipitationTypeId(e){const[t]=Object.entries(r).find((([,t])=>t===e));return t?`meteo.precise.precipitationTypes.${t}`:"meteo.precise.precipitationTypes.none"}}Hooks.on(i.REG_WEATHER_PERCIEVERS,(async()=>{Logger.debug("registered weatherPerciever for vague"),Utils.getApi().registerPerciever("vague",new VaguePerciever)}));class VaguePerciever extends WeatherPerception{isAllowed(e){return FoundryAbstractionLayer.isGm(e)}async getTextFromModel(e){return Handlebars.compile(Utils.i18n("meteo.vague.templates.text"))(await this.getWeatherInfoFromModel(e))}async getUiHtmlFromModel(e){return Handlebars.compile(Utils.i18n("meteo.vague.templates.ui"))(await this.getWeatherInfoFromModel(e))}async getChatHtmlFromModel(e){return this.getUiHtmlFromModel(e)}async getWeatherInfoFromModel(e){const t=5*Math.round(e.temp.percieved/5);let i=FoundryAbstractionLayer.mergeObject(WeatherPerception.DEFAULT_WEATHER_STRUCT,{temperature:{air:t,ground:NaN,percieved:t},humidity:{percent:NaN},wind:{speed:NaN,gusts:NaN,direction:NaN},clouds:{height:NaN,amount:10*Math.round(10*e.clouds.coverage),type:e.clouds.type>n.stratus?n.cumulus:n.none},sun:{amount:e.sun.amount>.3?1:0},precipitation:{amount:e.precipitation.amount>.4?1:0,type:e.precipitation.type>r.rain?r.rain:r.none},modifiers:{skyType:"none",tempType:"none",windType:"none"}});if(e.clouds.type==n.none)i.modifiers.skyType="meteo.vague.clear";else if(e.clouds.type==n.fog)i.modifiers.skyType="meteo.vague.fog";else if(e.clouds.type>=n.stratus)switch(e.precipitation.type){case r.blizzard:case r.snow:i.modifiers.skyType="meteo.vague.snow";break;case r.hail:case r.downpour:i.modifiers.skyType="meteo.vague.downpour",e.clouds.type>=n.cumulunimbus&&(i.modifiers.skyType="meteo.vague.thunderstorm");break;case r.rain:i.modifiers.skyType="meteo.vague.rain",e.clouds.type>=n.cumulunimbus&&(i.modifiers.skyType="meteo.vague.thunderstorm");break;case r.drizzle:i.modifiers.skyType="meteo.vague.drizzle";break;case r.none:default:i.modifiers.skyType="meteo.vague.cloudy"}return t>30?(i.modifiers.tempType="meteo.vague.warm",e.wind.speed>40&&(i.modifiers.windType="meteo.vague.windy")):t<5&&(i.modifiers.tempType="meteo.vague.cold",e.wind.speed>40&&(i.modifiers.windType="meteo.vague.windy")),Logger.debug("VaguePerciever.getWeatherInfoFromModel()",{modelData:e,weatherInfo:i}),i}getPercieverInfo(){const e=FoundryAbstractionLayer.mergeObject(WeatherPerception.DEFAULT_INFO_STRUCT,{id:"vague",name:"meteo.vague.name"});return Logger.debug("VaguePerciever.getPercieverInfo()",{info:e}),e}}Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"alpine",{name:"templates.region.alpine.name",description:"templates.region.alpine.description",elevation:1e3,vegetation:0,waterAmount:0,summer:{temperature:{day:15,night:5,var:7.5},humidity:{day:50,night:60,var:5},wind:{avg:30,var:10},sun:{hours:14}},winter:{temperature:{day:0,night:-15,var:7.5},humidity:{day:70,night:60,var:5},wind:{avg:40,var:20},sun:{hours:10}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"chaparral",{name:"templates.region.chaparral.name",description:"templates.region.chaparral.description",elevation:1e3,vegetation:5,waterAmount:5,summer:{temperature:{day:32.5,night:17.5,var:5},humidity:{day:60,night:40,var:5},wind:{avg:25,var:10},sun:{hours:13}},winter:{temperature:{day:17.5,night:2.5,var:5},humidity:{day:60,night:50,var:5},wind:{avg:30,var:10},sun:{hours:11}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"coastal",{name:"templates.region.coastal.name",description:"templates.region.coastal.description",elevation:100,vegetation:20,waterAmount:70,summer:{temperature:{day:25,night:15,var:10},humidity:{day:80,night:75,var:15},wind:{avg:10,var:25},sun:{hours:14}},winter:{temperature:{day:15,night:5,var:10},humidity:{day:75,night:70,var:5},wind:{avg:20,var:25},sun:{hours:10}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"desert",{name:"templates.region.desert.name",description:"templates.region.desert.description",elevation:500,vegetation:0,waterAmount:0,summer:{temperature:{day:45,night:25,var:10},humidity:{day:10,night:20,var:5},wind:{avg:30,var:10},sun:{hours:13}},winter:{temperature:{day:25,night:5,var:10},humidity:{day:30,night:50,var:20},wind:{avg:25,var:10},sun:{hours:11}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"grassland",{name:"templates.region.grassland.name",description:"templates.region.grassland.description",elevation:200,vegetation:40,waterAmount:20,summer:{temperature:{day:30,night:15,var:10},humidity:{day:70,night:80,var:5},wind:{avg:10,var:10},sun:{hours:14}},winter:{temperature:{day:10,night:-5,var:10},humidity:{day:70,night:60,var:10},wind:{avg:10,var:10},sun:{hours:10}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"littoral",{name:"templates.region.littoral.name",description:"templates.region.littoral.description",elevation:0,vegetation:1,waterAmount:50,summer:{temperature:{day:25,night:15,var:10},humidity:{day:60,night:60,var:5},wind:{avg:10,var:5},sun:{hours:16}},winter:{temperature:{day:15,night:5,var:10},humidity:{day:60,night:60,var:10},wind:{avg:15,var:10},sun:{hours:8}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"mangrove",{name:"templates.region.mangrove.name",description:"templates.region.mangrove.description",elevation:0,vegetation:80,waterAmount:60,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:60,night:70,var:10},wind:{avg:10,var:5},sun:{hours:16}},winter:{temperature:{day:27.5,night:17.5,var:5},humidity:{day:60,night:60,var:10},wind:{avg:15,var:10},sun:{hours:8}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"mediterranean",{name:"templates.region.mediterranean.name",description:"templates.region.mediterranean.description",elevation:500,vegetation:50,waterAmount:20,summer:{temperature:{day:30,night:17.5,var:7.5},humidity:{day:60,night:65,var:5},wind:{avg:15,var:10},sun:{hours:15}},winter:{temperature:{day:17.5,night:7.5,var:5},humidity:{day:70,night:60,var:10},wind:{avg:20,var:10},sun:{hours:9}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"polar",{name:"templates.region.polar.name",description:"templates.region.polar.description",elevation:0,vegetation:0,waterAmount:30,summer:{temperature:{day:2.5,night:-2.5,var:5},humidity:{day:80,night:65,var:10},wind:{avg:35,var:20},sun:{hours:23}},winter:{temperature:{day:-15,night:-25,var:10},humidity:{day:90,night:70,var:5},wind:{avg:40,var:20},sun:{hours:1}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"rainforest",{name:"templates.region.rainforest.name",description:"templates.region.rainforest.description",elevation:200,vegetation:100,waterAmount:80,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:90,night:80,var:10},wind:{avg:5,var:5},sun:{hours:12}},winter:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:80,night:70,var:10},wind:{avg:5,var:5},sun:{hours:12}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"savanna",{name:"templates.region.savanna.name",description:"templates.region.savanna.description",elevation:300,vegetation:30,waterAmount:5,summer:{temperature:{day:32.5,night:22.5,var:5},humidity:{day:60,night:70,var:10},wind:{avg:20,var:10},sun:{hours:13}},winter:{temperature:{day:27.5,night:17.5,var:5},humidity:{day:40,night:30,var:10},wind:{avg:20,var:10},sun:{hours:11}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"steppe",{name:"templates.region.steppe.name",description:"templates.region.steppe.description",elevation:500,vegetation:5,waterAmount:0,summer:{temperature:{day:27.5,night:15,var:5},humidity:{day:30,night:25,var:5},wind:{avg:25,var:10},sun:{hours:14}},winter:{temperature:{day:5,night:-5,var:10},humidity:{day:40,night:30,var:10},wind:{avg:20,var:10},sun:{hours:10}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"taiga",{name:"templates.region.taiga.name",description:"templates.region.taiga.description",elevation:400,vegetation:70,waterAmount:10,summer:{temperature:{day:20,night:10,var:10},humidity:{day:70,night:80,var:5},wind:{avg:15,var:10},sun:{hours:17}},winter:{temperature:{day:-5,night:-25,var:10},humidity:{day:80,night:60,var:5},wind:{avg:25,var:10},sun:{hours:8}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"temperate",{name:"templates.region.temperate.name",description:"templates.region.temperate.description",elevation:400,vegetation:50,waterAmount:10,summer:{temperature:{day:25,night:15,var:10},humidity:{day:70,night:60,var:10},wind:{avg:15,var:10},sun:{hours:15}},winter:{temperature:{day:10,night:0,var:10},humidity:{day:60,night:65,var:5},wind:{avg:20,var:10},sun:{hours:9}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"tundra",{name:"templates.region.tundra.name",description:"templates.region.tundra.description",elevation:300,vegetation:1,waterAmount:5,summer:{temperature:{day:7.5,night:2.5,var:5},humidity:{day:60,night:50,var:10},wind:{avg:20,var:10},sun:{hours:18}},winter:{temperature:{day:-15,night:-25,var:10},humidity:{day:70,night:50,var:5},wind:{avg:25,var:10},sun:{hours:6}}})})),Hooks.on(i.REG_TEMPLATE_REGION,(async()=>{SceneWeather.registerRegionTemplate(e.ID,"wetland",{name:"templates.region.wetland.name",description:"templates.region.wetland.description",elevation:100,vegetation:60,waterAmount:80,summer:{temperature:{day:25,night:15,var:10},humidity:{day:70,night:80,var:10},wind:{avg:15,var:10},sun:{hours:16}},winter:{temperature:{day:5,night:-5,var:10},humidity:{day:60,night:60,var:5},wind:{avg:20,var:5},sun:{hours:8}}})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"blizzard",{name:"templates.weather.blizzard.name",temp:{ground:0,air:-3,percieved:-4},wind:{speed:70,gusts:85,direction:115},clouds:{coverage:.7,bottom:1e3,top:3e3,type:n.cumulunimbus},precipitation:{amount:1,type:r.blizzard},sun:{amount:.1},humidity:10})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"densefog",{name:"templates.weather.densefog.name",temp:{ground:18,air:15,percieved:16},wind:{speed:15,gusts:16,direction:127},clouds:{coverage:.9,bottom:0,top:3e3,type:n.fog},precipitation:{amount:0,type:r.none},sun:{amount:.6},humidity:80})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"fog",{name:"templates.weather.fog.name",temp:{ground:18,air:15,percieved:16},wind:{speed:15,gusts:16,direction:127},clouds:{coverage:.3,bottom:0,top:3e3,type:n.fog},precipitation:{amount:0,type:r.none},sun:{amount:.6},humidity:80})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"frigid",{name:"templates.weather.frigid.name",temp:{ground:-5,air:-20,percieved:-25},wind:{speed:30,gusts:35,direction:70},clouds:{coverage:0,bottom:0,top:0,type:n.none},precipitation:{amount:0,type:r.none},sun:{amount:.6},humidity:10})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"heatwave",{name:"templates.weather.heatwave.name",temp:{ground:30,air:37,percieved:42},wind:{speed:0,gusts:0,direction:0},clouds:{coverage:0,bottom:0,top:0,type:n.none},precipitation:{amount:0,type:r.none},sun:{amount:1},humidity:80})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"heavyrain",{name:"templates.weather.heavyrain.name",temp:{ground:15,air:15,percieved:12},wind:{speed:25,gusts:29,direction:85},clouds:{coverage:.8,bottom:500,top:1e3,type:n.cumulus},precipitation:{amount:.9,type:r.rain},sun:{amount:.3},humidity:70})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"moderaterain",{name:"templates.weather.moderaterain.name",temp:{ground:16,air:18,percieved:16},wind:{speed:14,gusts:18,direction:75},clouds:{coverage:.6,bottom:1e3,top:3e3,type:n.cumulus},precipitation:{amount:.4,type:r.rain},sun:{amount:.6},humidity:65})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"partlycloudy",{name:"templates.weather.partlycloudy.name",temp:{ground:22,air:25,percieved:25},wind:{speed:20,gusts:25,direction:15},clouds:{coverage:.3,bottom:3e3,top:4e3,type:n.stratus},precipitation:{amount:0,type:r.none},sun:{amount:.6},humidity:60})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"rain",{name:"templates.weather.rain.name",temp:{ground:15,air:17,percieved:15},wind:{speed:22,gusts:27,direction:80},clouds:{coverage:.8,bottom:500,top:1e3,type:n.cumulus},precipitation:{amount:.6,type:r.rain},sun:{amount:.3},humidity:65})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"slightsnow",{name:"templates.weather.slightsnow.name",id:"",name:"Snowing slightly",temp:{ground:1,air:2,percieved:0},wind:{speed:14,gusts:18,direction:133},clouds:{coverage:.3,bottom:1e3,top:3e3,type:n.cumulus},precipitation:{amount:.4,type:r.snow},sun:{amount:.5},humidity:45})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"snow",{name:"templates.weather.snow.name",id:"",name:"Snowing",temp:{ground:0,air:-3,percieved:-4},wind:{speed:24,gusts:28,direction:223},clouds:{coverage:.3,bottom:1e3,top:3e3,type:n.cumulus},precipitation:{amount:.6,type:r.snow},sun:{amount:.3},humidity:45})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"snow",{name:"templates.weather.snow.name",id:"",name:"Snowing",temp:{ground:0,air:-3,percieved:-4},wind:{speed:24,gusts:28,direction:223},clouds:{coverage:.3,bottom:1e3,top:3e3,type:n.cumulus},precipitation:{amount:.6,type:r.snow},sun:{amount:.3},humidity:45})})),Hooks.on(i.REG_TEMPLATE_WEATHER,(async()=>{SceneWeather.registerWeatherTemplate(e.ID,"thunderstorm",{name:"templates.weather.thunderstorm.name",temp:{ground:14,air:13,percieved:11},wind:{speed:50,gusts:75,direction:90},clouds:{coverage:.95,bottom:500,top:8e3,type:n.cumulunimbus},precipitation:{amount:.95,type:r.downpour},sun:{amount:.1},humidity:70})}));export{l as CLOUD_HEIGHT,n as CLOUD_TYPE,ColorFilter,i as EVENTS,FlashFilter,FoundryAbstractionLayer,t as GENERATOR_MODES,Generators,o as HUMIDITY_LEVELS,Logger,a as METEO,e as MODULE,MeteoUi,Noise,c as PRECI_AMOUNT,r as PRECI_TYPE,RegionConfigDialog,RegionMeteo,s as SUN_INTENSITY,SceneWeather$1 as SceneWeather,SceneWeatherApi,g as TEMP_TYPES,TimeProvider,Utils,d as WIND_SPEED,WeatherConfigDialog,WeatherEffect,WeatherEffectsLayer,WeatherLayer,WeatherModel,WeatherPerception,WeatherTab,WeatherUi,getSceneWeatherAPIv1,loadHandlebars,registerHbHelpers,registerSettingsPostInit,registerSettingsPreInit};
